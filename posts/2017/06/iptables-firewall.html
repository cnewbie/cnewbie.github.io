<!DOCTYPE html>
<html lang="zh" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>iptables firewall - cnewbie's 	 blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://cnewbie.github.io/posts/2017/06/iptables-firewall.html">

        <meta name="author" content="cnewbie" />
        <meta name="keywords" content="iptables" />
        <meta name="description" content="iptables防火墙 filter,nat,mangle 规则表 filter表 数据包过滤,根据规则决定是否放行数据包（DROP,ACCEPT,REJECT,LOG） 三条规则链 INPUT 进入本地的包 FORWARD 不是本地产生且负责转发的包 OUTPUT 本地产生的包 nat表 修改数据包ip地址、端口等信息（SNAT,DNAT,MASQUERADE,REDIRECT） 三条规则链 PREROUTING 改变进入数据包的目的地址 OUTPUT 改变本地产生包的目的地址 POSTROUTING 改变发出数据包的源地址 mangle表 修改数据包的TOS，TTL及数据包的Mark。 五个规则链 PREROUTING，POSTROUTING，INPUT，OUTPUT，FORWARD raw表 决定数据包是否被状态跟踪机制处理 两条规则链 OUTPUT,PREROUTING 四种状态 NEW 开始一个连接 …" />

        <meta property="og:site_name" content="cnewbie's 	 blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="iptables firewall"/>
        <meta property="og:url" content="https://cnewbie.github.io/posts/2017/06/iptables-firewall.html"/>
        <meta property="og:description" content="iptables防火墙 filter,nat,mangle 规则表 filter表 数据包过滤,根据规则决定是否放行数据包（DROP,ACCEPT,REJECT,LOG） 三条规则链 INPUT 进入本地的包 FORWARD 不是本地产生且负责转发的包 OUTPUT 本地产生的包 nat表 修改数据包ip地址、端口等信息（SNAT,DNAT,MASQUERADE,REDIRECT） 三条规则链 PREROUTING 改变进入数据包的目的地址 OUTPUT 改变本地产生包的目的地址 POSTROUTING 改变发出数据包的源地址 mangle表 修改数据包的TOS，TTL及数据包的Mark。 五个规则链 PREROUTING，POSTROUTING，INPUT，OUTPUT，FORWARD raw表 决定数据包是否被状态跟踪机制处理 两条规则链 OUTPUT,PREROUTING 四种状态 NEW 开始一个连接 …"/>
        <meta property="article:published_time" content="2017-06-30" />
            <meta property="article:section" content="blog" />
            <meta property="article:tag" content="iptables" />
            <meta property="article:author" content="cnewbie" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cnewbie.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://cnewbie.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://cnewbie.github.io/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cnewbie.github.io/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://cnewbie.github.io/" class="navbar-brand">
cnewbie's 	 blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://cnewbie.github.io/others/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="https://cnewbie.github.io/others/category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://cnewbie.github.io/posts/index.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://cnewbie.github.io/posts/2017/06/iptables-firewall.html"
                       rel="bookmark"
                       title="Permalink to iptables firewall">
                        iptables firewall
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-06-30T20:16:05+08:00"> 2017 June 30 Fri</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://cnewbie.github.io/others/tag/iptables.html">iptables</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h1>iptables防火墙</h1>
<h2>filter,nat,mangle 规则表</h2>
<h3>filter表</h3>
<p>数据包过滤,根据规则决定是否放行数据包（DROP,ACCEPT,REJECT,LOG）</p>
<p>三条规则链</p>
<ul>
<li>INPUT 进入本地的包</li>
<li>FORWARD 不是本地产生且负责转发的包</li>
<li>OUTPUT 本地产生的包</li>
</ul>
<h3>nat表</h3>
<p>修改数据包ip地址、端口等信息（SNAT,DNAT,MASQUERADE,REDIRECT）</p>
<p>三条规则链</p>
<ul>
<li>PREROUTING 改变进入数据包的目的地址</li>
<li>OUTPUT 改变本地产生包的目的地址</li>
<li>POSTROUTING 改变发出数据包的源地址</li>
</ul>
<h3>mangle表</h3>
<p>修改数据包的TOS，TTL及数据包的Mark。
五个规则链 PREROUTING，POSTROUTING，INPUT，OUTPUT，FORWARD</p>
<h3>raw表</h3>
<p>决定数据包是否被状态跟踪机制处理
两条规则链 OUTPUT,PREROUTING</p>
<p>四种状态</p>
<ul>
<li>NEW 开始一个连接</li>
<li>RELATED 某个已经建立的连接所建立的新连接</li>
<li>ESTABLISHED 发送后接到应答的数据包</li>
<li>INVALID 无法识别的数据包</li>
</ul>
<h2>规则链和规则</h2>
<p>在处理各种数据包时，根据防火墙规则的不同时机，iptables供涉及5种默认规则链：</p>
<ul>
<li>INPUT 当接收到防火墙本机地址的数据包（入站）时,应用此链中的规则。。</li>
<li>OUTPUT 当防火墙本机向外发送数据包（出站）时，应用此链中的规则。</li>
<li>FORWARD 当接收到需要通过防火墙发送给其他地址的数据包（转发）时，应用此链中的规则。</li>
<li>PREROUTING 在对数据包作路由选择之前，应用此链中的规则，如DNAT。</li>
<li>POSTROUTING 在对数据包作路由选择之后，应用此链中的规则，如SNAT。</li>
</ul>
<div class="highlight"><pre><span></span>--&gt;PREROUTING--&gt;[ROUTE]--&gt;FORWARD--&gt;POSTROUTING--&gt;
     mangle        |       mangle        ^ mangle
      nat          |       filter        |  nat
                   |                     |
                   |                     |
                   v                     |
                 INPUT                 OUTPUT
                   | mangle              ^ mangle
                   | filter              |  nat
                   v ------&gt;local-------&gt;| filter
</pre></div>


<p>防火墙处理数据包的方式（规则）：</p>
<ul>
<li>ACCEPT：允许数据包通过</li>
<li>DROP：直接丢弃数据包，不给任何回应信息</li>
<li>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息。</li>
<li>SNAT：源地址转换。在进入路由层面的route之前，重新改写源地址，目标地址不变，并在本机建立NAT表项，当数据返回时，根据NAT表将目的地址数据改写为数据发送出去时候的源地址，并发送给主机。解决内网用户用同一个公网地址上网的问题。</li>
<li>MASQUERADE，是SNAT的一种特殊形式，适用于像adsl这种临时会变的ip上</li>
<li>DNAT:目标地址转换。和SNAT相反，IP包经过route之后、出本地的网络栈之前，重新修改目标地址，源地址不变，在本机建立NAT表项，当数据返回时，根据NAT表将源地址修改为数据发送过来时的目标地址，并发给远程主机。可以隐藏后端服务器的真实地址。</li>
<li>REDIRECT：是DNAT的一种特殊形式，将网络包转发到本地host上（不管IP头部指定的目标地址是啥），方便在本机做端口转发。</li>
<li>LOG：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则</li>
</ul>
<p>除去最后一个LOG，前3条规则匹配数据包后，该数据包不会再往下继续匹配了，所以编写的规则顺序极其关键。</p>
<p>Linux数据包路由原理</p>
<p><img alt="数据包流程" src="https://cnewbie.github.io/images/2017/packetflow.jpg"></p>
<h2>iptables编写规则</h2>
<p><img alt="命令格式" src="https://cnewbie.github.io/images/2017/iptables.png"></p>
<ul>
<li>[-t 表名]：该规则所操作的哪个表，可以使用filter、nat等，如果没有指定则默认为filter</li>
<li>-A：新增一条规则，到该规则链列表的最后一行</li>
<li>-I：插入一条规则，原本该位置上的规则会往后顺序移动，没有指定编号则为1</li>
<li>-D：从规则链中删除一条规则，要么输入完整的规则，或者指定规则编号加以删除</li>
<li>-R：替换某条规则，规则替换不会改变顺序，而且必须指定编号。</li>
<li>-P：设置某条规则链的默认动作</li>
<li>-nL：-L、-n，查看当前运行的防火墙规则列表</li>
<li>chain名：指定规则表的哪个链，如INPUT、OUPUT、FORWARD、PREROUTING等</li>
<li>[规则编号]：插入、删除、替换规则时用，--line-numbers显示号码</li>
<li>[-i|o 网卡名称]：i是指定数据包从哪块网卡进入，o是指定数据包从哪块网卡输出</li>
<li>[-p 协议类型]：可以指定规则应用的协议，包含tcp、udp和icmp等</li>
<li>[-s 源IP地址]：源主机的IP地址或子网地址</li>
<li>[--sport 源端口号]：数据包的IP的源端口号</li>
<li>[-d目标IP地址]：目标主机的IP地址或子网地址</li>
<li>[--dport目标端口号]：数据包的IP的目标端口号</li>
<li>-m：extend matches，这个选项用于提供更多的匹配参数，如：<ul>
<li>-m state –state ESTABLISHED,RELATED</li>
<li>-m tcp –dport 22</li>
<li>-m multiport –dports 80,8080</li>
<li>-m icmp –icmp-type 8</li>
</ul>
</li>
<li>&lt;-j 动作&gt;：处理数据包的动作，包括ACCEPT、DROP、REJECT等</li>
</ul>
<h2>iptables常用实例备查</h2>
<h3>普通规则</h3>
<div class="highlight"><pre><span></span>iptables -P INPUT DROP
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
</pre></div>


<p>限制</p>
<p><code>iptables -I INPUT 1 -m state --state RELATED,ESTABLISHED -j ACCEPT</code>  <br>
把这条语句插在input链的最前面（第一条），对状态为ESTABLISHED,RELATED的连接放行。</p>
<p><code>iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT</code> <br>
开放指定端口</p>
<p><code>iptables -I INPUT 2 -i lo -j ACCEPT</code> <br>
允许loopback，本地回环是主机内部发送和接收</p>
<p>删除</p>
<p><code>iptables -D chain  number</code></p>
<p>丢弃非法连接</p>
<div class="highlight"><pre><span></span>iptables -A INPUT -m state –state INVALID -j DROP
iptables -A OUTPUT -m state –state INVALID -j DROP
iptables-A FORWARD -m state –state INVALID -j DROP
</pre></div>


<p>日志</p>
<p><code>iptables -R INPUT 1 -p tcp --dport 22 -m limit --limit 3/minute --limit-burst 8 -j LOG</code></p>
<p>Dos</p>
<div class="highlight"><pre><span></span>iptables -N syn-flood   (如果您的防火墙默认配置有“ :syn-flood - [0:0] ”则不许要该项，因为重复了)
iptables -A INPUT -p tcp --syn -j syn-flood   
iptables -I syn-flood -p tcp -m limit --limit 2/s --limit-burst 5 -j RETURN   
iptables -A syn-flood -j REJECT   
# 防止DOS太多连接进来,可以允许外网网卡每个IP最多15个初始连接,超过的丢弃

# 需要iptables v1.4.19以上版本：iptables -V
iptables -A INPUT -p tcp --syn -i eth0 --dport 80 -m connlimit --connlimit-above 20 --connlimit-mask 24 -j DROP   

#用Iptables抵御DDOS (参数与上相同)   
iptables -A INPUT -p tcp --syn -m limit --limit 5/s --limit-burst 10 -j ACCEPT  
iptables -A FORWARD -p tcp --syn -m limit --limit 1/s -j ACCEPT
iptables -A FORWARD -p icmp -m limit --limit 2/s --limit-burst 10 -j ACCEPT
iptables -A INPUT -p icmp --icmp-type 0 -s ! 172.29.73.0/24 -j DROP
</pre></div>


<p>引用
<a href="http://seanlook.com/2014/02/23/iptables-understand/">Seanlook</a></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
        <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/cnewbie"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="https://cnewbie.github.io/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                    <li class="list-group-item tag-4">
                        <a href="https://cnewbie.github.io/others/tag/algorithm.html">
                            Algorithm
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://cnewbie.github.io/others/tag/iptables.html">
                            iptables
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="https://cnewbie.github.io/others/tag/git.html">
                            Git
                        </a>
                    </li>
                </ul>
            </li>


    </ul>
</section>            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 cnewbie
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://cnewbie.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://cnewbie.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://cnewbie.github.io/theme/js/respond.min.js"></script>


</body>
</html>