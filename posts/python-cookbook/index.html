<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.122.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Python Cookbook"><meta itemprop=description content="Python Cookbook"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://cnewbie.github.io/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="python,cookbook"><meta property="og:type" content="article"><meta property="og:title" content="Python Cookbook"><meta property="og:description" content="Python Cookbook"><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://cnewbie.github.io/posts/python-cookbook/"><meta property="og:site_name" content="Hugo NexT Blog"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="cnewbie"><meta property="article:published_time" content="2019-05-05 08:00:00 +0800 CST"><meta property="article:modified_time" content="2019-05-05 08:00:00 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.613cdd93403a6fc6667e9d7305a30b932cdc5a2fcc77df9f66518c9a9fa56b3c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"python-cookbook","permalink":"https://cnewbie.github.io/posts/python-cookbook/","title":"Python Cookbook","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Python Cookbook - Hugo NexT Blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Hugo NexT Blog</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>cnewbie的小窝</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>21</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#数据结构与算法>数据结构与算法</a><ul><li><a href=#小顶堆>小顶堆</a></li><li><a href=#优先队列>优先队列</a></li><li><a href=#multidict-多值字典>multidict 多值字典</a></li><li><a href=#ordereddict-排序字典>ordereddict 排序字典</a></li><li><a href=#字典运算>字典运算</a></li><li><a href=#查找字典相同键值>查找字典相同键值</a></li><li><a href=#删除序列重复元素并保持顺序>删除序列重复元素并保持顺序</a></li><li><a href=#命名切片>命名切片</a></li><li><a href=#序列中出现次数最多的元素>序列中出现次数最多的元素</a></li><li><a href=#字典排序>字典排序</a></li><li><a href=#排序不支持比较的对象>排序不支持比较的对象</a></li><li><a href=#数据分组>数据分组</a></li><li><a href=#过滤列表数据>过滤列表数据</a></li><li><a href=#字典子集>字典子集</a></li><li><a href=#映射名称到序列元素>映射名称到序列元素</a></li><li><a href=#转化并计算数据>转化并计算数据</a></li><li><a href=#合并词典或映射>合并词典或映射</a></li></ul></li><li><a href=#字符串和文本>字符串和文本</a><ul><li><a href=#多个界定符分割字符串>多个界定符分割字符串</a></li><li><a href=#shell-通配符匹配字符串>shell 通配符匹配字符串</a></li><li><a href=#字符串匹配搜索>字符串匹配搜索</a></li><li><a href=#字符串搜索替换>字符串搜索替换</a></li><li><a href=#字符串忽略大小写的搜索替换>字符串忽略大小写的搜索替换</a></li><li><a href=#最短匹配模式>最短匹配模式</a></li><li><a href=#多行匹配模式>多行匹配模式</a></li><li><a href=#unicode文本标准化>Unicode文本标准化</a></li><li><a href=#删除不需要的字符>删除不需要的字符</a></li><li><a href=#审查字符>审查字符</a></li><li><a href=#字符串对齐>字符串对齐</a></li><li><a href=#合并拼接字符串>合并拼接字符串</a></li><li><a href=#字符串中插入变量>字符串中插入变量</a></li><li><a href=#指定列宽格式化字符串>指定列宽格式化字符串</a></li><li><a href=#字符串令牌解析>字符串令牌解析</a></li><li><a href=#递归下降分析器>递归下降分析器</a></li></ul></li><li><a href=#数字日期与时间>数字日期与时间</a><ul><li><a href=#数字四舍五入>数字四舍五入</a></li><li><a href=#精确浮点数计算>精确浮点数计算</a></li><li><a href=#数字的格式化输出>数字的格式化输出</a></li><li><a href=#进制整数>进制整数</a></li><li><a href=#字节到大整数的打包与解包>字节到大整数的打包与解包</a></li><li><a href=#复数运算>复数运算</a></li><li><a href=#无穷大与-nan>无穷大与 NaN</a></li><li><a href=#分数计算>分数计算</a></li><li><a href=#numpy-模块>Numpy 模块</a></li><li><a href=#随机选择>随机选择</a></li><li><a href=#计算最后一个周五的日期>计算最后一个周五的日期</a></li><li><a href=#计算当前月份的日期范围>计算当前月份的日期范围</a></li><li><a href=#字符串转换为日期>字符串转换为日期</a></li></ul></li><li><a href=#迭代器与生成器>迭代器与生成器</a><ul><li><a href=#手动遍历迭代器>手动遍历迭代器</a></li><li><a href=#代理迭代>代理迭代</a></li><li><a href=#使用生成器创建新的迭代模式>使用生成器创建新的迭代模式</a></li><li><a href=#实现迭代器协议>实现迭代器协议</a><ul><li><a href=#生成器版本>生成器版本</a></li><li><a href=#迭代器版本>迭代器版本</a></li></ul></li><li><a href=#反向迭代>反向迭代</a></li><li><a href=#带有外部状态的生成器函数>带有外部状态的生成器函数</a></li><li><a href=#迭代器切片>迭代器切片</a></li><li><a href=#跳过可迭代对象的开始部分>跳过可迭代对象的开始部分</a></li><li><a href=#排列组合的迭代>排列组合的迭代</a></li><li><a href=#同时迭代多个序列>同时迭代多个序列</a></li><li><a href=#不同集合上元素的迭代>不同集合上元素的迭代</a></li><li><a href=#数据处理管道>数据处理管道</a></li><li><a href=#嵌套的序列>嵌套的序列</a></li><li><a href=#顺序迭代合并后的排序迭代对象>顺序迭代合并后的排序迭代对象</a></li><li><a href=#迭代器代替-while-无限循环>迭代器代替 while 无限循环</a></li></ul></li><li><a href=#文件与-io>文件与 IO</a><ul><li><a href=#字符串的io操作>字符串的I/O操作</a></li><li><a href=#固定大小记录的文件迭代>固定大小记录的文件迭代</a></li><li><a href=#读取二进制数据到可变缓冲区中>读取二进制数据到可变缓冲区中</a></li><li><a href=#内存映射的二进制文件>内存映射的二进制文件</a></li><li><a href=#打印不合法的文件名>打印不合法的文件名</a></li><li><a href=#增加或改变已打开文件的编码>增加或改变已打开文件的编码</a></li><li><a href=#将字节写入文本文件>将字节写入文本文件</a></li><li><a href=#文件描述符包装成文件对象>文件描述符包装成文件对象</a></li><li><a href=#创建临时文件和文件夹>创建临时文件和文件夹</a></li><li><a href=#序列化python对象>序列化Python对象</a></li></ul></li><li><a href=#数据编码和处理>数据编码和处理</a><ul><li><a href=#读写json数据>读写JSON数据</a></li><li><a href=#xml-操作>XML 操作</a><ul><li><a href=#增量解析大型-xml-文件>增量解析大型 XML 文件</a></li><li><a href=#修改文档>修改文档</a></li><li><a href=#命名空间解析xml文档>命名空间解析XML文档</a></li></ul></li><li><a href=#编码和解码十六进制数>编码和解码十六进制数</a></li><li><a href=#编码解码base64数据>编码解码Base64数据</a></li><li><a href=#struct>Struct</a></li><li><a href=#可变长度二进制数据>可变长度二进制数据</a><ul><li><a href=#数据结构定义>数据结构定义</a></li><li><a href=#直接代码解析>直接代码解析</a></li><li><a href=#高级抽象形式>高级抽象形式</a></li></ul></li></ul></li><li><a href=#函数>函数</a><ul><li><a href=#匿名函数捕获变量值>匿名函数捕获变量值</a></li><li><a href=#带额外状态信息的回调函数>带额外状态信息的回调函数</a><ul><li><a href=#类实例>类实例</a></li><li><a href=#函数闭包>函数闭包</a></li><li><a href=#协程方法>协程方法</a></li></ul></li><li><a href=#内联回调函数>内联回调函数</a></li><li><a href=#访问闭包中定义的变量>访问闭包中定义的变量</a></li></ul></li><li><a href=#类与对象>类与对象</a><ul><li><a href=#让对象支持上下文管理协议>让对象支持上下文管理协议</a></li><li><a href=#创建大量对象节省内存方法>创建大量对象节省内存方法</a></li><li><a href=#在类中封装属性名>在类中封装属性名</a></li><li><a href=#创建可管理的属性>创建可管理的属性</a></li><li><a href=#调用父类方法>调用父类方法</a></li><li><a href=#子类中拓展-property>子类中拓展 property</a><ul><li><a href=#描述符方式>描述符方式</a></li></ul></li><li><a href=#创建新的类或实例属性>创建新的类或实例属性</a><ul><li><a href=#类型检查描述符>类型检查描述符</a></li></ul></li><li><a href=#延迟计算属性>延迟计算属性</a></li><li><a href=#简化数据结构初始化>简化数据结构初始化</a></li><li><a href=#定义接口或者抽象基类>定义接口或者抽象基类</a></li><li><a href=#实现数据模型的类型约束>实现数据模型的类型约束</a><ul><li><a href=#描述符方式-1>描述符方式</a></li><li><a href=#类型检查类装饰器方式>类型检查类装饰器方式</a></li><li><a href=#类型检查元类方式>类型检查元类方式</a></li><li><a href=#类装饰器方式>类装饰器方式</a></li></ul></li><li><a href=#自定义容器>自定义容器</a></li><li><a href=#属性的代理访问>属性的代理访问</a><ul><li><a href=#代理类方式>代理类方式</a></li></ul></li><li><a href=#类中定义多个构造函数>类中定义多个构造函数</a></li><li><a href=#利用-mixins-扩展类功能>利用 Mixins 扩展类功能</a><ul><li><a href=#mixin>Mixin</a></li><li><a href=#类装饰器>类装饰器</a></li></ul></li><li><a href=#实现状态对象或者状态机state行为模式>实现状态对象或者状态机（State行为模式）</a></li><li><a href=#通过字符串调用对象方法反射自省>通过字符串调用对象方法（反射自省）</a></li><li><a href=#实现访问者模式>实现访问者模式</a><ul><li><a href=#访问者模式>访问者模式</a></li><li><a href=#将一个表达式转换成多个操作序列>将一个表达式转换成多个操作序列</a></li></ul></li><li><a href=#不用递归实现访问者模式>不用递归实现访问者模式</a></li><li><a href=#让类支持比较操作>让类支持比较操作</a></li><li><a href=#创建缓存实例>创建缓存实例</a><ul><li><a href=#应用缓存管理器>应用缓存管理器</a></li></ul></li></ul></li><li><a href=#元编程>元编程</a><ul><li><a href=#函数装饰器>函数装饰器</a></li><li><a href=#带参数装饰器>带参数装饰器</a></li><li><a href=#可自定义属性的装饰器>可自定义属性的装饰器</a></li><li><a href=#带可选参数的装饰器>带可选参数的装饰器</a></li><li><a href=#利用装饰器强制函数上的类型检查>利用装饰器强制函数上的类型检查</a></li><li><a href=#类内定义装饰器>类内定义装饰器</a></li><li><a href=#类作为装饰器>类作为装饰器</a><ul><li><a href=#闭包与-nonlocal-实现装饰器>闭包与 nonlocal 实现装饰器。</a></li></ul></li><li><a href=#类或静态方法提供装饰器>类或静态方法提供装饰器</a></li><li><a href=#装饰器为被包装函数增加参数>装饰器为被包装函数增加参数</a><ul><li><a href=#多个函数需要扩充参数>多个函数需要扩充参数</a></li></ul></li><li><a href=#使用装饰器扩充类的功能>使用装饰器扩充类的功能</a><ul><li><a href=#继承方式>继承方式</a></li><li><a href=#装饰器方式>装饰器方式</a></li></ul></li><li><a href=#使用元类控制实例的创建>使用元类控制实例的创建</a><ul><li><a href=#元类单例>元类单例</a></li><li><a href=#工厂实现单例模式>工厂实现单例模式</a></li><li><a href=#缓存实例>缓存实例</a></li></ul></li><li><a href=#捕获类的属性定义顺序>捕获类的属性定义顺序</a></li><li><a href=#定义有可选参数的元类>定义有可选参数的元类</a></li><li><a href=#args-和-kwargs-的强制参数签名>*args 和 **kwargs 的强制参数签名</a><ul><li><a href=#元类创建签名对象>元类创建签名对象</a></li></ul></li><li><a href=#在类上强制使用编程规约>在类上强制使用编程规约</a><ul><li><a href=#检测重载方法>检测重载方法</a></li></ul></li><li><a href=#以编程方式定义类>以编程方式定义类</a><ul><li><a href=#exec-方式实现-named-tuple>exec 方式实现 named tuple</a></li></ul></li><li><a href=#在定义的时候初始化类的成员>在定义的时候初始化类的成员</a></li><li><a href=#利用函数注解实现方法重载>利用函数注解实现方法重载</a><ul><li><a href=#元类方法>元类方法</a></li><li><a href=#描述器实现>描述器实现</a></li></ul></li><li><a href=#避免重复的属性方法>避免重复的属性方法</a></li><li><a href=#定义上下文管理器>定义上下文管理器</a><ul><li><a href=#实现了列表对象上的某种事务>实现了列表对象上的某种事务</a></li></ul></li><li><a href=#在局部变量域中执行代码>在局部变量域中执行代码</a></li><li><a href=#解析与分析python源码>解析与分析Python源码</a></li></ul></li><li><a href=#模块与包>模块与包</a><ul><li><a href=#构建一个模块的层级包>构建一个模块的层级包</a></li><li><a href=#控制模块被全部导入的内容>控制模块被全部导入的内容</a></li><li><a href=#使用相对路径名导入包中子模块>使用相对路径名导入包中子模块</a></li><li><a href=#将模块分割成多个文件>将模块分割成多个文件</a></li><li><a href=#利用命名空间导入目录分散的代码>利用命名空间导入目录分散的代码</a></li><li><a href=#重新加载模块>重新加载模块</a></li><li><a href=#读取位于包中的数据文件>读取位于包中的数据文件</a></li><li><a href=#将文件夹加入到syspath>将文件夹加入到sys.path</a></li><li><a href=#通过字符串名导入模块>通过字符串名导入模块</a></li><li><a href=#通过钩子远程加载模块>通过钩子远程加载模块</a></li></ul></li><li><a href=#网络与web编程>网络与Web编程</a><ul><li><a href=#作为客户端与http服务交互>作为客户端与HTTP服务交互</a></li><li><a href=#创建-tcp-服务器>创建 TCP 服务器</a><ul><li><a href=#并发-tcp-服务>并发 TCP 服务</a></li><li><a href=#端口复用>端口复用</a></li><li><a href=#socket-底层实现>socket 底层实现</a></li></ul></li><li><a href=#创建-udp-服务器>创建 UDP 服务器</a><ul><li><a href=#并发-udp-服务>并发 UDP 服务</a></li><li><a href=#socket-底层实现-1>socket 底层实现</a></li></ul></li><li><a href=#cidr地址生成对应的ip地址集>CIDR地址生成对应的IP地址集</a></li><li><a href=#创建一个简单的rest接口>创建一个简单的REST接口</a></li><li><a href=#通过-xml-rpc-实现简单的远程调用>通过 XML-RPC 实现简单的远程调用</a></li><li><a href=#在不同的python解释器之间交互>在不同的Python解释器之间交互</a></li><li><a href=#实现远程方法调用>实现远程方法调用</a><ul><li><a href=#服务端>服务端</a></li><li><a href=#客户端>客户端</a></li></ul></li><li><a href=#简单的客户端认证>简单的客户端认证</a></li><li><a href=#网络服务中加入-ssl>网络服务中加入 SSL</a><ul><li><a href=#mixin-类>mixin 类</a></li><li><a href=#ssl-xmlrpc>SSL XMLRPC</a></li><li><a href=#验证-xmlrpc-服务器证书>验证 XMLRPC 服务器证书</a></li></ul></li><li><a href=#进程间传递-socket-文件描述符>进程间传递 Socket 文件描述符</a></li><li><a href=#理解事件驱动io>理解事件驱动IO</a><ul><li><a href=#udp-网络服务>UDP 网络服务</a></li><li><a href=#tcp-网络服务>TCP 网络服务</a></li></ul></li><li><a href=#发送与接收大型数组>发送与接收大型数组</a></li></ul></li><li><a href=#并发编程>并发编程</a><ul><li><a href=#启动与停止线程>启动与停止线程</a></li><li><a href=#线程同步方式>线程同步方式</a><ul><li><a href=#condition>Condition</a></li><li><a href=#semaphore>Semaphore</a></li></ul></li><li><a href=#线程间通信>线程间通信</a><ul><li><a href=#condition-实现优先队列>Condition 实现优先队列</a></li></ul></li><li><a href=#线程锁>线程锁</a><ul><li><a href=#rlock>RLock</a></li></ul></li><li><a href=#防止死锁的加锁机制>防止死锁的加锁机制</a><ul><li><a href=#避免死锁>避免死锁</a></li></ul></li><li><a href=#保存线程的状态信息>保存线程的状态信息</a></li><li><a href=#线程池>线程池</a><ul><li><a href=#threadpoolexecutor-实现>ThreadPoolExecutor 实现</a></li><li><a href=#queue-实现>Queue 实现</a></li></ul></li><li><a href=#简单的并行编程>简单的并行编程</a><ul><li><a href=#pool-通用使用方式>pool 通用使用方式</a></li></ul></li><li><a href=#定义一个actor任务>定义一个Actor任务</a><ul><li><a href=#生成器方法>生成器方法</a></li><li><a href=#拓展>拓展</a></li></ul></li><li><a href=#实现消息发布订阅模型>实现消息发布/订阅模型</a><ul><li><a href=#交换机>交换机</a></li><li><a href=#交换机拓展上下文管理>交换机拓展上下文管理</a></li></ul></li><li><a href=#生成器代替线程>生成器代替线程</a><ul><li><a href=#任务调度器>任务调度器</a></li><li><a href=#生成器版-actor>生成器版 actor</a></li><li><a href=#生成器版并发网络程序>生成器版并发网络程序</a></li></ul></li><li><a href=#多个线程队列轮询>多个线程队列轮询</a></li><li><a href=#unix-系统上面启动守护进程>Unix 系统上面启动守护进程</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=cnewbie src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>cnewbie</p><div class=site-description itemprop=description>KISS</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>21</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>1</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>38</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/cnewbie title="Github → https://github.com/cnewbie" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://github.com/hugo-next/hugo-theme-next title=https://github.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2017-04-12T08:36:54+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=80008></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=172></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2024-07-31T08:00:00+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/cnewbie rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://cnewbie.github.io/posts/python-cookbook/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="cnewbie"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="cnewbie"><meta itemprop=description content="KISS"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Python Cookbook"><meta itemprop=description content="Python Cookbook"></span><header class=post-header><h1 class=post-title itemprop="name headline">Python Cookbook</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2019-05-05 08:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2019-05-05 08:00:00 +0800 CST">2019-05-05
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/tech itemprop=url rel=index><span itemprop=name>tech</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>38582</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>78分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/posts/python-cookbook/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h1 id=数据结构与算法>数据结构与算法
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e4%b8%8e%e7%ae%97%e6%b3%95></a></h1><h2 id=小顶堆>小顶堆
<a class=header-anchor href=#%e5%b0%8f%e9%a1%b6%e5%a0%86></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> heapq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nums <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>7</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>42</span>, <span style=color:#ae81ff>37</span>, <span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>heap <span style=color:#f92672>=</span> list(nums)
</span></span><span style=display:flex><span>heapq<span style=color:#f92672>.</span>heapify(heap)
</span></span><span style=display:flex><span>heap
</span></span><span style=display:flex><span><span style=color:#75715e># [-4, 2, 1, 23, 7, 2, 18, 23, 42, 37, 8]</span>
</span></span><span style=display:flex><span>print(heapq<span style=color:#f92672>.</span>nlargest(<span style=color:#ae81ff>3</span>, nums)) <span style=color:#75715e># Prints [42, 37, 23]</span>
</span></span><span style=display:flex><span>print(heapq<span style=color:#f92672>.</span>nsmallest(<span style=color:#ae81ff>3</span>, nums)) <span style=color:#75715e># Prints [-4, 1, 2]</span>
</span></span></code></pre></div><p><code>nlargest()</code> 和 <code>nsmallest()</code> 适合查找元素数量少的情况，如果查找数量较多，通常先排序后切片更快。<code>sorted(items)[:N]</code></p><h2 id=优先队列>优先队列
<a class=header-anchor href=#%e4%bc%98%e5%85%88%e9%98%9f%e5%88%97></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> heapq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PriorityQueue</span>(object):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_queue <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>push</span>(self, item, priority):
</span></span><span style=display:flex><span>        heapq<span style=color:#f92672>.</span>heappush(self<span style=color:#f92672>.</span>_queue, (<span style=color:#f92672>-</span>priority, self<span style=color:#f92672>.</span>_index, item))
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pop</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> heapq<span style=color:#f92672>.</span>heappop(self<span style=color:#f92672>.</span>_queue)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span></code></pre></div><p>heapq 是小顶堆，队列中包含 (-priority, index, item) 元组，优先级为负数的目的是使得元素按照优先级从高到低排序，index 变量的作用是保证同等优先级元素的正确排序。通过保存一个不断增加的 index 下标变量，可以确保元素按照它们插入的顺序排序。</p><h2 id=multidict-多值字典>multidict 多值字典
<a class=header-anchor href=#multidict-%e5%a4%9a%e5%80%bc%e5%ad%97%e5%85%b8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>d <span style=color:#f92672>=</span> defaultdict(set)
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;a&#39;</span>]<span style=color:#f92672>.</span>add(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;a&#39;</span>]<span style=color:#f92672>.</span>add(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;b&#39;</span>]<span style=color:#f92672>.</span>add(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 传统字典模拟</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>d <span style=color:#f92672>=</span> {} <span style=color:#75715e># 一个普通的字典</span>
</span></span><span style=display:flex><span>d<span style=color:#f92672>.</span>setdefault(<span style=color:#e6db74>&#39;a&#39;</span>, [])<span style=color:#f92672>.</span>append(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>d<span style=color:#f92672>.</span>setdefault(<span style=color:#e6db74>&#39;a&#39;</span>, [])<span style=color:#f92672>.</span>append(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>d<span style=color:#f92672>.</span>setdefault(<span style=color:#e6db74>&#39;b&#39;</span>, [])<span style=color:#f92672>.</span>append(<span style=color:#ae81ff>4</span>)
</span></span></code></pre></div><p>使用场景对于没有初值的字典进行操作，如统计列表中数字的个数，需要对未出现的值进行判断，多值字典默认具有初始化工厂获取初值，无需进行判断。</p><h2 id=ordereddict-排序字典>ordereddict 排序字典
<a class=header-anchor href=#ordereddict-%e6%8e%92%e5%ba%8f%e5%ad%97%e5%85%b8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> OrderedDict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>d <span style=color:#f92672>=</span> OrderedDict()
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;foo&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;bar&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;spam&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>d[<span style=color:#e6db74>&#39;grok&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> d:
</span></span><span style=display:flex><span>    print(key, d[key])
</span></span><span style=display:flex><span><span style=color:#75715e># Outputs &#34;foo 1&#34;, &#34;bar 2&#34;, &#34;spam 3&#34;, &#34;grok 4&#34;</span>
</span></span></code></pre></div><p>默认的字典中元素根据 hash 值进行排序，如果需要保留元素插入的顺序，使用 OrderedDict 是个很好的选择，排序字典内部维护着一个根据键插入顺序排序的双向链表，对已存在的键复制不会改变顺序，内存空间是原有字典的两倍。</p><h2 id=字典运算>字典运算
<a class=header-anchor href=#%e5%ad%97%e5%85%b8%e8%bf%90%e7%ae%97></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>prices <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;ACME&#39;</span>: <span style=color:#ae81ff>45.23</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;AAPL&#39;</span>: <span style=color:#ae81ff>612.78</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;IBM&#39;</span>: <span style=color:#ae81ff>205.55</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;HPQ&#39;</span>: <span style=color:#ae81ff>37.20</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;FB&#39;</span>: <span style=color:#ae81ff>10.75</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>min_price <span style=color:#f92672>=</span> min(zip(prices<span style=color:#f92672>.</span>values(), prices<span style=color:#f92672>.</span>keys()))
</span></span><span style=display:flex><span><span style=color:#75715e># min_price is (10.75, &#39;FB&#39;)</span>
</span></span><span style=display:flex><span>max_price <span style=color:#f92672>=</span> max(zip(prices<span style=color:#f92672>.</span>values(), prices<span style=color:#f92672>.</span>keys()))
</span></span><span style=display:flex><span><span style=color:#75715e># max_price is (612.78, &#39;AAPL&#39;)</span>
</span></span></code></pre></div><p>Note：通过 zip 获取最小值或最大值的键值对，需要注意的是在计算操作中使用到了 (值，键) 对。当多个实体拥有相同的值的时候，键会决定返回结果。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>prices <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#39;AAA&#39;</span> : <span style=color:#ae81ff>45.23</span>, <span style=color:#e6db74>&#39;ZZZ&#39;</span>: <span style=color:#ae81ff>45.23</span> }
</span></span><span style=display:flex><span>min(zip(prices<span style=color:#f92672>.</span>values(), prices<span style=color:#f92672>.</span>keys()))
</span></span><span style=display:flex><span><span style=color:#75715e># (45.23, &#39;AAA&#39;)</span>
</span></span><span style=display:flex><span>max(zip(prices<span style=color:#f92672>.</span>values(), prices<span style=color:#f92672>.</span>keys()))
</span></span><span style=display:flex><span><span style=color:#75715e># (45.23, &#39;ZZZ&#39;)</span>
</span></span></code></pre></div><h2 id=查找字典相同键值>查找字典相同键值
<a class=header-anchor href=#%e6%9f%a5%e6%89%be%e5%ad%97%e5%85%b8%e7%9b%b8%e5%90%8c%e9%94%ae%e5%80%bc></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>a <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;x&#39;</span> : <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;y&#39;</span> : <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;z&#39;</span> : <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;w&#39;</span> : <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;x&#39;</span> : <span style=color:#ae81ff>11</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;y&#39;</span> : <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find keys in common</span>
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>keys() <span style=color:#f92672>&amp;</span> b<span style=color:#f92672>.</span>keys() <span style=color:#75715e># { &#39;x&#39;, &#39;y&#39; }</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find keys in a that are not in b</span>
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>keys() <span style=color:#f92672>-</span> b<span style=color:#f92672>.</span>keys() <span style=color:#75715e># { &#39;z&#39; }</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find (key,value) pairs in common</span>
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>items() <span style=color:#f92672>&amp;</span> b<span style=color:#f92672>.</span>items() <span style=color:#75715e># { (&#39;y&#39;, 2) }</span>
</span></span></code></pre></div><p><strong>Note</strong></p><ul><li>字典是一个键集合与值集合的映射关系，字典的 <code>keys()</code> 方法返回一个展现键集合的键视图对象。键视图的一个很少被了解的特性就是它们也支持集合操作，比如集合并、交、差运算。</li><li>字典的 <code>items()</code> 方法返回一个包含 (键，值) 对的元素视图对象。这个对象同样也支持集合操作，并且可以被用来查找两个字典有哪些相同的键值对。</li><li>尽管字典的 <code>values()</code> 方法也是类似，但是它并<strong>不支持</strong>集合操作。</li></ul><h2 id=删除序列重复元素并保持顺序>删除序列重复元素并保持顺序
<a class=header-anchor href=#%e5%88%a0%e9%99%a4%e5%ba%8f%e5%88%97%e9%87%8d%e5%a4%8d%e5%85%83%e7%b4%a0%e5%b9%b6%e4%bf%9d%e6%8c%81%e9%a1%ba%e5%ba%8f></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dedupe</span>(items, key<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    seen <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> items:
</span></span><span style=display:flex><span>        val <span style=color:#f92672>=</span> item <span style=color:#66d9ef>if</span> key <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> key(item)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> val <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> seen:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> item
</span></span><span style=display:flex><span>            seen<span style=color:#f92672>.</span>add(val)
</span></span></code></pre></div><p>通过 key 参数指定函数，将序列元素如字典转换成 hashable 类型。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>a <span style=color:#f92672>=</span> [ {<span style=color:#e6db74>&#39;x&#39;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;y&#39;</span>:<span style=color:#ae81ff>2</span>}, {<span style=color:#e6db74>&#39;x&#39;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;y&#39;</span>:<span style=color:#ae81ff>3</span>}, {<span style=color:#e6db74>&#39;x&#39;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;y&#39;</span>:<span style=color:#ae81ff>2</span>}, {<span style=color:#e6db74>&#39;x&#39;</span>:<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;y&#39;</span>:<span style=color:#ae81ff>4</span>}]
</span></span><span style=display:flex><span>list(dedupe(a, key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> d: (d[<span style=color:#e6db74>&#39;x&#39;</span>],d[<span style=color:#e6db74>&#39;y&#39;</span>])))
</span></span><span style=display:flex><span><span style=color:#75715e># [{&#39;x&#39;: 1, &#39;y&#39;: 2}, {&#39;x&#39;: 1, &#39;y&#39;: 3}, {&#39;x&#39;: 2, &#39;y&#39;: 4}]</span>
</span></span><span style=display:flex><span>list(dedupe(a, key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> d: d[<span style=color:#e6db74>&#39;x&#39;</span>]))
</span></span><span style=display:flex><span><span style=color:#75715e># [{&#39;x&#39;: 1, &#39;y&#39;: 2}, {&#39;x&#39;: 2, &#39;y&#39;: 4}]</span>
</span></span></code></pre></div><h2 id=命名切片>命名切片
<a class=header-anchor href=#%e5%91%bd%e5%90%8d%e5%88%87%e7%89%87></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>items <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>]
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> slice(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>items[<span style=color:#ae81ff>2</span>:<span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># [2, 3]</span>
</span></span><span style=display:flex><span>items[a]
</span></span><span style=display:flex><span><span style=color:#75715e># [2, 3]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># indices 映射到指定大小的序列上</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> slice(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;HelloWorld&#39;</span>
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>indices(len(s))
</span></span><span style=display:flex><span><span style=color:#75715e># (5, 10, 2)</span>
</span></span></code></pre></div><h2 id=序列中出现次数最多的元素>序列中出现次数最多的元素
<a class=header-anchor href=#%e5%ba%8f%e5%88%97%e4%b8%ad%e5%87%ba%e7%8e%b0%e6%ac%a1%e6%95%b0%e6%9c%80%e5%a4%9a%e7%9a%84%e5%85%83%e7%b4%a0></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>words <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;look&#39;</span>, <span style=color:#e6db74>&#39;into&#39;</span>, <span style=color:#e6db74>&#39;my&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#39;look&#39;</span>, <span style=color:#e6db74>&#39;into&#39;</span>, <span style=color:#e6db74>&#39;my&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;the&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#39;the&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#39;the&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#39;not&#39;</span>, <span style=color:#e6db74>&#39;around&#39;</span>, <span style=color:#e6db74>&#39;the&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#34;don&#39;t&#34;</span>, <span style=color:#e6db74>&#39;look&#39;</span>, <span style=color:#e6db74>&#39;around&#39;</span>, <span style=color:#e6db74>&#39;the&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#39;look&#39;</span>, <span style=color:#e6db74>&#39;into&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;my&#39;</span>, <span style=color:#e6db74>&#39;eyes&#39;</span>, <span style=color:#e6db74>&#34;you&#39;re&#34;</span>, <span style=color:#e6db74>&#39;under&#39;</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> Counter
</span></span><span style=display:flex><span>word_counts <span style=color:#f92672>=</span> Counter(words)
</span></span><span style=display:flex><span><span style=color:#75715e># 出现频率最高的3个单词</span>
</span></span><span style=display:flex><span>top_three <span style=color:#f92672>=</span> word_counts<span style=color:#f92672>.</span>most_common(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>print(top_three)
</span></span><span style=display:flex><span><span style=color:#75715e># Outputs [(&#39;eyes&#39;, 8), (&#39;the&#39;, 5), (&#39;look&#39;, 4)]</span>
</span></span></code></pre></div><p>作为输入， Counter 对象可以接受任意的由可哈希（hashable）元素构成的序列对象。 在底层实现上，一个 Counter 对象就是一个字典，将元素映射到它出现的次数上。</p><p>Counter 实例一个鲜为人知的特性是它们可以很容易的跟数学运算操作相结合。Counter 对象在几乎所有需要<strong>制表或者计数数据</strong>的场合是非常有用的工具。</p><h2 id=字典排序>字典排序
<a class=header-anchor href=#%e5%ad%97%e5%85%b8%e6%8e%92%e5%ba%8f></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> operator <span style=color:#f92672>import</span> itemgetter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rows <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#39;fname&#39;</span>: <span style=color:#e6db74>&#39;Brian&#39;</span>, <span style=color:#e6db74>&#39;lname&#39;</span>: <span style=color:#e6db74>&#39;Jones&#39;</span>, <span style=color:#e6db74>&#39;uid&#39;</span>: <span style=color:#ae81ff>1003</span>},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#39;fname&#39;</span>: <span style=color:#e6db74>&#39;David&#39;</span>, <span style=color:#e6db74>&#39;lname&#39;</span>: <span style=color:#e6db74>&#39;Beazley&#39;</span>, <span style=color:#e6db74>&#39;uid&#39;</span>: <span style=color:#ae81ff>1002</span>},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#39;fname&#39;</span>: <span style=color:#e6db74>&#39;John&#39;</span>, <span style=color:#e6db74>&#39;lname&#39;</span>: <span style=color:#e6db74>&#39;Cleese&#39;</span>, <span style=color:#e6db74>&#39;uid&#39;</span>: <span style=color:#ae81ff>1001</span>},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#39;fname&#39;</span>: <span style=color:#e6db74>&#39;Big&#39;</span>, <span style=color:#e6db74>&#39;lname&#39;</span>: <span style=color:#e6db74>&#39;Jones&#39;</span>, <span style=color:#e6db74>&#39;uid&#39;</span>: <span style=color:#ae81ff>1004</span>}
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> operator <span style=color:#f92672>import</span> itemgetter
</span></span><span style=display:flex><span>rows_by_fname <span style=color:#f92672>=</span> sorted(rows, key<span style=color:#f92672>=</span>itemgetter(<span style=color:#e6db74>&#39;fname&#39;</span>))
</span></span><span style=display:flex><span>rows_by_uid <span style=color:#f92672>=</span> sorted(rows, key<span style=color:#f92672>=</span>itemgetter(<span style=color:#e6db74>&#39;uid&#39;</span>))
</span></span><span style=display:flex><span>print(rows_by_fname)
</span></span><span style=display:flex><span>print(rows_by_uid)
</span></span><span style=display:flex><span><span style=color:#75715e># [{&#39;fname&#39;: &#39;Big&#39;, &#39;uid&#39;: 1004, &#39;lname&#39;: &#39;Jones&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#39;fname&#39;: &#39;Brian&#39;, &#39;uid&#39;: 1003, &#39;lname&#39;: &#39;Jones&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#39;fname&#39;: &#39;David&#39;, &#39;uid&#39;: 1002, &#39;lname&#39;: &#39;Beazley&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#39;fname&#39;: &#39;John&#39;, &#39;uid&#39;: 1001, &#39;lname&#39;: &#39;Cleese&#39;}]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># [{&#39;fname&#39;: &#39;John&#39;, &#39;uid&#39;: 1001, &#39;lname&#39;: &#39;Cleese&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#39;fname&#39;: &#39;David&#39;, &#39;uid&#39;: 1002, &#39;lname&#39;: &#39;Beazley&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#39;fname&#39;: &#39;Brian&#39;, &#39;uid&#39;: 1003, &#39;lname&#39;: &#39;Jones&#39;},</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#39;fname&#39;: &#39;Big&#39;, &#39;uid&#39;: 1004, &#39;lname&#39;: &#39;Jones&#39;}]</span>
</span></span></code></pre></div><p><code>itemgetter()</code> 可多个键进行处理，比 key 指定的匿名函数的方式效率高。</p><h2 id=排序不支持比较的对象>排序不支持比较的对象
<a class=header-anchor href=#%e6%8e%92%e5%ba%8f%e4%b8%8d%e6%94%af%e6%8c%81%e6%af%94%e8%be%83%e7%9a%84%e5%af%b9%e8%b1%a1></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, user_id):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>user_id <span style=color:#f92672>=</span> user_id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;User(</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>user_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sort_notcompare</span>():
</span></span><span style=display:flex><span>    users <span style=color:#f92672>=</span> [User(<span style=color:#ae81ff>23</span>), User(<span style=color:#ae81ff>3</span>), User(<span style=color:#ae81ff>99</span>)]
</span></span><span style=display:flex><span>    print(users)
</span></span><span style=display:flex><span>    print(sorted(users, key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> u: u<span style=color:#f92672>.</span>user_id))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> operator <span style=color:#f92672>import</span> attrgetter
</span></span><span style=display:flex><span>sorted(users, key<span style=color:#f92672>=</span>attrgetter(<span style=color:#e6db74>&#39;user_id&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#75715e># [User(3), User(23), User(99)]</span>
</span></span></code></pre></div><h2 id=数据分组>数据分组
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e5%88%86%e7%bb%84></a></h2><p><code>itertools.groupby()</code> 函数对于这样的数据分组操作非常实用，指定字段排序后分组。<code>groupby()</code> 函数扫描整个序列并且查找<strong>连续相同值</strong>（或者根据指定 key 函数返回值相同）的元素序列。</p><p>一个非常重要的准备步骤是要根据指定的字段将数据排序。 因为 <code>groupby()</code> 仅仅<strong>检查连续的元素</strong>，如果事先并没有排序完成的话，分组函数将得不到想要的结果。</p><h2 id=过滤列表数据>过滤列表数据
<a class=header-anchor href=#%e8%bf%87%e6%bb%a4%e5%88%97%e8%a1%a8%e6%95%b0%e6%8d%ae></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>mylist <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># 列表推导</span>
</span></span><span style=display:flex><span>[n <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> mylist <span style=color:#66d9ef>if</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># [1, 4, 10, 2, 3]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成表达式</span>
</span></span><span style=display:flex><span>(n <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> mylist <span style=color:#66d9ef>if</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># filter() 函数</span>
</span></span><span style=display:flex><span>values <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;1&#39;</span>, <span style=color:#e6db74>&#39;2&#39;</span>, <span style=color:#e6db74>&#39;-3&#39;</span>, <span style=color:#e6db74>&#39;-&#39;</span>, <span style=color:#e6db74>&#39;4&#39;</span>, <span style=color:#e6db74>&#39;N/A&#39;</span>, <span style=color:#e6db74>&#39;5&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>is_int</span>(val):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> int(val)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ValueError</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>ivals <span style=color:#f92672>=</span> list(filter(is_int, values))
</span></span><span style=display:flex><span>print(ivals)
</span></span><span style=display:flex><span><span style=color:#75715e># Outputs [&#39;1&#39;, &#39;2&#39;, &#39;-3&#39;, &#39;4&#39;, &#39;5&#39;]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># compress() 函数</span>
</span></span><span style=display:flex><span>addresses <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;5412 N CLARK&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;5148 N CLARK&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;5800 E 58TH&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;2122 N CLARK&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;5645 N RAVENSWOOD&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;1060 W ADDISON&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;4801 N BROADWAY&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;1039 W GRANVILLE&#39;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>counts <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># 取出 count &gt; 5 的值</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> itertools <span style=color:#f92672>import</span> compress
</span></span><span style=display:flex><span>more5 <span style=color:#f92672>=</span> [n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span> <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> counts]
</span></span><span style=display:flex><span>more5
</span></span><span style=display:flex><span><span style=color:#75715e># [False, False, True, False, False, True, True, False]</span>
</span></span><span style=display:flex><span>list(compress(addresses, more5))
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;5800 E 58TH&#39;, &#39;1060 W ADDISON&#39;, &#39;4801 N BROADWAY&#39;]</span>
</span></span></code></pre></div><p>这里的关键点在于先创建一个 Boolean 序列，指示哪些元素符合条件。 然后 <code>compress()</code> 函数根据这个序列去选择输出对应位置为 True 的元素。</p><p>和 <code>filter()</code> 函数类似，<code>compress()</code> 也是返回的一个迭代器。因此，如果你需要得到一个列表， 那么你需要使用 <code>list()</code> 来将结果转换为列表类型。</p><h2 id=字典子集>字典子集
<a class=header-anchor href=#%e5%ad%97%e5%85%b8%e5%ad%90%e9%9b%86></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>prices <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;ACME&#39;</span>: <span style=color:#ae81ff>45.23</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;AAPL&#39;</span>: <span style=color:#ae81ff>612.78</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;IBM&#39;</span>: <span style=color:#ae81ff>205.55</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;HPQ&#39;</span>: <span style=color:#ae81ff>37.20</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;FB&#39;</span>: <span style=color:#ae81ff>10.75</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># Make a dictionary of all prices over 200</span>
</span></span><span style=display:flex><span>p1 <span style=color:#f92672>=</span> {key: value <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> prices<span style=color:#f92672>.</span>items() <span style=color:#66d9ef>if</span> value <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>200</span>}
</span></span><span style=display:flex><span><span style=color:#75715e># Make a dictionary of tech stocks</span>
</span></span><span style=display:flex><span>tech_names <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;AAPL&#39;</span>, <span style=color:#e6db74>&#39;IBM&#39;</span>, <span style=color:#e6db74>&#39;HPQ&#39;</span>, <span style=color:#e6db74>&#39;MSFT&#39;</span>}
</span></span><span style=display:flex><span>p2 <span style=color:#f92672>=</span> {key: value <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> prices<span style=color:#f92672>.</span>items() <span style=color:#66d9ef>if</span> key <span style=color:#f92672>in</span> tech_names}
</span></span><span style=display:flex><span>p2 <span style=color:#f92672>=</span> { key:prices[key] <span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> prices<span style=color:#f92672>.</span>keys() <span style=color:#f92672>&amp;</span> tech_names }
</span></span></code></pre></div><h2 id=映射名称到序列元素>映射名称到序列元素
<a class=header-anchor href=#%e6%98%a0%e5%b0%84%e5%90%8d%e7%a7%b0%e5%88%b0%e5%ba%8f%e5%88%97%e5%85%83%e7%b4%a0></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> namedtuple
</span></span><span style=display:flex><span>Subscriber <span style=color:#f92672>=</span> namedtuple(<span style=color:#e6db74>&#39;Subscriber&#39;</span>, [<span style=color:#e6db74>&#39;addr&#39;</span>, <span style=color:#e6db74>&#39;joined&#39;</span>])
</span></span><span style=display:flex><span>sub <span style=color:#f92672>=</span> Subscriber(<span style=color:#e6db74>&#39;jonesy@example.com&#39;</span>, <span style=color:#e6db74>&#39;2012-10-19&#39;</span>)
</span></span><span style=display:flex><span>sub
</span></span><span style=display:flex><span><span style=color:#75715e># Subscriber(addr=&#39;jonesy@example.com&#39;, joined=&#39;2012-10-19&#39;)</span>
</span></span><span style=display:flex><span>sub<span style=color:#f92672>.</span>addr
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;jonesy@example.com&#39;</span>
</span></span><span style=display:flex><span>sub<span style=color:#f92672>.</span>joined
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;2012-10-19&#39;</span>
</span></span><span style=display:flex><span>sub <span style=color:#f92672>=</span> sub<span style=color:#f92672>.</span>_replace(joined<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2017-10-19&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Subscriber(addr=&#39;jonesy@example.com&#39;, joined=&#39;2017-10-19&#39;)</span>
</span></span></code></pre></div><p>命名元组的一个主要用途是将你的代码从下标操作中解脱出来。命名元组另一个用途就是作为字典的替代，因为字典存储需要更多的内存空间。 如果你需要构建一个非常大的包含字典的数据结构，那么使用命名元组会更加高效。 但是需要注意的是，<strong>命名元组是不可更改的</strong>。</p><p>如果你真的需要改变属性的值，那么可以使用命名元组实例的 <code>_replace()</code> 方法， 它会创建一个全新的命名元组并将对应的字段用新的值取代。</p><h2 id=转化并计算数据>转化并计算数据
<a class=header-anchor href=#%e8%bd%ac%e5%8c%96%e5%b9%b6%e8%ae%a1%e7%ae%97%e6%95%b0%e6%8d%ae></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>s <span style=color:#f92672>=</span> sum((x <span style=color:#f92672>*</span> x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> nums)) <span style=color:#75715e># 显式的传递一个生成器表达式对象</span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> sum(x <span style=color:#f92672>*</span> x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> nums) <span style=color:#75715e># 更加优雅的实现方式，省略了括号</span>
</span></span></code></pre></div><h2 id=合并词典或映射>合并词典或映射
<a class=header-anchor href=#%e5%90%88%e5%b9%b6%e8%af%8d%e5%85%b8%e6%88%96%e6%98%a0%e5%b0%84></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> ChainMap
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> ChainMap(a,b)
</span></span><span style=display:flex><span>print(c[<span style=color:#e6db74>&#39;x&#39;</span>]) <span style=color:#75715e># Outputs 1 (from a)</span>
</span></span><span style=display:flex><span>print(c[<span style=color:#e6db74>&#39;y&#39;</span>]) <span style=color:#75715e># Outputs 2 (from b)</span>
</span></span><span style=display:flex><span>print(c[<span style=color:#e6db74>&#39;z&#39;</span>]) <span style=color:#75715e># Outputs 3 (from a)</span>
</span></span></code></pre></div><p>Note：对于字典的更新或删除操作总是影响的是列表中<strong>第一个字典</strong>。</p><p>作为 ChainMap 的替代，你可能会考虑使用 <code>update()</code> 方法将两个字典合并。它需要你创建一个完全不同的字典对象（或者是破坏现有字典结构）。 同时，如果原字典做了更新，这种改变不会反应到新的合并字典中去</p><h1 id=字符串和文本>字符串和文本
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%92%8c%e6%96%87%e6%9c%ac></a></h1><h2 id=多个界定符分割字符串>多个界定符分割字符串
<a class=header-anchor href=#%e5%a4%9a%e4%b8%aa%e7%95%8c%e5%ae%9a%e7%ac%a6%e5%88%86%e5%89%b2%e5%ad%97%e7%ac%a6%e4%b8%b2></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>line <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;asdf fjdk; afed, fjek,asdf, foo&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span>re<span style=color:#f92672>.</span>split(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;[;,\s]\s*&#39;</span>, line)
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;asdf&#39;, &#39;fjdk&#39;, &#39;afed&#39;, &#39;fjek&#39;, &#39;asdf&#39;, &#39;foo&#39;]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 包含分割字符串</span>
</span></span><span style=display:flex><span>fields <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>split(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(;|,|\s)\s*&#39;</span>, line)
</span></span><span style=display:flex><span>fields
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;asdf&#39;, &#39; &#39;, &#39;fjdk&#39;, &#39;;&#39;, &#39;afed&#39;, &#39;,&#39;, &#39;fjek&#39;, &#39;,&#39;, &#39;asdf&#39;, &#39;,&#39;, &#39;foo&#39;]</span>
</span></span><span style=display:flex><span>values <span style=color:#f92672>=</span> fields[::<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>delimiters <span style=color:#f92672>=</span> fields[<span style=color:#ae81ff>1</span>::<span style=color:#ae81ff>2</span>] <span style=color:#f92672>+</span> [<span style=color:#e6db74>&#39;&#39;</span>]
</span></span><span style=display:flex><span>values
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;asdf&#39;, &#39;fjdk&#39;, &#39;afed&#39;, &#39;fjek&#39;, &#39;asdf&#39;, &#39;foo&#39;]</span>
</span></span><span style=display:flex><span>delimiters
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39; &#39;, &#39;;&#39;, &#39;,&#39;, &#39;,&#39;, &#39;,&#39;, &#39;&#39;]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Reform the line using the same delimiters</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(v<span style=color:#f92672>+</span>d <span style=color:#66d9ef>for</span> v,d <span style=color:#f92672>in</span> zip(values, delimiters))
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;asdf fjdk;afed,fjek,asdf,foo&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 不想保留分割字符串，使用括号分组</span>
</span></span><span style=display:flex><span>re<span style=color:#f92672>.</span>split(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?:,|;|\s)\s*&#39;</span>, line)
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;asdf&#39;, &#39;fjdk&#39;, &#39;afed&#39;, &#39;fjek&#39;, &#39;asdf&#39;, &#39;foo&#39;]</span>
</span></span></code></pre></div><h2 id=shell-通配符匹配字符串>shell 通配符匹配字符串
<a class=header-anchor href=#shell-%e9%80%9a%e9%85%8d%e7%ac%a6%e5%8c%b9%e9%85%8d%e5%ad%97%e7%ac%a6%e4%b8%b2></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> fnmatch <span style=color:#f92672>import</span> fnmatch, fnmatchcase
</span></span><span style=display:flex><span>fnmatch(<span style=color:#e6db74>&#39;foo.txt&#39;</span>, <span style=color:#e6db74>&#39;*.txt&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>fnmatch(<span style=color:#e6db74>&#39;foo.txt&#39;</span>, <span style=color:#e6db74>&#39;?oo.txt&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>fnmatch(<span style=color:#e6db74>&#39;Dat45.csv&#39;</span>, <span style=color:#e6db74>&#39;Dat[0-9]*&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>names <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;Dat1.csv&#39;</span>, <span style=color:#e6db74>&#39;Dat2.csv&#39;</span>, <span style=color:#e6db74>&#39;config.ini&#39;</span>, <span style=color:#e6db74>&#39;foo.py&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># [name for name in names if fnmatch(name, &#39;Dat*.csv&#39;)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;Dat1.csv&#39;, &#39;Dat2.csv&#39;]</span>
</span></span></code></pre></div><h2 id=字符串匹配搜索>字符串匹配搜索
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%8c%b9%e9%85%8d%e6%90%9c%e7%b4%a2></a></h2><p>如果你想匹配的是字面字符串，那么你通常只需要调用基本字符串方法就行， 比如 <code>str.find()</code> , <code>str.endswith()</code>, <code>str.startswith()</code>。</p><p>对于复杂的匹配需要使用正则表达式和 re 模块。<code>match()</code> 总是从<strong>字符串开始</strong>去匹配，如果你想查找字符串任意部分的模式出现位置， 使用 <code>findall()</code> 方法去代替。</p><p><code>findall()</code> 方法会搜索文本并以列表形式返回所有的匹配。 如果你想以迭代方式返回匹配，可以使用 <code>finditer()</code> 方法来代替。</p><h2 id=字符串搜索替换>字符串搜索替换
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%90%9c%e7%b4%a2%e6%9b%bf%e6%8d%a2></a></h2><p>对于简单的字面模式，直接使用 <code>str.replace()</code> 方法，对于复杂的模式，请使用 re 模块中的 <code>sub()</code> 函数，<code>sub()</code> 函数中的第一个参数是被匹配的模式，第二个参数是替换模式。</p><p>如果除了替换后的结果外，你还想知道有多少替换发生了，可以使用 <code>re.subn()</code> 来代替。</p><h2 id=字符串忽略大小写的搜索替换>字符串忽略大小写的搜索替换
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%bf%bd%e7%95%a5%e5%a4%a7%e5%b0%8f%e5%86%99%e7%9a%84%e6%90%9c%e7%b4%a2%e6%9b%bf%e6%8d%a2></a></h2><p>为了在文本操作时忽略大小写，你需要在使用 re 模块的时候给这些操作提供 <code>re.IGNORECASE</code> 标志参数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;UPPER PYTHON, lower python, Mixed Python&#39;</span>
</span></span><span style=display:flex><span>re<span style=color:#f92672>.</span>findall(<span style=color:#e6db74>&#39;python&#39;</span>, text, flags<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>IGNORECASE)
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;PYTHON&#39;, &#39;python&#39;, &#39;Python&#39;]</span>
</span></span><span style=display:flex><span>re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>&#39;python&#39;</span>, <span style=color:#e6db74>&#39;snake&#39;</span>, text, flags<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>IGNORECASE)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;UPPER snake, lower snake, Mixed snake&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 替换字符串并不会自动跟被匹配字符串的大小写保持一致。 为了修复这个，你可能需要一个辅助函数</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>matchcase</span>(word):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>replace</span>(m):
</span></span><span style=display:flex><span>        text <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span>group()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> text<span style=color:#f92672>.</span>isupper():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> word<span style=color:#f92672>.</span>upper()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> text<span style=color:#f92672>.</span>islower():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> word<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> text[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>isupper():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> word<span style=color:#f92672>.</span>capitalize()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> word
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> replace
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>&#39;python&#39;</span>, matchcase(<span style=color:#e6db74>&#39;snake&#39;</span>), text, flags<span style=color:#f92672>=</span>re<span style=color:#f92672>.</span>IGNORECASE)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;UPPER SNAKE, lower snake, Mixed Snake&#39;</span>
</span></span></code></pre></div><h2 id=最短匹配模式>最短匹配模式
<a class=header-anchor href=#%e6%9c%80%e7%9f%ad%e5%8c%b9%e9%85%8d%e6%a8%a1%e5%bc%8f></a></h2><p>正则 <code>?</code> 非贪婪模式，模式中的*操作符后面加上?修饰符</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>str_pat <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;&#34;(.*?)&#34;&#39;</span>)
</span></span></code></pre></div><h2 id=多行匹配模式>多行匹配模式
<a class=header-anchor href=#%e5%a4%9a%e8%a1%8c%e5%8c%b9%e9%85%8d%e6%a8%a1%e5%bc%8f></a></h2><p>跨行匹配文本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>comment <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;/\*(.*?)\*/&#39;</span>)
</span></span><span style=display:flex><span>text1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/* this is a comment */&#39;</span>
</span></span><span style=display:flex><span>text2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;/* this is a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>multiline comment */
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>comment<span style=color:#f92672>.</span>findall(text1)
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39; this is a comment &#39;]</span>
</span></span><span style=display:flex><span>comment<span style=color:#f92672>.</span>findall(text2)
</span></span><span style=display:flex><span><span style=color:#75715e># []</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>为了修正这个问题<span style=color:#960050;background-color:#1e0010>，</span>你可以修改模式字符串<span style=color:#960050;background-color:#1e0010>，</span>增加对换行的支持<span style=color:#960050;background-color:#1e0010>。</span>比如<span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>comment <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;/\*((?:.|\n)*?)\*/&#39;</span>)
</span></span><span style=display:flex><span>comment<span style=color:#f92672>.</span>findall(text2)
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39; this is a\n multiline comment &#39;]</span>
</span></span></code></pre></div><p>在这个模式中， <code>(?:.|\n)</code> 指定了一个非捕获组 (也就是它定义了一个仅仅用来做匹配，而不能通过单独捕获或者编号的组)。</p><p><code>re.compile()</code> 函数接受一个标志参数叫 re.DOTALL ，在这里非常有用。 它可以让正则表达式中的点(.)匹配包括换行符在内的任意字符。</p><h2 id=unicode文本标准化>Unicode文本标准化
<a class=header-anchor href=#unicode%e6%96%87%e6%9c%ac%e6%a0%87%e5%87%86%e5%8c%96></a></h2><p>使用 unicodedata 模块先将文本标准化</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> unicodedata
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> t1 <span style=color:#f92672>=</span> unicodedata<span style=color:#f92672>.</span>normalize(<span style=color:#e6db74>&#39;NFC&#39;</span>, s1)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> t2 <span style=color:#f92672>=</span> unicodedata<span style=color:#f92672>.</span>normalize(<span style=color:#e6db74>&#39;NFC&#39;</span>, s2)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> t1 <span style=color:#f92672>==</span> t2
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(ascii(t1))
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;Spicy Jalape</span><span style=color:#ae81ff>\xf1</span><span style=color:#e6db74>o&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> t3 <span style=color:#f92672>=</span> unicodedata<span style=color:#f92672>.</span>normalize(<span style=color:#e6db74>&#39;NFD&#39;</span>, s1)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> t4 <span style=color:#f92672>=</span> unicodedata<span style=color:#f92672>.</span>normalize(<span style=color:#e6db74>&#39;NFD&#39;</span>, s2)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> t3 <span style=color:#f92672>==</span> t4
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(ascii(t3))
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;Spicy Jalapen</span><span style=color:#ae81ff>\u0303</span><span style=color:#e6db74>o&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><h2 id=删除不需要的字符>删除不需要的字符
<a class=header-anchor href=#%e5%88%a0%e9%99%a4%e4%b8%8d%e9%9c%80%e8%a6%81%e7%9a%84%e5%ad%97%e7%ac%a6></a></h2><p><code>strip()</code> 方法能用于删除开始或结尾的字符。 <code>lstrip()</code> 和 <code>rstrip()</code> 分别从左和从右执行删除操作。但是需要注意的是去除操作不会对字符串的中间的文本产生任何影响。</p><h2 id=审查字符>审查字符
<a class=header-anchor href=#%e5%ae%a1%e6%9f%a5%e5%ad%97%e7%ac%a6></a></h2><p>第一步是清理空白字符。为了这样做，先创建一个小的转换表格然后使用 <code>translate()</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pýtĥöñ</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>is</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>awesome</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>remap <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>ord(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#39;</span>) : <span style=color:#e6db74>&#39; &#39;</span>,
</span></span><span style=display:flex><span>ord(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>&#39;</span>) : <span style=color:#e6db74>&#39; &#39;</span>,
</span></span><span style=display:flex><span>ord(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#39;</span>) : <span style=color:#66d9ef>None</span> <span style=color:#75715e># Deleted</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>translate(remap)
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;pýtĥöñ is awesome\n&#39;</span>
</span></span></code></pre></div><p>对于简单的替换操作， <code>str.replace()</code> 方法通常是最快的,如果你需要执行任何复杂字符对字符的重新映射或者删除操作的话， <code>tanslate()</code> 方法会非常的快。</p><h2 id=字符串对齐>字符串对齐
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%af%b9%e9%bd%90></a></h2><p>对于基本的字符串对齐操作，可以使用字符串的 <code>ljust()</code> , <code>rjust()</code> 和 <code>center()</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello World&#39;</span>
</span></span><span style=display:flex><span>text<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Hello World         &#39;</span>
</span></span><span style=display:flex><span>text<span style=color:#f92672>.</span>rjust(<span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;         Hello World&#39;</span>
</span></span><span style=display:flex><span>text<span style=color:#f92672>.</span>center(<span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;    Hello World     &#39;</span>
</span></span></code></pre></div><p>函数 <code>format()</code> 同样可以用来很容易的对齐字符串。 你要做的就是使用 &lt;,> 或者 ^ 字符后面紧跟一个指定的宽度。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>format(text, <span style=color:#e6db74>&#39;&gt;20&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;         Hello World&#39;</span>
</span></span><span style=display:flex><span>format(text, <span style=color:#e6db74>&#39;&lt;20&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Hello World         &#39;</span>
</span></span><span style=display:flex><span>format(text, <span style=color:#e6db74>&#39;^20&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;    Hello World     &#39;</span>
</span></span></code></pre></div><h2 id=合并拼接字符串>合并拼接字符串
<a class=header-anchor href=#%e5%90%88%e5%b9%b6%e6%8b%bc%e6%8e%a5%e5%ad%97%e7%ac%a6%e4%b8%b2></a></h2><p>如果你想要合并的字符串是在一个序列或者 iterable 中，那么最快的方式就是使用 <code>join()</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>parts <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;Is&#39;</span>, <span style=color:#e6db74>&#39;Chicago&#39;</span>, <span style=color:#e6db74>&#39;Not&#39;</span>, <span style=color:#e6db74>&#39;Chicago?&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(parts)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Is Chicago Not Chicago?&#39;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>.</span>join(parts)
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Is,Chicago,Not,Chicago?&#39;</span>
</span></span></code></pre></div><p>初看起来，这种语法看上去会比较怪，但是 <code>join()</code> 被指定为字符串的一个方法。 这样做的部分原因是你想去连接的对象可能来自各种不同的数据序列(比如列表，元组，字典，文件，集合或生成器等)， 如果在所有这些对象上都定义一个 <code>join()</code> 方法明显是冗余的。 因此你只需要指定你想要的分割字符串并调用他的 <code>join()</code> 方法去将文本片段组合起来。</p><p>最重要的需要引起注意的是，当我们使用加号(+)操作符去连接大量的字符串的时候是非常低效率的， 因为加号连接会引起内存复制以及垃圾回收操作。</p><h2 id=字符串中插入变量>字符串中插入变量
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e4%b8%ad%e6%8f%92%e5%85%a5%e5%8f%98%e9%87%8f></a></h2><p>Python并没有对在字符串中简单替换变量值提供直接的支持。 但是通过使用字符串的 <code>format()</code> 方法来解决这个问题。</p><p><code>format()</code> 和 <code>format_map()</code> 的一个缺陷就是它们并不能很好的处理变量缺失的情况。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># format_map</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>format_map(vars())
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Guido has 37 messages.&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%(name) ha</span><span style=color:#e6db74>s %(n) messages.&#39;</span> <span style=color:#f92672>%</span> vars()
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Guido has 37 messages.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># string template</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> string
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> string<span style=color:#f92672>.</span>Template(<span style=color:#e6db74>&#39;$name has $n messages.&#39;</span>)
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>substitute(vars())
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Guido has 37 messages.&#39;</span>
</span></span></code></pre></div><p><code>format()</code> 和 <code>format_map()</code> 相比较 Template 方案而已更加先进，因此应该被优先选择。 使用 <code>format() </code>方法还有一个好处就是你可以获得对字符串格式化的所有支持(对齐，填充，数字格式化等待)， 而这些特性是使用像模板字符串之类的方案不可能获得的。</p><h2 id=指定列宽格式化字符串>指定列宽格式化字符串
<a class=header-anchor href=#%e6%8c%87%e5%ae%9a%e5%88%97%e5%ae%bd%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%ad%97%e7%ac%a6%e4%b8%b2></a></h2><p>想以指定的列宽将它们重新格式化,使用 textwrap 模块来格式化字符串的输出。</p><h2 id=字符串令牌解析>字符串令牌解析
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e4%bb%a4%e7%89%8c%e8%a7%a3%e6%9e%90></a></h2><p>你有一个字符串，想从左至右将其解析为一个令牌流。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;foo = 23 + 42 * 10&#39;</span>
</span></span><span style=display:flex><span>tokens <span style=color:#f92672>=</span> [(<span style=color:#e6db74>&#39;NAME&#39;</span>, <span style=color:#e6db74>&#39;foo&#39;</span>), (<span style=color:#e6db74>&#39;EQ&#39;</span>,<span style=color:#e6db74>&#39;=&#39;</span>), (<span style=color:#e6db74>&#39;NUM&#39;</span>, <span style=color:#e6db74>&#39;23&#39;</span>), (<span style=color:#e6db74>&#39;PLUS&#39;</span>,<span style=color:#e6db74>&#39;+&#39;</span>),
</span></span><span style=display:flex><span>          (<span style=color:#e6db74>&#39;NUM&#39;</span>, <span style=color:#e6db74>&#39;42&#39;</span>), (<span style=color:#e6db74>&#39;TIMES&#39;</span>, <span style=color:#e6db74>&#39;*&#39;</span>), (<span style=color:#e6db74>&#39;NUM&#39;</span>, <span style=color:#e6db74>&#39;10&#39;</span>)]
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span>NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?P&lt;NAME&gt;[a-zA-Z_][a-zA-Z_0-9]*)&#39;</span>
</span></span><span style=display:flex><span>NUM <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?P&lt;NUM&gt;\d+)&#39;</span>
</span></span><span style=display:flex><span>PLUS <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?P&lt;PLUS&gt;\+)&#39;</span>
</span></span><span style=display:flex><span>TIMES <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?P&lt;TIMES&gt;\*)&#39;</span>
</span></span><span style=display:flex><span>EQ <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?P&lt;EQ&gt;=)&#39;</span>
</span></span><span style=display:flex><span>WS <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(?P&lt;WS&gt;\s+)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>master_pat <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>&#39;|&#39;</span><span style=color:#f92672>.</span>join([NAME, NUM, PLUS, TIMES, EQ, WS]))
</span></span></code></pre></div><p>在上面的模式中， <code>?P&lt;TOKENNAME></code> 用于给一个模式命名，供后面使用。</p><p>为了令牌化，使用模式对象很少被人知道的 <code>scanner()</code> 方法。 这个方法会创建一个 scanner 对象， 在这个对象上不断的调用 <code>match()</code> 方法会一步步的扫描目标文本，每步一个匹配。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_tokens</span>(pat, text):
</span></span><span style=display:flex><span>    Token <span style=color:#f92672>=</span> namedtuple(<span style=color:#e6db74>&#39;Token&#39;</span>, [<span style=color:#e6db74>&#39;type&#39;</span>, <span style=color:#e6db74>&#39;value&#39;</span>])
</span></span><span style=display:flex><span>    scanner <span style=color:#f92672>=</span> pat<span style=color:#f92672>.</span>scanner(text)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> m <span style=color:#f92672>in</span> iter(scanner<span style=color:#f92672>.</span><span style=color:#66d9ef>match</span>, <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> Token(m<span style=color:#f92672>.</span>lastgroup, m<span style=color:#f92672>.</span>group())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> tok <span style=color:#f92672>in</span> generate_tokens(master_pat, <span style=color:#e6db74>&#39;foo = 42&#39;</span>):
</span></span><span style=display:flex><span>    print(tok)
</span></span><span style=display:flex><span><span style=color:#75715e># Produces output</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Token(type=&#39;NAME&#39;, value=&#39;foo&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Token(type=&#39;WS&#39;, value=&#39; &#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Token(type=&#39;EQ&#39;, value=&#39;=&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Token(type=&#39;WS&#39;, value=&#39; &#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Token(type=&#39;NUM&#39;, value=&#39;42&#39;)</span>
</span></span></code></pre></div><p>Note</p><ul><li>正则表达式指定了所有输入中可能出现的文本序列</li><li>长模式写在前面</li></ul><p><a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c02/p18_tokenizing_text.html title=令牌字符串解析 rel="noopener external nofollow noreferrer" target=_blank class=exturl>令牌字符串解析
<i class="fa fa-external-link-alt"></i></a></p><h2 id=递归下降分析器>递归下降分析器
<a class=header-anchor href=#%e9%80%92%e5%bd%92%e4%b8%8b%e9%99%8d%e5%88%86%e6%9e%90%e5%99%a8></a></h2><p>根据一组语法规则解析文本并执行命令，或者构造一个代表输入的抽象语法树。</p><p>// TODO 编译原理</p><p><a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c02/p19_writing_recursive_descent_parser.html title=递归下降解析 rel="noopener external nofollow noreferrer" target=_blank class=exturl>递归下降解析
<i class="fa fa-external-link-alt"></i></a></p><h1 id=数字日期与时间>数字日期与时间
<a class=header-anchor href=#%e6%95%b0%e5%ad%97%e6%97%a5%e6%9c%9f%e4%b8%8e%e6%97%b6%e9%97%b4></a></h1><h2 id=数字四舍五入>数字四舍五入
<a class=header-anchor href=#%e6%95%b0%e5%ad%97%e5%9b%9b%e8%88%8d%e4%ba%94%e5%85%a5></a></h2><p><code>round(value, ndigits)</code> 函数。</p><p><strong>Note</strong> 当一个值刚好在两个边界的中间的时候， <code>round</code> 函数返回离它最近的偶数。 也就是说，对1.5或者2.5的舍入运算都会得到2。</p><h2 id=精确浮点数计算>精确浮点数计算
<a class=header-anchor href=#%e7%b2%be%e7%a1%ae%e6%b5%ae%e7%82%b9%e6%95%b0%e8%ae%a1%e7%ae%97></a></h2><p>decimal 模块的一个主要特征是允许你控制计算的每一方面，包括数字位数和四舍五入运算。decimal 模块主要用在涉及到金融的领域。</p><h2 id=数字的格式化输出>数字的格式化输出
<a class=header-anchor href=#%e6%95%b0%e5%ad%97%e7%9a%84%e6%a0%bc%e5%bc%8f%e5%8c%96%e8%be%93%e5%87%ba></a></h2><p>格式化输出单个数字的时候，可以使用内置的 format() 函数，指定宽度和精度的一般形式是 <code>[&lt;>^]?width[,]?(.digits)?</code> ， 其中 width 和 digits 为整数，？代表可选部分。同样的格式也被用在字符串的 <code>format()</code> 方法中。</p><h2 id=进制整数>进制整数
<a class=header-anchor href=#%e8%bf%9b%e5%88%b6%e6%95%b4%e6%95%b0></a></h2><p>为了将整数转换为二进制、八进制或十六进制的文本串， 可以分别使用 <code>bin()</code> , <code>oct()</code> 或 <code>hex()</code> 函数，如果不想输出 0b , 0o 或者 0x 的前缀的话，可以使用 <code>format()</code> 函数。</p><h2 id=字节到大整数的打包与解包>字节到大整数的打包与解包
<a class=header-anchor href=#%e5%ad%97%e8%8a%82%e5%88%b0%e5%a4%a7%e6%95%b4%e6%95%b0%e7%9a%84%e6%89%93%e5%8c%85%e4%b8%8e%e8%a7%a3%e5%8c%85></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>data <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00\x12</span><span style=color:#e6db74>4V</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>x</span><span style=color:#ae81ff>\x90\xab\x00\xcd\xef\x01\x00</span><span style=color:#e6db74>#</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>4&#39;</span>
</span></span><span style=display:flex><span>len(data)
</span></span><span style=display:flex><span><span style=color:#75715e># 16</span>
</span></span><span style=display:flex><span><span style=color:#75715e># bytes 解析为整数</span>
</span></span><span style=display:flex><span>int<span style=color:#f92672>.</span>from_bytes(data, <span style=color:#e6db74>&#39;little&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 69120565665751139577663547927094891008</span>
</span></span><span style=display:flex><span>int<span style=color:#f92672>.</span>from_bytes(data, <span style=color:#e6db74>&#39;big&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 94522842520747284487117727783387188</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 整数转换为 bytes</span>
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>94522842520747284487117727783387188</span>
</span></span><span style=display:flex><span>x<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>16</span>, <span style=color:#e6db74>&#39;big&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;\x00\x124V\x00x\x90\xab\x00\xcd\xef\x01\x00#\x004&#39;</span>
</span></span><span style=display:flex><span>x<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>16</span>, <span style=color:#e6db74>&#39;little&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;4\x00#\x00\x01\xef\xcd\x00\xab\x90x\x00V4\x12\x00&#39;</span>
</span></span></code></pre></div><h2 id=复数运算>复数运算
<a class=header-anchor href=#%e5%a4%8d%e6%95%b0%e8%bf%90%e7%ae%97></a></h2><p>复数可以用使用函数 <code>complex(real, imag)</code> 或者是带有后缀j的浮点数来指定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>a <span style=color:#f92672>=</span> complex(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>j
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#75715e># (2+4j)</span>
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span><span style=color:#75715e># (3-5j)</span>
</span></span></code></pre></div><p>如果要执行其他的复数函数比如正弦、余弦或平方根，使用 cmath 模块。</p><h2 id=无穷大与-nan>无穷大与 NaN
<a class=header-anchor href=#%e6%97%a0%e7%a9%b7%e5%a4%a7%e4%b8%8e-nan></a></h2><p>Python并没有特殊的语法来表示这些特殊的浮点值，但是可以使用 float() 来创建它们。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>a <span style=color:#f92672>=</span> float(<span style=color:#e6db74>&#39;inf&#39;</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> float(<span style=color:#e6db74>&#39;-inf&#39;</span>)
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> float(<span style=color:#e6db74>&#39;nan&#39;</span>)
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#75715e># inf</span>
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span><span style=color:#75715e># -inf</span>
</span></span><span style=display:flex><span>c
</span></span><span style=display:flex><span><span style=color:#75715e># nan</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试值</span>
</span></span><span style=display:flex><span>math<span style=color:#f92672>.</span>isinf(a)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>math<span style=color:#f92672>.</span>isnan(c)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span></code></pre></div><p><strong>Note</strong></p><ul><li>无穷大数在执行数学计算的时候会传播</li><li>有些操作时未定义的并会返回一个 NaN 结果</li><li>NaN 值会在所有操作中传播，而不会产生异常</li><li>NaN 值的一个特别的地方时，它们之间的比较操作总是返回 False</li></ul><h2 id=分数计算>分数计算
<a class=header-anchor href=#%e5%88%86%e6%95%b0%e8%ae%a1%e7%ae%97></a></h2><p>fractions 模块可以被用来执行包含分数的数学运算。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> fractions <span style=color:#f92672>import</span> Fraction
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> Fraction(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> Fraction(<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>print(a <span style=color:#f92672>+</span> b)
</span></span><span style=display:flex><span><span style=color:#75715e># 27/16</span>
</span></span><span style=display:flex><span>print(a <span style=color:#f92672>*</span> b)
</span></span><span style=display:flex><span><span style=color:#75715e># 35/64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Getting numerator/denominator</span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> a <span style=color:#f92672>*</span> b
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>numerator
</span></span><span style=display:flex><span><span style=color:#75715e># 35</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>denominator
</span></span><span style=display:flex><span><span style=color:#75715e># 64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Converting to a float</span>
</span></span><span style=display:flex><span>float(c)
</span></span><span style=display:flex><span><span style=color:#75715e># 0.546875</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Limiting the denominator of a value</span>
</span></span><span style=display:flex><span>print(c<span style=color:#f92672>.</span>limit_denominator(<span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span><span style=color:#75715e># 4/7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Converting a float to a fraction</span>
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.75</span>
</span></span><span style=display:flex><span>y <span style=color:#f92672>=</span> Fraction(<span style=color:#f92672>*</span>x<span style=color:#f92672>.</span>as_integer_ratio())
</span></span><span style=display:flex><span>y
</span></span><span style=display:flex><span><span style=color:#75715e># Fraction(15, 4)</span>
</span></span></code></pre></div><h2 id=numpy-模块>Numpy 模块
<a class=header-anchor href=#numpy-%e6%a8%a1%e5%9d%97></a></h2><p>// TODO</p><h2 id=随机选择>随机选择
<a class=header-anchor href=#%e9%9a%8f%e6%9c%ba%e9%80%89%e6%8b%a9></a></h2><p>random 模块有大量的函数用来产生随机数和随机选择元素。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span>values <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>]
</span></span><span style=display:flex><span>random<span style=color:#f92672>.</span>choice(values)
</span></span><span style=display:flex><span><span style=color:#75715e># 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 随机抽取 n 个样本</span>
</span></span><span style=display:flex><span>random<span style=color:#f92672>.</span>sample(values, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># [6, 2]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 打乱顺序</span>
</span></span><span style=display:flex><span>random<span style=color:#f92672>.</span>shuffle(values)
</span></span><span style=display:flex><span><span style=color:#75715e># [2, 4, 6, 5, 3, 1]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成随机数</span>
</span></span><span style=display:flex><span>random<span style=color:#f92672>.</span>randint(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成0到1范围内均匀分布的浮点数</span>
</span></span><span style=display:flex><span>random<span style=color:#f92672>.</span>random()
</span></span><span style=display:flex><span><span style=color:#75715e># 0.9406677561675867</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取N位随机位(二进制)的整数</span>
</span></span><span style=display:flex><span>random<span style=color:#f92672>.</span>getrandbits(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 335837000776573622800628485064121869519521710558559406913275</span>
</span></span></code></pre></div><p>random 模块使用 <strong>Mersenne Twister</strong> 算法来计算生成随机数。</p><h2 id=计算最后一个周五的日期>计算最后一个周五的日期
<a class=header-anchor href=#%e8%ae%a1%e7%ae%97%e6%9c%80%e5%90%8e%e4%b8%80%e4%b8%aa%e5%91%a8%e4%ba%94%e7%9a%84%e6%97%a5%e6%9c%9f></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- encoding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Topic: 最后的周五
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime, timedelta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>weekdays <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;Monday&#39;</span>, <span style=color:#e6db74>&#39;Tuesday&#39;</span>, <span style=color:#e6db74>&#39;Wednesday&#39;</span>, <span style=color:#e6db74>&#39;Thursday&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Friday&#39;</span>, <span style=color:#e6db74>&#39;Saturday&#39;</span>, <span style=color:#e6db74>&#39;Sunday&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_previous_by_day</span>(dayname, start_date<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> start_date <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        start_date <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>today()
</span></span><span style=display:flex><span>    day_num <span style=color:#f92672>=</span> start_date<span style=color:#f92672>.</span>weekday()
</span></span><span style=display:flex><span>    day_num_target <span style=color:#f92672>=</span> weekdays<span style=color:#f92672>.</span>index(dayname)
</span></span><span style=display:flex><span>    days_ago <span style=color:#f92672>=</span> (<span style=color:#ae81ff>7</span> <span style=color:#f92672>+</span> day_num <span style=color:#f92672>-</span> day_num_target) <span style=color:#f92672>%</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> days_ago <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        days_ago <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>    target_date <span style=color:#f92672>=</span> start_date <span style=color:#f92672>-</span> timedelta(days<span style=color:#f92672>=</span>days_ago)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> target_date
</span></span></code></pre></div><p>上面的算法原理是这样的：先将开始日期和目标日期映射到星期数组的位置上(星期一索引为0)， 然后通过模运算计算出目标日期要经过多少天才能到达开始日期。然后用开始日期减去那个时间差即得到结果日期。</p><h2 id=计算当前月份的日期范围>计算当前月份的日期范围
<a class=header-anchor href=#%e8%ae%a1%e7%ae%97%e5%bd%93%e5%89%8d%e6%9c%88%e4%bb%bd%e7%9a%84%e6%97%a5%e6%9c%9f%e8%8c%83%e5%9b%b4></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime, date, timedelta
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> calendar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_month_range</span>(start_date<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> start_date <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        start_date <span style=color:#f92672>=</span> date<span style=color:#f92672>.</span>today()<span style=color:#f92672>.</span>replace(day<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    _, days_in_month <span style=color:#f92672>=</span> calendar<span style=color:#f92672>.</span>monthrange(start_date<span style=color:#f92672>.</span>year, start_date<span style=color:#f92672>.</span>month)
</span></span><span style=display:flex><span>    end_date <span style=color:#f92672>=</span> start_date <span style=color:#f92672>+</span> timedelta(days<span style=color:#f92672>=</span>days_in_month)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (start_date, end_date)
</span></span></code></pre></div><p>计算出一个对应月份第一天的日期，使用 date 或 datetime 对象的 <code>replace()</code> 方法简单的将 days 属性设置成1即可。 <code>replace()</code> 方法一个好处就是它会创建和你开传入对象类型相同的对象。</p><h2 id=字符串转换为日期>字符串转换为日期
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e8%bd%ac%e6%8d%a2%e4%b8%ba%e6%97%a5%e6%9c%9f></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;2012-09-20&#39;</span>
</span></span><span style=display:flex><span>y <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>strptime(text, <span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>z <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>diff <span style=color:#f92672>=</span> z <span style=color:#f92672>-</span> y
</span></span><span style=display:flex><span>diff
</span></span><span style=display:flex><span>datetime<span style=color:#f92672>.</span>timedelta(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>77824</span>, <span style=color:#ae81ff>177393</span>)
</span></span></code></pre></div><p><strong>Note</strong> <code>strptime()</code> 的性能要比你想象中的差很多， 因为它是使用纯Python实现，并且必须处理所有的系统本地设置。如果你要在代码中需要解析大量的日期并且已经知道了日期字符串的确切格式，可以自己实现一套解析方案来获取更好的性能。</p><h1 id=迭代器与生成器>迭代器与生成器
<a class=header-anchor href=#%e8%bf%ad%e4%bb%a3%e5%99%a8%e4%b8%8e%e7%94%9f%e6%88%90%e5%99%a8></a></h1><h2 id=手动遍历迭代器>手动遍历迭代器
<a class=header-anchor href=#%e6%89%8b%e5%8a%a8%e9%81%8d%e5%8e%86%e8%bf%ad%e4%bb%a3%e5%99%a8></a></h2><p>为了手动的遍历可迭代对象，使用 <code>next()</code> 函数并在代码中捕获 StopIteration 异常。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>manual_iter</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;/etc/passwd&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>                line <span style=color:#f92672>=</span> next(f)
</span></span><span style=display:flex><span>                print(line, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>通常来讲， StopIteration 用来指示迭代的结尾。</p><h2 id=代理迭代>代理迭代
<a class=header-anchor href=#%e4%bb%a3%e7%90%86%e8%bf%ad%e4%bb%a3></a></h2><p>需要定义一个 <code>__iter__()</code> 方法，将迭代操作代理到容器内部的对象上去。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_value <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Node(</span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>_value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_child</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children<span style=color:#f92672>.</span>append(node)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __iter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> iter(self<span style=color:#f92672>.</span>_children)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    root <span style=color:#f92672>=</span> Node(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    child1 <span style=color:#f92672>=</span> Node(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    child2 <span style=color:#f92672>=</span> Node(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    root<span style=color:#f92672>.</span>add_child(child1)
</span></span><span style=display:flex><span>    root<span style=color:#f92672>.</span>add_child(child2)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Outputs Node(1), Node(2)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ch <span style=color:#f92672>in</span> root:
</span></span><span style=display:flex><span>        print(ch)
</span></span></code></pre></div><p>Python的迭代器协议需要 <code>__iter__()</code> 方法返回一个实现了 <code>__next__()</code> 方法的迭代器对象。</p><p>这里的 <code>iter()</code> 函数的使用简化了代码， <code>iter(s)</code> 只是简单的通过调用 <code>s.__iter__()</code> 方法来返回对应的迭代器对象， 就跟 <code>len(s)</code> 会调用 <code>s.__len__()</code> 原理是一样的。</p><h2 id=使用生成器创建新的迭代模式>使用生成器创建新的迭代模式
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e7%94%9f%e6%88%90%e5%99%a8%e5%88%9b%e5%bb%ba%e6%96%b0%e7%9a%84%e8%bf%ad%e4%bb%a3%e6%a8%a1%e5%bc%8f></a></h2><p>如果你想实现一种新的迭代模式，使用一个生成器函数来定义它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>frange</span>(start, stop, increment):
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> start
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> x <span style=color:#f92672>&lt;</span> stop:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> x
</span></span><span style=display:flex><span>        x <span style=color:#f92672>+=</span> increment
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> frange(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>0.5</span>):
</span></span><span style=display:flex><span>    print(n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 0.5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1.0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1.5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2.0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2.5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3.0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3.5</span>
</span></span></code></pre></div><p>一个生成器函数主要特征是它只会回应在迭代中使用到的 next 操作。 一旦生成器函数返回退出，迭代终止。</p><h2 id=实现迭代器协议>实现迭代器协议
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e8%bf%ad%e4%bb%a3%e5%99%a8%e5%8d%8f%e8%ae%ae></a></h2><p>// TODO
<a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c04/p04_implement_iterator_protocol.html title=复习 rel="noopener external nofollow noreferrer" target=_blank class=exturl>复习
<i class="fa fa-external-link-alt"></i></a></p><h3 id=生成器版本>生成器版本
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e5%99%a8%e7%89%88%e6%9c%ac></a></h3><p>实现一个以深度优先方式遍历树形节点的生成器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_value <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Node(</span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>_value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_child</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children<span style=color:#f92672>.</span>append(node)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __iter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> iter(self<span style=color:#f92672>.</span>_children)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>depth_first</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> self:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield from</span> c<span style=color:#f92672>.</span>depth_first()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    root <span style=color:#f92672>=</span> Node(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    child1 <span style=color:#f92672>=</span> Node(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    child2 <span style=color:#f92672>=</span> Node(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    root<span style=color:#f92672>.</span>add_child(child1)
</span></span><span style=display:flex><span>    root<span style=color:#f92672>.</span>add_child(child2)
</span></span><span style=display:flex><span>    child1<span style=color:#f92672>.</span>add_child(Node(<span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>    child1<span style=color:#f92672>.</span>add_child(Node(<span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>    child2<span style=color:#f92672>.</span>add_child(Node(<span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ch <span style=color:#f92672>in</span> root<span style=color:#f92672>.</span>depth_first():
</span></span><span style=display:flex><span>        print(ch)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Outputs Node(0), Node(1), Node(3), Node(4), Node(2), Node(5)</span>
</span></span></code></pre></div><p>它首先返回自己本身并迭代每一个子节点并通过调用子节点的 <code>depth_first()</code> 方法(使用 <code>yield from</code> 语句)返回对应元素。</p><h3 id=迭代器版本>迭代器版本
<a class=header-anchor href=#%e8%bf%ad%e4%bb%a3%e5%99%a8%e7%89%88%e6%9c%ac></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node2</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_value <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Node(</span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>_value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_child</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children<span style=color:#f92672>.</span>append(node)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __iter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> iter(self<span style=color:#f92672>.</span>_children)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>depth_first</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> DepthFirstIterator(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DepthFirstIterator</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Depth-first traversal
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, start_node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_node <span style=color:#f92672>=</span> start_node
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_children_iter <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_child_iter <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __iter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __next__(self):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Return myself if just started; create an iterator for children</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>_children_iter <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_children_iter <span style=color:#f92672>=</span> iter(self<span style=color:#f92672>.</span>_node)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_node
</span></span><span style=display:flex><span>        <span style=color:#75715e># If processing a child, return its next item</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 迭代子节点</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>_child_iter:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                nextchild <span style=color:#f92672>=</span> next(self<span style=color:#f92672>.</span>_child_iter)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> nextchild
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_child_iter <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> next(self)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Advance to the next child and start its iteration</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_child_iter <span style=color:#f92672>=</span> next(self<span style=color:#f92672>.</span>_children_iter)<span style=color:#f92672>.</span>depth_first()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> next(self)
</span></span></code></pre></div><p>Python的迭代协议要求一个 <code>__iter__()</code> 方法返回一个特殊的迭代器对象， 这个迭代器对象实现了 <code>__next__()</code> 方法并通过 StopIteration 异常标识迭代的完成。</p><h2 id=反向迭代>反向迭代
<a class=header-anchor href=#%e5%8f%8d%e5%90%91%e8%bf%ad%e4%bb%a3></a></h2><p>使用内置的 <code>reversed()</code> 函数。反向迭代仅仅当对象的大小可<strong>预先确定</strong>或者对象实现了 <code>__reversed__()</code> 的特殊方法时才能生效。 如果两者都不符合，那你必须先将对象转换为一个列表才行。</p><h2 id=带有外部状态的生成器函数>带有外部状态的生成器函数
<a class=header-anchor href=#%e5%b8%a6%e6%9c%89%e5%a4%96%e9%83%a8%e7%8a%b6%e6%80%81%e7%9a%84%e7%94%9f%e6%88%90%e5%99%a8%e5%87%bd%e6%95%b0></a></h2><p>如果你想让你的生成器暴露外部状态给用户， 别忘了你可以简单的将它实现为一个类，然后把生成器函数放到 <code>__iter__()</code> 方法中过去。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> deque
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>linehistory</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, lines, histlen<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>lines <span style=color:#f92672>=</span> lines
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>history <span style=color:#f92672>=</span> deque(maxlen<span style=color:#f92672>=</span>histlen)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __iter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> lineno, line <span style=color:#f92672>in</span> enumerate(self<span style=color:#f92672>.</span>lines, <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>history<span style=color:#f92672>.</span>append((lineno, line))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> line
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>clear</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>history<span style=color:#f92672>.</span>clear()
</span></span></code></pre></div><h2 id=迭代器切片>迭代器切片
<a class=header-anchor href=#%e8%bf%ad%e4%bb%a3%e5%99%a8%e5%88%87%e7%89%87></a></h2><p>函数 <code>itertools.islice()</code> 正好适用于在迭代器和生成器上做切片操作。</p><p>这里要着重强调的一点是 <code>islice()</code> 会消耗掉传入的迭代器中的数据。 必须考虑到迭代器是不可逆的这个事实。</p><h2 id=跳过可迭代对象的开始部分>跳过可迭代对象的开始部分
<a class=header-anchor href=#%e8%b7%b3%e8%bf%87%e5%8f%af%e8%bf%ad%e4%bb%a3%e5%af%b9%e8%b1%a1%e7%9a%84%e5%bc%80%e5%a7%8b%e9%83%a8%e5%88%86></a></h2><p><code>itertools.dropwhile()</code> 函数。使用时，你给它传递一个函数对象和一个可迭代对象。 它会返回一个迭代器对象，丢弃原有序列中直到函数返回Flase之前的所有元素，然后返回后面所有元素。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 去除开始注释行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> itertools <span style=color:#f92672>import</span> dropwhile
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;/etc/passwd&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> dropwhile(<span style=color:#66d9ef>lambda</span> line: line<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;#&#39;</span>), f):
</span></span><span style=display:flex><span>        print(line, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)
</span></span></code></pre></div><h2 id=排列组合的迭代>排列组合的迭代
<a class=header-anchor href=#%e6%8e%92%e5%88%97%e7%bb%84%e5%90%88%e7%9a%84%e8%bf%ad%e4%bb%a3></a></h2><p><code>itertools.permutations()</code> 接受一个集合并产生一个元组序列，每个元组由集合中所有元素的一个可能排列组成。</p><p><code>itertools.combinations()</code> 可得到输入集合中元素的所有的组合。</p><p>在计算组合的时候，一旦元素被选取就会从候选中剔除掉(比如如果元素’a’已经被选取了，那么接下来就不会再考虑它了)。 而函数 <code>itertools.combinations_with_replacement()</code> 允许同一个元素被选择多次。</p><h2 id=同时迭代多个序列>同时迭代多个序列
<a class=header-anchor href=#%e5%90%8c%e6%97%b6%e8%bf%ad%e4%bb%a3%e5%a4%9a%e4%b8%aa%e5%ba%8f%e5%88%97></a></h2><p>为了同时迭代多个序列，使用 <code>zip()</code> 函数。<code>zip()</code> 会生成一个可返回元组 (x, y) 的迭代器，<strong>迭代长度跟参数中最短序列长度一致</strong>。</p><p>如果需要最长的序列遍历，那么可以使用 <code>itertools.zip_longest()</code> 函数来代替，<strong>fillvalue</strong> 参数指定没有对应值的默认值。</p><h2 id=不同集合上元素的迭代>不同集合上元素的迭代
<a class=header-anchor href=#%e4%b8%8d%e5%90%8c%e9%9b%86%e5%90%88%e4%b8%8a%e5%85%83%e7%b4%a0%e7%9a%84%e8%bf%ad%e4%bb%a3></a></h2><p><code>itertools.chain()</code> 接受一个或多个可迭代对象作为输入参数。 然后创建一个迭代器，依次连续的返回每个可迭代对象中的元素。 这种方式要比先将序列合并再迭代要高效的多。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> itertools <span style=color:#f92672>import</span> chain
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#e6db74>&#39;z&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> chain(a, b):
</span></span><span style=display:flex><span>print(x)
</span></span><span style=display:flex><span><span style=color:#75715e># 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4</span>
</span></span><span style=display:flex><span><span style=color:#75715e># x</span>
</span></span><span style=display:flex><span><span style=color:#75715e># y</span>
</span></span><span style=display:flex><span><span style=color:#75715e># z</span>
</span></span></code></pre></div><h2 id=数据处理管道>数据处理管道
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e7%ae%a1%e9%81%93></a></h2><p>目的：以数据管道(类似Unix管道)的方式迭代处理数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> fnmatch
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> gzip
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> bz2
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_find</span>(filepat, top):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Find all filenames in a directory tree that match a shell wildcard pattern
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> path, dirlist, filelist <span style=color:#f92672>in</span> os<span style=color:#f92672>.</span>walk(top):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> fnmatch<span style=color:#f92672>.</span>filter(filelist, filepat):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(path,name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_opener</span>(filenames):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Open a sequence of filenames one at a time producing a file object.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    The file is closed immediately when proceeding to the next iteration.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> filename <span style=color:#f92672>in</span> filenames:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> filename<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#39;.gz&#39;</span>):
</span></span><span style=display:flex><span>            f <span style=color:#f92672>=</span> gzip<span style=color:#f92672>.</span>open(filename, <span style=color:#e6db74>&#39;rt&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> filename<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#39;.bz2&#39;</span>):
</span></span><span style=display:flex><span>            f <span style=color:#f92672>=</span> bz2<span style=color:#f92672>.</span>open(filename, <span style=color:#e6db74>&#39;rt&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            f <span style=color:#f92672>=</span> open(filename, <span style=color:#e6db74>&#39;rt&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> f
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_concatenate</span>(iterators):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Chain a sequence of iterators together into a single sequence.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> it <span style=color:#f92672>in</span> iterators:
</span></span><span style=display:flex><span>        <span style=color:#75715e># 展开生成的生成器</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield from</span> it
</span></span><span style=display:flex><span>        <span style=color:#75715e># = for i in it:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#       yield i</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_grep</span>(pattern, lines):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Look for a regex pattern in a sequence of lines
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    pat <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(pattern)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> lines:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> pat<span style=color:#f92672>.</span>search(line):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> line
</span></span></code></pre></div><p>yield 语句作为数据的生产者而 for 循环语句作为数据的消费者。<code>gen_concatenate()</code> 函数中出现 <code>yield from</code> 语句，目的是将输入序列拼接成一个很长的行序列，并将 yield 操作代理到父生成器上去。 语句 <code>yield from it</code> 简单的返回生成器 it 所产生的所有值，yield from 在生成器中调用其他生成器作为子例程的时候非常有用。</p><h2 id=嵌套的序列>嵌套的序列
<a class=header-anchor href=#%e5%b5%8c%e5%a5%97%e7%9a%84%e5%ba%8f%e5%88%97></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> Iterable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>flatten</span>(items, ignore_types<span style=color:#f92672>=</span>(str, bytes)):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> items:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(x, Iterable) <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> isinstance(x, ignore_types):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield from</span> flatten(x)
</span></span><span style=display:flex><span><span style=color:#75715e>#            for i in flatten(x):</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#                yield i</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> x
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>items <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, [<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, [<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>], <span style=color:#ae81ff>7</span>], <span style=color:#ae81ff>8</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># Produces 1 2 3 4 5 6 7 8</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> flatten(items):
</span></span><span style=display:flex><span>    print(x)
</span></span></code></pre></div><p>语句 <code>yield from</code> 在生成器中调用其他生成器作为子例程的时候非常有用。如果不使用它，那么就必须写额外的 for 循环了。</p><h2 id=顺序迭代合并后的排序迭代对象>顺序迭代合并后的排序迭代对象
<a class=header-anchor href=#%e9%a1%ba%e5%ba%8f%e8%bf%ad%e4%bb%a3%e5%90%88%e5%b9%b6%e5%90%8e%e7%9a%84%e6%8e%92%e5%ba%8f%e8%bf%ad%e4%bb%a3%e5%af%b9%e8%b1%a1></a></h2><p>有一系列排序序列，想将它们合并后得到一个排序序列并在上面迭代遍历。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> heapq
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>10</span>]
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>11</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> heapq<span style=color:#f92672>.</span>merge(a, b):
</span></span><span style=display:flex><span>    print(c)
</span></span><span style=display:flex><span><span style=color:#75715e># 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 6</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 7</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 10</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 11</span>
</span></span></code></pre></div><p>heapq.merge 可迭代特性意味着它不会立马读取所有序列。 这就意味着你可以在非常长的序列中使用它，而不会有太大的开销。</p><p><code>heapq.merge()</code> 需要所有<strong>输入序列必须是排序</strong>。 特别的，它并不会预先读取所有数据到堆栈中或者预先排序，也不会对输入做任何的排序检测。 它仅仅是检查所有序列的开始部分并返回最小的那个，这个过程一直会持续直到所有输入序列中的元素都被遍历完。</p><h2 id=迭代器代替-while-无限循环>迭代器代替 while 无限循环
<a class=header-anchor href=#%e8%bf%ad%e4%bb%a3%e5%99%a8%e4%bb%a3%e6%9b%bf-while-%e6%97%a0%e9%99%90%e5%be%aa%e7%8e%af></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>CHUNKSIZE <span style=color:#f92672>=</span> <span style=color:#ae81ff>8192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>reader</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(CHUNKSIZE)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data <span style=color:#f92672>==</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        process_data(data)
</span></span><span style=display:flex><span><span style=color:#75715e># 迭代器操作</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>reader2</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> chunk <span style=color:#f92672>in</span> iter(<span style=color:#66d9ef>lambda</span>: s<span style=color:#f92672>.</span>recv(CHUNKSIZE), <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># process_data(data)</span>
</span></span></code></pre></div><p>iter 函数一个鲜为人知的特性是它接受一个可选的 callable 对象和一个标记(结尾)值作为输入参数。这种特殊的方法对于一些特定的会被重复调用的函数很有效果，比如涉及到I/O调用的函数。</p><h1 id=文件与-io>文件与 IO
<a class=header-anchor href=#%e6%96%87%e4%bb%b6%e4%b8%8e-io></a></h1><h2 id=字符串的io操作>字符串的I/O操作
<a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e7%9a%84io%e6%93%8d%e4%bd%9c></a></h2><p>使用 <code>io.StringIO()</code> 和 <code>io.BytesIO()</code> 类来创建类文件对象操作字符串数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>s <span style=color:#f92672>=</span> io<span style=color:#f92672>.</span>StringIO()
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;Hello World</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 12</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;This is a test&#39;</span>, file<span style=color:#f92672>=</span>s)
</span></span><span style=display:flex><span><span style=color:#75715e># 15</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get all of the data written so far</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>getvalue()
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;Hello World\nThis is a test\n&#39;</span>
</span></span></code></pre></div><p>当你想模拟一个普通的文件的时候 StringIO 和 BytesIO 类是很有用的。需要注意的是， StringIO 和 BytesIO 实例并没有整数类型的文件描述符。 因此，它们不能在那些需要使用真实的系统级文件如文件，管道或者是套接字的程序中使用。</p><h2 id=固定大小记录的文件迭代>固定大小记录的文件迭代
<a class=header-anchor href=#%e5%9b%ba%e5%ae%9a%e5%a4%a7%e5%b0%8f%e8%ae%b0%e5%bd%95%e7%9a%84%e6%96%87%e4%bb%b6%e8%bf%ad%e4%bb%a3></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RECORD_SIZE <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;somefile.data&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    records <span style=color:#f92672>=</span> iter(partial(f<span style=color:#f92672>.</span>read, RECORD_SIZE), <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> records:
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>records 对象是一个可迭代对象，它会不断的产生固定大小的数据块，直到文件末尾。 要注意的是如果总记录大小不是块大小的整数倍的话，<strong>最后一个返回元素的字节数会比期望值少</strong>。</p><h2 id=读取二进制数据到可变缓冲区中>读取二进制数据到可变缓冲区中
<a class=header-anchor href=#%e8%af%bb%e5%8f%96%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%95%b0%e6%8d%ae%e5%88%b0%e5%8f%af%e5%8f%98%e7%bc%93%e5%86%b2%e5%8c%ba%e4%b8%ad></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os.path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_into_buffer</span>(filename):
</span></span><span style=display:flex><span>    buf <span style=color:#f92672>=</span> bytearray(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>getsize(filename))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>readinto(buf)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> buf
</span></span></code></pre></div><p>和普通 <code>read()</code> 方法不同的是， <code>readinto()</code> 填充已存在的缓冲区而不是为新对象重新分配内存再返回它们。</p><p>另外有一个有趣特性就是 memoryview ， 它可以通过零复制的方式对已存在的缓冲区执行切片操作，甚至还能修改它的内容。</p><p>使用 <code>f.readinto()</code> 时需要注意的是，你必须检查它的返回值，也就是实际读取的字节数。如果字节数小于缓冲区大小，表明数据被截断或者被破坏了(比如你期望每次读取指定数量的字节)。</p><h2 id=内存映射的二进制文件>内存映射的二进制文件
<a class=header-anchor href=#%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%96%87%e4%bb%b6></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> mmap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>memory_map</span>(filename, access<span style=color:#f92672>=</span>mmap<span style=color:#f92672>.</span>ACCESS_WRITE):
</span></span><span style=display:flex><span>    size <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>getsize(filename)
</span></span><span style=display:flex><span>    fd <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>open(filename, os<span style=color:#f92672>.</span>O_RDWR)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mmap<span style=color:#f92672>.</span>mmap(fd, size, access<span style=color:#f92672>=</span>access)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 为了使用这个函数，你需要有一个已创建并且内容不为空的文件。 下面是一个例子，教你怎样初始创建一个文件并将其内容扩充到指定大小：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;data&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    f<span style=color:#f92672>.</span>seek(size<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    f<span style=color:#f92672>.</span>write(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>m <span style=color:#f92672>=</span> memory_map(<span style=color:#e6db74>&#39;data&#39;</span>)
</span></span><span style=display:flex><span>len(m)
</span></span><span style=display:flex><span><span style=color:#75715e># 1000000</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Memoryview of unsigned integers</span>
</span></span><span style=display:flex><span>v <span style=color:#f92672>=</span> memoryview(m)<span style=color:#f92672>.</span>cast(<span style=color:#e6db74>&#39;I&#39;</span>)
</span></span><span style=display:flex><span>v[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>m[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;\x07\x00\x00\x00&#39;</span>
</span></span></code></pre></div><p>内存映射一个文件并不会导致整个文件被读取到内存中。 也就是说，文件并没有被复制到内存缓存或数组中。相反，操作系统仅仅为文件内容保留了一段虚拟内存。当你访问文件的不同区域时，这些区域的内容才根据需要被读取并映射到内存区域中。 而那些从没被访问到的部分还是留在磁盘上。</p><h2 id=打印不合法的文件名>打印不合法的文件名
<a class=header-anchor href=#%e6%89%93%e5%8d%b0%e4%b8%8d%e5%90%88%e6%b3%95%e7%9a%84%e6%96%87%e4%bb%b6%e5%90%8d></a></h2><p><a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c05/p15_printing_bad_filenames.html title=详细 rel="noopener external nofollow noreferrer" target=_blank class=exturl>详细
<i class="fa fa-external-link-alt"></i></a></p><p>问题：打印文件名的时候程序崩溃， 出现了 UnicodeEncodeError 异常和一条奇怪的消息—— surrogates not allowed 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bad_filename</span>(filename):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> repr(filename)[<span style=color:#ae81ff>1</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重新编码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bad_filename2</span>(filename):
</span></span><span style=display:flex><span>    temp <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>encode(sys<span style=color:#f92672>.</span>getfilesystemencoding(), errors<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;surrogateescape&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> temp<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;latin-1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    print(filename)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> <span style=color:#a6e22e>UnicodeEncodeError</span>:
</span></span><span style=display:flex><span>    print(bad_filename(filename))
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>surrogateescape:
</span></span><span style=display:flex><span>这种是Python在绝大部分面向OS的API中所使用的错误处理器，
</span></span><span style=display:flex><span>它能以一种优雅的方式处理由操作系统提供的数据的编码问题。
</span></span><span style=display:flex><span>在解码出错时会将出错字节存储到一个很少被使用到的Unicode编码范围内。
</span></span><span style=display:flex><span>在编码时将那些隐藏值又还原回原先解码失败的字节序列。
</span></span><span style=display:flex><span>它不仅对于OS API非常有用，也能很容易的处理其他情况下的编码错误。
</span></span></code></pre></div><p>当执行类似 <code>os.listdir()</code> 这样的函数时，这些不合规范的文件名就会让 Python 陷入困境。 一方面，它不能仅仅只是丢弃这些不合格的名字。而另一方面，它又不能将这些文件名转换为正确的文本字符串。 Python 对这个问题的解决方案是从文件名中获取未解码的字节值比如 \xhh 并将它映射成 Unicode 字符 \udchh 表示的所谓的”代理编码”。当你想要输出文件名时才会碰到些麻烦(比如打印输出到屏幕或日志文件等).</p><h2 id=增加或改变已打开文件的编码>增加或改变已打开文件的编码
<a class=header-anchor href=#%e5%a2%9e%e5%8a%a0%e6%88%96%e6%94%b9%e5%8f%98%e5%b7%b2%e6%89%93%e5%bc%80%e6%96%87%e4%bb%b6%e7%9a%84%e7%bc%96%e7%a0%81></a></h2><p>如果你想给一个以二进制模式打开的文件添加 Unicode 编码/解码方式， 可以使用 <code>io.TextIOWrapper()</code> 对象包装它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> urllib.request
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>urlopen(<span style=color:#e6db74>&#39;http://www.python.org&#39;</span>)
</span></span><span style=display:flex><span>f <span style=color:#f92672>=</span> io<span style=color:#f92672>.</span>TextIOWrapper(u, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>text <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span></code></pre></div><h2 id=将字节写入文本文件>将字节写入文本文件
<a class=header-anchor href=#%e5%b0%86%e5%ad%97%e8%8a%82%e5%86%99%e5%85%a5%e6%96%87%e6%9c%ac%e6%96%87%e4%bb%b6></a></h2><p>能够通过读取文本文件的 buffer 属性来读取二进制数据。</p><p>I/O系统以层级结构的形式构建而成。 文本文件是通过在一个拥有缓冲的二进制模式文件上增加一个Unicode编码/解码层来创建。 buffer 属性指向对应的底层文件。如果你直接访问它的话就会绕过文本编码/解码层。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;sample.txt&#39;</span>,<span style=color:#e6db74>&#39;w&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> f
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>_io<span style=color:#f92672>.</span>TextIOWrapper name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;sample.txt&#39;</span> mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;w&#39;</span> encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;UTF-8&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> f<span style=color:#f92672>.</span>buffer
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>_io<span style=color:#f92672>.</span>BufferedWriter name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;sample.txt&#39;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> f<span style=color:#f92672>.</span>buffer<span style=color:#f92672>.</span>raw
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>_io<span style=color:#f92672>.</span>FileIO name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;sample.txt&#39;</span> mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;wb&#39;</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>io.TextIOWrapper 是一个编码和解码 Unicode 的文本处理层， io.BufferedWriter 是一个处理二进制数据的带缓冲的I/O层， io.FileIO 是一个表示操作系统底层文件描述符的原始文件。 增加或改变文本编码会涉及增加或改变最上面的 io.TextIOWrapper 层。</p><h2 id=文件描述符包装成文件对象>文件描述符包装成文件对象
<a class=header-anchor href=#%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%8c%85%e8%a3%85%e6%88%90%e6%96%87%e4%bb%b6%e5%af%b9%e8%b1%a1></a></h2><p>一个文件描述符和一个打开的普通文件是不一样的。 文件描述符仅仅是一个由操作系统指定的整数，用来指代某个系统的I/O通道。 如果你碰巧有这么一个文件描述符，你可以通过使用 <code>open()</code> 函数来将其包装为一个Python的文件对象。 你仅仅只需要使用这个整数值的文件描述符作为第一个参数来代替文件名即可。</p><h2 id=创建临时文件和文件夹>创建临时文件和文件夹
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e4%b8%b4%e6%97%b6%e6%96%87%e4%bb%b6%e5%92%8c%e6%96%87%e4%bb%b6%e5%a4%b9></a></h2><p><code>TemporaryFile()</code> 、<code>NamedTemporaryFile()</code> 和 <code>TemporaryDirectory()</code> 函数应该是处理临时文件目录的最简单的方式了，因为它们会自动处理所有的创建和清理步骤。</p><h2 id=序列化python对象>序列化Python对象
<a class=header-anchor href=#%e5%ba%8f%e5%88%97%e5%8c%96python%e5%af%b9%e8%b1%a1></a></h2><p>对于序列化最普遍的做法就是使用 pickle 模块。</p><p><code>dump()</code>、<code>dumps()</code>、<code>load()</code>、<code>loads()</code>函数。</p><p>有些类型的对象是不能被序列化的。这些通常是那些依赖外部系统状态的对象， 比如打开的文件，网络连接，线程，进程，栈帧等等。 用户自定义类可以通过提供 <code>__getstate__()</code> 和 <code>__setstate__()</code> 方法来绕过这些限制。</p><h1 id=数据编码和处理>数据编码和处理
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e7%bc%96%e7%a0%81%e5%92%8c%e5%a4%84%e7%90%86></a></h1><h2 id=读写json数据>读写JSON数据
<a class=header-anchor href=#%e8%af%bb%e5%86%99json%e6%95%b0%e6%8d%ae></a></h2><p>json 模块提供了一种很简单的方式来编码和解码JSON数据。 其中两个主要的函数是 <code>json.dumps()</code> 和 <code>json.loads()</code>。</p><p>JSON 编码的格式对于 Python 语法而已几乎是完全一样的，除了一些小的差异之外。 比如，True 会被映射为 true，False 被映射为 false，而 None 会被映射为 null。</p><p>JSON字典与 Python 对象转换</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>serialize_instance</span>(obj):
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#39;__classname__&#39;</span> : type(obj)<span style=color:#f92672>.</span>__name__ }
</span></span><span style=display:flex><span>    d<span style=color:#f92672>.</span>update(vars(obj))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Dictionary mapping names to known classes</span>
</span></span><span style=display:flex><span>classes <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Point&#39;</span> : Point
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unserialize_object</span>(d):
</span></span><span style=display:flex><span>    clsname <span style=color:#f92672>=</span> d<span style=color:#f92672>.</span>pop(<span style=color:#e6db74>&#39;__classname__&#39;</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> clsname:
</span></span><span style=display:flex><span>        cls <span style=color:#f92672>=</span> classes[clsname]
</span></span><span style=display:flex><span>        obj <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__new__(cls) <span style=color:#75715e># Make instance without calling __init__</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> d<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            setattr(obj, key, value)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> obj
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> Point(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>dumps(p, default<span style=color:#f92672>=</span>serialize_instance)
</span></span><span style=display:flex><span>s
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;{&#34;__classname__&#34;: &#34;Point&#34;, &#34;y&#34;: 3, &#34;x&#34;: 2}&#39;</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(s, object_hook<span style=color:#f92672>=</span>unserialize_object)
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#75715e># main__.Point object at 0x1017577d0&gt;</span>
</span></span></code></pre></div><h2 id=xml-操作>XML 操作
<a class=header-anchor href=#xml-%e6%93%8d%e4%bd%9c></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> urllib.request <span style=color:#f92672>import</span> urlopen
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> xml.etree.ElementTree <span style=color:#f92672>import</span> parse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Download the RSS feed and parse it</span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> urlopen(<span style=color:#e6db74>&#39;http://planet.python.org/rss20.xml&#39;</span>)
</span></span><span style=display:flex><span>doc <span style=color:#f92672>=</span> parse(u)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extract and output tags of interest</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> doc<span style=color:#f92672>.</span>iterfind(<span style=color:#e6db74>&#39;channel/item&#39;</span>):
</span></span><span style=display:flex><span>    title <span style=color:#f92672>=</span> item<span style=color:#f92672>.</span>findtext(<span style=color:#e6db74>&#39;title&#39;</span>)
</span></span><span style=display:flex><span>    date <span style=color:#f92672>=</span> item<span style=color:#f92672>.</span>findtext(<span style=color:#e6db74>&#39;pubDate&#39;</span>)
</span></span><span style=display:flex><span>    link <span style=color:#f92672>=</span> item<span style=color:#f92672>.</span>findtext(<span style=color:#e6db74>&#39;link&#39;</span>)
</span></span><span style=display:flex><span>    des <span style=color:#f92672>=</span> item<span style=color:#f92672>.</span>findtext(<span style=color:#e6db74>&#39;description&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(title)
</span></span><span style=display:flex><span>    print(date)
</span></span><span style=display:flex><span>    print(link)
</span></span><span style=display:flex><span>    print(des)
</span></span></code></pre></div><h3 id=增量解析大型-xml-文件>增量解析大型 XML 文件
<a class=header-anchor href=#%e5%a2%9e%e9%87%8f%e8%a7%a3%e6%9e%90%e5%a4%a7%e5%9e%8b-xml-%e6%96%87%e4%bb%b6></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> xml.etree.ElementTree <span style=color:#f92672>import</span> iterparse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>parse_and_remove</span>(filename, path):
</span></span><span style=display:flex><span>    path_parts <span style=color:#f92672>=</span> path<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>    doc <span style=color:#f92672>=</span> iterparse(filename, (<span style=color:#e6db74>&#39;start&#39;</span>, <span style=color:#e6db74>&#39;end&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#75715e># Skip the root element</span>
</span></span><span style=display:flex><span>    next(doc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tag_stack <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    elem_stack <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> event, elem <span style=color:#f92672>in</span> doc:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> event <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;start&#39;</span>:
</span></span><span style=display:flex><span>            tag_stack<span style=color:#f92672>.</span>append(elem<span style=color:#f92672>.</span>tag)
</span></span><span style=display:flex><span>            elem_stack<span style=color:#f92672>.</span>append(elem)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> event <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;end&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> tag_stack <span style=color:#f92672>==</span> path_parts:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>yield</span> elem
</span></span><span style=display:flex><span>                elem_stack[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>]<span style=color:#f92672>.</span>remove(elem)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                tag_stack<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>                elem_stack<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>IndexError</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>第一，<code>iterparse()</code> 方法允许对XML文档进行增量操作。 使用时，你需要提供文件名和一个包含下面一种或多种类型的事件列表： start , end, start-ns 和 end-ns 。 由 <code>iterparse()</code> 创建的迭代器会产生形如 (event, elem) 的元组， 其中 event 是上述事件列表中的某一个，而 elem 是相应的XML元素。</p><p>start 事件在某个元素第一次被创建并且还没有被插入其他数据(如子元素)时被创建。 而 end 事件在某个元素已经完成时被创建。</p><h3 id=修改文档>修改文档
<a class=header-anchor href=#%e4%bf%ae%e6%94%b9%e6%96%87%e6%a1%a3></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> xml.etree.ElementTree <span style=color:#f92672>import</span> parse, Element
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> doc <span style=color:#f92672>=</span> parse(<span style=color:#e6db74>&#39;pred.xml&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> root <span style=color:#f92672>=</span> doc<span style=color:#f92672>.</span>getroot()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> root
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>Element <span style=color:#e6db74>&#39;stop&#39;</span> at <span style=color:#ae81ff>0x100770cb0</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Remove a few elements</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> root<span style=color:#f92672>.</span>remove(root<span style=color:#f92672>.</span>find(<span style=color:#e6db74>&#39;sri&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> root<span style=color:#f92672>.</span>remove(root<span style=color:#f92672>.</span>find(<span style=color:#e6db74>&#39;cr&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Insert a new element after &lt;nm&gt;...&lt;/nm&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> root<span style=color:#f92672>.</span>getchildren()<span style=color:#f92672>.</span>index(root<span style=color:#f92672>.</span>find(<span style=color:#e6db74>&#39;nm&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> e <span style=color:#f92672>=</span> Element(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> e<span style=color:#f92672>.</span>text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;This is a test&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> root<span style=color:#f92672>.</span>insert(<span style=color:#ae81ff>2</span>, e)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Write back to a file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> doc<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;newpred.xml&#39;</span>, xml_declaration<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><h3 id=命名空间解析xml文档>命名空间解析XML文档
<a class=header-anchor href=#%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4%e8%a7%a3%e6%9e%90xml%e6%96%87%e6%a1%a3></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XMLNamespaces</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>namespaces <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, uri <span style=color:#f92672>in</span> kwargs<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>register(name, uri)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>(self, name, uri):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>namespaces[name] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{&#39;</span><span style=color:#f92672>+</span>uri<span style=color:#f92672>+</span><span style=color:#e6db74>&#39;}&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, path):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> path<span style=color:#f92672>.</span>format_map(self<span style=color:#f92672>.</span>namespaces)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> ns <span style=color:#f92672>=</span> XMLNamespaces(html<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;http://www.w3.org/1999/xhtml&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> doc<span style=color:#f92672>.</span>find(ns(<span style=color:#e6db74>&#39;content/</span><span style=color:#e6db74>{html}</span><span style=color:#e6db74>html&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>Element <span style=color:#e6db74>&#39;{http://www.w3.org/1999/xhtml}html&#39;</span> at <span style=color:#ae81ff>0x1007767e0</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> doc<span style=color:#f92672>.</span>findtext(ns(<span style=color:#e6db74>&#39;content/</span><span style=color:#e6db74>{html}</span><span style=color:#e6db74>html/</span><span style=color:#e6db74>{html}</span><span style=color:#e6db74>head/</span><span style=color:#e6db74>{html}</span><span style=color:#e6db74>title&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;Hello World&#39;</span>
</span></span></code></pre></div><h2 id=编码和解码十六进制数>编码和解码十六进制数
<a class=header-anchor href=#%e7%bc%96%e7%a0%81%e5%92%8c%e8%a7%a3%e7%a0%81%e5%8d%81%e5%85%ad%e8%bf%9b%e5%88%b6%e6%95%b0></a></h2><p>如果你只是简单的解码或编码一个十六进制的原始字符串，可以使用　binascii 模块。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Initial byte string</span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Encode as hex</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> binascii
</span></span><span style=display:flex><span>h <span style=color:#f92672>=</span> binascii<span style=color:#f92672>.</span>b2a_hex(s)
</span></span><span style=display:flex><span>h
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;68656c6c6f&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Decode back to bytes</span>
</span></span><span style=display:flex><span>binascii<span style=color:#f92672>.</span>a2b_hex(h)
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;hello&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> base64
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> h <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b16encode(s)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> h
</span></span><span style=display:flex><span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;68656C6C6F&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> base64<span style=color:#f92672>.</span>b16decode(h)
</span></span><span style=display:flex><span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;hello&#39;</span>
</span></span></code></pre></div><p>函数 <code>base64.b16decode()</code> 和 <code>base64.b16encode()</code> 只能操作大写形式的十六进制字母， 而 binascii 模块中的函数大小写都能处理。</p><p>当解码Base64的时候，字节字符串和Unicode文本都可以作为参数。 但是，Unicode字符串只能包含ASCII字符。</p><h2 id=编码解码base64数据>编码解码Base64数据
<a class=header-anchor href=#%e7%bc%96%e7%a0%81%e8%a7%a3%e7%a0%81base64%e6%95%b0%e6%8d%ae></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Some byte data</span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Encode as Base64</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64encode(s)
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;aGVsbG8=&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Decode from Base64</span>
</span></span><span style=display:flex><span>base64<span style=color:#f92672>.</span>b64decode(a)
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;hello&#39;</span>
</span></span></code></pre></div><p>Base64编码仅仅用于面向字节的数据比如字节字符串和字节数组。 此外，编码处理的输出结果总是一个字节字符串。</p><p>当解码Base64的时候，字节字符串和Unicode文本都可以作为参数。 但是，Unicode字符串只能包含ASCII字符。</p><h2 id=struct>Struct
<a class=header-anchor href=#struct></a></h2><p>struct 模块处理二进制数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> struct <span style=color:#f92672>import</span> Struct
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_records</span>(records, format, f):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Write a sequence of tuples to a binary file of structures.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    record_struct <span style=color:#f92672>=</span> Struct(format)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> records:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>write(record_struct<span style=color:#f92672>.</span>pack(<span style=color:#f92672>*</span>r))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    records <span style=color:#f92672>=</span> [ (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2.3</span>, <span style=color:#ae81ff>4.5</span>),
</span></span><span style=display:flex><span>                (<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7.8</span>, <span style=color:#ae81ff>9.0</span>),
</span></span><span style=display:flex><span>                (<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13.4</span>, <span style=color:#ae81ff>56.7</span>) ]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;data.b&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        write_records(records, <span style=color:#e6db74>&#39;&lt;idd&#39;</span>, f)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 增量读取文件</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_records</span>(format, f):
</span></span><span style=display:flex><span>    record_struct <span style=color:#f92672>=</span> Struct(format)
</span></span><span style=display:flex><span>    chunks <span style=color:#f92672>=</span> iter(<span style=color:#66d9ef>lambda</span>: f<span style=color:#f92672>.</span>read(record_struct<span style=color:#f92672>.</span>size), <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (record_struct<span style=color:#f92672>.</span>unpack(chunk) <span style=color:#66d9ef>for</span> chunk <span style=color:#f92672>in</span> chunks)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;data.b&#39;</span>,<span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> rec <span style=color:#f92672>in</span> read_records(<span style=color:#e6db74>&#39;&lt;idd&#39;</span>, f):
</span></span><span style=display:flex><span>            <span style=color:#75715e># Process rec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 一次性读取</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unpack_records</span>(format, data):
</span></span><span style=display:flex><span>    record_struct <span style=color:#f92672>=</span> Struct(format)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (record_struct<span style=color:#f92672>.</span>unpack_from(data, offset)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> offset <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(data), record_struct<span style=color:#f92672>.</span>size))
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;data.b&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> rec <span style=color:#f92672>in</span> unpack_records(<span style=color:#e6db74>&#39;&lt;idd&#39;</span>, data):
</span></span></code></pre></div><p>产生的 Struct 实例有很多属性和方法用来操作相应类型的结构。 size 属性包含了结构的字节数，这在I/O操作时非常有用。 <code>pack()</code> 和 <code>unpack()</code> 方法被用来打包和解包数据。</p><p><code>unpack_from()</code> 对于从一个大型二进制数组中提取二进制数据非常有用， 因为它不会产生任何的临时对象或者进行内存复制操作。</p><h2 id=可变长度二进制数据>可变长度二进制数据
<a class=header-anchor href=#%e5%8f%af%e5%8f%98%e9%95%bf%e5%ba%a6%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%95%b0%e6%8d%ae></a></h2><p>struct 模块可被用来编码/解码几乎所有类型的二进制的数据结构。</p><h3 id=数据结构定义>数据结构定义
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e5%ae%9a%e4%b9%89></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>polys <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    [ (<span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>2.5</span>), (<span style=color:#ae81ff>3.5</span>, <span style=color:#ae81ff>4.0</span>), (<span style=color:#ae81ff>2.5</span>, <span style=color:#ae81ff>1.5</span>) ],
</span></span><span style=display:flex><span>    [ (<span style=color:#ae81ff>7.0</span>, <span style=color:#ae81ff>1.2</span>), (<span style=color:#ae81ff>5.1</span>, <span style=color:#ae81ff>3.0</span>), (<span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>7.5</span>), (<span style=color:#ae81ff>0.8</span>, <span style=color:#ae81ff>9.0</span>) ],
</span></span><span style=display:flex><span>    [ (<span style=color:#ae81ff>3.4</span>, <span style=color:#ae81ff>6.3</span>), (<span style=color:#ae81ff>1.2</span>, <span style=color:#ae81ff>0.5</span>), (<span style=color:#ae81ff>4.6</span>, <span style=color:#ae81ff>9.2</span>) ],
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 头部文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>Byte  <span style=color:#f92672>|</span> Type   <span style=color:#f92672>|</span>  Description                       <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+======+========+====================================+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>0</span>     <span style=color:#f92672>|</span> int    <span style=color:#f92672>|</span>  文件代码<span style=color:#960050;background-color:#1e0010>（</span><span style=color:#ae81ff>0x1234</span><span style=color:#960050;background-color:#1e0010>，</span>小端<span style=color:#960050;background-color:#1e0010>）</span>          <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>4</span>     <span style=color:#f92672>|</span> double <span style=color:#f92672>|</span>  x 的最小值<span style=color:#960050;background-color:#1e0010>（</span>小端<span style=color:#960050;background-color:#1e0010>）</span>                <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>12</span>    <span style=color:#f92672>|</span> double <span style=color:#f92672>|</span>  y 的最小值<span style=color:#960050;background-color:#1e0010>（</span>小端<span style=color:#960050;background-color:#1e0010>）</span>                <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>20</span>    <span style=color:#f92672>|</span> double <span style=color:#f92672>|</span>  x 的最大值<span style=color:#960050;background-color:#1e0010>（</span>小端<span style=color:#960050;background-color:#1e0010>）</span>                <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>28</span>    <span style=color:#f92672>|</span> double <span style=color:#f92672>|</span>  y 的最大值<span style=color:#960050;background-color:#1e0010>（</span>小端<span style=color:#960050;background-color:#1e0010>）</span>                <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>36</span>    <span style=color:#f92672>|</span> int    <span style=color:#f92672>|</span>  三角形数量<span style=color:#960050;background-color:#1e0010>（</span>小端<span style=color:#960050;background-color:#1e0010>）</span>                <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+------------------------------------+</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 多边形记录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+-------------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>Byte  <span style=color:#f92672>|</span> Type   <span style=color:#f92672>|</span>  Description                              <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+======+========+===========================================+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>0</span>     <span style=color:#f92672>|</span> int    <span style=color:#f92672>|</span>  记录长度<span style=color:#960050;background-color:#1e0010>（</span>N字节<span style=color:#960050;background-color:#1e0010>）</span>                        <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+-------------------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span><span style=color:#ae81ff>4</span><span style=color:#f92672>-</span>N   <span style=color:#f92672>|</span> Points <span style=color:#f92672>|</span>  (X,Y) 坐标<span style=color:#960050;background-color:#1e0010>，</span>以浮点数表示                 <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+------+--------+-------------------------------------------+</span>
</span></span></code></pre></div><h3 id=直接代码解析>直接代码解析
<a class=header-anchor href=#%e7%9b%b4%e6%8e%a5%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> struct
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> itertools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_polys</span>(filename, polys):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Determine bounding box</span>
</span></span><span style=display:flex><span>    flattened <span style=color:#f92672>=</span> list(itertools<span style=color:#f92672>.</span>chain(<span style=color:#f92672>*</span>polys))
</span></span><span style=display:flex><span>    min_x <span style=color:#f92672>=</span> min(x <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> flattened)
</span></span><span style=display:flex><span>    max_x <span style=color:#f92672>=</span> max(x <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> flattened)
</span></span><span style=display:flex><span>    min_y <span style=color:#f92672>=</span> min(y <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> flattened)
</span></span><span style=display:flex><span>    max_y <span style=color:#f92672>=</span> max(y <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> flattened)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>write(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#39;&lt;iddddi&#39;</span>, <span style=color:#ae81ff>0x1234</span>,
</span></span><span style=display:flex><span>                            min_x, min_y,
</span></span><span style=display:flex><span>                            max_x, max_y,
</span></span><span style=display:flex><span>                            len(polys)))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> poly <span style=color:#f92672>in</span> polys:
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> len(poly) <span style=color:#f92672>*</span> struct<span style=color:#f92672>.</span>calcsize(<span style=color:#e6db74>&#39;&lt;dd&#39;</span>)
</span></span><span style=display:flex><span>            f<span style=color:#f92672>.</span>write(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#39;&lt;i&#39;</span>, size <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> pt <span style=color:#f92672>in</span> poly:
</span></span><span style=display:flex><span>                f<span style=color:#f92672>.</span>write(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#39;&lt;dd&#39;</span>, <span style=color:#f92672>*</span>pt))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_polys</span>(filename):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Read the header</span>
</span></span><span style=display:flex><span>        header <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>40</span>)
</span></span><span style=display:flex><span>        file_code, min_x, min_y, max_x, max_y, num_polys <span style=color:#f92672>=</span> \
</span></span><span style=display:flex><span>            struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#39;&lt;iddddi&#39;</span>, header)
</span></span><span style=display:flex><span>        polys <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(num_polys):
</span></span><span style=display:flex><span>            pbytes, <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#39;&lt;i&#39;</span>, f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>            poly <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> m <span style=color:#f92672>in</span> range(pbytes <span style=color:#f92672>//</span> <span style=color:#ae81ff>16</span>):
</span></span><span style=display:flex><span>                pt <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#39;&lt;dd&#39;</span>, f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>16</span>))
</span></span><span style=display:flex><span>                poly<span style=color:#f92672>.</span>append(pt)
</span></span><span style=display:flex><span>            polys<span style=color:#f92672>.</span>append(poly)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> polys
</span></span></code></pre></div><h3 id=高级抽象形式>高级抽象形式
<a class=header-anchor href=#%e9%ab%98%e7%ba%a7%e6%8a%bd%e8%b1%a1%e5%bd%a2%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 数据结构类</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> struct
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructField</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Descriptor representing a simple structure field
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, format, offset):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>format <span style=color:#f92672>=</span> format
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>offset <span style=color:#f92672>=</span> offset
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            r <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack_from(self<span style=color:#f92672>.</span>format, instance<span style=color:#f92672>.</span>_buffer, self<span style=color:#f92672>.</span>offset)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> r[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>if</span> len(r) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, bytedata):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_buffer <span style=color:#f92672>=</span> memoryview(bytedata)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 头部信息</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PolyHeader</span>(Structure):
</span></span><span style=display:flex><span>    file_code <span style=color:#f92672>=</span> StructField(<span style=color:#e6db74>&#39;&lt;i&#39;</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    min_x <span style=color:#f92672>=</span> StructField(<span style=color:#e6db74>&#39;&lt;d&#39;</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    min_y <span style=color:#f92672>=</span> StructField(<span style=color:#e6db74>&#39;&lt;d&#39;</span>, <span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>    max_x <span style=color:#f92672>=</span> StructField(<span style=color:#e6db74>&#39;&lt;d&#39;</span>, <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>    max_y <span style=color:#f92672>=</span> StructField(<span style=color:#e6db74>&#39;&lt;d&#39;</span>, <span style=color:#ae81ff>28</span>)
</span></span><span style=display:flex><span>    num_polys <span style=color:#f92672>=</span> StructField(<span style=color:#e6db74>&#39;&lt;i&#39;</span>, <span style=color:#ae81ff>36</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;polys.bin&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead <span style=color:#f92672>=</span> PolyHeader(f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>40</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>file_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x1234</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>min_x
</span></span><span style=display:flex><span><span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>min_y
</span></span><span style=display:flex><span><span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>max_x
</span></span><span style=display:flex><span><span style=color:#ae81ff>7.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>max_y
</span></span><span style=display:flex><span><span style=color:#ae81ff>9.2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>num_polys
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 元类方法自动计算结构体偏移</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructureMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Metaclass that automatically creates StructField descriptors
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        fields <span style=color:#f92672>=</span> getattr(self, <span style=color:#e6db74>&#39;_fields_&#39;</span>, [])
</span></span><span style=display:flex><span>        byte_order <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>        offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> format, fieldname <span style=color:#f92672>in</span> fields:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> format<span style=color:#f92672>.</span>startswith((<span style=color:#e6db74>&#39;&lt;&#39;</span>,<span style=color:#e6db74>&#39;&gt;&#39;</span>,<span style=color:#e6db74>&#39;!&#39;</span>,<span style=color:#e6db74>&#39;@&#39;</span>)):
</span></span><span style=display:flex><span>                byte_order <span style=color:#f92672>=</span> format[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>                format <span style=color:#f92672>=</span> format[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>            format <span style=color:#f92672>=</span> byte_order <span style=color:#f92672>+</span> format
</span></span><span style=display:flex><span>            setattr(self, fieldname, StructField(format, offset))
</span></span><span style=display:flex><span>            offset <span style=color:#f92672>+=</span> struct<span style=color:#f92672>.</span>calcsize(format)
</span></span><span style=display:flex><span>        setattr(self, <span style=color:#e6db74>&#39;struct_size&#39;</span>, offset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure</span>(metaclass<span style=color:#f92672>=</span>StructureMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, bytedata):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_buffer <span style=color:#f92672>=</span> bytedata
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>from_file</span>(cls, f):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls(f<span style=color:#f92672>.</span>read(cls<span style=color:#f92672>.</span>struct_size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PolyHeader</span>(Structure):
</span></span><span style=display:flex><span>    _fields_ <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;&lt;i&#39;</span>, <span style=color:#e6db74>&#39;file_code&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;d&#39;</span>, <span style=color:#e6db74>&#39;min_x&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;d&#39;</span>, <span style=color:#e6db74>&#39;min_y&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;d&#39;</span>, <span style=color:#e6db74>&#39;max_x&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;d&#39;</span>, <span style=color:#e6db74>&#39;max_y&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;i&#39;</span>, <span style=color:#e6db74>&#39;num_polys&#39;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 嵌套字节结构</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NestedStruct</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Descriptor representing a nested structure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, struct_type, offset):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>struct_type <span style=color:#f92672>=</span> struct_type
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>offset <span style=color:#f92672>=</span> offset
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            data <span style=color:#f92672>=</span> instance<span style=color:#f92672>.</span>_buffer[self<span style=color:#f92672>.</span>offset:
</span></span><span style=display:flex><span>                            self<span style=color:#f92672>.</span>offset<span style=color:#f92672>+</span>self<span style=color:#f92672>.</span>struct_type<span style=color:#f92672>.</span>struct_size]
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>struct_type(data)
</span></span><span style=display:flex><span>            <span style=color:#75715e># Save resulting structure back on instance to avoid</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># further recomputation of this step</span>
</span></span><span style=display:flex><span>            setattr(instance, self<span style=color:#f92672>.</span>name, result)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructureMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Metaclass that automatically creates StructField descriptors
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        fields <span style=color:#f92672>=</span> getattr(self, <span style=color:#e6db74>&#39;_fields_&#39;</span>, [])
</span></span><span style=display:flex><span>        byte_order <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>        offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> format, fieldname <span style=color:#f92672>in</span> fields:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(format, StructureMeta):
</span></span><span style=display:flex><span>                setattr(self, fieldname,
</span></span><span style=display:flex><span>                        NestedStruct(fieldname, format, offset))
</span></span><span style=display:flex><span>                offset <span style=color:#f92672>+=</span> format<span style=color:#f92672>.</span>struct_size
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> format<span style=color:#f92672>.</span>startswith((<span style=color:#e6db74>&#39;&lt;&#39;</span>,<span style=color:#e6db74>&#39;&gt;&#39;</span>,<span style=color:#e6db74>&#39;!&#39;</span>,<span style=color:#e6db74>&#39;@&#39;</span>)):
</span></span><span style=display:flex><span>                    byte_order <span style=color:#f92672>=</span> format[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>                    format <span style=color:#f92672>=</span> format[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>                format <span style=color:#f92672>=</span> byte_order <span style=color:#f92672>+</span> format
</span></span><span style=display:flex><span>                setattr(self, fieldname, StructField(format, offset))
</span></span><span style=display:flex><span>                offset <span style=color:#f92672>+=</span> struct<span style=color:#f92672>.</span>calcsize(format)
</span></span><span style=display:flex><span>        setattr(self, <span style=color:#e6db74>&#39;struct_size&#39;</span>, offset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>(Structure):
</span></span><span style=display:flex><span>    _fields_ <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;&lt;d&#39;</span>, <span style=color:#e6db74>&#39;x&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;d&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PolyHeader</span>(Structure):
</span></span><span style=display:flex><span>    _fields_ <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;&lt;i&#39;</span>, <span style=color:#e6db74>&#39;file_code&#39;</span>),
</span></span><span style=display:flex><span>        (Point, <span style=color:#e6db74>&#39;min&#39;</span>), <span style=color:#75715e># nested struct</span>
</span></span><span style=display:flex><span>        (Point, <span style=color:#e6db74>&#39;max&#39;</span>), <span style=color:#75715e># nested struct</span>
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;i&#39;</span>, <span style=color:#e6db74>&#39;num_polys&#39;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;polys.bin&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead <span style=color:#f92672>=</span> PolyHeader<span style=color:#f92672>.</span>from_file(f)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>file_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x1234</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>min <span style=color:#75715e># Nested structure</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>__main__<span style=color:#f92672>.</span>Point object at <span style=color:#ae81ff>0x1006a48d0</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>min<span style=color:#f92672>.</span>x
</span></span><span style=display:flex><span><span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>min<span style=color:#f92672>.</span>y
</span></span><span style=display:flex><span><span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>max<span style=color:#f92672>.</span>x
</span></span><span style=display:flex><span><span style=color:#ae81ff>7.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>max<span style=color:#f92672>.</span>y
</span></span><span style=display:flex><span><span style=color:#ae81ff>9.2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> phead<span style=color:#f92672>.</span>num_polys
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 变长数据解析</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SizedRecord</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, bytedata):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_buffer <span style=color:#f92672>=</span> memoryview(bytedata)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>from_file</span>(cls, f, size_fmt, includes_size<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>):
</span></span><span style=display:flex><span>        sz_nbytes <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>calcsize(size_fmt)
</span></span><span style=display:flex><span>        sz_bytes <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(sz_nbytes)
</span></span><span style=display:flex><span>        sz, <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(size_fmt, sz_bytes)
</span></span><span style=display:flex><span>        buf <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(sz <span style=color:#f92672>-</span> includes_size <span style=color:#f92672>*</span> sz_nbytes)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls(buf)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>iter_as</span>(self, code):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(code, str):
</span></span><span style=display:flex><span>            s <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>Struct(code)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> off <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(self<span style=color:#f92672>.</span>_buffer), s<span style=color:#f92672>.</span>size):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>yield</span> s<span style=color:#f92672>.</span>unpack_from(self<span style=color:#f92672>.</span>_buffer, off)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> isinstance(code, StructureMeta):
</span></span><span style=display:flex><span>            size <span style=color:#f92672>=</span> code<span style=color:#f92672>.</span>struct_size
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> off <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(self<span style=color:#f92672>.</span>_buffer), size):
</span></span><span style=display:flex><span>                data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_buffer[off:off<span style=color:#f92672>+</span>size]
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>yield</span> code(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 结合</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>(Structure):
</span></span><span style=display:flex><span>    _fields_ <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;&lt;d&#39;</span>, <span style=color:#e6db74>&#39;x&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;d&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PolyHeader</span>(Structure):
</span></span><span style=display:flex><span>    _fields_ <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;&lt;i&#39;</span>, <span style=color:#e6db74>&#39;file_code&#39;</span>),
</span></span><span style=display:flex><span>        (Point, <span style=color:#e6db74>&#39;min&#39;</span>),
</span></span><span style=display:flex><span>        (Point, <span style=color:#e6db74>&#39;max&#39;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#39;i&#39;</span>, <span style=color:#e6db74>&#39;num_polys&#39;</span>)
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_polys</span>(filename):
</span></span><span style=display:flex><span>    polys <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        phead <span style=color:#f92672>=</span> PolyHeader<span style=color:#f92672>.</span>from_file(f)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(phead<span style=color:#f92672>.</span>num_polys):
</span></span><span style=display:flex><span>            rec <span style=color:#f92672>=</span> SizedRecord<span style=color:#f92672>.</span>from_file(f, <span style=color:#e6db74>&#39;&lt;i&#39;</span>)
</span></span><span style=display:flex><span>            poly <span style=color:#f92672>=</span> [ (p<span style=color:#f92672>.</span>x, p<span style=color:#f92672>.</span>y) <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> rec<span style=color:#f92672>.</span>iter_as(Point) ]
</span></span><span style=display:flex><span>            polys<span style=color:#f92672>.</span>append(poly)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> polys
</span></span></code></pre></div><p>当一个 Structure 实例被创建时， <code>__init__()</code> 仅仅只是创建一个字节数据的内存视图，没有做其他任何事。</p><p>为了实现懒解包和打包，需要使用 StructField 描述器类。 用户在 <code>_fields_</code> 中列出来的每个属性都会被转化成一个 StructField 描述器， 它将相关结构格式码和偏移值保存到存储缓存中。元类 StructureMeta 在多个结构类被定义时自动创建了这些描述器。</p><p>StructureMeta 的一个很微妙的地方就是它会固定字节数据顺序。也就是说，如果任意的属性指定了一个字节顺序(&lt;表示低位优先 或者 >表示高位优先)， 那后面所有字段的顺序都以这个顺序为准。</p><h1 id=函数>函数
<a class=header-anchor href=#%e5%87%bd%e6%95%b0></a></h1><h2 id=匿名函数捕获变量值>匿名函数捕获变量值
<a class=header-anchor href=#%e5%8c%bf%e5%90%8d%e5%87%bd%e6%95%b0%e6%8d%95%e8%8e%b7%e5%8f%98%e9%87%8f%e5%80%bc></a></h2><p>如果你想让某个匿名函数在定义时就捕获到值，可以将那个参数值定义成默认参数即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> y, x<span style=color:#f92672>=</span>x: x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> y, x<span style=color:#f92672>=</span>x: x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>a(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 20</span>
</span></span><span style=display:flex><span>b(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 30</span>
</span></span></code></pre></div><h2 id=带额外状态信息的回调函数>带额外状态信息的回调函数
<a class=header-anchor href=#%e5%b8%a6%e9%a2%9d%e5%a4%96%e7%8a%b6%e6%80%81%e4%bf%a1%e6%81%af%e7%9a%84%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>apply_asnc</span>(func, args, <span style=color:#f92672>*</span>, callback):
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> func(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    callback(result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 回调函数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_result</span>(result):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got:&#39;</span>, result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>), callback<span style=color:#f92672>=</span>print_result)
</span></span><span style=display:flex><span><span style=color:#75715e># Got: 5</span>
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#e6db74>&#39;hello&#39;</span>, <span style=color:#e6db74>&#39;world&#39;</span>), callback<span style=color:#f92672>=</span>print_result)
</span></span><span style=display:flex><span><span style=color:#75715e># Got: helloworld</span>
</span></span></code></pre></div><p>使回调函数访问其他变量或者特定环境的变量值</p><h3 id=类实例>类实例
<a class=header-anchor href=#%e7%b1%bb%e5%ae%9e%e4%be%8b></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResultHandler</span>(object):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sequence <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handler</span>(self, result):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sequence <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;[</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>] Got: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>sequenceee, result))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> ResultHandler()
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>), callback<span style=color:#f92672>=</span>r<span style=color:#f92672>.</span>handler)
</span></span><span style=display:flex><span><span style=color:#75715e># [1] Got: 5</span>
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#e6db74>&#39;hello&#39;</span>, <span style=color:#e6db74>&#39;world&#39;</span>), callback<span style=color:#f92672>=</span>r<span style=color:#f92672>.</span>handler)
</span></span><span style=display:flex><span><span style=color:#75715e># [2] Got: helloworld</span>
</span></span></code></pre></div><h3 id=函数闭包>函数闭包
<a class=header-anchor href=#%e5%87%bd%e6%95%b0%e9%97%ad%e5%8c%85></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_handler</span>():
</span></span><span style=display:flex><span>    sequence <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handler</span>(result):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>nonlocal</span> sequence
</span></span><span style=display:flex><span>        sequence <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;[</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>] Got: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(sequence, result))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> handler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>handler <span style=color:#f92672>=</span> make_handler()
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>), callback<span style=color:#f92672>=</span>handler)
</span></span><span style=display:flex><span><span style=color:#75715e># [1] Got: 5</span>
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#e6db74>&#39;hello&#39;</span>, <span style=color:#e6db74>&#39;world&#39;</span>), callback<span style=color:#f92672>=</span>handler)
</span></span><span style=display:flex><span><span style=color:#75715e># [2] Got: helloworld</span>
</span></span></code></pre></div><h3 id=协程方法>协程方法
<a class=header-anchor href=#%e5%8d%8f%e7%a8%8b%e6%96%b9%e6%b3%95></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_handler</span>():
</span></span><span style=display:flex><span>    sequence <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>        sequence <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;[</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>] Got: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(sequence, result))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>handler <span style=color:#f92672>=</span> make_handler()
</span></span><span style=display:flex><span>next(handler) <span style=color:#75715e># Advance to the yield</span>
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>), callback<span style=color:#f92672>=</span>handler<span style=color:#f92672>.</span>send)
</span></span><span style=display:flex><span><span style=color:#75715e># [1] Got: 5</span>
</span></span><span style=display:flex><span>apply_async(add, (<span style=color:#e6db74>&#39;hello&#39;</span>, <span style=color:#e6db74>&#39;world&#39;</span>), callback<span style=color:#f92672>=</span>handler<span style=color:#f92672>.</span>send)
</span></span><span style=display:flex><span><span style=color:#75715e># [2] Got: helloworld</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 仅仅只需要给回调函数传递额外的值</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apply_async<span style=color:#960050;background-color:#1e0010>（</span>add, (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>), callback<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> r: handler(r, seq))
</span></span><span style=display:flex><span><span style=color:#75715e># [1] Got: 5</span>
</span></span></code></pre></div><p>至少有两种主要方式来捕获和保存状态信息，你可以在一个对象实例(通过一个绑定方法)或者在一个闭包中保存它。 两种方式相比，闭包或许是更加轻量级和自然一点，因为它们可以很简单的通过函数来构造。</p><h2 id=内联回调函数>内联回调函数
<a class=header-anchor href=#%e5%86%85%e8%81%94%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0></a></h2><p>当你编写使用回调函数的代码的时候，担心很多小函数的扩张可能会弄乱程序控制流。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> queue <span style=color:#f92672>import</span> Queue
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>apply_async</span>(func, args, <span style=color:#f92672>*</span>, callback):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Compute the result</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> func(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Invoke the callback with the result</span>
</span></span><span style=display:flex><span>    callback(result)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Async</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, func, args):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>func <span style=color:#f92672>=</span> func
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>args <span style=color:#f92672>=</span> args
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>inlined_async</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        f <span style=color:#f92672>=</span> func(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>        result_queue <span style=color:#f92672>=</span> Queue()
</span></span><span style=display:flex><span>        result_queue<span style=color:#f92672>.</span>put(<span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> result_queue<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                a <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>send(result)
</span></span><span style=display:flex><span>                apply_async(a<span style=color:#f92672>.</span>func, a<span style=color:#f92672>.</span>args, callback<span style=color:#f92672>=</span>result_queue<span style=color:#f92672>.</span>put)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@inlined_async</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test</span>():
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span> Async(add, (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>    print(r)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span> Async(add, (<span style=color:#e6db74>&#39;hello&#39;</span>, <span style=color:#e6db74>&#39;world&#39;</span>))
</span></span><span style=display:flex><span>    print(r)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>):
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span> Async(add, (n, n))
</span></span><span style=display:flex><span>        print(r)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Goodbye&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test()
</span></span><span style=display:flex><span><span style=color:#75715e># 5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># helloworld</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 6</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 8</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 10</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 12</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 14</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 16</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 18</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Goodbye</span>
</span></span></code></pre></div><p>yield 操作会使一个生成器函数产生一个值并暂停。 接下来调用生成器的 <code>__next__()</code> 或 <code>send()</code> 方法又会让它从暂停处继续执行。</p><p>核心就在 <code>inline_async()</code> 装饰器函数中了。 关键点就是，装饰器会逐步遍历生成器函数的所有 yield 语句，每一次一个。 为了这样做，刚开始的时候创建了一个 result 队列并向里面放入一个 None 值。 然后开始一个循环操作，从队列中取出结果值并发送给生成器，它会持续到下一个 yield 语句， 在这里一个 Async 的实例被接受到。然后循环开始检查函数和参数，并开始进行异步计算 <code>apply_async()</code> 。 然而，这个计算有个最诡异部分是它并没有使用一个普通的回调函数，而是用队列的 <code>put()</code> 方法来回调。</p><p>将复杂的控制流隐藏到生成器函数背后的例子在标准库和第三方包中都能看到。 比如，在 contextlib 中的 @contextmanager 装饰器使用了一个令人费解的技巧， 通过一个 yield 语句将进入和离开上下文管理器粘合在一起。</p><h2 id=访问闭包中定义的变量>访问闭包中定义的变量
<a class=header-anchor href=#%e8%ae%bf%e9%97%ae%e9%97%ad%e5%8c%85%e4%b8%ad%e5%ae%9a%e4%b9%89%e7%9a%84%e5%8f%98%e9%87%8f></a></h2><p>扩展函数中的某个闭包，允许它能访问和修改函数的内部变量。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClosureInstance</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, locals<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> locals <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            locals <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>_getframe(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>f_locals
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Update instance dictionary with callables</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__dict__<span style=color:#f92672>.</span>update((key,value) <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> locals<span style=color:#f92672>.</span>items()
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> callable(value) )
</span></span><span style=display:flex><span>    <span style=color:#75715e># Redirect special methods</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __len__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__dict__[<span style=color:#e6db74>&#39;__len__&#39;</span>]()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Stack</span>():
</span></span><span style=display:flex><span>    items <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>push</span>(item):
</span></span><span style=display:flex><span>        items<span style=color:#f92672>.</span>append(item)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pop</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> items<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __len__():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> len(items)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ClosureInstance()
</span></span></code></pre></div><h1 id=类与对象>类与对象
<a class=header-anchor href=#%e7%b1%bb%e4%b8%8e%e5%af%b9%e8%b1%a1></a></h1><h2 id=让对象支持上下文管理协议>让对象支持上下文管理协议
<a class=header-anchor href=#%e8%ae%a9%e5%af%b9%e8%b1%a1%e6%94%af%e6%8c%81%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e5%8d%8f%e8%ae%ae></a></h2><p>为了让一个对象兼容 with 语句，你需要实现 <code>__enter__()</code> 和 <code>__exit__()</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LazyConnection</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, address, family<span style=color:#f92672>=</span>AF_INET, type<span style=color:#f92672>=</span>SOCK_STREAM):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> address
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>family <span style=color:#f92672>=</span> family
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> type
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>sock <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Already connected&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> socket(self<span style=color:#f92672>.</span>family, self<span style=color:#f92672>.</span>type)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>address)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>sock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_ty, exc_val, tb):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> LazyConnection((<span style=color:#e6db74>&#39;www.python.org&#39;</span>, <span style=color:#ae81ff>80</span>))
</span></span><span style=display:flex><span><span style=color:#75715e># Connection closed</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> conn <span style=color:#66d9ef>as</span> s:
</span></span><span style=display:flex><span>    <span style=color:#75715e># conn.__enter__() executes: connection open</span>
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;GET /index.html HTTP/1.0</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Host: www.python.org</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(iter(partial(s<span style=color:#f92672>.</span>recv, <span style=color:#ae81ff>8192</span>), <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#75715e># conn.__exit__() executes: connection closed</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 支持嵌套版本</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LazyConnection</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, address, family<span style=color:#f92672>=</span>AF_INET, type<span style=color:#f92672>=</span>SOCK_STREAM):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> address
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>family <span style=color:#f92672>=</span> family
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> type
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>connections <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> socket(self<span style=color:#f92672>.</span>family, self<span style=color:#f92672>.</span>type)
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>address)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>connections<span style=color:#f92672>.</span>append(sock)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_ty, exc_val, tb):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>connections<span style=color:#f92672>.</span>pop()<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> LazyConnection((<span style=color:#e6db74>&#39;www.python.org&#39;</span>, <span style=color:#ae81ff>80</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> conn <span style=color:#66d9ef>as</span> s1:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> conn <span style=color:#66d9ef>as</span> s2:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># s1 and s2 are independent sockets</span>
</span></span></code></pre></div><p>编写上下文管理器的主要原理是你的代码会放到 with 语句块中执行。 当出现 with 语句的时候，对象的 <code>__enter__()</code> 方法被触发， 它返回的值(如果有的话)会被赋值给 as 声明的变量。然后，with 语句块里面的代码开始执行。 最后，<code>__exit__()</code> 方法被触发进行清理工作，<code>__exit__()</code> 方法的第三个参数包含了异常类型、异常值和追溯信息(如果有的话)。</p><h2 id=创建大量对象节省内存方法>创建大量对象节省内存方法
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e5%a4%a7%e9%87%8f%e5%af%b9%e8%b1%a1%e8%8a%82%e7%9c%81%e5%86%85%e5%ad%98%e6%96%b9%e6%b3%95></a></h2><p>对于主要是用来当成简单的数据结构的类而言，你可以通过给类添加 <strong>slots</strong> 属性来极大的减少实例所占的内存。</p><p>关于 <strong>slots</strong> 的一个常见误区是它可以作为一个封装工具来防止用户给实例增加新的属性。 尽管使用slots可以达到这样的目的，但是这个并不是它的初衷。 <strong>slots</strong> 更多的是用来作为一个内存优化工具。</p><h2 id=在类中封装属性名>在类中封装属性名
<a class=header-anchor href=#%e5%9c%a8%e7%b1%bb%e4%b8%ad%e5%b0%81%e8%a3%85%e5%b1%9e%e6%80%a7%e5%90%8d></a></h2><p>大多数而言，你应该让你的非公共名称以<strong>单下划线</strong>开头。但是，如果代码会涉及到子类， 并且有些内部属性应该在子类中隐藏起来，那么才考虑使用<strong>双下划线</strong>方案，这种属性通过继承是无法被覆盖的。定义的一个变量和某个保留关键字冲突，这时候可以使用单下划线作为后缀。</p><h2 id=创建可管理的属性>创建可管理的属性
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e5%8f%af%e7%ae%a1%e7%90%86%e7%9a%84%e5%b1%9e%e6%80%a7></a></h2><p>增加除访问与修改之外的其他处理逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, first_name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>first_name <span style=color:#f92672>=</span> first_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Getter function</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>first_name</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_first_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Setter function</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@first_name.setter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>first_name</span>(self, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, str):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected a string&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_first_name <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Deleter function (optional)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@first_name.deleter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>first_name</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>(<span style=color:#e6db74>&#34;Can&#39;t delete attribute&#34;</span>)
</span></span></code></pre></div><p>property 的一个关键特征是它看上去跟普通的 attribute 没什么两样， 但是访问它的时候会自动触发 getter 、setter 和 deleter 方法。</p><p>上述代码中有三个相关联的方法，这三个方法的名字都必须一样。 第一个方法是一个 getter 函数，它使得 first_name 成为一个属性。在实现一个property的时候，底层数据(如果有的话)仍然需要存储在某个地方。 因此，在 get 和 set 方法中，你会看到对 _first_name 属性的操作，这也是实际数据保存的地方。</p><h2 id=调用父类方法>调用父类方法
<a class=header-anchor href=#%e8%b0%83%e7%94%a8%e7%88%b6%e7%b1%bb%e6%96%b9%e6%b3%95></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(A):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, obj):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_obj <span style=color:#f92672>=</span> obj
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Delegate attribute lookup to internal obj</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattr__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>_obj, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Delegate attribute assignment</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setattr__(self, name, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;_&#39;</span>):
</span></span><span style=display:flex><span>            super()<span style=color:#f92672>.</span>__setattr__(name, value) <span style=color:#75715e># Call original __setattr__</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            setattr(self<span style=color:#f92672>.</span>_obj, name, value)
</span></span></code></pre></div><ul><li>super() 函数的一个常见用法是在 <strong>init</strong>() 方法中确保父类被正确的初始化了</li><li>super() 的另外一个常见用法出现在覆盖 Python 特殊方法的代码</li></ul><p>当你使用 <code>super()</code> 函数时，Python会在MRO列表上继续搜索下一个类。 只要每个重定义的方法统一使用 <code>super()</code> 并只调用它一次， 那么控制流最终会遍历完整个MRO列表，每个方法也只会被调用一次。</p><p><code>super()</code> 有个令人吃惊的地方是它并不一定去查找某个类在MRO中下一个直接父类， 你甚至可以在一个没有直接父类的类中使用它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;A.spam&#39;</span>)
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>spam()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a <span style=color:#f92672>=</span> A()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a<span style=color:#f92672>.</span>spam()
</span></span><span style=display:flex><span>A<span style=color:#f92672>.</span>spam
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>    File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>4</span>, <span style=color:#f92672>in</span> spam
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeError</span>: <span style=color:#e6db74>&#39;super&#39;</span> object has no attribute <span style=color:#e6db74>&#39;spam&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self):
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>         print(<span style=color:#e6db74>&#39;B.spam&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>C</span>(A,B):
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c <span style=color:#f92672>=</span> C()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>spam()
</span></span><span style=display:flex><span>A<span style=color:#f92672>.</span>spam
</span></span><span style=display:flex><span>B<span style=color:#f92672>.</span>spam
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><p><strong>准则</strong></p><p>首先，确保在继承体系中所有相同名字的方法拥有可兼容的参数签名(比如相同的参数个数和参数名称)。 这样可以确保 <code>super()</code> 调用一个非直接父类方法时不会出错。 其次，最好确保最顶层的类提供了这个方法的实现，这样的话在MRO上面的查找链肯定可以找到某个确定的方法。</p><h2 id=子类中拓展-property>子类中拓展 property
<a class=header-anchor href=#%e5%ad%90%e7%b1%bb%e4%b8%ad%e6%8b%93%e5%b1%95-property></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Getter function</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Setter function</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@name.setter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, str):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected a string&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_name <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Deleter function</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@name.deleter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>(<span style=color:#e6db74>&#34;Can&#39;t delete attribute&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubPerson</span>(Person):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting name&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@name.setter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self, value):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Setting name to&#39;</span>, value)
</span></span><span style=display:flex><span>        super(SubPerson, SubPerson)<span style=color:#f92672>.</span>name<span style=color:#f92672>.</span>__set__(self, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@name.deleter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Deleting name&#39;</span>)
</span></span><span style=display:flex><span>        super(SubPerson, SubPerson)<span style=color:#f92672>.</span>name<span style=color:#f92672>.</span>__delete__(self)
</span></span><span style=display:flex><span><span style=color:#75715e># 仅修改一个方法</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubPerson</span>(Person):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Person.name.getter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting name&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>name
</span></span></code></pre></div><p>property其实是 getter、setter 和 deleter 方法的集合，而不是单个方法。 因此，当你扩展一个property的时候，你需要先确定你是否要重新定义所有的方法还是说只修改其中某一个。如果你只想重定义其中一个方法，那只使用 @property 本身是不够的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubPerson</span>(Person):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>  <span style=color:#75715e># Doesn&#39;t work</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting name&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> SubPerson(<span style=color:#e6db74>&#39;Guido&#39;</span>)
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>    File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    File <span style=color:#e6db74>&#34;example.py&#34;</span>, line <span style=color:#ae81ff>5</span>, <span style=color:#f92672>in</span> __init__
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span><span style=color:#a6e22e>AttributeError</span>: can<span style=color:#e6db74>&#39;t set attribute</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 正确方式</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubPerson</span>(Person):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Person.name.getter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting name&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>name
</span></span></code></pre></div><h3 id=描述符方式>描述符方式
<a class=header-anchor href=#%e6%8f%8f%e8%bf%b0%e7%ac%a6%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># A descriptor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>String</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, str):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected a string&#39;</span>)
</span></span><span style=display:flex><span>        instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A class with a descriptor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>:
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> String(<span style=color:#e6db74>&#39;name&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extending a descriptor with a property</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubPerson</span>(Person):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting name&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@name.setter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self, value):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Setting name to&#39;</span>, value)
</span></span><span style=display:flex><span>        super(SubPerson, SubPerson)<span style=color:#f92672>.</span>name<span style=color:#f92672>.</span>__set__(self, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@name.deleter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Deleting name&#39;</span>)
</span></span><span style=display:flex><span>        super(SubPerson, SubPerson)<span style=color:#f92672>.</span>name<span style=color:#f92672>.</span>__delete__(self)
</span></span></code></pre></div><h2 id=创建新的类或实例属性>创建新的类或实例属性
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e6%96%b0%e7%9a%84%e7%b1%bb%e6%88%96%e5%ae%9e%e4%be%8b%e5%b1%9e%e6%80%a7></a></h2><p>目的：创建一个新的拥有一些额外功能的实例属性类型，比如类型检查。</p><p>一个描述器就是一个实现了三个核心的属性访问操作(get, set, delete)的类， 分别为 <code>__get__()</code> 、<code>__set__()</code> 和 <code>__delete__()</code> 这三个特殊的方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Descriptor attribute for an integer type-checked attribute</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Integer</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># getattr(instance, self.name) 会造成递归</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, int):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected an int&#39;</span>)
</span></span><span style=display:flex><span>        instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __delete__(self, instance):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>:
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> Integer(<span style=color:#e6db74>&#39;x&#39;</span>)
</span></span><span style=display:flex><span>    y <span style=color:#f92672>=</span> Integer(<span style=color:#e6db74>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, x, y):
</span></span><span style=display:flex><span>        <span style=color:#75715e># self.x = Integer(&#39;x&#39;) # No! Must be a class variable</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># self.y = Integer(&#39;y&#39;)</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> x
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> y
</span></span></code></pre></div><p>描述器的一个比较困惑的地方是它只能在<strong>类级别</strong>被定义，而不能为每个实例单独定义。</p><p><code>__get__()</code> 看上去有点复杂的原因归结于实例变量和类变量的不同。 如果一个描述器被当做一个类变量来访问，那么 instance 参数被设置成 None 。</p><h3 id=类型检查描述符>类型检查描述符
<a class=header-anchor href=#%e7%b1%bb%e5%9e%8b%e6%a3%80%e6%9f%a5%e6%8f%8f%e8%bf%b0%e7%ac%a6></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Descriptor for a type-checked attribute</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Typed</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, expected_type):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>expected_type <span style=color:#f92672>=</span> expected_type
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, self<span style=color:#f92672>.</span>expected_type):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected &#39;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>expected_type))
</span></span><span style=display:flex><span>        instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __delete__(self, instance):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Class decorator that applies it to selected attributes</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>typeassert</span>(<span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate</span>(cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, expected_type <span style=color:#f92672>in</span> kwargs<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#75715e># Attach a Typed descriptor to the class</span>
</span></span><span style=display:flex><span>            setattr(cls, name, Typed(name, expected_type))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decorate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@typeassert</span>(name<span style=color:#f92672>=</span>str, shares<span style=color:#f92672>=</span>int, price<span style=color:#f92672>=</span>float)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, shares, price):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> shares
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>price <span style=color:#f92672>=</span> price
</span></span></code></pre></div><h2 id=延迟计算属性>延迟计算属性
<a class=header-anchor href=#%e5%bb%b6%e8%bf%9f%e8%ae%a1%e7%ae%97%e5%b1%9e%e6%80%a7></a></h2><p>目的：将一个只读属性定义成一个property，并且只在访问的时候才会计算结果。 但是一旦被访问后，你希望结果值被缓存起来，不用每次都去计算。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>lazyproperty</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, func):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>func <span style=color:#f92672>=</span> func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>func(instance)
</span></span><span style=display:flex><span>            setattr(instance, self<span style=color:#f92672>.</span>func<span style=color:#f92672>.</span>__name__, value)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Circle</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, radius):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>radius <span style=color:#f92672>=</span> radius
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@lazyproperty</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>area</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Computing area&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> math<span style=color:#f92672>.</span>pi <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>radius <span style=color:#f92672>**</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@lazyproperty</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>perimeter</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Computing perimeter&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> math<span style=color:#f92672>.</span>pi <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>radius
</span></span></code></pre></div><p>方案有一个小缺陷就是计算出的值被创建后是可以被修改的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lazyproperty</span>(func):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;_lazy_&#39;</span> <span style=color:#f92672>+</span> func<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lazy</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> hasattr(self, name):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> getattr(self, name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> func(self)
</span></span><span style=display:flex><span>            setattr(self, name, value)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> lazy
</span></span></code></pre></div><p>然而，这种方案有一个缺点就是所有get操作都必须被定向到属性的 getter 函数上去，相对而言效率要低。</p><h2 id=简化数据结构初始化>简化数据结构初始化
<a class=header-anchor href=#%e7%ae%80%e5%8c%96%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e5%88%9d%e5%a7%8b%e5%8c%96></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure1</span>:
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(args) <span style=color:#f92672>&gt;</span> len(self<span style=color:#f92672>.</span>_fields):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> arguments&#39;</span><span style=color:#f92672>.</span>format(len(self<span style=color:#f92672>.</span>_fields)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Set all of the positional arguments</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> zip(self<span style=color:#f92672>.</span>_fields, args):
</span></span><span style=display:flex><span>            setattr(self, name, value)
</span></span><span style=display:flex><span>        <span style=color:#75715e># ==         self.__dict__.update(zip(self._fields,args))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Set the remaining keyword arguments</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 支持关键词参数</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_fields[len(args):]:
</span></span><span style=display:flex><span>            setattr(self, name, kwargs<span style=color:#f92672>.</span>pop(name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Check for any remaining unknown arguments</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> kwargs:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Invalid argument(s): </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(<span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>.</span>join(kwargs)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example class definitions</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>(Structure1):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#e6db74>&#39;shares&#39;</span>, <span style=color:#e6db74>&#39;price&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>(Structure1):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Circle</span>(Structure1):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;radius&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>area</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> math<span style=color:#f92672>.</span>pi <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>radius <span style=color:#f92672>**</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 支持额外的参数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure2</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Class variable that specifies expected fields</span>
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(args) <span style=color:#f92672>!=</span> len(self<span style=color:#f92672>.</span>_fields):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> arguments&#39;</span><span style=color:#f92672>.</span>format(len(self<span style=color:#f92672>.</span>_fields)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Set the arguments</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> zip(self<span style=color:#f92672>.</span>_fields, args):
</span></span><span style=display:flex><span>            setattr(self, name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Set the additional arguments (if any)</span>
</span></span><span style=display:flex><span>        extra_args <span style=color:#f92672>=</span> kwargs<span style=color:#f92672>.</span>keys() <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>_fields
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> extra_args:
</span></span><span style=display:flex><span>            setattr(self, name, kwargs<span style=color:#f92672>.</span>pop(name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> kwargs:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Duplicate values for </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(<span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>.</span>join(kwargs)))
</span></span></code></pre></div><h2 id=定义接口或者抽象基类>定义接口或者抽象基类
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89%e6%8e%a5%e5%8f%a3%e6%88%96%e8%80%85%e6%8a%bd%e8%b1%a1%e5%9f%ba%e7%b1%bb></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> abc <span style=color:#f92672>import</span> ABCMeta, abstractmethod
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IStream</span>(metaclass<span style=color:#f92672>=</span>ABCMeta):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@abstractmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, maxbytes<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@abstractmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, data):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 注册方法</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Register the built-in I/O classes as supporting our interface</span>
</span></span><span style=display:flex><span>IStream<span style=color:#f92672>.</span>register(io<span style=color:#f92672>.</span>IOBase)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Open a normal file and type check</span>
</span></span><span style=display:flex><span>f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;foo.txt&#39;</span>)
</span></span><span style=display:flex><span>isinstance(f, IStream) <span style=color:#75715e># Returns True</span>
</span></span></code></pre></div><p>抽象类的目的就是让别的类继承它并实现特定的抽象方法，除了继承这种方式外，还可以通过注册方式来让某个类实现抽象基类。</p><p>抽象基类的一个主要用途是在代码中检查某些类是否为特定类型，实现了特定接口。</p><p><strong>Note</strong>：@abstractmethod 还能注解静态方法、类方法和 properties 。 你只需保证这个注解紧靠在函数定义前即可</p><p>标准库中有很多用到抽象基类的地方。collections 模块定义了很多跟容器和迭代器(序列、映射、集合等)有关的抽象基类。 numbers 库定义了跟数字对象(整数、浮点数、有理数等)有关的基类。io 库定义了很多跟I/O操作相关的基类。</p><h2 id=实现数据模型的类型约束>实现数据模型的类型约束
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e6%95%b0%e6%8d%ae%e6%a8%a1%e5%9e%8b%e7%9a%84%e7%b1%bb%e5%9e%8b%e7%ba%a6%e6%9d%9f></a></h2><p>目的：限制某些在属性赋值上的数据结构</p><p>// TODO
<a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c08/p13_implementing_data_model_or_type_system.html title=理解 rel="noopener external nofollow noreferrer" target=_blank class=exturl>理解
<i class="fa fa-external-link-alt"></i></a></p><h3 id=描述符方式-1>描述符方式
<a class=header-anchor href=#%e6%8f%8f%e8%bf%b0%e7%ac%a6%e6%96%b9%e5%bc%8f-1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 设置属性描述符</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Base class. Uses a descriptor to set a value</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Descriptor</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, <span style=color:#f92672>**</span>opts):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> opts<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            setattr(self, key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 类型检查描述符</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Descriptor for enforcing types</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Typed</span>(Descriptor):
</span></span><span style=display:flex><span>    expected_type <span style=color:#f92672>=</span> type(<span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, self<span style=color:#f92672>.</span>expected_type):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;expected &#39;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>expected_type))
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__set__(instance, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 参数检查描述符</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Descriptor for enforcing values</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Unsigned</span>(Descriptor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> value <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;Expected &gt;= 0&#39;</span>)
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__set__(instance, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MaxSized</span>(Descriptor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, <span style=color:#f92672>**</span>opts):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;size&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> opts:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;missing size option&#39;</span>)
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(name, <span style=color:#f92672>**</span>opts)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(value) <span style=color:#f92672>&gt;=</span> self<span style=color:#f92672>.</span>size:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;size must be &lt; &#39;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>size))
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__set__(instance, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义数据类型</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Integer</span>(Typed):
</span></span><span style=display:flex><span>    expected_type <span style=color:#f92672>=</span> int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnsignedInteger</span>(Integer, Unsigned):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Float</span>(Typed):
</span></span><span style=display:flex><span>    expected_type <span style=color:#f92672>=</span> float
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnsignedFloat</span>(Float, Unsigned):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>String</span>(Typed):
</span></span><span style=display:flex><span>    expected_type <span style=color:#f92672>=</span> str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SizedString</span>(String, MaxSized):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义类</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Specify constraints</span>
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> SizedString(<span style=color:#e6db74>&#39;name&#39;</span>, size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    shares <span style=color:#f92672>=</span> UnsignedInteger(<span style=color:#e6db74>&#39;shares&#39;</span>)
</span></span><span style=display:flex><span>    price <span style=color:#f92672>=</span> UnsignedFloat(<span style=color:#e6db74>&#39;price&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, shares, price):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> shares
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>price <span style=color:#f92672>=</span> price
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> Stock(<span style=color:#e6db74>&#39;ACME&#39;</span>, <span style=color:#ae81ff>75</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;ACME&#39;</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> <span style=color:#ae81ff>75</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Traceback (most recent call last):</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     File &#34;example.py&#34;, line 17, in __set__</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         super().__set__(instance, value)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     File &#34;example.py&#34;, line 23, in __set__</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         raise ValueError(&#39;Expected &gt;= 0&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ValueError: Expected &gt;= 0</span>
</span></span></code></pre></div><h3 id=类型检查类装饰器方式>类型检查类装饰器方式
<a class=header-anchor href=#%e7%b1%bb%e5%9e%8b%e6%a3%80%e6%9f%a5%e7%b1%bb%e8%a3%85%e9%a5%b0%e5%99%a8%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Class decorator to apply constraints</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_attributes</span>(<span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate</span>(cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> kwargs<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#75715e># 实例对象</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(value, Descriptor):
</span></span><span style=display:flex><span>                <span style=color:#75715e># name 名称</span>
</span></span><span style=display:flex><span>                value<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> key
</span></span><span style=display:flex><span>                setattr(cls, key, value)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># 非实例</span>
</span></span><span style=display:flex><span>                setattr(cls, key, value(key))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decorate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@check_attributes</span>(name<span style=color:#f92672>=</span>SizedString(size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>                  shares<span style=color:#f92672>=</span>UnsignedInteger,
</span></span><span style=display:flex><span>                  price<span style=color:#f92672>=</span>UnsignedFloat)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, shares, price):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> shares
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>price <span style=color:#f92672>=</span> price
</span></span></code></pre></div><h3 id=类型检查元类方式>类型检查元类方式
<a class=header-anchor href=#%e7%b1%bb%e5%9e%8b%e6%a3%80%e6%9f%a5%e5%85%83%e7%b1%bb%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># A metaclass that applies checking</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>checkedmeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, clsname, bases, methods):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Attach attribute names to the descriptors</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key, value <span style=color:#f92672>in</span> methods<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(value, Descriptor):
</span></span><span style=display:flex><span>                value<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> key
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> type<span style=color:#f92672>.</span>__new__(cls, clsname, bases, methods)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock2</span>(metaclass<span style=color:#f92672>=</span>checkedmeta):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> SizedString(size<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    shares <span style=color:#f92672>=</span> UnsignedInteger()
</span></span><span style=display:flex><span>    price <span style=color:#f92672>=</span> UnsignedFloat()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, shares, price):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> shares
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>price <span style=color:#f92672>=</span> price
</span></span></code></pre></div><p>所有方法中，类装饰器方案应该是最灵活和最高明的。 首先，它并不依赖任何其他新的技术，比如元类。其次，装饰器可以很容易的添加或删除。最后，装饰器还能作为混入类的替代技术来实现同样的效果。</p><h3 id=类装饰器方式>类装饰器方式
<a class=header-anchor href=#%e7%b1%bb%e8%a3%85%e9%a5%b0%e5%99%a8%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Decorator for applying type checking</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Typed</span>(expected_type, cls<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> cls <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>lambda</span> cls: Typed(expected_type, cls)
</span></span><span style=display:flex><span>    super_set <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__set__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, expected_type):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;expected &#39;</span> <span style=color:#f92672>+</span> str(expected_type))
</span></span><span style=display:flex><span>        super_set(self, instance, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__set__ <span style=color:#f92672>=</span> __set__
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Decorator for unsigned values</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Unsigned</span>(cls):
</span></span><span style=display:flex><span>    super_set <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__set__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> value <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;Expected &gt;= 0&#39;</span>)
</span></span><span style=display:flex><span>        super_set(self, instance, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__set__ <span style=color:#f92672>=</span> __set__
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Decorator for allowing sized values</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>MaxSized</span>(cls):
</span></span><span style=display:flex><span>    super_init <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__init__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, <span style=color:#f92672>**</span>opts):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;size&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> opts:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;missing size option&#39;</span>)
</span></span><span style=display:flex><span>        super_init(self, name, <span style=color:#f92672>**</span>opts)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__init__ <span style=color:#f92672>=</span> __init__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    super_set <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__set__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(value) <span style=color:#f92672>&gt;=</span> self<span style=color:#f92672>.</span>size:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;size must be &lt; &#39;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>size))
</span></span><span style=display:flex><span>        super_set(self, instance, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__set__ <span style=color:#f92672>=</span> __set__
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Specialized descriptors</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Typed</span>(int)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Integer</span>(Descriptor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Unsigned</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnsignedInteger</span>(Integer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Typed</span>(float)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Float</span>(Descriptor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Unsigned</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnsignedFloat</span>(Float):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Typed</span>(str)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>String</span>(Descriptor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@MaxSized</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SizedString</span>(String):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><h2 id=自定义容器>自定义容器
<a class=header-anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%ae%b9%e5%99%a8></a></h2><p>目的：自定义的类来模拟内置的容器类功能，继承容器模块中的抽象接口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> collections
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> bisect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SortedItems</span>(collections<span style=color:#f92672>.</span>Sequence):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, initial<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_items <span style=color:#f92672>=</span> sorted(initial) <span style=color:#66d9ef>if</span> initial <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#66d9ef>else</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Required sequence methods</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, index):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_items[index]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __len__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> len(self<span style=color:#f92672>.</span>_items)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Method for adding an item in the right location</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(self, item):
</span></span><span style=display:flex><span>        bisect<span style=color:#f92672>.</span>insort(self<span style=color:#f92672>.</span>_items, item)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>items <span style=color:#f92672>=</span> SortedItems([<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span>print(list(items))
</span></span><span style=display:flex><span>print(items[<span style=color:#ae81ff>0</span>], items[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>items<span style=color:#f92672>.</span>add(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>print(list(items))
</span></span></code></pre></div><p>这里面使用到了 bisect 模块，它是一个在排序列表中插入元素的高效方式。可以保证元素插入后还保持顺序。</p><p>使用 collections 中的抽象基类可以确保你自定义的容器实现了所有必要的方法。并且还能简化类型检查。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>items <span style=color:#f92672>=</span> SortedItems()
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> collections
</span></span><span style=display:flex><span>isinstance(items, collections<span style=color:#f92672>.</span>Iterable)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>isinstance(items, collections<span style=color:#f92672>.</span>Sequence)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>isinstance(items, collections<span style=color:#f92672>.</span>Container)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>isinstance(items, collections<span style=color:#f92672>.</span>Sized)
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span><span style=display:flex><span>isinstance(items, collections<span style=color:#f92672>.</span>Mapping)
</span></span><span style=display:flex><span><span style=color:#75715e># False</span>
</span></span></code></pre></div><h2 id=属性的代理访问>属性的代理访问
<a class=header-anchor href=#%e5%b1%9e%e6%80%a7%e7%9a%84%e4%bb%a3%e7%90%86%e8%ae%bf%e9%97%ae></a></h2><p>代理是一种编程模式，它将某个操作转移给另外一个对象来实现，目的可能是作为继承的一个替代方法或者实现代理模式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self, x):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B2</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;使用__getattr__的代理，代理方法比较多时候&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_a <span style=color:#f92672>=</span> A()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Expose all of the methods defined on class A</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattr__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;这个方法在访问的attribute不存在的时候被调用
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        the __getattr__() method is actually a fallback method
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        that only gets called when an attribute is not found&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>_a, name)
</span></span></code></pre></div><h3 id=代理类方式>代理类方式
<a class=header-anchor href=#%e4%bb%a3%e7%90%86%e7%b1%bb%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># A proxy class that wraps around another object, but</span>
</span></span><span style=display:flex><span><span style=color:#75715e># exposes its public attributes</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, obj):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_obj <span style=color:#f92672>=</span> obj
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Delegate attribute lookup to internal obj</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattr__(self, name):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;getattr:&#39;</span>, name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>_obj, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Delegate attribute assignment</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setattr__(self, name, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;_&#39;</span>):
</span></span><span style=display:flex><span>            super()<span style=color:#f92672>.</span>__setattr__(name, value)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;setattr:&#39;</span>, name, value)
</span></span><span style=display:flex><span>            setattr(self<span style=color:#f92672>.</span>_obj, name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Delegate attribute deletion</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __delattr__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;_&#39;</span>):
</span></span><span style=display:flex><span>            super()<span style=color:#f92672>.</span>__delattr__(name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;delattr:&#39;</span>, name)
</span></span><span style=display:flex><span>            delattr(self<span style=color:#f92672>.</span>_obj, name)
</span></span></code></pre></div><p>当实现代理模式时，还有些细节需要注意。 首先，<code>__getattr__()</code> 实际是一个后备方法，只有在属性不存在时才会调用。 因此，如果代理类实例本身有这个属性的话，那么不会触发这个方法的。 另外，<code>__setattr__()</code> 和 <code>__delattr__()</code> 需要额外的魔法来区分代理实例和被代理实例 _obj 的属性。 通常的约定是只代理那些不以<strong>下划线 _ 开头</strong>的属性。</p><p><code>__getattr__()</code> 对于大部分以<strong>双下划线(__)开始</strong>和结尾的属性并不适用，为了让它支持这些方法，你必须手动的实现这些方法代理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ListLike</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;__getattr__对于双下划线开始和结尾的方法是不能用的，需要一个个去重定义&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_items <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattr__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>_items, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Added special methods to support certain list operations</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __len__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> len(self<span style=color:#f92672>.</span>_items)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, index):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_items[index]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, index, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_items[index] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __delitem__(self, index):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> self<span style=color:#f92672>.</span>_items[index]
</span></span></code></pre></div><h2 id=类中定义多个构造函数>类中定义多个构造函数
<a class=header-anchor href=#%e7%b1%bb%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%a4%9a%e4%b8%aa%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Date</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;方法一：使用类方法&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Primary constructor</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, year, month, day):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>year <span style=color:#f92672>=</span> year
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>month <span style=color:#f92672>=</span> month
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>day <span style=color:#f92672>=</span> day
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Alternate constructor</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>today</span>(cls):
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>localtime()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls(t<span style=color:#f92672>.</span>tm_year, t<span style=color:#f92672>.</span>tm_mon, t<span style=color:#f92672>.</span>tm_mday)
</span></span></code></pre></div><p>类方法的一个<strong>主要用途</strong>就是定义多个构造器。</p><h2 id=利用-mixins-扩展类功能>利用 Mixins 扩展类功能
<a class=header-anchor href=#%e5%88%a9%e7%94%a8-mixins-%e6%89%a9%e5%b1%95%e7%b1%bb%e5%8a%9f%e8%83%bd></a></h2><h3 id=mixin>Mixin
<a class=header-anchor href=#mixin></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedMappingMixin</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Add logging to get/set/delete operations for debugging.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    __slots__ <span style=color:#f92672>=</span> ()  <span style=color:#75715e># 混入类都没有实例变量，因为直接实例化混入类没有任何意义</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, key):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting &#39;</span> <span style=color:#f92672>+</span> str(key))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__getitem__(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, key, value):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Setting </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> = </span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(key, value))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__setitem__(key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __delitem__(self, key):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Deleting &#39;</span> <span style=color:#f92672>+</span> str(key))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__delitem__(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetOnceMappingMixin</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Only allow a key to be set once.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    __slots__ <span style=color:#f92672>=</span> ()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, key, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> key <span style=color:#f92672>in</span> self:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>KeyError</span>(str(key) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; already set&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__setitem__(key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StringKeysMappingMixin</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Restrict keys to strings only
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    __slots__ <span style=color:#f92672>=</span> ()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, key, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(key, str):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;keys must be strings&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__setitem__(key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedDict</span>(LoggedMappingMixin, dict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SetOnceDefaultDict</span>(SetOnceMappingMixin, defaultdict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>这些类单独使用起来没有任何意义，事实上如果你去实例化任何一个类，<strong>除了产生异常外没任何作用</strong>。 它们是用来通过多继承来和其他映射对象混入使用的。</p><p>对于混入类，有几点需要记住。首先是，混入类<strong>不能直接被实例化</strong>使用。 其次，混入类<strong>没有自己的状态信息</strong>，也就是说它们并没有定义 <code>__init__()</code> 方法，并且没有实例属性。 这也是为什么我们在上面明确定义了 <code>__slots__ = ()</code> 。</p><h3 id=类装饰器>类装饰器
<a class=header-anchor href=#%e7%b1%bb%e8%a3%85%e9%a5%b0%e5%99%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>LoggedMapping</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;第二种方式：使用类装饰器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cls_getitem <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__getitem__
</span></span><span style=display:flex><span>    cls_setitem <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__setitem__
</span></span><span style=display:flex><span>    cls_delitem <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__delitem__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, key):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Getting &#39;</span> <span style=color:#f92672>+</span> str(key))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls_getitem(self, key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, key, value):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Setting </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> = </span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(key, value))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls_setitem(self, key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __delitem__(self, key):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Deleting &#39;</span> <span style=color:#f92672>+</span> str(key))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cls_delitem(self, key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__getitem__ <span style=color:#f92672>=</span> __getitem__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__setitem__ <span style=color:#f92672>=</span> __setitem__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__delitem__ <span style=color:#f92672>=</span> __delitem__
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@LoggedMapping</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedDict</span>(dict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><h2 id=实现状态对象或者状态机state行为模式>实现状态对象或者状态机（State行为模式）
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e7%8a%b6%e6%80%81%e5%af%b9%e8%b1%a1%e6%88%96%e8%80%85%e7%8a%b6%e6%80%81%e6%9c%bastate%e8%a1%8c%e4%b8%ba%e6%a8%a1%e5%bc%8f></a></h2><p>目的：实现一个状态机或者是在不同状态下执行操作的对象，但是又不想在代码中出现太多的条件判断语句。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>ConnectionState &lt;|-- ClosedConnectionState
</span></span><span style=display:flex><span>ConnectionState &lt;|-- OpenConnectionState
</span></span><span style=display:flex><span>Connection &#34;1&#34; *-- &#34;n&#34; ConnectionState
</span></span><span style=display:flex><span>Connection &lt;.. ClosedConnectionState
</span></span><span style=display:flex><span>Connection &lt;.. OpenConnectionState
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Connection</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;新方案——对每个状态定义一个类&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 成员变量构成组合</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>new_state(ClosedConnectionState)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new_state</span>(self, newstate):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_state <span style=color:#f92672>=</span> newstate
</span></span><span style=display:flex><span>        <span style=color:#75715e># Delegate to the state class</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_state<span style=color:#f92672>.</span>read(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, data):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_state<span style=color:#f92672>.</span>write(self, data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>open</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_state<span style=color:#f92672>.</span>open(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_state<span style=color:#f92672>.</span>close(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Connection state base class</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConnectionState</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(conn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>NotImplementedError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(conn, data):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>NotImplementedError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>open</span>(conn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>NotImplementedError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(conn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>NotImplementedError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Implementation of different states</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClosedConnectionState</span>(ConnectionState):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(conn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Not open&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(conn, data):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Not open&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 形参构成依赖</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>open</span>(conn):
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>new_state(OpenConnectionState)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(conn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Already closed&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenConnectionState</span>(ConnectionState):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(conn):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;reading&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(conn, data):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;writing&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>open</span>(conn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Already open&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 形参构成依赖</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(conn):
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>new_state(ClosedConnectionState)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> Connection()
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>_state
</span></span><span style=display:flex><span><span style=color:#75715e># &lt;class &#39;__main__.ClosedConnectionState&#39;&gt;</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span><span style=color:#75715e># Traceback (most recent call last):</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     File &#34;example.py&#34;, line 10, in read</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         return self._state.read(self)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     File &#34;example.py&#34;, line 43, in read</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#         raise RuntimeError(&#39;Not open&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># RuntimeError: Not open</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>open()
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>_state
</span></span><span style=display:flex><span><span style=color:#75715e># &lt;class &#39;__main__.OpenConnectionState&#39;&gt;</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span><span style=color:#75715e># reading</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;hello&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># writing</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>_state
</span></span><span style=display:flex><span><span style=color:#75715e># &lt;class &#39;__main__.ClosedConnectionState&#39;&gt;</span>
</span></span></code></pre></div><p>每个状态对象都只有静态方法，并没有存储任何的实例属性数据。 实际上，所有状态信息都只存储在 Connection 实例中。</p><h2 id=通过字符串调用对象方法反射自省>通过字符串调用对象方法（反射自省）
<a class=header-anchor href=#%e9%80%9a%e8%bf%87%e5%ad%97%e7%ac%a6%e4%b8%b2%e8%b0%83%e7%94%a8%e5%af%b9%e8%b1%a1%e6%96%b9%e6%b3%95%e5%8f%8d%e5%b0%84%e8%87%aa%e7%9c%81></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, x, y):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> x
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __repr__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Point(</span><span style=color:#e6db74>{!r:}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{!r:}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>x, self<span style=color:#f92672>.</span>y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>distance</span>(self, x, y):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> math<span style=color:#f92672>.</span>hypot(self<span style=color:#f92672>.</span>x <span style=color:#f92672>-</span> x, self<span style=color:#f92672>.</span>y <span style=color:#f92672>-</span> y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> Point(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>d <span style=color:#f92672>=</span> getattr(p, <span style=color:#e6db74>&#39;distance&#39;</span>)(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)  <span style=color:#75715e># Calls p.distance(0, 0)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用 operator.methodcaller()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> operator
</span></span><span style=display:flex><span>operator<span style=color:#f92672>.</span>methodcaller(<span style=color:#e6db74>&#39;distance&#39;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)(p)
</span></span></code></pre></div><h2 id=实现访问者模式>实现访问者模式
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e8%ae%bf%e9%97%ae%e8%80%85%e6%a8%a1%e5%bc%8f></a></h2><p>// TODO
<a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c08/p21_implementing_visitor_pattern.html title=理解 rel="noopener external nofollow noreferrer" target=_blank class=exturl>理解
<i class="fa fa-external-link-alt"></i></a></p><p>目的：处理由大量不同类型的对象组成的复杂数据结构，每一个对象都需要进行不同的处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Node &lt;|-- Number
</span></span><span style=display:flex><span>Node &lt;|-- UnaryOperator
</span></span><span style=display:flex><span>Node &lt;|-- BinaryOperator
</span></span><span style=display:flex><span>BinaryOperator &lt;|-- Add
</span></span><span style=display:flex><span>BinaryOperator &lt;|-- Sub
</span></span><span style=display:flex><span>BinaryOperator &lt;|-- Mul
</span></span><span style=display:flex><span>BinaryOperator &lt;|-- Div
</span></span><span style=display:flex><span>UnaryOperator &lt;|-- Negate
</span></span><span style=display:flex><span>NodeVistor &lt;|-- Evaluater
</span></span><span style=display:flex><span>NodeVistor &lt;|-- StackCode
</span></span><span style=display:flex><span>Evaluater ..&gt; Node
</span></span><span style=display:flex><span>StackCode ..&gt; Node
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnaryOperator</span>(Node):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, operand):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>operand <span style=color:#f92672>=</span> operand
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BinaryOperator</span>(Node):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, left, right):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>left <span style=color:#f92672>=</span> left
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>right <span style=color:#f92672>=</span> right
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Add</span>(BinaryOperator):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Sub</span>(BinaryOperator):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Mul</span>(BinaryOperator):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Div</span>(BinaryOperator):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Negate</span>(UnaryOperator):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Number</span>(Node):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>value <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>t1 <span style=color:#f92672>=</span> Sub(Number(<span style=color:#ae81ff>3</span>), Number(<span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>t2 <span style=color:#f92672>=</span> Mul(Number(<span style=color:#ae81ff>2</span>), t1)
</span></span><span style=display:flex><span>t3 <span style=color:#f92672>=</span> Div(t2, Number(<span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>t4 <span style=color:#f92672>=</span> Add(Number(<span style=color:#ae81ff>1</span>), t3)
</span></span></code></pre></div><h3 id=访问者模式>访问者模式
<a class=header-anchor href=#%e8%ae%bf%e9%97%ae%e8%80%85%e6%a8%a1%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NodeVisitor</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 依赖node</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit</span>(self, node):
</span></span><span style=display:flex><span>        methname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;visit_&#39;</span> <span style=color:#f92672>+</span> type(node)<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>        meth <span style=color:#f92672>=</span> getattr(self, methname, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> meth <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            meth <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>generic_visit
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> meth(node)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generic_visit</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;No </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> method&#39;</span><span style=color:#f92672>.</span>format(<span style=color:#e6db74>&#39;visit_&#39;</span> <span style=color:#f92672>+</span> type(node)<span style=color:#f92672>.</span>__name__))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 为了使用这个类，可以定义一个类继承它并且实现各种 `visit_Name()` 方法，其中Name是node类型。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Evaluator</span>(NodeVisitor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Number</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> node<span style=color:#f92672>.</span>value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Add</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>left) <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Sub</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>left) <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Mul</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>left) <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Div</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>left) <span style=color:#f92672>/</span> self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Negate</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>node<span style=color:#f92672>.</span>operand
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e <span style=color:#f92672>=</span> Evaluator()
</span></span><span style=display:flex><span>e<span style=color:#f92672>.</span>visit(t4)
</span></span></code></pre></div><h3 id=将一个表达式转换成多个操作序列>将一个表达式转换成多个操作序列
<a class=header-anchor href=#%e5%b0%86%e4%b8%80%e4%b8%aa%e8%a1%a8%e8%be%be%e5%bc%8f%e8%bd%ac%e6%8d%a2%e6%88%90%e5%a4%9a%e4%b8%aa%e6%93%8d%e4%bd%9c%e5%ba%8f%e5%88%97></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StackCode</span>(NodeVisitor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_code</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>instructions <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>visit(node)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>instructions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Number</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>instructions<span style=color:#f92672>.</span>append((<span style=color:#e6db74>&#39;PUSH&#39;</span>, node<span style=color:#f92672>.</span>value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>binop</span>(self, node, instruction):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>left)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>instructions<span style=color:#f92672>.</span>append((instruction,))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Add</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>binop(node, <span style=color:#e6db74>&#39;ADD&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Sub</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>binop(node, <span style=color:#e6db74>&#39;SUB&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Mul</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>binop(node, <span style=color:#e6db74>&#39;MUL&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Div</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>binop(node, <span style=color:#e6db74>&#39;DIV&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unaryop</span>(self, node, instruction):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>visit(node<span style=color:#f92672>.</span>operand)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>instructions<span style=color:#f92672>.</span>append((instruction,))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Negate</span>(self, node):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>unaryop(node, <span style=color:#e6db74>&#39;NEG&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> StackCode()
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>generate_code(t4)
</span></span><span style=display:flex><span><span style=color:#75715e># [(&#39;PUSH&#39;, 1), (&#39;PUSH&#39;, 2), (&#39;PUSH&#39;, 3), (&#39;PUSH&#39;, 4), (&#39;SUB&#39;,), (&#39;MUL&#39;,), (&#39;PUSH&#39;, 5), (&#39;DIV&#39;,), (&#39;ADD&#39;,)]</span>
</span></span></code></pre></div><p>这种技术也是实现其他语言中switch或case语句的方式。</p><p>访问者模式一个缺点就是它严重依赖递归，如果数据结构嵌套层次太深可能会有问题。</p><h2 id=不用递归实现访问者模式>不用递归实现访问者模式
<a class=header-anchor href=#%e4%b8%8d%e7%94%a8%e9%80%92%e5%bd%92%e5%ae%9e%e7%8e%b0%e8%ae%bf%e9%97%ae%e8%80%85%e6%a8%a1%e5%bc%8f></a></h2><p>// TODO 理解</p><p>使用生成器可以在树遍历或搜索算法中消除递归。<strong>避免递归的一个通常方法是使用一个栈或队列的数据结构</strong>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NodeVisitor</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit</span>(self, node):
</span></span><span style=display:flex><span>        stack <span style=color:#f92672>=</span> [node]
</span></span><span style=display:flex><span>        last_result <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> stack:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                last <span style=color:#f92672>=</span> stack[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> isinstance(last, types<span style=color:#f92672>.</span>GeneratorType):
</span></span><span style=display:flex><span>                    <span style=color:#75715e># 生成器运行</span>
</span></span><span style=display:flex><span>                    stack<span style=color:#f92672>.</span>append(last<span style=color:#f92672>.</span>send(last_result))
</span></span><span style=display:flex><span>                    last_result <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>elif</span> isinstance(last, Node):
</span></span><span style=display:flex><span>                    <span style=color:#75715e># 访问节点</span>
</span></span><span style=display:flex><span>                    stack<span style=color:#f92672>.</span>append(self<span style=color:#f92672>.</span>_visit(stack<span style=color:#f92672>.</span>pop()))
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                    <span style=color:#75715e># 返回结果</span>
</span></span><span style=display:flex><span>                    last_result <span style=color:#f92672>=</span> stack<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># 抛弃已结束生成器</span>
</span></span><span style=display:flex><span>                stack<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> last_result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_visit</span>(self, node):
</span></span><span style=display:flex><span>        methname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;visit_&#39;</span> <span style=color:#f92672>+</span> type(node)<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>        meth <span style=color:#f92672>=</span> getattr(self, methname, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> meth <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            meth <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>generic_visit
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> meth(node)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generic_visit</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;No </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> method&#39;</span><span style=color:#f92672>.</span>format(<span style=color:#e6db74>&#39;visit_&#39;</span> <span style=color:#f92672>+</span> type(node)<span style=color:#f92672>.</span>__name__))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 替换 yield 关键词</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Evaluator</span>(NodeVisitor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Number</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> node<span style=color:#f92672>.</span>value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Add</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#75715e># return self.visit(node.left) + self.visit(node.right)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>left) <span style=color:#f92672>+</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Sub</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>left) <span style=color:#f92672>-</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Mul</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>left) <span style=color:#f92672>*</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Div</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>left) <span style=color:#f92672>/</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>visit_Negate</span>(self, node):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> <span style=color:#f92672>-</span> (<span style=color:#66d9ef>yield</span> node<span style=color:#f92672>.</span>operand)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>e <span style=color:#f92672>=</span> Evaluator()
</span></span><span style=display:flex><span>e<span style=color:#f92672>.</span>visit(t4)
</span></span></code></pre></div><h2 id=让类支持比较操作>让类支持比较操作
<a class=header-anchor href=#%e8%ae%a9%e7%b1%bb%e6%94%af%e6%8c%81%e6%af%94%e8%be%83%e6%93%8d%e4%bd%9c></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> total_ordering
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Room</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, length, width):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>length <span style=color:#f92672>=</span> length
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>width <span style=color:#f92672>=</span> width
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>square_feet <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>length <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>width
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@total_ordering</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>House</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, style):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>style <span style=color:#f92672>=</span> style
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rooms <span style=color:#f92672>=</span> list()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>living_space_footage</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sum(r<span style=color:#f92672>.</span>square_feet <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>rooms)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_room</span>(self, room):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rooms<span style=color:#f92672>.</span>append(room)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __str__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> square foot </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>name,
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>living_space_footage,
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>style)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __eq__(self, other):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>living_space_footage <span style=color:#f92672>==</span> other<span style=color:#f92672>.</span>living_space_footage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __lt__(self, other):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>living_space_footage <span style=color:#f92672>&lt;</span> other<span style=color:#f92672>.</span>living_space_footage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build a few houses, and add rooms to them</span>
</span></span><span style=display:flex><span>h1 <span style=color:#f92672>=</span> House(<span style=color:#e6db74>&#39;h1&#39;</span>, <span style=color:#e6db74>&#39;Cape&#39;</span>)
</span></span><span style=display:flex><span>h1<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Master Bedroom&#39;</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>21</span>))
</span></span><span style=display:flex><span>h1<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Living Room&#39;</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>20</span>))
</span></span><span style=display:flex><span>h1<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Kitchen&#39;</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>16</span>))
</span></span><span style=display:flex><span>h1<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Office&#39;</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>12</span>))
</span></span><span style=display:flex><span>h2 <span style=color:#f92672>=</span> House(<span style=color:#e6db74>&#39;h2&#39;</span>, <span style=color:#e6db74>&#39;Ranch&#39;</span>)
</span></span><span style=display:flex><span>h2<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Master Bedroom&#39;</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>21</span>))
</span></span><span style=display:flex><span>h2<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Living Room&#39;</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>20</span>))
</span></span><span style=display:flex><span>h2<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Kitchen&#39;</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>16</span>))
</span></span><span style=display:flex><span>h3 <span style=color:#f92672>=</span> House(<span style=color:#e6db74>&#39;h3&#39;</span>, <span style=color:#e6db74>&#39;Split&#39;</span>)
</span></span><span style=display:flex><span>h3<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Master Bedroom&#39;</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>21</span>))
</span></span><span style=display:flex><span>h3<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Living Room&#39;</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>20</span>))
</span></span><span style=display:flex><span>h3<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Office&#39;</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>16</span>))
</span></span><span style=display:flex><span>h3<span style=color:#f92672>.</span>add_room(Room(<span style=color:#e6db74>&#39;Kitchen&#39;</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>17</span>))
</span></span><span style=display:flex><span>houses <span style=color:#f92672>=</span> [h1, h2, h3]
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Is h1 bigger than h2?&#39;</span>, h1 <span style=color:#f92672>&gt;</span> h2) <span style=color:#75715e># prints True</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Is h2 smaller than h3?&#39;</span>, h2 <span style=color:#f92672>&lt;</span> h3) <span style=color:#75715e># prints True</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Is h2 greater than or equal to h1?&#39;</span>, h2 <span style=color:#f92672>&gt;=</span> h1) <span style=color:#75715e># Prints False</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Which one is biggest?&#39;</span>, max(houses)) <span style=color:#75715e># Prints &#39;h3: 1101-square-foot Split&#39;</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Which is smallest?&#39;</span>, min(houses)) <span style=color:#75715e># Prints &#39;h2: 846-square-foot Ranch&#39;</span>
</span></span></code></pre></div><p>装饰器 functools.total_ordering 就是用来简化这个处理的。 使用它来装饰一个来，你只需定义一个 <code>__eq__()</code> 方法， 外加其他方法(<strong>lt</strong>, <strong>le</strong>, <strong>gt</strong>, or <strong>ge</strong>)中的一个即可。 然后装饰器会自动为你填充其它比较方法。它就是定义了一个从每个比较支持方法到所有需要定义的其他方法的一个映射而已。</p><h2 id=创建缓存实例>创建缓存实例
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e7%bc%93%e5%ad%98%e5%ae%9e%e4%be%8b></a></h2><p>目的：在创建一个类的对象时，如果之前使用同样参数创建过这个对象， 你想返回它的缓存引用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 工厂函数</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The class in question</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Caching support</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> weakref
</span></span><span style=display:flex><span>_spam_cache <span style=color:#f92672>=</span> weakref<span style=color:#f92672>.</span>WeakValueDictionary()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_spam</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> name <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> _spam_cache:
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> Spam(name)
</span></span><span style=display:flex><span>        _spam_cache[name] <span style=color:#f92672>=</span> s
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> _spam_cache[name]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> get_spam(<span style=color:#e6db74>&#39;foo&#39;</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> get_spam(<span style=color:#e6db74>&#39;bar&#39;</span>)
</span></span><span style=display:flex><span>a <span style=color:#f92672>is</span> b
</span></span><span style=display:flex><span><span style=color:#75715e># False</span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> get_spam(<span style=color:#e6db74>&#39;foo&#39;</span>)
</span></span><span style=display:flex><span>a <span style=color:#f92672>is</span> c
</span></span><span style=display:flex><span><span style=color:#75715e># True</span>
</span></span></code></pre></div><p>一个 WeakValueDictionary 实例只会保存那些在其它地方还在被使用的实例。 否则的话，只要实例不再被使用了，它就从字典中被移除了。</p><h3 id=应用缓存管理器>应用缓存管理器
<a class=header-anchor href=#%e5%ba%94%e7%94%a8%e7%bc%93%e5%ad%98%e7%ae%a1%e7%90%86%e5%99%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> weakref
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CachedSpamManager</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_cache <span style=color:#f92672>=</span> weakref<span style=color:#f92672>.</span>WeakValueDictionary()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_spam</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_cache:
</span></span><span style=display:flex><span>            s <span style=color:#f92672>=</span> Spam(name)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_cache[name] <span style=color:#f92672>=</span> s
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            s <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_cache[name]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>clear</span>(self):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_cache<span style=color:#f92672>.</span>clear()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>:
</span></span><span style=display:flex><span>    manager <span style=color:#f92672>=</span> CachedSpamManager()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_spam</span>(name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Spam<span style=color:#f92672>.</span>manager<span style=color:#f92672>.</span>get_spam(name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 隐藏实例化类方法</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第一个是将类的名字修改为以下划线(_)开头，提示用户别直接调用它。 第二种就是让这个类的 __init__() 方法抛出一个异常，让它不能被初始化</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam2</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Can&#39;t instantiate directly&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Alternate constructor</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_new</span>(cls, name):
</span></span><span style=display:flex><span>        self <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__new__(cls)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ------------------------最后的方案------------------------</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CachedSpamManager2</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_cache <span style=color:#f92672>=</span> weakref<span style=color:#f92672>.</span>WeakValueDictionary()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_spam</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_cache:
</span></span><span style=display:flex><span>            temp <span style=color:#f92672>=</span> Spam3<span style=color:#f92672>.</span>_new(name)  <span style=color:#75715e># Modified creation</span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_cache[name] <span style=color:#f92672>=</span> temp
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            temp <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_cache[name]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> temp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>clear</span>(self):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_cache<span style=color:#f92672>.</span>clear()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam3</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Can&#39;t instantiate directly&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Alternate constructor</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_new</span>(cls, name):
</span></span><span style=display:flex><span>        self <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__new__(cls)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span></code></pre></div><h1 id=元编程>元编程
<a class=header-anchor href=#%e5%85%83%e7%bc%96%e7%a8%8b></a></h1><h2 id=函数装饰器>函数装饰器
<a class=header-anchor href=#%e5%87%bd%e6%95%b0%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><p>在函数上添加包装器，增加额外的操作处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> timeit
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functolls <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>timethis</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Decorator that report the execution time.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>*</span>kwargs):
</span></span><span style=display:flex><span>        start <span style=color:#f92672>=</span> timeit<span style=color:#f92672>.</span>default_timer()
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>*</span>kwargs)
</span></span><span style=display:flex><span>        end <span style=color:#f92672>=</span> timeit<span style=color:#f92672>.</span>defaulr_timer()
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>        logging<span style=color:#f92672>.</span>debug(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> running time: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(func<span style=color:#f92672>.</span>__name__, end<span style=color:#f92672>-</span>start))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ret
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timethis</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countdown</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Counts down
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        n <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>countdown(<span style=color:#ae81ff>100000</span>)
</span></span></code></pre></div><p>@wraps 装饰器来注解底层包装函数。保留函数元数据。@wraps 有一个重要特征是它能让你通过属性 <code>__wrapped__</code> 直接访问被包装函数。如果有多个包装器，那么访问 <code>__wrapped__</code> 属性的行为是不可预知的，应该避免这样做。</p><h2 id=带参数装饰器>带参数装饰器
<a class=header-anchor href=#%e5%b8%a6%e5%8f%82%e6%95%b0%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>logged</span>(level, <span style=color:#f92672>*</span>, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, message<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate</span>(func):
</span></span><span style=display:flex><span>        logname <span style=color:#f92672>=</span> name <span style=color:#66d9ef>if</span> name <span style=color:#66d9ef>else</span> func<span style=color:#f92672>.</span>__module__
</span></span><span style=display:flex><span>        log <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(logname)
</span></span><span style=display:flex><span>        logmsg <span style=color:#f92672>=</span> message <span style=color:#66d9ef>if</span> message <span style=color:#66d9ef>else</span> func<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>log(level, logmsg)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decorate
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@logged</span>(logging<span style=color:#f92672>.</span>DEBUG)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span></code></pre></div><p><code>logged()</code> 的返回结果必须是一个可调用对象，它接受一个函数作为参数并包装它。</p><h2 id=可自定义属性的装饰器>可自定义属性的装饰器
<a class=header-anchor href=#%e5%8f%af%e8%87%aa%e5%ae%9a%e4%b9%89%e5%b1%9e%e6%80%a7%e7%9a%84%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><p>装饰器包装一个函数，并且允许用户提供参数在运行时控制装饰器行为。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps, partial
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#75715e># Utility decorator to attach a function as an attribute of obj</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>attach_wrapper</span>(obj, func<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> func <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> partial(attach_wrapper, obj)
</span></span><span style=display:flex><span>    setattr(obj, func<span style=color:#f92672>.</span>__name__, func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>logged</span>(level, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, message<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Add logging to a function. level is the logging
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    level, name is the logger name, and message is the
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    log message. If name and message aren&#39;t specified,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    they default to the function&#39;s module and name.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate</span>(func):
</span></span><span style=display:flex><span>        logname <span style=color:#f92672>=</span> name <span style=color:#66d9ef>if</span> name <span style=color:#66d9ef>else</span> func<span style=color:#f92672>.</span>__module__
</span></span><span style=display:flex><span>        log <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(logname)
</span></span><span style=display:flex><span>        logmsg <span style=color:#f92672>=</span> message <span style=color:#66d9ef>if</span> message <span style=color:#66d9ef>else</span> func<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            log<span style=color:#f92672>.</span>log(level, logmsg)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Attach setter functions</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@attach_wrapper</span>(wrapper)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set_level</span>(newlevel):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>nonlocal</span> level
</span></span><span style=display:flex><span>            level <span style=color:#f92672>=</span> newlevel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@attach_wrapper</span>(wrapper)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set_message</span>(newmsg):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>nonlocal</span> logmsg
</span></span><span style=display:flex><span>            logmsg <span style=color:#f92672>=</span> newmsg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decorate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@logged</span>(logging<span style=color:#f92672>.</span>DEBUG)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@logged</span>(logging<span style=color:#f92672>.</span>CRITICAL, <span style=color:#e6db74>&#39;example&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Spam!&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> logging<span style=color:#f92672>.</span>basicConfig(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>DEBUG)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> add(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>DEBUG:__main__:add
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Change the log message</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> add<span style=color:#f92672>.</span>set_message(<span style=color:#e6db74>&#39;Add called&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> add(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>DEBUG:__main__:Add called
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Change the log level</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> add<span style=color:#f92672>.</span>set_level(logging<span style=color:#f92672>.</span>WARNING)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> add(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>WARNING:__main__:Add called
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 直接修改属性（这个方法也可能正常工作，但前提是它必须是最外层的装饰器才行。）</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>    wrapper<span style=color:#f92672>.</span>log<span style=color:#f92672>.</span>log(wrapper<span style=color:#f92672>.</span>level, wrapper<span style=color:#f92672>.</span>logmsg)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Attach adjustable attributes</span>
</span></span><span style=display:flex><span>wrapper<span style=color:#f92672>.</span>level <span style=color:#f92672>=</span> level
</span></span><span style=display:flex><span>wrapper<span style=color:#f92672>.</span>logmsg <span style=color:#f92672>=</span> logmsg
</span></span><span style=display:flex><span>wrapper<span style=color:#f92672>.</span>log <span style=color:#f92672>=</span> log
</span></span></code></pre></div><p>关键点在于访问函数(如 <code>set_message()</code> 和 <code>set_level()</code> )，它们被作为属性赋给包装器。 每个访问函数允许使用 nonlocal 来修改函数内部的变量。还有一个令人吃惊的地方是访问函数会在多层装饰器间传播(如果你的装饰器都使用了 @functools.wraps 注解)。</p><h2 id=带可选参数的装饰器>带可选参数的装饰器
<a class=header-anchor href=#%e5%b8%a6%e5%8f%af%e9%80%89%e5%8f%82%e6%95%b0%e7%9a%84%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><p>你想写一个装饰器，既可以不传参数给它，也可以传递可选参数给它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps, partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>logged</span>(func<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, <span style=color:#f92672>*</span>, level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>DEBUG, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, message<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> func <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> partial(logged, level<span style=color:#f92672>=</span>level, name<span style=color:#f92672>=</span>name, message<span style=color:#f92672>=</span>message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logname <span style=color:#f92672>=</span> name <span style=color:#66d9ef>if</span> name <span style=color:#66d9ef>else</span> func<span style=color:#f92672>.</span>__module__
</span></span><span style=display:flex><span>    log <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger(logname)
</span></span><span style=display:flex><span>    logmsg <span style=color:#f92672>=</span> message <span style=color:#66d9ef>if</span> message <span style=color:#66d9ef>else</span> func<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        log<span style=color:#f92672>.</span>log(level, logmsg)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@logged</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span><span style=color:#75715e># add = logged(add)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@logged</span>(level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>CRITICAL, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;example&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Spam!&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># spam = logged(level=logging.CRITICAL, name=&#39;example&#39;)(spam)</span>
</span></span></code></pre></div><h2 id=利用装饰器强制函数上的类型检查>利用装饰器强制函数上的类型检查
<a class=header-anchor href=#%e5%88%a9%e7%94%a8%e8%a3%85%e9%a5%b0%e5%99%a8%e5%bc%ba%e5%88%b6%e5%87%bd%e6%95%b0%e4%b8%8a%e7%9a%84%e7%b1%bb%e5%9e%8b%e6%a3%80%e6%9f%a5></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> inspect <span style=color:#f92672>import</span> signature
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>typeassert</span>(<span style=color:#f92672>*</span>ty_args, <span style=color:#f92672>**</span>ty_kwargs):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate</span>(func):
</span></span><span style=display:flex><span>        <span style=color:#75715e># If in optimized mode, disable type checking</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> __debug__:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Map function argument names to supplied types</span>
</span></span><span style=display:flex><span>        sig <span style=color:#f92672>=</span> signature(func)
</span></span><span style=display:flex><span>        bound_types <span style=color:#f92672>=</span> sig<span style=color:#f92672>.</span>bind_partial(<span style=color:#f92672>*</span>ty_args, <span style=color:#f92672>**</span>ty_kwargs)<span style=color:#f92672>.</span>arguments
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            bound_values <span style=color:#f92672>=</span> sig<span style=color:#f92672>.</span>bind(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>            <span style=color:#75715e># Enforce type assertions across supplied arguments</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> bound_values<span style=color:#f92672>.</span>arguments<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> name <span style=color:#f92672>in</span> bound_types:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, bound_types[name]):
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#39;Argument </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> must be </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(name, bound_types[name])
</span></span><span style=display:flex><span>                            )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decorate
</span></span></code></pre></div><p>这个方案还有点小瑕疵，它对于有默认值的参数并不适用。</p><p><code>inspect.signature()</code> 提取一个可调用对象的参数签名信息。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> inspect <span style=color:#f92672>import</span> signature
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(x, y, z<span style=color:#f92672>=</span><span style=color:#ae81ff>42</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>sig <span style=color:#f92672>=</span> signature(spam)
</span></span><span style=display:flex><span>print(sig)
</span></span><span style=display:flex><span><span style=color:#75715e># (x, y, z=42)</span>
</span></span><span style=display:flex><span>sig<span style=color:#f92672>.</span>parameters
</span></span><span style=display:flex><span><span style=color:#75715e># mappingproxy(OrderedDict([(&#39;x&#39;, &lt;Parameter at 0x10077a050 &#39;x&#39;&gt;),</span>
</span></span><span style=display:flex><span><span style=color:#75715e># (&#39;y&#39;, &lt;Parameter at 0x10077a158 &#39;y&#39;&gt;), (&#39;z&#39;, &lt;Parameter at 0x10077a1b0 &#39;z&#39;&gt;)]))</span>
</span></span></code></pre></div><p><code>bind_partial()</code> 方法来执行从指定类型到名称的部分绑定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>bound_types <span style=color:#f92672>=</span> sig<span style=color:#f92672>.</span>bind_partial(int,z<span style=color:#f92672>=</span>int)
</span></span><span style=display:flex><span>bound_types
</span></span><span style=display:flex><span><span style=color:#75715e># &lt;inspect.BoundArguments object at 0x10069bb50&gt;</span>
</span></span><span style=display:flex><span>bound_types<span style=color:#f92672>.</span>arguments
</span></span><span style=display:flex><span><span style=color:#75715e># OrderedDict([(&#39;x&#39;, &lt;class &#39;int&#39;&gt;), (&#39;z&#39;, &lt;class &#39;int&#39;&gt;)])</span>
</span></span></code></pre></div><p>装饰器与函数注解的方法比较，如果注解被用来做类型检查就不能做其他事情了。而且 @typeassert 不能再用于使用注解做其他事情的函数了。</p><h2 id=类内定义装饰器>类内定义装饰器
<a class=header-anchor href=#%e7%b1%bb%e5%86%85%e5%ae%9a%e4%b9%89%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Decorator as an instance method</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorator1</span>(self, func):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Decorator 1&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Decorator as a class method</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorator2</span>(cls, func):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Decorator 2&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># As an instance method</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> A()
</span></span><span style=display:flex><span><span style=color:#a6e22e>@a.decorator1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span><span style=color:#75715e># As a class method</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@A.decorator2</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>grok</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>尽管最外层的装饰器函数比如 <code>decorator1()</code> 或 <code>decorator2()</code> 需要提供一个 self 或 cls 参数， 但是在两个装饰器内部被创建的 <code>wrapper()</code> 函数并不需要包含这个 self 参数。 你唯一需要这个参数是在你确实要访问包装器中这个实例的某些部分的时候。其他情况下都不用去管它。</p><p>@property 装饰器实际上是一个类，它里面定义了三个方法 <code>getter()</code>, <code>setter()</code>, <code>deleter()</code> , 每一个方法都是一个装饰器。它为什么要这么定义的主要原因是各种不同的装饰器方法会在关联的 property 实例上操作它的状态。 因此，任何时候只要你碰到需要在<strong>装饰器中记录或绑定信息</strong>，那么这不失为一种可行方法。</p><h2 id=类作为装饰器>类作为装饰器
<a class=header-anchor href=#%e7%b1%bb%e4%bd%9c%e4%b8%ba%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><p>为了将装饰器定义成一个实例，你需要确保它实现了 <code>__call__()</code> 和 <code>__get__()</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Profiled</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, func):
</span></span><span style=display:flex><span>        wraps(func)(self)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>ncalls <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>ncalls <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__wrapped__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#75715e># 区分实例与类调用</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> types<span style=color:#f92672>.</span>MethodType(self, instance)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Profiled</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Profiled</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self, x):
</span></span><span style=display:flex><span>        print(self, x)
</span></span></code></pre></div><p><code>__get__()</code> 方法是为了确保绑定方法对象能被正确的创建。 <code>type.MethodType()</code> 手动创建一个绑定方法来使用。</p><h3 id=闭包与-nonlocal-实现装饰器>闭包与 nonlocal 实现装饰器。
<a class=header-anchor href=#%e9%97%ad%e5%8c%85%e4%b8%8e-nonlocal-%e5%ae%9e%e7%8e%b0%e8%a3%85%e9%a5%b0%e5%99%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>profiled</span>(func):
</span></span><span style=display:flex><span>    ncalls <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>nonlocal</span> ncalls
</span></span><span style=display:flex><span>        ncalls <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        print(ncalls)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>    wrapper<span style=color:#f92672>.</span>ncalls <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span>: ncalls
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@profiled</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add<span style=color:#f92672>.</span>ncalls()
</span></span></code></pre></div><h2 id=类或静态方法提供装饰器>类或静态方法提供装饰器
<a class=header-anchor href=#%e7%b1%bb%e6%88%96%e9%9d%99%e6%80%81%e6%96%b9%e6%b3%95%e6%8f%90%e4%be%9b%e8%a3%85%e9%a5%b0%e5%99%a8></a></h2><p>给类或静态方法提供装饰器是很简单的，不过要确保装饰器在 @classmethod 或 @staticmethod 之前。</p><p>如果你把装饰器的顺序写错了就会出错。同样 @abstractmethod 也需要注意顺序，问题在于 @classmethod 和 @staticmethod 实际上并不会创建可直接调用的对象， 而是创建特殊的描述器对象，因此当你试着在其他装饰器中将它们当做函数来使用时就会出错。</p><h2 id=装饰器为被包装函数增加参数>装饰器为被包装函数增加参数
<a class=header-anchor href=#%e8%a3%85%e9%a5%b0%e5%99%a8%e4%b8%ba%e8%a2%ab%e5%8c%85%e8%a3%85%e5%87%bd%e6%95%b0%e5%a2%9e%e5%8a%a0%e5%8f%82%e6%95%b0></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>optional_debug</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> debug:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Calling&#39;</span>, func<span style=color:#f92672>.</span>__name__)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@optional_debug</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(a,b,c):
</span></span><span style=display:flex><span>    print(a,b,c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>spam(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 1 2 3</span>
</span></span><span style=display:flex><span>spam(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Calling spam</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1 2 3</span>
</span></span></code></pre></div><h3 id=多个函数需要扩充参数>多个函数需要扩充参数
<a class=header-anchor href=#%e5%a4%9a%e4%b8%aa%e5%87%bd%e6%95%b0%e9%9c%80%e8%a6%81%e6%89%a9%e5%85%85%e5%8f%82%e6%95%b0></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> inspect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>optional_debug</span>(func):
</span></span><span style=display:flex><span>    <span style=color:#75715e># 排除已有 debug 参数的函数</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;debug&#39;</span> <span style=color:#f92672>in</span> inspect<span style=color:#f92672>.</span>getargspec(func)<span style=color:#f92672>.</span>args:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;debug argument already defined&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> debug:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Calling&#39;</span>, func<span style=color:#f92672>.</span>__name__)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 修复签名问题</span>
</span></span><span style=display:flex><span>    sig <span style=color:#f92672>=</span> inspect<span style=color:#f92672>.</span>signature(func)
</span></span><span style=display:flex><span>    parms <span style=color:#f92672>=</span> list(sig<span style=color:#f92672>.</span>parameters<span style=color:#f92672>.</span>values())
</span></span><span style=display:flex><span>    parms<span style=color:#f92672>.</span>append(inspect<span style=color:#f92672>.</span>Parameter(<span style=color:#e6db74>&#39;debug&#39;</span>,
</span></span><span style=display:flex><span>                inspect<span style=color:#f92672>.</span>Parameter<span style=color:#f92672>.</span>KEYWORD_ONLY,
</span></span><span style=display:flex><span>                default<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>))
</span></span><span style=display:flex><span>    wrapper<span style=color:#f92672>.</span>__signature__ <span style=color:#f92672>=</span> sig<span style=color:#f92672>.</span>replace(parameters<span style=color:#f92672>=</span>parms)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span></code></pre></div><h2 id=使用装饰器扩充类的功能>使用装饰器扩充类的功能
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e8%a3%85%e9%a5%b0%e5%99%a8%e6%89%a9%e5%85%85%e7%b1%bb%e7%9a%84%e5%8a%9f%e8%83%bd></a></h2><p>想通过自省或者重写类定义的某部分来修改它的行为，但不希望使用继承或元类的方式。</p><h3 id=继承方式>继承方式
<a class=header-anchor href=#%e7%bb%a7%e6%89%bf%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggedGetattribute</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattribute__(self, name):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;getting:&#39;</span>, name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__getattribute__(name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(LoggedGetattribute):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self,x):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> x
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><h3 id=装饰器方式>装饰器方式
<a class=header-anchor href=#%e8%a3%85%e9%a5%b0%e5%99%a8%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log_getattribute</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get the original implementation</span>
</span></span><span style=display:flex><span>    orig_getattribute <span style=color:#f92672>=</span> cls<span style=color:#f92672>.</span>__getattribute__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Make a new definition</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new_getattribute</span>(self, name):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;getting:&#39;</span>, name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> orig_getattribute(self, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Attach to the class and return</span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__getattribute__ <span style=color:#f92672>=</span> new_getattribute
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@log_getattribute</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self,x):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> x
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>某种程度上来讲，类装饰器方案就显得更加直观，并且它不会引入新的继承体系。它的运行速度也更快一些， 因为它并不依赖 <code>super()</code> 函数。</p><h2 id=使用元类控制实例的创建>使用元类控制实例的创建
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e5%85%83%e7%b1%bb%e6%8e%a7%e5%88%b6%e5%ae%9e%e4%be%8b%e7%9a%84%e5%88%9b%e5%bb%ba></a></h2><p>通过改变实例创建方式来实现单例、缓存或其他类似的特性。</p><h3 id=元类单例>元类单例
<a class=header-anchor href=#%e5%85%83%e7%b1%bb%e5%8d%95%e4%be%8b></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Singleton</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>__instance <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>__instance <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>__call__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__instance
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>(metaclass<span style=color:#f92672>=</span>Singleton):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Creating Spam&#39;</span>)
</span></span></code></pre></div><h3 id=工厂实现单例模式>工厂实现单例模式
<a class=header-anchor href=#%e5%b7%a5%e5%8e%82%e5%ae%9e%e7%8e%b0%e5%8d%95%e4%be%8b%e6%a8%a1%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_Spam</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Creating Spam&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_spam_instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Spam</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> _spam_instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> _spam_instance <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _spam_instance
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        _spam_instance <span style=color:#f92672>=</span> _Spam()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _spam_instance
</span></span></code></pre></div><h3 id=缓存实例>缓存实例
<a class=header-anchor href=#%e7%bc%93%e5%ad%98%e5%ae%9e%e4%be%8b></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> weakref
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Cached</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__cache <span style=color:#f92672>=</span> weakref<span style=color:#f92672>.</span>WeakValueDictionary()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, <span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> args <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>__cache:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>__cache[args]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            obj <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>__call__(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>__cache[args] <span style=color:#f92672>=</span> obj
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> obj
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>(metaclass<span style=color:#f92672>=</span>Cached):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Creating Spam(</span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>)&#39;</span><span style=color:#f92672>.</span>format(name))
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span></code></pre></div><p>利用元类实现多种实例<strong>创建模式</strong>通常要比不使用元类的方式优雅得多。更多关于创建缓存实例、弱引用等内容，请
<a href=#%e5%88%9b%e5%bb%ba%e7%bc%93%e5%ad%98%e5%ae%9e%e4%be%8b title=参考>参考
</a>。</p><h2 id=捕获类的属性定义顺序>捕获类的属性定义顺序
<a class=header-anchor href=#%e6%8d%95%e8%8e%b7%e7%b1%bb%e7%9a%84%e5%b1%9e%e6%80%a7%e5%ae%9a%e4%b9%89%e9%a1%ba%e5%ba%8f></a></h2><p>自动记录一个类中属性和方法定义的顺序，然后可以利用它来做很多操作（比如序列化、映射到数据库等等）。</p><p>利用元类可以很容易的捕获类的定义信息。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> OrderedDict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A set of descriptors for various types</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Typed</span>:
</span></span><span style=display:flex><span>    _expected_type <span style=color:#f92672>=</span> type(<span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, self<span style=color:#f92672>.</span>_expected_type):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected &#39;</span> <span style=color:#f92672>+</span> str(self<span style=color:#f92672>.</span>_expected_type))
</span></span><span style=display:flex><span>        instance<span style=color:#f92672>.</span>__dict__[self<span style=color:#f92672>.</span>_name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Integer</span>(Typed):
</span></span><span style=display:flex><span>    _expected_type <span style=color:#f92672>=</span> int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Float</span>(Typed):
</span></span><span style=display:flex><span>    _expected_type <span style=color:#f92672>=</span> float
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>String</span>(Typed):
</span></span><span style=display:flex><span>    _expected_type <span style=color:#f92672>=</span> str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Metaclass that uses an OrderedDict for class body</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderedMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        d <span style=color:#f92672>=</span> dict(clsdict)
</span></span><span style=display:flex><span>        order <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> clsdict<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(value, Typed):
</span></span><span style=display:flex><span>                <span style=color:#75715e># 名称</span>
</span></span><span style=display:flex><span>                value<span style=color:#f92672>.</span>_name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>                order<span style=color:#f92672>.</span>append(name)
</span></span><span style=display:flex><span>        d[<span style=color:#e6db74>&#39;_order&#39;</span>] <span style=color:#f92672>=</span> order
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> type<span style=color:#f92672>.</span>__new__(cls, clsname, bases, d)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 最先调用返回 clsdict</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __prepare__(cls, clsname, bases):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> OrderedDict()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure</span>(metaclass<span style=color:#f92672>=</span>OrderedMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>as_csv</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;,&#39;</span><span style=color:#f92672>.</span>join(str(getattr(self<span style=color:#f92672>.</span>name)) <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_order)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>(Structure):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> String()
</span></span><span style=display:flex><span>    shares <span style=color:#f92672>=</span> Integer()
</span></span><span style=display:flex><span>    price <span style=color:#f92672>=</span> Float()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, shares, price):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> shares
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>price <span style=color:#f92672>=</span> price
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> Stock(<span style=color:#e6db74>&#39;GOOG&#39;</span>,<span style=color:#ae81ff>100</span>,<span style=color:#ae81ff>490.1</span>)
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;GOOG&#39;</span>
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>as_csv()
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;GOOG,100,490.1&#39;</span>
</span></span></code></pre></div><p>一个关键点就是 OrderedMeta 元类中定义的 <code>__prepare__()</code> 方法。 这个方法会在开始定义类和它的父类的时候被执行。它必须返回一个映射对象以便在类定义体中被使用到。 我们这里通过返回了一个 OrderedDict 而不是一个普通的字典，可以很容易的捕获定义的顺序。</p><h2 id=定义有可选参数的元类>定义有可选参数的元类
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89%e6%9c%89%e5%8f%af%e9%80%89%e5%8f%82%e6%95%b0%e7%9a%84%e5%85%83%e7%b1%bb></a></h2><p>为了使元类支持这些关键字参数，你必须确保在 <code>__prepare__()</code> , <code>__new__()</code> 和 <code>__init__()</code> 方法中 都使用强制关键字参数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Optional</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __prepare__(cls, name, bases, <span style=color:#f92672>*</span>, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, synchronize<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Custom processing</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__prepare__(name, bases)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Required</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, name, bases, ns, <span style=color:#f92672>*</span>, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, synchronize<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Custom processing</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls, name, bases, ns)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Required</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, bases, ns, <span style=color:#f92672>*</span>, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, synchronize<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Custom processing</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(name, bases, ns)
</span></span></code></pre></div><p>给一个元类添加可选关键字参数需要你完全弄懂类创建的所有步骤， 因为这些参数会被传递给每一个相关的方法。 <code>__prepare__()</code> 方法在所有类定义开始执行前首先被调用，用来创建类命名空间。 通常来讲，这个方法只是简单的返回一个字典或其他映射对象。 <code>__new__()</code> 方法被用来实例化最终的类对象。它在类的主体被执行完后开始执行。 <code>__init__()</code> 方法最后被调用，用来执行其他的一些初始化工作。</p><p>当我们构造元类的时候，通常只需要定义一个 <code>__new__()</code> 或 <code>__init__()</code> 方法，但不是两个都定义。 但是，如果需要<strong>接受其他的关键字参数</strong>的话，这两个方法就要同时提供，并且都要提供对应的参数签名。 默认的 <code>__prepare__()</code> 方法接受任意的关键字参数，但是会忽略它们， 所以只有当这些额外的参数可能会影响到类命名空间的创建时你才需要去定义 <code>__prepare__()</code> 方法。</p><p>使用关键字参数配置一个元类还可以视作对类变量的一种替代方式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>(metaclass<span style=color:#f92672>=</span>MyMeta):
</span></span><span style=display:flex><span>    debug <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    synchronize <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><p>将这些属性定义为参数的好处在于它们不会污染类的名称空间， 这些属性仅仅只从属于类的<strong>创建阶段</strong>，而不是类中的语句<strong>执行阶段</strong>。 另外，它们在 <code>__prepare__()</code> 方法中是可以被访问的，因为这个方法会在所有类主体执行前被执行。 但是类变量只能在元类的 <code>__new__()</code> 和 <code>__init__()</code> 方法中可见。</p><h2 id=args-和-kwargs-的强制参数签名>*args 和 **kwargs 的强制参数签名
<a class=header-anchor href=#args-%e5%92%8c-kwargs-%e7%9a%84%e5%bc%ba%e5%88%b6%e5%8f%82%e6%95%b0%e7%ad%be%e5%90%8d></a></h2><p>对任何涉及到操作函数调用签名的问题，你都应该使用 inspect 模块中的签名特性。主要关注两个类：Signature 和 Parameter 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> inspect <span style=color:#f92672>import</span> Signature, Parameter
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Make a signature for a func(x, y=42, *, z=None)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> parms <span style=color:#f92672>=</span> [ Parameter(<span style=color:#e6db74>&#39;x&#39;</span>, Parameter<span style=color:#f92672>.</span>POSITIONAL_OR_KEYWORD),
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>         Parameter(<span style=color:#e6db74>&#39;y&#39;</span>, Parameter<span style=color:#f92672>.</span>POSITIONAL_OR_KEYWORD, default<span style=color:#f92672>=</span><span style=color:#ae81ff>42</span>),
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>         Parameter(<span style=color:#e6db74>&#39;z&#39;</span>, Parameter<span style=color:#f92672>.</span>KEYWORD_ONLY, default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>) ]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> sig <span style=color:#f92672>=</span> Signature(parms)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(sig)
</span></span><span style=display:flex><span>(x, y<span style=color:#f92672>=</span><span style=color:#ae81ff>42</span>, <span style=color:#f92672>*</span>, z<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 一旦你有了一个签名对象，你就可以使用它的 bind() 方法很容易的将它绑定到 *args 和 **kwargs 上去。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     bound_values <span style=color:#f92672>=</span> sig<span style=color:#f92672>.</span>bind(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>     <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> bound_values<span style=color:#f92672>.</span>arguments<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>         print(name,value)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> inspect <span style=color:#f92672>import</span> Signature, Parameter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_sig</span>(<span style=color:#f92672>*</span>names):
</span></span><span style=display:flex><span>    parms <span style=color:#f92672>=</span> [Parameter(name, Parameter<span style=color:#f92672>.</span>POSITIONAL_OR_KEYWORD)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> names]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Signature(parms)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure</span>:
</span></span><span style=display:flex><span>    __signature__ <span style=color:#f92672>=</span> make_sig()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        bound_values <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__signature__<span style=color:#f92672>.</span>bind(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> bound_values<span style=color:#f92672>.</span>arguments<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            setattr(self, name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>(Structure):
</span></span><span style=display:flex><span>    __signature__ <span style=color:#f92672>=</span> make_sig(<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#e6db74>&#39;shares&#39;</span>, <span style=color:#e6db74>&#39;price&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>(Structure):
</span></span><span style=display:flex><span>    __signature__ <span style=color:#f92672>=</span> make_sig(<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> inspect
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(inspect<span style=color:#f92672>.</span>signature(Stock))
</span></span><span style=display:flex><span>(name, shares, price)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s1 <span style=color:#f92672>=</span> Stock(<span style=color:#e6db74>&#39;ACME&#39;</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>490.1</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s2 <span style=color:#f92672>=</span> Stock(<span style=color:#e6db74>&#39;ACME&#39;</span>, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TypeError</span>: <span style=color:#e6db74>&#39;price&#39;</span> parameter lacking default value
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s3 <span style=color:#f92672>=</span> Stock(<span style=color:#e6db74>&#39;ACME&#39;</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>490.1</span>, shares<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>)
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TypeError</span>: multiple values <span style=color:#66d9ef>for</span> argument <span style=color:#e6db74>&#39;shares&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><h3 id=元类创建签名对象>元类创建签名对象
<a class=header-anchor href=#%e5%85%83%e7%b1%bb%e5%88%9b%e5%bb%ba%e7%ad%be%e5%90%8d%e5%af%b9%e8%b1%a1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> inspect <span style=color:#f92672>import</span> Signature, Parameter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_sig</span>(<span style=color:#f92672>*</span>names):
</span></span><span style=display:flex><span>    parms <span style=color:#f92672>=</span> [Parameter(name, Parameter<span style=color:#f92672>.</span>POSITIONAL_OR_KEYWORD)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> names]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Signature(parms)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructureMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        clsdict[<span style=color:#e6db74>&#39;__signature__&#39;</span>] <span style=color:#f92672>=</span> make_sig(<span style=color:#f92672>*</span>clsdict<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;_fields&#39;</span>,[]))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls, clsname, bases, clsdict)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Structure</span>(metaclass<span style=color:#f92672>=</span>StructureMeta):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        bound_values <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__signature__<span style=color:#f92672>.</span>bind(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> bound_values<span style=color:#f92672>.</span>arguments<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            setattr(self, name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>(Structure):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#e6db74>&#39;shares&#39;</span>, <span style=color:#e6db74>&#39;price&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>(Structure):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>]
</span></span></code></pre></div><p>当我们自定义签名的时候，将签名存储在特定的属性 <strong>signature</strong> 中通常是很有用的。 这样在使用 inspect 模块执行内省的代码就能发现签名并将它作为调用。</p><h2 id=在类上强制使用编程规约>在类上强制使用编程规约
<a class=header-anchor href=#%e5%9c%a8%e7%b1%bb%e4%b8%8a%e5%bc%ba%e5%88%b6%e4%bd%bf%e7%94%a8%e7%bc%96%e7%a8%8b%e8%a7%84%e7%ba%a6></a></h2><p>如果你想监控类的定义，通常可以通过定义一个元类。一个基本元类通常是继承自 type 并重定义它的 <code>__new__()</code> 方法 或者是 <code>__init__()</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(self, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        <span style=color:#75715e># clsname is name of class being defined</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># bases is tuple of base classes</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># clsdict is class dictionary</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls, clsname, bases, clsdict)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(clsname, bases, clsdict)
</span></span><span style=display:flex><span>        <span style=color:#75715e># clsname is name of class being defined</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># bases is tuple of base classes</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># clsdict is class dictionary</span>
</span></span></code></pre></div><p>元类的一个关键特点是它允许你在定义的时候检查类的内容。在重新定义 <code>__init__()</code> 方法中， 你可以很轻松的检查类字典、父类等等。并且，一旦某个元类被指定给了某个类，那么就会被继承到所有子类中去。 因此，一个框架的构建者就能在大型的继承体系中通过给一个顶级父类指定一个元类去捕获所有下面子类的定义。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NoMixedCaseMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> clsdict:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>lower() <span style=color:#f92672>!=</span> name:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Bad attribute name: &#39;</span> <span style=color:#f92672>+</span> name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls, clsname, bases, clsdict)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Root</span>(metaclass<span style=color:#f92672>=</span>NoMixedCaseMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(Root):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo_bar</span>(self): <span style=color:#75715e># Ok</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(Root):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fooBar</span>(self): <span style=color:#75715e># TypeError</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span></code></pre></div><h3 id=检测重载方法>检测重载方法
<a class=header-anchor href=#%e6%a3%80%e6%b5%8b%e9%87%8d%e8%bd%bd%e6%96%b9%e6%b3%95></a></h3><p>确保它的调用参数跟父类中原始方法有着相同的参数签名。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> inspect <span style=color:#f92672>import</span> signature
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MatchSignaturesMeta</span>(type):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(clsname, bases, clsdict)
</span></span><span style=display:flex><span>        <span style=color:#75715e># 找位于继承体系中构建 self 父类的定义</span>
</span></span><span style=display:flex><span>        sup <span style=color:#f92672>=</span> super(self, self)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> clsdict<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;_&#39;</span>) <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> callable(value):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Get the previous definition (if any) and compare the signatures</span>
</span></span><span style=display:flex><span>            prev_dfn <span style=color:#f92672>=</span> getattr(sup, name, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> prev_dfn:
</span></span><span style=display:flex><span>                prev_sig <span style=color:#f92672>=</span> signature(prev_dfn)
</span></span><span style=display:flex><span>                val_sig <span style=color:#f92672>=</span> signature(value)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> prev_sig <span style=color:#f92672>!=</span> val_sig:
</span></span><span style=display:flex><span>                    logging<span style=color:#f92672>.</span>warning(<span style=color:#e6db74>&#39;Signature mismatch in </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>. </span><span style=color:#e6db74>%s</span><span style=color:#e6db74> != </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>,
</span></span><span style=display:flex><span>                                    value<span style=color:#f92672>.</span>__qualname__, prev_sig, val_sig)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Root</span>(metaclass<span style=color:#f92672>=</span>MatchSignaturesMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(Root):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(self, x, y):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self, x, <span style=color:#f92672>*</span>, z):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Class with redefined methods, but slightly different signatures</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(A):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(self, a, b):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self,x,z):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># WARNING:root:Signature mismatch in B.spam. (self, x, *, z) != (self, x, z)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># WARNING:root:Signature mismatch in B.foo. (self, x, y) != (self, a, b)</span>
</span></span></code></pre></div><p>在元类中选择重新定义 <code>__new__()</code> 方法还是 <code>__init__()</code> 方法取决于你想怎样使用结果类。 <code>__new__()</code> 方法在类<strong>创建之前被调用</strong>，通常用于通过某种方式（比如通过改变类字典的内容）修改类的定义。 而 <code>__init__()</code> 方法是在类被<strong>创建之后被调用</strong>，当你需要完整构建类对象的时候会很有用。 在最后一个例子中，这是必要的，因为它使用了 <code>super()</code> 函数来搜索之前的定义。 它只能在类的实例被创建之后，并且相应的方法解析顺序也已经被设置好了。</p><p>代码中有一行使用了 <code>super(self, self)</code> 并不是排版错误。 当使用元类的时候，我们要时刻记住一点就是 self 实际上是一个类对象。 因此，这条语句其实就是用来寻找位于继承体系中构建 self 父类的定义</p><h2 id=以编程方式定义类>以编程方式定义类
<a class=header-anchor href=#%e4%bb%a5%e7%bc%96%e7%a8%8b%e6%96%b9%e5%bc%8f%e5%ae%9a%e4%b9%89%e7%b1%bb></a></h2><p>你可以使用函数 <code>types.new_class()</code> 来初始化新的类对象。 你需要做的只是提供类的名字、父类元组、关键字参数，以及一个用成员变量填充类字典的回调函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># stock.py</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example of making a class manually from parts</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Methods</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> __init__(self, name, shares, price):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>shares <span style=color:#f92672>=</span> shares
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>price <span style=color:#f92672>=</span> price
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cost</span>(self):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>shares <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>price
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cls_dict <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;__init__&#39;</span> : __init__,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;cost&#39;</span> : cost,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Make a class</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Stock <span style=color:#f92672>=</span> types<span style=color:#f92672>.</span>new_class(<span style=color:#e6db74>&#39;Stock&#39;</span>, (), {}, <span style=color:#66d9ef>lambda</span> ns: ns<span style=color:#f92672>.</span>update(cls_dict))
</span></span><span style=display:flex><span>Stock<span style=color:#f92672>.</span>__module__ <span style=color:#f92672>=</span> __name__
</span></span></code></pre></div><p>每次当一个类被定义后，它的 <code>__module__</code> 属性包含定义它的模块名。 这个名字用于生成 <code>__repr__()</code> 方法的输出。(&lt;class &lsquo;<strong>main</strong>.Stock&rsquo;>)</p><p><code>new_class()</code> 第三个参数还可以包含其他的关键字参数。第四个参数最神秘，它是一个用来接受类命名空间的映射对象的函数。 通常这是一个普通的字典，但是它实际上是 <code>__prepare__()</code> 方法返回的任意对象， 这个函数需要使用 <strong><code>update()</code></strong> 方法给命名空间增加内容。</p><h3 id=exec-方式实现-named-tuple>exec 方式实现 named tuple
<a class=header-anchor href=#exec-%e6%96%b9%e5%bc%8f%e5%ae%9e%e7%8e%b0-named-tuple></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> operator
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>named_tuple</span>(classname, fieldnames):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Populate a dictionary of field property accessors</span>
</span></span><span style=display:flex><span>    cls_dict <span style=color:#f92672>=</span> { name: property(operator<span style=color:#f92672>.</span>itemgetter(n))
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> n, name <span style=color:#f92672>in</span> enumerate(fieldnames) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Make a __new__ function and add to the class dict</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, <span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(args) <span style=color:#f92672>!=</span> len(fieldnames):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;Expected </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> arguments&#39;</span><span style=color:#f92672>.</span>format(len(fieldnames)))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> tuple<span style=color:#f92672>.</span>__new__(cls, args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls_dict[<span style=color:#e6db74>&#39;__new__&#39;</span>] <span style=color:#f92672>=</span> __new__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Make the class</span>
</span></span><span style=display:flex><span>    cls <span style=color:#f92672>=</span> types<span style=color:#f92672>.</span>new_class(classname, (tuple,), {},
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>lambda</span> ns: ns<span style=color:#f92672>.</span>update(cls_dict))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set the module to that of the caller</span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__module__ <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>_getframe(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>f_globals[<span style=color:#e6db74>&#39;__name__&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span></code></pre></div><p><code>Stock = type('Stock', (), cls_dict)</code> 这种方法的问题在于它忽略了一些关键步骤，比如对于元类中 <code>__prepare__()</code> 方法的调用。 通过使用 <code>types.new_class()</code> ，你可以保证所有的必要初始化步骤都能得到执行。</p><p>如果你仅仅只是想执行准备步骤，可以使用 <code>types.prepare_class()</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span>metaclass, kwargs, ns <span style=color:#f92672>=</span> types<span style=color:#f92672>.</span>prepare_class(<span style=color:#e6db74>&#39;Stock&#39;</span>, (), {<span style=color:#e6db74>&#39;metaclass&#39;</span>: type})
</span></span></code></pre></div><h2 id=在定义的时候初始化类的成员>在定义的时候初始化类的成员
<a class=header-anchor href=#%e5%9c%a8%e5%ae%9a%e4%b9%89%e7%9a%84%e6%97%b6%e5%80%99%e5%88%9d%e5%a7%8b%e5%8c%96%e7%b1%bb%e7%9a%84%e6%88%90%e5%91%98></a></h2><p>在类被定义的时候就初始化一部分类的成员，而不是要等到实例被创建后。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> operator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructTupleMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(cls, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> n, name <span style=color:#f92672>in</span> enumerate(cls<span style=color:#f92672>.</span>_fields):
</span></span><span style=display:flex><span>            setattr(cls, name, property(operator<span style=color:#f92672>.</span>itemgetter(n)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StructTuple</span>(tuple, metaclass<span style=color:#f92672>=</span>StructTupleMeta):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, <span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(args) <span style=color:#f92672>!=</span> len(cls<span style=color:#f92672>.</span>_fields):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> arguments required&#39;</span><span style=color:#f92672>.</span>format(len(cls<span style=color:#f92672>.</span>_fields)))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls,args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stock</span>(StructTuple):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#e6db74>&#39;shares&#39;</span>, <span style=color:#e6db74>&#39;price&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point</span>(StructTuple):
</span></span><span style=display:flex><span>    _fields <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#e6db74>&#39;y&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> Stock(<span style=color:#e6db74>&#39;ACME&#39;</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>91.1</span>)
</span></span></code></pre></div><p>函数 <code>operator.itemgetter()</code> 创建一个访问器函数， 然后 <code>property()</code> 函数将其转换成一个属性。</p><p>本节最难懂的部分是知道不同的初始化步骤是什么时候发生的。 StructTupleMeta 中的 <code>__init__()</code> 方法只在每个<strong>类被定义时被调用一次</strong>。 cls 参数就是那个被定义的类。实际上，上述代码使用了 _fields 类变量来保存新的被定义的类， 然后给它再添加一点新的东西。</p><p>StructTuple 类作为一个普通的基类，供其他使用者来继承。 这个类中的 <code>__new__()</code> 方法用来构造新的实例。 这里使用 <code>__new__()</code> 并不是很常见，主要是因为我们要修改元组的调用签名， 使得我们可以像普通的实例调用那样创建实例。</p><p>跟 <code>__init__()</code> 不同的是，<code>__new__()</code> 方法在<strong>实例被创建之前被触发</strong>。 由于元组是不可修改的，所以一旦它们被创建了就不可能对它做任何改变。</p><h2 id=利用函数注解实现方法重载>利用函数注解实现方法重载
<a class=header-anchor href=#%e5%88%a9%e7%94%a8%e5%87%bd%e6%95%b0%e6%b3%a8%e8%a7%a3%e5%ae%9e%e7%8e%b0%e6%96%b9%e6%b3%95%e9%87%8d%e8%bd%bd></a></h2><p>// TODO 复习</p><p>实现基于类型的方法重载。</p><h3 id=元类方法>元类方法
<a class=header-anchor href=#%e5%85%83%e7%b1%bb%e6%96%b9%e6%b3%95></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># multiple.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> inspect
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultiMethod</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Represents a single multimethod.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_methods <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__name__ <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>(self, meth):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Register a new method as a multimethod
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        sig <span style=color:#f92672>=</span> inspect<span style=color:#f92672>.</span>signature(meth)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Build a type signature from the method&#39;s annotations</span>
</span></span><span style=display:flex><span>        types <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name, parm <span style=color:#f92672>in</span> sig<span style=color:#f92672>.</span>parameters<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;self&#39;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> parm<span style=color:#f92672>.</span>annotation <span style=color:#f92672>is</span> inspect<span style=color:#f92672>.</span>Parameter<span style=color:#f92672>.</span>empty:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;Argument </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> must be annotated with a type&#39;</span><span style=color:#f92672>.</span>format(name)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(parm<span style=color:#f92672>.</span>annotation, type):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;Argument </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> annotation must be a type&#39;</span><span style=color:#f92672>.</span>format(name)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> parm<span style=color:#f92672>.</span>default <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> inspect<span style=color:#f92672>.</span>Parameter<span style=color:#f92672>.</span>empty:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_methods[tuple(types)] <span style=color:#f92672>=</span> meth
</span></span><span style=display:flex><span>            types<span style=color:#f92672>.</span>append(parm<span style=color:#f92672>.</span>annotation)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_methods[tuple(types)] <span style=color:#f92672>=</span> meth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, <span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Call a method based on type signature of the arguments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        types <span style=color:#f92672>=</span> tuple(type(arg) <span style=color:#66d9ef>for</span> arg <span style=color:#f92672>in</span> args[<span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>        meth <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_methods<span style=color:#f92672>.</span>get(types, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> meth:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> meth(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;No matching method for types </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(types))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Descriptor method needed to make calls work in a class
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> types<span style=color:#f92672>.</span>MethodType(self, instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultiDict</span>(dict):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Special dictionary to build multimethods in a metaclass
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, key, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> key <span style=color:#f92672>in</span> self:
</span></span><span style=display:flex><span>            <span style=color:#75715e># If key already exists, it must be a multimethod or callable</span>
</span></span><span style=display:flex><span>            current_value <span style=color:#f92672>=</span> self[key]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(current_value, MultiMethod):
</span></span><span style=display:flex><span>                current_value<span style=color:#f92672>.</span>register(value)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                mvalue <span style=color:#f92672>=</span> MultiMethod(key)
</span></span><span style=display:flex><span>                mvalue<span style=color:#f92672>.</span>register(current_value)
</span></span><span style=display:flex><span>                mvalue<span style=color:#f92672>.</span>register(value)
</span></span><span style=display:flex><span>                super()<span style=color:#f92672>.</span>__setitem__(key, mvalue)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            super()<span style=color:#f92672>.</span>__setitem__(key, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultipleMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Metaclass that allows multiple dispatch of methods
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, clsname, bases, clsdict):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> type<span style=color:#f92672>.</span>__new__(cls, clsname, bases, dict(clsdict))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __prepare__(cls, clsname, bases):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> MultiDict()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>(metaclass<span style=color:#f92672>=</span>MultipleMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self, x:int, y:int):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Bar 1:&#39;</span>, x, y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self, s:str, n:int <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Bar 2:&#39;</span>, s, n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example: overloaded __init__</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Date</span>(metaclass<span style=color:#f92672>=</span>MultipleMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, year: int, month:int, day:int):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>year <span style=color:#f92672>=</span> year
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>month <span style=color:#f92672>=</span> month
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>day <span style=color:#f92672>=</span> day
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>localtime()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__init__(t<span style=color:#f92672>.</span>tm_year, t<span style=color:#f92672>.</span>tm_mon, t<span style=color:#f92672>.</span>tm_mday)
</span></span></code></pre></div><p>本节的实现中的主要思路其实是很简单的。MutipleMeta 元类使用它的 <code>__prepare__()</code> 方法 来提供一个作为 MultiDict 实例的自定义字典。这个跟普通字典不一样的是， MultiDict 会在元素被设置的时候检查是否已经存在，如果存在的话，重复的元素会在 MultiMethod 实例中合并。</p><p>MultiMethod 实例通过构建从类型签名到函数的映射来收集方法。 在这个构建过程中，函数注解被用来收集这些签名然后构建这个映射。 这个过程在 <code>MultiMethod.register()</code> 方法中实现。 这种映射的一个关键特点是对于多个方法，所有参数类型都必须要指定，否则就会报错。</p><p>为了让 MultiMethod 实例模拟一个调用，<code>__call__()</code> 方法被实现了。 这个方法从所有排除 self 的参数中构建一个类型元组，在内部map中查找这个方法， 然后调用相应的方法。为了能让 MultiMethod 实例在类定义时正确操作，<code>__get__()</code> 是必须得实现的。 它被用来构建正确的绑定方法。</p><p>缺陷：</p><ul><li>不能使用关键字参数</li><li>对于继承有限制</li></ul><h3 id=描述器实现>描述器实现
<a class=header-anchor href=#%e6%8f%8f%e8%bf%b0%e5%99%a8%e5%ae%9e%e7%8e%b0></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> types
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>multimethod</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, func):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_methods <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__name__ <span style=color:#f92672>=</span> func<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_default <span style=color:#f92672>=</span> func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>match</span>(self, <span style=color:#f92672>*</span>types):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>(func):
</span></span><span style=display:flex><span>            <span style=color:#75715e># 查找默认参数个数</span>
</span></span><span style=display:flex><span>            ndefaults <span style=color:#f92672>=</span> len(func<span style=color:#f92672>.</span>__defaults__) <span style=color:#66d9ef>if</span> func<span style=color:#f92672>.</span>__defaults__ <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(ndefaults<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_methods[types[:len(types) <span style=color:#f92672>-</span> n]] <span style=color:#f92672>=</span> func
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> register
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, <span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        types <span style=color:#f92672>=</span> tuple(type(arg) <span style=color:#66d9ef>for</span> arg <span style=color:#f92672>in</span> args[<span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>        meth <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_methods<span style=color:#f92672>.</span>get(types, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> meth:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> meth(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_default(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> instance <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> types<span style=color:#f92672>.</span>MethodType(self, instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Spam</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@multimethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self, <span style=color:#f92672>*</span>args):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Default method called if no match</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;No matching method for bar&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@bar.match</span>(int, int)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self, x, y):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Bar 1:&#39;</span>, x, y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@bar.match</span>(str, int)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self, s, n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Bar 2:&#39;</span>, s, n)
</span></span></code></pre></div><p>描述器方案同样也有前面提到的限制（不支持关键字参数和继承）。</p><p><a href="https://www.artima.com/weblogs/viewpost.jsp?thread=101605" title="Guido van Rossum" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Guido van Rossum
<i class="fa fa-external-link-alt"></i></a></p><h2 id=避免重复的属性方法>避免重复的属性方法
<a class=header-anchor href=#%e9%81%bf%e5%85%8d%e9%87%8d%e5%a4%8d%e7%9a%84%e5%b1%9e%e6%80%a7%e6%96%b9%e6%b3%95></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>typed_property</span>(name, expected_type):
</span></span><span style=display:flex><span>    storage_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;_&#39;</span> <span style=color:#f92672>+</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>prop</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(self, storage_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@prop.setter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>prop</span>(self, value):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, expected_type):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> must be a </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(name, expected_type))
</span></span><span style=display:flex><span>        setattr(self, storage_name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> prop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>:
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> typed_property(<span style=color:#e6db74>&#39;name&#39;</span>, str)
</span></span><span style=display:flex><span>    age <span style=color:#f92672>=</span> typed_property(<span style=color:#e6db74>&#39;age&#39;</span>, int)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, age):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>age <span style=color:#f92672>=</span> age
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 简化方法</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>String <span style=color:#f92672>=</span> partial(typed_property, expected_type<span style=color:#f92672>=</span>str)
</span></span><span style=display:flex><span>Integer <span style=color:#f92672>=</span> partial(typed_property, expected_type<span style=color:#f92672>=</span>int)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example:</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>:
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> String(<span style=color:#e6db74>&#39;name&#39;</span>)
</span></span><span style=display:flex><span>    age <span style=color:#f92672>=</span> Integer(<span style=color:#e6db74>&#39;age&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, age):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>age <span style=color:#f92672>=</span> age
</span></span></code></pre></div><h2 id=定义上下文管理器>定义上下文管理器
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e5%99%a8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> contextlib <span style=color:#f92672>import</span> contextmanager
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>timethis</span>(label):
</span></span><span style=display:flex><span>    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        end <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(label, end <span style=color:#f92672>-</span> start))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> timethis(<span style=color:#e6db74>&#39;counting&#39;</span>):
</span></span><span style=display:flex><span>    n <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000000</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        n <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>在函数 <code>timethis()</code> 中，yield 之前的代码会在上下文管理器中作为 <code>__enter__()</code> 方法执行， 所有在 yield 之后的代码会作为 <code>__exit__()</code> 方法执行。 如果出现了异常，异常会在 yield 语句那里抛出。</p><h3 id=实现了列表对象上的某种事务>实现了列表对象上的某种事务
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e4%ba%86%e5%88%97%e8%a1%a8%e5%af%b9%e8%b1%a1%e4%b8%8a%e7%9a%84%e6%9f%90%e7%a7%8d%e4%ba%8b%e5%8a%a1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>list_transaction</span>(orig_list):
</span></span><span style=display:flex><span>    working <span style=color:#f92672>=</span> list(orig_list)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> working
</span></span><span style=display:flex><span>    orig_list[:] <span style=color:#f92672>=</span> working
</span></span></code></pre></div><p>@contextmanager 应该仅仅用来写自包含的上下文管理函数。如果你有一些对象(比如一个文件、网络连接或锁)，需要支持 with 语句，那么你就需要单独实现 <code>__enter__()</code> 方法和 <code>__exit__()</code> 方法。</p><h2 id=在局部变量域中执行代码>在局部变量域中执行代码
<a class=header-anchor href=#%e5%9c%a8%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e5%9f%9f%e4%b8%ad%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81></a></h2><p>调用 <code>exec()</code> 之前使用 <code>locals()</code> 函数来得到一个局部变量字典。</p><p>默认情况下，<code>exec()</code> 会在调用者局部和全局范围内执行代码。然而，在函数里面， 传递给 <code>exec()</code> 的局部范围是拷贝实际局部变量组成的一个字典。 因此，如果 <code>exec()</code> 如果执行了修改操作，这种修改后的结果对实际局部变量值是没有影响的。</p><p>调用 <code>locals()</code> 获取局部变量时，你获得的是传递给 <code>exec()</code> 的局部变量的一个拷贝。 通过在代码执行后审查这个字典的值，那就能获取修改后的值了。</p><h2 id=解析与分析python源码>解析与分析Python源码
<a class=header-anchor href=#%e8%a7%a3%e6%9e%90%e4%b8%8e%e5%88%86%e6%9e%90python%e6%ba%90%e7%a0%81></a></h2><p>// TODO</p><h1 id=模块与包>模块与包
<a class=header-anchor href=#%e6%a8%a1%e5%9d%97%e4%b8%8e%e5%8c%85></a></h1><h2 id=构建一个模块的层级包>构建一个模块的层级包
<a class=header-anchor href=#%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e6%a8%a1%e5%9d%97%e7%9a%84%e5%b1%82%e7%ba%a7%e5%8c%85></a></h2><p>封装成包是很简单的。在文件系统上组织你的代码，并确保<strong>每个目录</strong>都定义了一个__init__.py文件。</p><h2 id=控制模块被全部导入的内容>控制模块被全部导入的内容
<a class=header-anchor href=#%e6%8e%a7%e5%88%b6%e6%a8%a1%e5%9d%97%e8%a2%ab%e5%85%a8%e9%83%a8%e5%af%bc%e5%85%a5%e7%9a%84%e5%86%85%e5%ae%b9></a></h2><p>在你的模块中定义一个变量 <code>__all__</code> 来明确地列出需要导出的内容。</p><p>如果你不做任何事, 这样的导入将会导入所有不以下划线开头的。 另一方面,如果定义了 <code>__all__</code> , 那么只有被列举出的东西会被导出。如果你将 <code>__all__</code> 定义成一个空列表, 没有东西将被导入。 如果 <code>__all__</code> 包含未定义的名字, 在导入时引起 AttributeError。</p><h2 id=使用相对路径名导入包中子模块>使用相对路径名导入包中子模块
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e7%9b%b8%e5%af%b9%e8%b7%af%e5%be%84%e5%90%8d%e5%af%bc%e5%85%a5%e5%8c%85%e4%b8%ad%e5%ad%90%e6%a8%a1%e5%9d%97></a></h2><p>import语句的 . 和 .. 看起来很滑稽, 但它指定目录名.为当前目录，..B为目录../B。这种语法<strong>只适用于 import</strong>。</p><p>尽管使用相对导入看起来像是浏览文件系统，但是<strong>不能到定义包的目录之外</strong>。也就是说，使用点的这种模式从不是包的目录中导入将会引发错误。</p><p>最后，相对导入只适用于在合适的包中的模块。尤其是在顶层的脚本的简单模块中，它们将不起作用。</p><h2 id=将模块分割成多个文件>将模块分割成多个文件
<a class=header-anchor href=#%e5%b0%86%e6%a8%a1%e5%9d%97%e5%88%86%e5%89%b2%e6%88%90%e5%a4%9a%e4%b8%aa%e6%96%87%e4%bb%b6></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># mymodule.py</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spam</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;A.spam&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>B</span>(A):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;B.bar&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mymodule/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     __init__.py</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     a.py</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#     b.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># __init__.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> .a <span style=color:#f92672>import</span> A
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> .b <span style=color:#f92672>import</span> B
</span></span></code></pre></div><p>延迟导入</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># __init__.py</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>A</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> .a <span style=color:#f92672>import</span> A
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> A()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>B</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> .b <span style=color:#f92672>import</span> B
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> B()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> isinstance(x, mymodule<span style=color:#f92672>.</span>A): <span style=color:#75715e># Error</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> isinstance(x, mymodule<span style=color:#f92672>.</span>a<span style=color:#f92672>.</span>A): <span style=color:#75715e># Ok</span>
</span></span></code></pre></div><p>延迟加载的主要缺点是继承和类型检查可能会中断。</p><p>延迟加载的真实例子, 见标准库 <code>multiprocessing/__init__.py</code> 的源码。</p><h2 id=利用命名空间导入目录分散的代码>利用命名空间导入目录分散的代码
<a class=header-anchor href=#%e5%88%a9%e7%94%a8%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4%e5%af%bc%e5%85%a5%e7%9b%ae%e5%bd%95%e5%88%86%e6%95%a3%e7%9a%84%e4%bb%a3%e7%a0%81></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>foo<span style=color:#f92672>-</span>package<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    spam<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>        blah<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bar<span style=color:#f92672>-</span>package<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>    spam<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>        grok<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> sys<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>extend([<span style=color:#e6db74>&#39;foo-package&#39;</span>, <span style=color:#e6db74>&#39;bar-package&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> spam.blah
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> spam.grok
</span></span></code></pre></div><p>包命名空间的一个重要特点是任何人都可以用自己的代码来扩展命名空间。</p><p>一个包是否被作为一个包命名空间的主要方法是检查其 <strong>file</strong> 属性。如果没有，那包是个命名空间。这也可以由其字符表现形式中的“namespace”这个词体现出来。</p><h2 id=重新加载模块>重新加载模块
<a class=header-anchor href=#%e9%87%8d%e6%96%b0%e5%8a%a0%e8%bd%bd%e6%a8%a1%e5%9d%97></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> spam
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> imp
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> imp<span style=color:#f92672>.</span>reload(spam)
</span></span></code></pre></div><p><code>reload()</code> 擦除了模块底层字典的内容，并通过重新执行模块的源代码来刷新它。模块对象本身的身份保持不变。因此，该操作在程序中所有已经被导入了的地方更新了模块。</p><p>在生产环境中可能需要避免重新加载模块。在交互环境下调试，解释程序并试图弄懂它。</p><h2 id=读取位于包中的数据文件>读取位于包中的数据文件
<a class=header-anchor href=#%e8%af%bb%e5%8f%96%e4%bd%8d%e4%ba%8e%e5%8c%85%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e6%96%87%e4%bb%b6></a></h2><p><code>pkgutil.get_data()</code> 函数是一个读取数据文件的高级工具，不用管包是如何安装以及安装在哪。它只是工作并将文件内容以字节字符串返回。</p><p><code>get_data()</code> 的第一个参数是包含包名的字符串。你可以直接使用包名，也可以使用特殊的变量，比如 <code>__package__</code> 。第二个参数是包内文件的相对名称。如果有必要，可以使用标准的Unix命名规范到不同的目录，只要最后的目录仍然位于包中。</p><h2 id=将文件夹加入到syspath>将文件夹加入到sys.path
<a class=header-anchor href=#%e5%b0%86%e6%96%87%e4%bb%b6%e5%a4%b9%e5%8a%a0%e5%85%a5%e5%88%b0syspath></a></h2><ul><li>使用PYTHONPATH环境变量来添加</li><li>是创建一个.pth文件，将目录列举出来，.pth 文件需要放在某个 Python 的 site-packages 目录</li><li>编码实现</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os.path <span style=color:#f92672>import</span> abspath, join, dirname
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>insert(<span style=color:#ae81ff>0</span>, join(abspath(dirname(__file__)), <span style=color:#e6db74>&#39;src&#39;</span>))
</span></span></code></pre></div><h2 id=通过字符串名导入模块>通过字符串名导入模块
<a class=header-anchor href=#%e9%80%9a%e8%bf%87%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%90%8d%e5%af%bc%e5%85%a5%e6%a8%a1%e5%9d%97></a></h2><p>使用 <code>importlib.import_module()</code> 函数来手动导入名字为字符串给出的一个模块或者包的一部分。</p><p>import_module只是简单地执行和import相同的步骤，但是返回生成的模块对象。你只需要将其存储在一个变量，然后像正常的模块一样使用。</p><h2 id=通过钩子远程加载模块>通过钩子远程加载模块
<a class=header-anchor href=#%e9%80%9a%e8%bf%87%e9%92%a9%e5%ad%90%e8%bf%9c%e7%a8%8b%e5%8a%a0%e8%bd%bd%e6%a8%a1%e5%9d%97></a></h2><p>// TODO</p><h1 id=网络与web编程>网络与Web编程
<a class=header-anchor href=#%e7%bd%91%e7%bb%9c%e4%b8%8eweb%e7%bc%96%e7%a8%8b></a></h1><h2 id=作为客户端与http服务交互>作为客户端与HTTP服务交互
<a class=header-anchor href=#%e4%bd%9c%e4%b8%ba%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8ehttp%e6%9c%8d%e5%8a%a1%e4%ba%a4%e4%ba%92></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> urllib <span style=color:#f92672>import</span> request, parse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Base URL being accessed</span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://httpbin.org/get&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Dictionary of query parameters (if any)</span>
</span></span><span style=display:flex><span>parms <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#39;name1&#39;</span> : <span style=color:#e6db74>&#39;value1&#39;</span>,
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#39;name2&#39;</span> : <span style=color:#e6db74>&#39;value2&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Encode the query string</span>
</span></span><span style=display:flex><span>querystring <span style=color:#f92672>=</span> parse<span style=color:#f92672>.</span>urlencode(parms)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Make a GET request and read the response</span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>urlopen(url<span style=color:#f92672>+</span><span style=color:#e6db74>&#39;?&#39;</span> <span style=color:#f92672>+</span> querystring)
</span></span><span style=display:flex><span>resp <span style=color:#f92672>=</span> u<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> urllib <span style=color:#f92672>import</span> request, parse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extra headers</span>
</span></span><span style=display:flex><span>headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;User-agent&#39;</span> : <span style=color:#e6db74>&#39;none/ofyourbusiness&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Spam&#39;</span> : <span style=color:#e6db74>&#39;Eggs&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>req <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>Request(url, querystring<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;ascii&#39;</span>), headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Make a request and read the response</span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>urlopen(req)
</span></span><span style=display:flex><span>resp <span style=color:#f92672>=</span> u<span style=color:#f92672>.</span>read()
</span></span></code></pre></div><h2 id=创建-tcp-服务器>创建 TCP 服务器
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba-tcp-%e6%9c%8d%e5%8a%a1%e5%99%a8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socketserver <span style=color:#f92672>import</span> BaseRequestHandler, StreamRequestHandler, TCPServer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 文本类型</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EchoHandler</span>(BaseRequestHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Got connection from&#39;</span>, self<span style=color:#f92672>.</span>client_address)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> msg:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 流类型</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EchoHandler2</span>(StreamRequestHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Got connection from&#39;</span>, self<span style=color:#f92672>.</span>client_address)
</span></span><span style=display:flex><span>        <span style=color:#75715e># self.rfile is a file-like object for reading</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>rfile:
</span></span><span style=display:flex><span>            <span style=color:#75715e># self.wfile is a file-like object for writing</span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>wfile<span style=color:#f92672>.</span>write(line)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> TCPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), EchoHandler)
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> TCPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), EchoHandler2)
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><h3 id=并发-tcp-服务>并发 TCP 服务
<a class=header-anchor href=#%e5%b9%b6%e5%8f%91-tcp-%e6%9c%8d%e5%8a%a1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># ForkingTCPServer 或者是 ThreadingTCPServer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> socketserver <span style=color:#f92672>import</span> ThreadingTCPServer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> ThreadingTCPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), EchoHandler)
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 限制线程个数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span>    NWORKERS <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> TCPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), EchoHandler)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(NWORKERS):
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>serv<span style=color:#f92672>.</span>serve_forever)
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><h3 id=端口复用>端口复用
<a class=header-anchor href=#%e7%ab%af%e5%8f%a3%e5%a4%8d%e7%94%a8></a></h3><p>一般来讲，一个 TCPServer 在实例化的时候会绑定并激活相应的 socket 。 不过，有时候你想通过设置某些选项去调整底下的 <code>socket</code> ，可以设置参数 bind_and_activate=False 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 允许服务器重新绑定一个之前使用过的端口号</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> TCPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), EchoHandler, bind_and_activate<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up various socket options</span>
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>socket<span style=color:#f92672>.</span>setsockopt(socket<span style=color:#f92672>.</span>SOL_SOCKET, socket<span style=color:#f92672>.</span>SO_REUSEADDR, <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Bind and activate</span>
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>server_bind()
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>server_activate()
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 简化版</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    TCPServer<span style=color:#f92672>.</span>allow_reuse_address <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> TCPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), EchoHandler)
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><h3 id=socket-底层实现>socket 底层实现
<a class=header-anchor href=#socket-%e5%ba%95%e5%b1%82%e5%ae%9e%e7%8e%b0></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_handler</span>(address, client_sock):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got connection from </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(address))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> client_sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> msg:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        client_sock<span style=color:#f92672>.</span>sendall(msg)
</span></span><span style=display:flex><span>    client_sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_server</span>(address, backlog<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>):
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>listen(backlog)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        client_sock, client_addr <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        echo_handler(client_addr, client_sock)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    echo_server((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>))
</span></span></code></pre></div><h2 id=创建-udp-服务器>创建 UDP 服务器
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba-udp-%e6%9c%8d%e5%8a%a1%e5%99%a8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socketserver <span style=color:#f92672>import</span> BaseRequestHandler, UDPServer
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TimeHandler</span>(BaseRequestHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Got connection from&#39;</span>, self<span style=color:#f92672>.</span>client_address)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get message and client socket</span>
</span></span><span style=display:flex><span>        msg, sock <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>request
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>ctime()
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>sendto(resp<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;ascii&#39;</span>), self<span style=color:#f92672>.</span>client_address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> UDPServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>), TimeHandler)
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><h3 id=并发-udp-服务>并发 UDP 服务
<a class=header-anchor href=#%e5%b9%b6%e5%8f%91-udp-%e6%9c%8d%e5%8a%a1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socketserver <span style=color:#f92672>import</span> ThreadingUDPServer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> ThreadingUDPServer((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>20000</span>), TimeHandler)
</span></span><span style=display:flex><span>    serv<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><h3 id=socket-底层实现-1>socket 底层实现
<a class=header-anchor href=#socket-%e5%ba%95%e5%b1%82%e5%ae%9e%e7%8e%b0-1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_DGRAM
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>time_server</span>(address):
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> socket(AF_INET, SOCK_DGRAM)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        msg, addr <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Got message from&#39;</span>, addr)
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>ctime()
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>sendto(resp<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;ascii&#39;</span>), addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    time_server((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>))
</span></span></code></pre></div><h2 id=cidr地址生成对应的ip地址集>CIDR地址生成对应的IP地址集
<a class=header-anchor href=#cidr%e5%9c%b0%e5%9d%80%e7%94%9f%e6%88%90%e5%af%b9%e5%ba%94%e7%9a%84ip%e5%9c%b0%e5%9d%80%e9%9b%86></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> ipaddress
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> net <span style=color:#f92672>=</span> ipaddress<span style=color:#f92672>.</span>ip_network(<span style=color:#e6db74>&#39;123.45.67.64/27&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> net
</span></span><span style=display:flex><span>IPv4Network(<span style=color:#e6db74>&#39;123.45.67.64/27&#39;</span>)
</span></span></code></pre></div><p>要注意的是，ipaddress 模块跟其他一些和网络相关的模块比如 socket 库交集很少。 所以，你不能使用 IPv4Address 的实例来代替一个地址字符串，你首先得显式的使用 str() 转换它。</p><h2 id=创建一个简单的rest接口>创建一个简单的REST接口
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84rest%e6%8e%a5%e5%8f%a3></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># resty.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cgi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>notfound_404</span>(environ, start_response):
</span></span><span style=display:flex><span>    start_response(<span style=color:#e6db74>&#39;404 Not Found&#39;</span>, [ (<span style=color:#e6db74>&#39;Content-type&#39;</span>, <span style=color:#e6db74>&#39;text/plain&#39;</span>) ])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Not Found&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PathDispatcher</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pathmap <span style=color:#f92672>=</span> { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, environ, start_response):
</span></span><span style=display:flex><span>        path <span style=color:#f92672>=</span> environ[<span style=color:#e6db74>&#39;PATH_INFO&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#75715e># 查询参数</span>
</span></span><span style=display:flex><span>        params <span style=color:#f92672>=</span> cgi<span style=color:#f92672>.</span>FieldStorage(environ[<span style=color:#e6db74>&#39;wsgi.input&#39;</span>],
</span></span><span style=display:flex><span>                                  environ<span style=color:#f92672>=</span>environ)
</span></span><span style=display:flex><span>        method <span style=color:#f92672>=</span> environ[<span style=color:#e6db74>&#39;REQUEST_METHOD&#39;</span>]<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span>        environ[<span style=color:#e6db74>&#39;params&#39;</span>] <span style=color:#f92672>=</span> { key: params<span style=color:#f92672>.</span>getvalue(key) <span style=color:#66d9ef>for</span> key <span style=color:#f92672>in</span> params }
</span></span><span style=display:flex><span>        handler <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>pathmap<span style=color:#f92672>.</span>get((method,path), notfound_404)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> handler(environ, start_response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>(self, method, path, function):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pathmap[method<span style=color:#f92672>.</span>lower(), path] <span style=color:#f92672>=</span> function
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> function
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_hello_resp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>&lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     &lt;title&gt;Hello </span><span style=color:#e6db74>{name}</span><span style=color:#e6db74>&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   &lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   &lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     &lt;h1&gt;Hello </span><span style=color:#e6db74>{name}</span><span style=color:#e6db74>!&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   &lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hello_world</span>(environ, start_response):
</span></span><span style=display:flex><span>    start_response(<span style=color:#e6db74>&#39;200 OK&#39;</span>, [ (<span style=color:#e6db74>&#39;Content-type&#39;</span>,<span style=color:#e6db74>&#39;text/html&#39;</span>)])
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> environ[<span style=color:#e6db74>&#39;params&#39;</span>]
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> _hello_resp<span style=color:#f92672>.</span>format(name<span style=color:#f92672>=</span>params<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;name&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> resp<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_localtime_resp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>&lt;?xml version=&#34;1.0&#34;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;time&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;year&gt;</span><span style=color:#e6db74>{t.tm_year}</span><span style=color:#e6db74>&lt;/year&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;month&gt;</span><span style=color:#e6db74>{t.tm_mon}</span><span style=color:#e6db74>&lt;/month&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;day&gt;</span><span style=color:#e6db74>{t.tm_mday}</span><span style=color:#e6db74>&lt;/day&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;hour&gt;</span><span style=color:#e6db74>{t.tm_hour}</span><span style=color:#e6db74>&lt;/hour&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;minute&gt;</span><span style=color:#e6db74>{t.tm_min}</span><span style=color:#e6db74>&lt;/minute&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;second&gt;</span><span style=color:#e6db74>{t.tm_sec}</span><span style=color:#e6db74>&lt;/second&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/time&gt;&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>localtime</span>(environ, start_response):
</span></span><span style=display:flex><span>    start_response(<span style=color:#e6db74>&#39;200 OK&#39;</span>, [ (<span style=color:#e6db74>&#39;Content-type&#39;</span>, <span style=color:#e6db74>&#39;application/xml&#39;</span>) ])
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> _localtime_resp<span style=color:#f92672>.</span>format(t<span style=color:#f92672>=</span>time<span style=color:#f92672>.</span>localtime())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> resp<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># from resty import PathDispatcher</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> wsgiref.simple_server <span style=color:#f92672>import</span> make_server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create the dispatcher and register functions</span>
</span></span><span style=display:flex><span>    dispatcher <span style=color:#f92672>=</span> PathDispatcher()
</span></span><span style=display:flex><span>    dispatcher<span style=color:#f92672>.</span>register(<span style=color:#e6db74>&#39;GET&#39;</span>, <span style=color:#e6db74>&#39;/hello&#39;</span>, hello_world)
</span></span><span style=display:flex><span>    dispatcher<span style=color:#f92672>.</span>register(<span style=color:#e6db74>&#39;GET&#39;</span>, <span style=color:#e6db74>&#39;/localtime&#39;</span>, localtime)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Launch a basic server</span>
</span></span><span style=display:flex><span>    httpd <span style=color:#f92672>=</span> make_server(<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>8080</span>, dispatcher)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Serving on port 8080...&#39;</span>)
</span></span><span style=display:flex><span>    httpd<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div><ul><li>environ 属性是一个字典，包含了从web服务器提供的CGI接口中获取的值。</li><li>cgi.FieldStorage() 可以从请求中提取查询参数并将它们放入一个类字典对象中以便后面使用。</li><li>start_response 参数是一个为了初始化一个请求对象而必须被调用的函数。 第一个参数是返回的HTTP状态值，第二个参数是一个(名,值)元组列表，用来构建返回的HTTP头。</li><li>为了返回数据，一个WSGI程序必须返回一个字节字符串序列。</li></ul><p>WSGI本身是一个很小的标准。因此它并没有提供一些高级的特性比如认证、cookies、重定向等。</p><h2 id=通过-xml-rpc-实现简单的远程调用>通过 XML-RPC 实现简单的远程调用
<a class=header-anchor href=#%e9%80%9a%e8%bf%87-xml-rpc-%e5%ae%9e%e7%8e%b0%e7%ae%80%e5%8d%95%e7%9a%84%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> xmlrpc.server <span style=color:#f92672>import</span> SimpleXMLRPCServer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KeyValueServer</span>:
</span></span><span style=display:flex><span>    _rpc_methods_ <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;get&#39;</span>, <span style=color:#e6db74>&#39;set&#39;</span>, <span style=color:#e6db74>&#39;delete&#39;</span>, <span style=color:#e6db74>&#39;exists&#39;</span>, <span style=color:#e6db74>&#39;keys&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, address):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_data <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_serv <span style=color:#f92672>=</span> SimpleXMLRPCServer(address, allow_none<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_rpc_methods_:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_serv<span style=color:#f92672>.</span>register_function(getattr(self, name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_data[name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set</span>(self, name, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_data[name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> self<span style=color:#f92672>.</span>_data[name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>exists</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>keys</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list(self<span style=color:#f92672>.</span>_data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>serve_forever</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_serv<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    kvserv <span style=color:#f92672>=</span> KeyValueServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>15000</span>))
</span></span><span style=display:flex><span>    kvserv<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 客户端访问</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> xmlrpc.client <span style=color:#f92672>import</span> ServerProxy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> ServerProxy(<span style=color:#e6db74>&#39;http://localhost:15000&#39;</span>, allow_none<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;foo&#39;</span>, <span style=color:#e6db74>&#39;bar&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;spam&#39;</span>, [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>keys()
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;spam&#39;</span>, <span style=color:#e6db74>&#39;foo&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;foo&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;bar&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>delete(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>exists(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 二进制需要特别处理</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;foo&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello World&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;foo&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>xmlrpc<span style=color:#f92672>.</span>client<span style=color:#f92672>.</span>Binary object at <span style=color:#ae81ff>0x10131d410</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> _<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello World&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><h2 id=在不同的python解释器之间交互>在不同的Python解释器之间交互
<a class=header-anchor href=#%e5%9c%a8%e4%b8%8d%e5%90%8c%e7%9a%84python%e8%a7%a3%e9%87%8a%e5%99%a8%e4%b9%8b%e9%97%b4%e4%ba%a4%e4%ba%92></a></h2><p>你在不同的机器上面运行着多个 Python 解释器实例，并希望能够在这些解释器之间通过消息来交换数据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing.connection <span style=color:#f92672>import</span> Listener
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> traceback
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_client</span>(conn):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>            conn<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>EOFError</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Connection closed&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_server</span>(address, authkey):
</span></span><span style=display:flex><span>    serv <span style=color:#f92672>=</span> Listener(address, authkey<span style=color:#f92672>=</span>authkey)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            client <span style=color:#f92672>=</span> serv<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            echo_client(client)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span>:
</span></span><span style=display:flex><span>            traceback<span style=color:#f92672>.</span>print_exc()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo_server((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>25000</span>), authkey<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;peekaboo&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 访问</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> multiprocessing.connection <span style=color:#f92672>import</span> Client
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c <span style=color:#f92672>=</span> Client((<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>25000</span>), authkey<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;peekaboo&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;hello&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>send(<span style=color:#ae81ff>42</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>send([<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>]
</span></span></code></pre></div><p>跟底层 socket 不同的是，每个消息会完整保存（每一个通过 <code>send()</code> 发送的对象能通过 <code>recv()</code> 来完整接受）。 另外，所有对象会通过 <strong>pickle</strong> 序列化。因此，任何兼容 pickle 的对象都能在此连接上面被发送和接受。</p><p>通用准则，不要使用 multiprocessing 来实现一个对外的公共服务。 <code>Client()</code> 和 <code>Listener()</code> 中的 authkey 参数用来认证发起连接的终端用户。</p><h2 id=实现远程方法调用>实现远程方法调用
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e8%bf%9c%e7%a8%8b%e6%96%b9%e6%b3%95%e8%b0%83%e7%94%a8></a></h2><h3 id=服务端>服务端
<a class=header-anchor href=#%e6%9c%8d%e5%8a%a1%e7%ab%af></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># rpcserver.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pickle
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RPCHandler</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_functions <span style=color:#f92672>=</span> { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register_function</span>(self, func):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_functions[func<span style=color:#f92672>.</span>__name__] <span style=color:#f92672>=</span> func
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_connection</span>(self, connection):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># Receive a message</span>
</span></span><span style=display:flex><span>                func_name, args, kwargs <span style=color:#f92672>=</span> pickle<span style=color:#f92672>.</span>loads(connection<span style=color:#f92672>.</span>recv())
</span></span><span style=display:flex><span>                <span style=color:#75715e># Run the RPC and send a response</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                    r <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_functions[func_name](<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>                    connection<span style=color:#f92672>.</span>send(pickle<span style=color:#f92672>.</span>dumps(r))
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                    connection<span style=color:#f92672>.</span>send(pickle<span style=color:#f92672>.</span>dumps(e))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>EOFError</span>:
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing.connection <span style=color:#f92672>import</span> Listener
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rpc_server</span>(handler, address, authkey):
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> Listener(address, authkey<span style=color:#f92672>=</span>authkey)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>handler<span style=color:#f92672>.</span>handle_connection, args<span style=color:#f92672>=</span>(client,))
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Some remote functions</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sub</span>(x, y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>-</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Register with a handler</span>
</span></span><span style=display:flex><span>handler <span style=color:#f92672>=</span> RPCHandler()
</span></span><span style=display:flex><span>handler<span style=color:#f92672>.</span>register_function(add)
</span></span><span style=display:flex><span>handler<span style=color:#f92672>.</span>register_function(sub)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run the server</span>
</span></span><span style=display:flex><span>rpc_server(handler, (<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>17000</span>), authkey<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;peekaboo&#39;</span>)
</span></span></code></pre></div><h3 id=客户端>客户端
<a class=header-anchor href=#%e5%ae%a2%e6%88%b7%e7%ab%af></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pickle
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RPCProxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, connection):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_connection <span style=color:#f92672>=</span> connection
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattr__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_rpc</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_connection<span style=color:#f92672>.</span>send(pickle<span style=color:#f92672>.</span>dumps((name, args, kwargs)))
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> pickle<span style=color:#f92672>.</span>loads(self<span style=color:#f92672>.</span>_connection<span style=color:#f92672>.</span>recv())
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(result, <span style=color:#a6e22e>Exception</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> result
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> do_rpc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> multiprocessing.connection <span style=color:#f92672>import</span> Client
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c <span style=color:#f92672>=</span> Client((<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>17000</span>), authkey<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;peekaboo&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> proxy <span style=color:#f92672>=</span> RPCProxy(c)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> proxy<span style=color:#f92672>.</span>add(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> proxy<span style=color:#f92672>.</span>sub(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> proxy<span style=color:#f92672>.</span>sub([<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;rpcserver.py&#34;</span>, line <span style=color:#ae81ff>37</span>, <span style=color:#f92672>in</span> do_rpc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> result
</span></span><span style=display:flex><span><span style=color:#a6e22e>TypeError</span>: unsupported operand type(s) <span style=color:#66d9ef>for</span> <span style=color:#f92672>-</span>: <span style=color:#e6db74>&#39;list&#39;</span> <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39;int&#39;</span>
</span></span></code></pre></div><h2 id=简单的客户端认证>简单的客户端认证
<a class=header-anchor href=#%e7%ae%80%e5%8d%95%e7%9a%84%e5%ae%a2%e6%88%b7%e7%ab%af%e8%ae%a4%e8%af%81></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> hmac
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>client_authenticate</span>(connection, secret_key):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Authenticate client to a remote service.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    connection represents a network connection.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    secret_key is a key known only to both client/server.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    message <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>    hash <span style=color:#f92672>=</span> hmac<span style=color:#f92672>.</span>new(secret_key, message)
</span></span><span style=display:flex><span>    digest <span style=color:#f92672>=</span> hash<span style=color:#f92672>.</span>digest()
</span></span><span style=display:flex><span>    connection<span style=color:#f92672>.</span>send(digest)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>server_authenticate</span>(connection, secret_key):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Request client authentication.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    message <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>urandom(<span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>    connection<span style=color:#f92672>.</span>send(message)
</span></span><span style=display:flex><span>    hash <span style=color:#f92672>=</span> hmac<span style=color:#f92672>.</span>new(secret_key, message)
</span></span><span style=display:flex><span>    digest <span style=color:#f92672>=</span> hash<span style=color:#f92672>.</span>digest()
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span>recv(len(digest))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hmac<span style=color:#f92672>.</span>compare_digest(digest,response)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>secret_key <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;peekaboo&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_handler</span>(client_sock):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> server_authenticate(client_sock, secret_key):
</span></span><span style=display:flex><span>        client_sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> client_sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> msg:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        client_sock<span style=color:#f92672>.</span>sendall(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_server</span>(address):
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        c,a <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        echo_handler(c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo_server((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>18000</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Within a client, you would do this:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>secret_key <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;peekaboo&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>18000</span>))
</span></span><span style=display:flex><span>client_authenticate(s, secret_key)
</span></span><span style=display:flex><span>s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello World&#39;</span>)
</span></span><span style=display:flex><span>resp <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1024</span>)
</span></span></code></pre></div><h2 id=网络服务中加入-ssl>网络服务中加入 SSL
<a class=header-anchor href=#%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1%e4%b8%ad%e5%8a%a0%e5%85%a5-ssl></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 服务端</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> ssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>KEYFILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;server_key.pem&#39;</span>   <span style=color:#75715e># Private key of the server</span>
</span></span><span style=display:flex><span>CERTFILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;server_cert.pem&#39;</span> <span style=color:#75715e># Server certificate (given to client)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_client</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data <span style=color:#f92672>==</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        s<span style=color:#f92672>.</span>send(data)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Connection closed&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_server</span>(address):
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Wrap with an SSL layer requiring client certs</span>
</span></span><span style=display:flex><span>    s_ssl <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>wrap_socket(s,
</span></span><span style=display:flex><span>                            keyfile<span style=color:#f92672>=</span>KEYFILE,
</span></span><span style=display:flex><span>                            certfile<span style=color:#f92672>=</span>CERTFILE,
</span></span><span style=display:flex><span>                            server_side<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>                            )
</span></span><span style=display:flex><span>    <span style=color:#75715e># Wait for connections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            c,a <span style=color:#f92672>=</span> s_ssl<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Got connection&#39;</span>, c, a)
</span></span><span style=display:flex><span>            echo_client(c)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(e<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__, e))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo_server((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>20000</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 客户端</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> ssl
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s_ssl <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>wrap_socket(s,
</span></span><span style=display:flex><span>                cert_reqs<span style=color:#f92672>=</span>ssl<span style=color:#f92672>.</span>CERT_REQUIRED,
</span></span><span style=display:flex><span>                ca_certs <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;server_cert.pem&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s_ssl<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>20000</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s_ssl<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello World?&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s_ssl<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello World?&#39;</span>
</span></span></code></pre></div><h3 id=mixin-类>mixin 类
<a class=header-anchor href=#mixin-%e7%b1%bb></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> ssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SSLMixin</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Mixin class that adds support for SSL to existing servers based
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    on the socketserver module.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args,
</span></span><span style=display:flex><span>                 keyfile<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, certfile<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, ca_certs<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>                 cert_reqs<span style=color:#f92672>=</span>ssl<span style=color:#f92672>.</span>CERT_NONE,
</span></span><span style=display:flex><span>                 <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_keyfile <span style=color:#f92672>=</span> keyfile
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_certfile <span style=color:#f92672>=</span> certfile
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ca_certs <span style=color:#f92672>=</span> ca_certs
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_cert_reqs <span style=color:#f92672>=</span> cert_reqs
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_request</span>(self):
</span></span><span style=display:flex><span>        client, addr <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>get_request()
</span></span><span style=display:flex><span>        client_ssl <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>wrap_socket(client,
</span></span><span style=display:flex><span>                                     keyfile <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_keyfile,
</span></span><span style=display:flex><span>                                     certfile <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_certfile,
</span></span><span style=display:flex><span>                                     ca_certs <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_ca_certs,
</span></span><span style=display:flex><span>                                     cert_reqs <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_cert_reqs,
</span></span><span style=display:flex><span>                                     server_side <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> client_ssl, addr
</span></span></code></pre></div><h3 id=ssl-xmlrpc>SSL XMLRPC
<a class=header-anchor href=#ssl-xmlrpc></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># XML-RPC server with SSL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> xmlrpc.server <span style=color:#f92672>import</span> SimpleXMLRPCServer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SSLSimpleXMLRPCServer</span>(SSLMixin, SimpleXMLRPCServer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Here<span style=color:#e6db74>&#39;s the XML-RPC server from Recipe 11.6 modified only slightly to use SSL:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> ssl
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> xmlrpc.server <span style=color:#f92672>import</span> SimpleXMLRPCServer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sslmixin <span style=color:#f92672>import</span> SSLMixin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SSLSimpleXMLRPCServer</span>(SSLMixin, SimpleXMLRPCServer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KeyValueServer</span>:
</span></span><span style=display:flex><span>    _rpc_methods_ <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;get&#39;</span>, <span style=color:#e6db74>&#39;set&#39;</span>, <span style=color:#e6db74>&#39;delete&#39;</span>, <span style=color:#e6db74>&#39;exists&#39;</span>, <span style=color:#e6db74>&#39;keys&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_data <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_serv <span style=color:#f92672>=</span> SSLSimpleXMLRPCServer(<span style=color:#f92672>*</span>args, allow_none<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_rpc_methods_:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_serv<span style=color:#f92672>.</span>register_function(getattr(self, name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_data[name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set</span>(self, name, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_data[name] <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> self<span style=color:#f92672>.</span>_data[name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>exists</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>keys</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list(self<span style=color:#f92672>.</span>_data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>serve_forever</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_serv<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    KEYFILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;server_key.pem&#39;</span>    <span style=color:#75715e># Private key of the server</span>
</span></span><span style=display:flex><span>    CERTFILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;server_cert.pem&#39;</span>  <span style=color:#75715e># Server certificate</span>
</span></span><span style=display:flex><span>    kvserv <span style=color:#f92672>=</span> KeyValueServer((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>15000</span>),
</span></span><span style=display:flex><span>                            keyfile<span style=color:#f92672>=</span>KEYFILE,
</span></span><span style=display:flex><span>                            certfile<span style=color:#f92672>=</span>CERTFILE)
</span></span><span style=display:flex><span>    kvserv<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> xmlrpc.client <span style=color:#f92672>import</span> ServerProxy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> ServerProxy(<span style=color:#e6db74>&#39;https://localhost:15000&#39;</span>, allow_none<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;foo&#39;</span>,<span style=color:#e6db74>&#39;bar&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>set(<span style=color:#e6db74>&#39;spam&#39;</span>, [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>keys()
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;spam&#39;</span>, <span style=color:#e6db74>&#39;foo&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;foo&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;bar&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>delete(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>exists(<span style=color:#e6db74>&#39;spam&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>False</span>
</span></span></code></pre></div><h3 id=验证-xmlrpc-服务器证书>验证 XMLRPC 服务器证书
<a class=header-anchor href=#%e9%aa%8c%e8%af%81-xmlrpc-%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%af%81%e4%b9%a6></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> xmlrpc.client <span style=color:#f92672>import</span> SafeTransport, ServerProxy
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> ssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VerifyCertSafeTransport</span>(SafeTransport):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, cafile, certfile<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, keyfile<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        SafeTransport<span style=color:#f92672>.</span>__init__(self)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ssl_context <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>SSLContext(ssl<span style=color:#f92672>.</span>PROTOCOL_TLSv1)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ssl_context<span style=color:#f92672>.</span>load_verify_locations(cafile)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> certfile:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_ssl_context<span style=color:#f92672>.</span>load_cert_chain(certfile, keyfile)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ssl_context<span style=color:#f92672>.</span>verify_mode <span style=color:#f92672>=</span> ssl<span style=color:#f92672>.</span>CERT_REQUIRED
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_connection</span>(self, host):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Items in the passed dictionary are passed as keyword</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># arguments to the http.client.HTTPSConnection() constructor.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># The context argument allows an ssl.SSLContext instance to</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># be passed with information about the SSL configuration</span>
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>make_connection((host, {<span style=color:#e6db74>&#39;context&#39;</span>: self<span style=color:#f92672>.</span>_ssl_context}))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the client proxy</span>
</span></span><span style=display:flex><span>s <span style=color:#f92672>=</span> ServerProxy(<span style=color:#e6db74>&#39;https://localhost:15000&#39;</span>,
</span></span><span style=display:flex><span>                transport<span style=color:#f92672>=</span>VerifyCertSafeTransport(<span style=color:#e6db74>&#39;server_cert.pem&#39;</span>),
</span></span><span style=display:flex><span>                allow_none<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><h2 id=进程间传递-socket-文件描述符>进程间传递 Socket 文件描述符
<a class=header-anchor href=#%e8%bf%9b%e7%a8%8b%e9%97%b4%e4%bc%a0%e9%80%92-socket-%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> multiprocessing
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing.reduction <span style=color:#f92672>import</span> recv_handle, send_handle
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>worker</span>(in_p, out_p):
</span></span><span style=display:flex><span>    out_p<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        fd <span style=color:#f92672>=</span> recv_handle(in_p)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;CHILD: GOT FD&#39;</span>, fd)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM, fileno<span style=color:#f92672>=</span>fd) <span style=color:#66d9ef>as</span> s:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> msg:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#39;CHILD: RECV </span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(msg))
</span></span><span style=display:flex><span>                s<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>server</span>(address, in_p, out_p, worker_pid):
</span></span><span style=display:flex><span>    in_p<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>setsockopt(socket<span style=color:#f92672>.</span>SOL_SOCKET, socket<span style=color:#f92672>.</span>SO_REUSEADDR, <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        client, addr <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;SERVER: Got connection from&#39;</span>, addr)
</span></span><span style=display:flex><span>        send_handle(out_p, client<span style=color:#f92672>.</span>fileno(), worker_pid)
</span></span><span style=display:flex><span>        client<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    c1, c2 <span style=color:#f92672>=</span> multiprocessing<span style=color:#f92672>.</span>Pipe()
</span></span><span style=display:flex><span>    worker_p <span style=color:#f92672>=</span> multiprocessing<span style=color:#f92672>.</span>Process(target<span style=color:#f92672>=</span>worker, args<span style=color:#f92672>=</span>(c1,c2))
</span></span><span style=display:flex><span>    worker_p<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server_p <span style=color:#f92672>=</span> multiprocessing<span style=color:#f92672>.</span>Process(target<span style=color:#f92672>=</span>server,
</span></span><span style=display:flex><span>                  args<span style=color:#f92672>=</span>((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>15000</span>), c1, c2, worker_p<span style=color:#f92672>.</span>pid))
</span></span><span style=display:flex><span>    server_p<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    c1<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    c2<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>两个进程被创建并通过一个 multiprocessing 管道连接起来。 服务器进程打开一个socket并等待客户端连接请求。 工作进程仅仅使用 <code>recv_handle()</code> 在管道上面等待接收一个文件描述符。 当服务器接收到一个连接，它将产生的socket文件描述符通过 <code>send_handle()</code> 传递给工作进程。</p><p>// TODO</p><h2 id=理解事件驱动io>理解事件驱动IO
<a class=header-anchor href=#%e7%90%86%e8%a7%a3%e4%ba%8b%e4%bb%b6%e9%a9%b1%e5%8a%a8io></a></h2><p>// TODO 理解</p><p>事件驱动I/O本质上来讲就是将基本I/O操作（比如读和写）转化为你程序需要处理的事件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventHandler</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fileno</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Return the associated file descriptor&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> NotImplemented(<span style=color:#e6db74>&#39;must implement&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Return True if receiving is allowed&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Perform the receive operation&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_send</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Return True if sending is requested&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_send</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Send outgoing data&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> select
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>event_loop</span>(handlers):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        wants_recv <span style=color:#f92672>=</span> [h <span style=color:#66d9ef>for</span> h <span style=color:#f92672>in</span> handlers <span style=color:#66d9ef>if</span> h<span style=color:#f92672>.</span>wants_to_receive()]
</span></span><span style=display:flex><span>        wants_send <span style=color:#f92672>=</span> [h <span style=color:#66d9ef>for</span> h <span style=color:#f92672>in</span> handlers <span style=color:#66d9ef>if</span> h<span style=color:#f92672>.</span>wants_to_send()]
</span></span><span style=display:flex><span>        can_recv, can_send, _ <span style=color:#f92672>=</span> select<span style=color:#f92672>.</span>select(wants_recv, wants_send, [])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> h <span style=color:#f92672>in</span> can_recv:
</span></span><span style=display:flex><span>            h<span style=color:#f92672>.</span>handle_receive()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> h <span style=color:#f92672>in</span> can_send:
</span></span><span style=display:flex><span>            h<span style=color:#f92672>.</span>handle_send()
</span></span></code></pre></div><p>事件循环的关键部分是 <code>select()</code> 调用，它会不断轮询文件描述符从而激活它。 在调用 <code>select()</code> 之前，事件循环会询问所有的处理器来决定哪一个想接受或发生。 然后它将结果列表提供给 <code>select()</code> 。然后 <code>select()</code> 返回准备接受或发送的对象组成的列表。 然后相应的 <code>handle_receive()</code> 或 <code>handle_send()</code> 方法被触发。</p><h3 id=udp-网络服务>UDP 网络服务
<a class=header-anchor href=#udp-%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UDPServer</span>(EventHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, address):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_DGRAM)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fileno</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>fileno()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UDPTimeServer</span>(UDPServer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        msg, addr <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>sendto(time<span style=color:#f92672>.</span>ctime()<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;ascii&#39;</span>), addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UDPEchoServer</span>(UDPServer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        msg, addr <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>sendto(msg, addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    handlers <span style=color:#f92672>=</span> [ UDPTimeServer((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>14000</span>)), UDPEchoServer((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>15000</span>))  ]
</span></span><span style=display:flex><span>    event_loop(handlers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> socket(AF_INET, SOCK_DGRAM)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>sendto(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>,(<span style=color:#e6db74>&#39;localhost&#39;</span>,<span style=color:#ae81ff>14000</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>128</span>)
</span></span><span style=display:flex><span>(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Tue Sep 18 14:29:23 2012&#39;</span>, (<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>14000</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>sendto(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello&#39;</span>,(<span style=color:#e6db74>&#39;localhost&#39;</span>,<span style=color:#ae81ff>15000</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>128</span>)
</span></span><span style=display:flex><span>(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Hello&#39;</span>, (<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>15000</span>))
</span></span></code></pre></div><h3 id=tcp-网络服务>TCP 网络服务
<a class=header-anchor href=#tcp-%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1></a></h3><p>每一个客户端都要初始化一个新的处理器对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TCPServer</span>(EventHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, address, client_handler, handler_list):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>setsockopt(socket<span style=color:#f92672>.</span>SOL_SOCKET, socket<span style=color:#f92672>.</span>SO_REUSEADDR, <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>bind(address)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>client_handler <span style=color:#f92672>=</span> client_handler
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>handler_list <span style=color:#f92672>=</span> handler_list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fileno</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>fileno()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        client, addr <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        <span style=color:#75715e># Add the client to the event loop&#39;s handler list</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>handler_list<span style=color:#f92672>.</span>append(self<span style=color:#f92672>.</span>client_handler(client, self<span style=color:#f92672>.</span>handler_list))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TCPClient</span>(EventHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, sock, handler_list):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> sock
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>handler_list <span style=color:#f92672>=</span> handler_list
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>outgoing <span style=color:#f92672>=</span> bytearray()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fileno</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>fileno()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        <span style=color:#75715e># Remove myself from the event loop&#39;s handler list</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>handler_list<span style=color:#f92672>.</span>remove(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_send</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span> <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>outgoing <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_send</span>(self):
</span></span><span style=display:flex><span>        nsent <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>send(self<span style=color:#f92672>.</span>outgoing)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>outgoing <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>outgoing[nsent:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TCPEchoClient</span>(TCPClient):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> data:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>outgoing<span style=color:#f92672>.</span>extend(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>   handlers <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>   handlers<span style=color:#f92672>.</span>append(TCPServer((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>16000</span>), TCPEchoClient, handlers))
</span></span><span style=display:flex><span>   event_loop(handlers)
</span></span></code></pre></div><p>TCP例子的关键点是从处理器中列表增加和删除客户端的操作。 对每一个连接，一个新的处理器被创建并加到列表中。当连接被关闭后，每个客户端负责将其从列表中删除。</p><p>事件驱动I/O的缺点是没有真正的同步机制。 如果任何事件处理器方法阻塞或执行一个耗时计算，它会阻塞所有的处理进程。 调用那些并不是事件驱动风格的库函数也会有问题，同样要是某些库函数调用会阻塞，那么也会导致整个事件循环停止。</p><p>对于阻塞或耗时计算的问题可以通过将事件发送个其他单独的现场或进程来处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> concurrent.futures <span style=color:#f92672>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThreadPoolHandler</span>(EventHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, nworkers):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;posix&#39;</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>signal_done_sock, self<span style=color:#f92672>.</span>done_sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socketpair()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            server <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span>bind((<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>signal_done_sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET,
</span></span><span style=display:flex><span>                                                  socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>signal_done_sock<span style=color:#f92672>.</span>connect(server<span style=color:#f92672>.</span>getsockname())
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>done_sock, _ <span style=color:#f92672>=</span> server<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pending <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pool <span style=color:#f92672>=</span> ThreadPoolExecutor(nworkers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fileno</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>done_sock<span style=color:#f92672>.</span>fileno()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Callback that executes when the thread is done</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_complete</span>(self, callback, r):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pending<span style=color:#f92672>.</span>append((callback, r<span style=color:#f92672>.</span>result()))
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>signal_done_sock<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;x&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Run a function in a thread pool</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self, func, args<span style=color:#f92672>=</span>(), kwargs<span style=color:#f92672>=</span>{},<span style=color:#f92672>*</span>,callback):
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>pool<span style=color:#f92672>.</span>submit(func, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        r<span style=color:#f92672>.</span>add_done_callback(<span style=color:#66d9ef>lambda</span> r: self<span style=color:#f92672>.</span>_complete(callback, r))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wants_to_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Run callback functions of completed work</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Invoke all pending callback functions</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> callback, result <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>pending:
</span></span><span style=display:flex><span>            callback(result)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>done_sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>pending <span style=color:#f92672>=</span> []
</span></span></code></pre></div><p><code>run()</code> 方法被用来将工作提交给回调函数池，处理完成后调用。 实际工作被提交给 ThreadPoolExecutor 实例。 不过一个难点是协调计算结果和事件循环，为了解决它，我们创建了一对 socket 并将其作为某种信号量机制来使用。 当线程池完成工作后，它会执行类中的 <code>_complete()</code> 方法。 这个方法再某个 socket 上写入字节之前会将挂起的回调函数和结果放入队列中。 <code>fileno()</code> 方法返回另外的那个 socket。 因此，这个字节被写入时，它会通知事件循环， 然后 <code>handle_receive()</code> 方法被激活并为所有之前提交的工作执行回调函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># A really bad Fibonacci implementation</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fib</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> fib(n <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> fib(n <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UDPFibServer</span>(UDPServer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_receive</span>(self):
</span></span><span style=display:flex><span>        msg, addr <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>128</span>)
</span></span><span style=display:flex><span>        n <span style=color:#f92672>=</span> int(msg)
</span></span><span style=display:flex><span>        pool<span style=color:#f92672>.</span>run(fib, (n,), callback<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> r: self<span style=color:#f92672>.</span>respond(r, addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>respond</span>(self, result, addr):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>sendto(str(result)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;ascii&#39;</span>), addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    pool <span style=color:#f92672>=</span> ThreadPoolHandler(<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    handlers <span style=color:#f92672>=</span> [ pool, UDPFibServer((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>16000</span>))]
</span></span><span style=display:flex><span>    event_loop(handlers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>sock <span style=color:#f92672>=</span> socket(AF_INET, SOCK_DGRAM)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>40</span>):
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>sendto(str(x)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;ascii&#39;</span>), (<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>16000</span>))
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>    print(resp[<span style=color:#ae81ff>0</span>])
</span></span></code></pre></div><h2 id=发送与接收大型数组>发送与接收大型数组
<a class=header-anchor href=#%e5%8f%91%e9%80%81%e4%b8%8e%e6%8e%a5%e6%94%b6%e5%a4%a7%e5%9e%8b%e6%95%b0%e7%bb%84></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># zerocopy.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_from</span>(arr, dest):
</span></span><span style=display:flex><span>    view <span style=color:#f92672>=</span> memoryview(arr)<span style=color:#f92672>.</span>cast(<span style=color:#e6db74>&#39;B&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> len(view):
</span></span><span style=display:flex><span>        nsent <span style=color:#f92672>=</span> dest<span style=color:#f92672>.</span>send(view)
</span></span><span style=display:flex><span>        view <span style=color:#f92672>=</span> view[nsent:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recv_into</span>(arr, source):
</span></span><span style=display:flex><span>    view <span style=color:#f92672>=</span> memoryview(arr)<span style=color:#f92672>.</span>cast(<span style=color:#e6db74>&#39;B&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> len(view):
</span></span><span style=display:flex><span>        nrecv <span style=color:#f92672>=</span> source<span style=color:#f92672>.</span>recv_into(view)
</span></span><span style=display:flex><span>        view <span style=color:#f92672>=</span> view[nrecv:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Server</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>bind((<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>25000</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c,a <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a <span style=color:#f92672>=</span> numpy<span style=color:#f92672>.</span>arange(<span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>50000000.0</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> send_from(a, c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Client</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>25000</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a <span style=color:#f92672>=</span> numpy<span style=color:#f92672>.</span>zeros(shape<span style=color:#f92672>=</span><span style=color:#ae81ff>50000000</span>, dtype<span style=color:#f92672>=</span>float)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>10</span>]
</span></span><span style=display:flex><span>array([ <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>0.</span>])
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> recv_into(a, c)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a[<span style=color:#ae81ff>0</span>:<span style=color:#ae81ff>10</span>]
</span></span><span style=display:flex><span>array([ <span style=color:#ae81ff>0.</span>,  <span style=color:#ae81ff>1.</span>,  <span style=color:#ae81ff>2.</span>,  <span style=color:#ae81ff>3.</span>,  <span style=color:#ae81ff>4.</span>,  <span style=color:#ae81ff>5.</span>,  <span style=color:#ae81ff>6.</span>,  <span style=color:#ae81ff>7.</span>,  <span style=color:#ae81ff>8.</span>,  <span style=color:#ae81ff>9.</span>])
</span></span></code></pre></div><p>这个视图能被传递给socket相关函数， 比如 <code>socket.send()</code> 或 <code>send.recv_into()</code> 。 在内部，这些方法能够直接操作这个内存区域。</p><p>这里有个问题就是接受者必须事先知道有多少数据要被发送， 以便它能预分配一个数组或者确保它能将接受的数据放入一个已经存在的数组中。 如果没办法知道的话，发送者就得先将数据大小发送过来，然后再发送实际的数组数据。</p><h1 id=并发编程>并发编程
<a class=header-anchor href=#%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b></a></h1><h2 id=启动与停止线程>启动与停止线程
<a class=header-anchor href=#%e5%90%af%e5%8a%a8%e4%b8%8e%e5%81%9c%e6%ad%a2%e7%ba%bf%e7%a8%8b></a></h2><p>threading 库可以在单独的线程中执行任何的在 Python 中可以调用的对象。你可以创建一个 Thread 对象并将你要执行的对象以 target 参数的形式提供给该对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Code to execute in an independent thread</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countdown</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;T-minus&#39;</span>, n)
</span></span><span style=display:flex><span>        n <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create and launch a thread</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span>t <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>countdown, args<span style=color:#f92672>=</span>(<span style=color:#ae81ff>10</span>,))
</span></span><span style=display:flex><span>t<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>当你创建好一个线程对象后，该对象并不会立即执行，除非你调用它的 <code>start()</code> 方法。</p><p>由于全局解释锁（GIL）的原因，Python 的线程被限制到同一时刻只允许一个线程执行这样一个执行模型。所以，Python 的线程更适用于处理 I/O 和其他需要并发执行的阻塞操作（比如等待I/O、等待从数据库获取数据等等），而不是需要多处理器并行的计算密集型任务。</p><h2 id=线程同步方式>线程同步方式
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5%e6%96%b9%e5%bc%8f></a></h2><p>线程的一个关键特性是每个线程都是独立运行且状态不可预测。Event 对象包含一个可由线程设置的信号标志，它允许线程等待某些事件的发生。在初始情况下，event 对象中的信号标志被设置为假。如果有线程等待一个 event 对象，而这个 event 对象的标志为假，那么这个线程将会被一直阻塞直至该标志为真。一个线程如果将一个 event 对象的信号标志设置为真，它将唤醒所有等待这个 event 对象的线程。如果一个线程等待一个已经被设置为真的 event 对象，那么它将忽略这个事件，继续执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread, Event
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Code to execute in an independent thread</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countdown</span>(n, started_evt):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;countdown starting&#39;</span>)
</span></span><span style=display:flex><span>    started_evt<span style=color:#f92672>.</span>set()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;T-minus&#39;</span>, n)
</span></span><span style=display:flex><span>        n <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the event object that will be used to signal startup</span>
</span></span><span style=display:flex><span>started_evt <span style=color:#f92672>=</span> Event()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Launch the thread and pass the startup event</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;Launching countdown&#39;</span>)
</span></span><span style=display:flex><span>t <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>countdown, args<span style=color:#f92672>=</span>(<span style=color:#ae81ff>10</span>, started_evt))
</span></span><span style=display:flex><span>t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wait for the thread to start</span>
</span></span><span style=display:flex><span>started_evt<span style=color:#f92672>.</span>wait()
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;countdown is running&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Launching countdown</span>
</span></span><span style=display:flex><span><span style=color:#75715e># countdown starting</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 10</span>
</span></span><span style=display:flex><span><span style=color:#75715e># countdown is running</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 9</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 8</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 7</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 6</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 4</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 1</span>
</span></span></code></pre></div><p>event 对象最好单次使用，就是说，你创建一个 event 对象，让某个线程等待这个对象，一旦这个对象被设置为真，你就应该丢弃它。尽管可以通过 <code>clear()</code> 方法来重置 event 对象，但是很难确保安全地清理 event 对象并对它重新赋值。很可能会发生错过事件、死锁或者其他问题（特别是，你无法保证重置 event 对象的代码会在线程再次等待这个 event 对象之前执行）。如果一个线程需要不停地重复使用 event 对象，你最好使用 Condition 对象来代替。</p><h3 id=condition>Condition
<a class=header-anchor href=#condition></a></h3><p>event 对象的一个重要特点是当它被设置为真时，会唤醒所有等待它的线程。如果你只想唤醒单个线程，最好是使用信号量或者 Condition 对象来替代。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PeriodicTimer</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, interval):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_interval <span style=color:#f92672>=</span> interval
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_flag <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_cv <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Condition()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start</span>(self):
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>run)
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Run the timer and notify waiting threads after each interval
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            time<span style=color:#f92672>.</span>sleep(self<span style=color:#f92672>.</span>_interval)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>_cv:
</span></span><span style=display:flex><span>                 self<span style=color:#f92672>.</span>_flag <span style=color:#f92672>^=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                 self<span style=color:#f92672>.</span>_cv<span style=color:#f92672>.</span>notify_all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wait_for_tick</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Wait for the next tick of the timer
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>_cv:
</span></span><span style=display:flex><span>            last_flag <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_flag
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> last_flag <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>_flag:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_cv<span style=color:#f92672>.</span>wait()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use of the timer</span>
</span></span><span style=display:flex><span>ptimer <span style=color:#f92672>=</span> PeriodicTimer(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>ptimer<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Two threads that synchronize on the timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countdown</span>(nticks):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> nticks <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        ptimer<span style=color:#f92672>.</span>wait_for_tick()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;T-minus&#39;</span>, nticks)
</span></span><span style=display:flex><span>        nticks <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countup</span>(last):
</span></span><span style=display:flex><span>    n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&lt;</span> last:
</span></span><span style=display:flex><span>        ptimer<span style=color:#f92672>.</span>wait_for_tick()
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Counting&#39;</span>, n)
</span></span><span style=display:flex><span>        n <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>countdown, args<span style=color:#f92672>=</span>(<span style=color:#ae81ff>10</span>,))<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>countup, args<span style=color:#f92672>=</span>(<span style=color:#ae81ff>5</span>,))<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><h3 id=semaphore>Semaphore
<a class=header-anchor href=#semaphore></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Worker thread</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>worker</span>(n, sema):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Wait to be signaled</span>
</span></span><span style=display:flex><span>    sema<span style=color:#f92672>.</span>acquire()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Do some work</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Working&#39;</span>, n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create some threads</span>
</span></span><span style=display:flex><span>sema <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Semaphore(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>nworkers <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(nworkers):
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>worker, args<span style=color:#f92672>=</span>(n, sema,))
</span></span><span style=display:flex><span>    t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> sema<span style=color:#f92672>.</span>release()
</span></span><span style=display:flex><span>Working <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> sema<span style=color:#f92672>.</span>release()
</span></span><span style=display:flex><span>Working <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h2 id=线程间通信>线程间通信
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e9%97%b4%e9%80%9a%e4%bf%a1></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> queue <span style=color:#f92672>import</span> Queue
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Object that signals shutdown</span>
</span></span><span style=display:flex><span>_sentinel <span style=color:#f92672>=</span> object()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A thread that produces data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>producer</span>(out_q):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> running:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Produce some data</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        out_q<span style=color:#f92672>.</span>put(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Put the sentinel on the queue to indicate completion</span>
</span></span><span style=display:flex><span>    out_q<span style=color:#f92672>.</span>put(_sentinel)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A thread that consumes data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consumer</span>(in_q):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get some data</span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> in_q<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Check for termination</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data <span style=color:#f92672>is</span> _sentinel:
</span></span><span style=display:flex><span>            in_q<span style=color:#f92672>.</span>put(_sentinel)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Process the data</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the shared queue and launch both threads</span>
</span></span><span style=display:flex><span>q <span style=color:#f92672>=</span> Queue()
</span></span><span style=display:flex><span>t1 <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>consumer, args<span style=color:#f92672>=</span>(q,))
</span></span><span style=display:flex><span>t2 <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>producer, args<span style=color:#f92672>=</span>(q,))
</span></span><span style=display:flex><span>t1<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>t2<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>Queue 对象已经包含了必要的锁，所以你可以通过它在多个线程间多安全地共享数据。本例中有一个特殊的地方：消费者在读到这个特殊值之后立即又把它放回到队列中，将之传递下去。这样，所有监听这个队列的消费者线程就可以全部关闭了。</p><h3 id=condition-实现优先队列>Condition 实现优先队列
<a class=header-anchor href=#condition-%e5%ae%9e%e7%8e%b0%e4%bc%98%e5%85%88%e9%98%9f%e5%88%97></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PriorityQueue</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_queue <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_cv <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Condition()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>put</span>(self, item, priority):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>_cv:
</span></span><span style=display:flex><span>            heapq<span style=color:#f92672>.</span>heappush(self<span style=color:#f92672>.</span>_queue, (<span style=color:#f92672>-</span>priority, self<span style=color:#f92672>.</span>_count, item))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_cv<span style=color:#f92672>.</span>notify()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>_cv:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> len(self<span style=color:#f92672>.</span>_queue) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_cv<span style=color:#f92672>.</span>wait()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> heapq<span style=color:#f92672>.</span>heappop(self<span style=color:#f92672>.</span>_queue)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span></code></pre></div><p>使用队列来进行线程间通信是一个单向、不确定的过程。通常情况下，你没有办法知道接收数据的线程是什么时候接收到的数据并开始工作的。不过队列对象提供一些基本完成的特性，比如 <code>task_done()</code> 和 <code>join()</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> queue <span style=color:#f92672>import</span> Queue
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A thread that produces data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>producer</span>(out_q):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> running:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Produce some data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        out_q<span style=color:#f92672>.</span>put(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A thread that consumes data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consumer</span>(in_q):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get some data</span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> in_q<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Process the data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Indicate completion</span>
</span></span><span style=display:flex><span>        in_q<span style=color:#f92672>.</span>task_done()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create the shared queue and launch both threads</span>
</span></span><span style=display:flex><span>q <span style=color:#f92672>=</span> Queue()
</span></span><span style=display:flex><span>t1 <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>consumer, args<span style=color:#f92672>=</span>(q,))
</span></span><span style=display:flex><span>t2 <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>producer, args<span style=color:#f92672>=</span>(q,))
</span></span><span style=display:flex><span>t1<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>t2<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wait for all produced items to be consumed</span>
</span></span><span style=display:flex><span>q<span style=color:#f92672>.</span>join()
</span></span></code></pre></div><p>如果一个线程需要在一个“消费者”线程处理完特定的数据项时立即得到通知，你可以把要发送的数据和一个 Event 放到一起使用，这样“生产者”就可以通过这个Event对象来监测处理的过程了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> queue <span style=color:#f92672>import</span> Queue
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread, Event
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A thread that produces data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>producer</span>(out_q):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> running:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Produce some data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Make an (data, event) pair and hand it to the consumer</span>
</span></span><span style=display:flex><span>        evt <span style=color:#f92672>=</span> Event()
</span></span><span style=display:flex><span>        out_q<span style=color:#f92672>.</span>put((data, evt))
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Wait for the consumer to process the item</span>
</span></span><span style=display:flex><span>        evt<span style=color:#f92672>.</span>wait()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># A thread that consumes data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consumer</span>(in_q):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get some data</span>
</span></span><span style=display:flex><span>        data, evt <span style=color:#f92672>=</span> in_q<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>        <span style=color:#75715e># Process the data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Indicate completion</span>
</span></span><span style=display:flex><span>        evt<span style=color:#f92672>.</span>set()
</span></span></code></pre></div><p>使用线程队列有一个要注意的问题是，向队列中添加数据项时并不会复制此数据项，线程间通信实际上是在线程间<strong>传递对象引用</strong>。如果你担心对象的共享状态，那你最好只传递不可修改的数据结构（如：整型、字符串或者元组）或者一个对象的深拷贝。</p><p>Queue 对象提供一些在当前上下文很有用的附加特性。比如在创建 Queue 对象时提供可选的 size 参数来限制可以添加到队列中的元素数量。<code>get()</code> 和 <code>put()</code> 方法都支持非阻塞方式和设定超时。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> queue
</span></span><span style=display:flex><span>q <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span>Queue()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> q<span style=color:#f92672>.</span>get(block<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> queue<span style=color:#f92672>.</span>Empty:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    q<span style=color:#f92672>.</span>put(item, block<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> queue<span style=color:#f92672>.</span>Full:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> q<span style=color:#f92672>.</span>get(timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>5.0</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> queue<span style=color:#f92672>.</span>Empty:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><p>最后，有 <code>q.qsize()</code> ， <code>q.full()</code> ， <code>q.empty()</code> 等实用方法可以获取一个队列的当前大小和状态。但要注意，这些方法都不是线程安全的。</p><h2 id=线程锁>线程锁
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e9%94%81></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SharedCounter</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    A counter object that can be shared by multiple threads.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, initial_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_value <span style=color:#f92672>=</span> initial_value
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_value_lock <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>incr</span>(self,delta<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Increment the counter with locking
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>_value_lock:
</span></span><span style=display:flex><span>             self<span style=color:#f92672>.</span>_value <span style=color:#f92672>+=</span> delta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decr</span>(self,delta<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Decrement the counter with locking
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>_value_lock:
</span></span><span style=display:flex><span>             self<span style=color:#f92672>.</span>_value <span style=color:#f92672>-=</span> delta
</span></span></code></pre></div><p>Lock 对象和 with 语句块一起使用可以保证互斥执行，就是每次只有一个线程可以执行 with 语句包含的代码块。with 语句会在这个代码块执行前自动获取锁，在执行结束后自动释放锁。</p><h3 id=rlock>RLock
<a class=header-anchor href=#rlock></a></h3><p>RLock （可重入锁）可以被同一个线程多次获取，主要用来实现<strong>基于监测对象模式的锁定和同步</strong>。在使用这种锁的情况下，当锁被持有时，只有一个线程可以使用完整的函数或者类中的方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 所有实例共享的类级锁</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SharedCounter</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    A counter object that can be shared by multiple threads.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    _lock <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>RLock()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, initial_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_value <span style=color:#f92672>=</span> initial_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>incr</span>(self,delta<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Increment the counter with locking
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> SharedCounter<span style=color:#f92672>.</span>_lock:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_value <span style=color:#f92672>+=</span> delta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decr</span>(self,delta<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Decrement the counter with locking
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> SharedCounter<span style=color:#f92672>.</span>_lock:
</span></span><span style=display:flex><span>             self<span style=color:#f92672>.</span>incr(<span style=color:#f92672>-</span>delta)
</span></span></code></pre></div><h2 id=防止死锁的加锁机制>防止死锁的加锁机制
<a class=header-anchor href=#%e9%98%b2%e6%ad%a2%e6%ad%bb%e9%94%81%e7%9a%84%e5%8a%a0%e9%94%81%e6%9c%ba%e5%88%b6></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> contextlib <span style=color:#f92672>import</span> contextmanager
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Thread-local state to stored information on locks already acquired</span>
</span></span><span style=display:flex><span>_local <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>local()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>acquire</span>(<span style=color:#f92672>*</span>locks):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Sort locks by object identifier</span>
</span></span><span style=display:flex><span>    locks <span style=color:#f92672>=</span> sorted(locks, key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: id(x))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Make sure lock order of previously acquired locks is not violated</span>
</span></span><span style=display:flex><span>    acquired <span style=color:#f92672>=</span> getattr(_local,<span style=color:#e6db74>&#39;acquired&#39;</span>,[])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> acquired <span style=color:#f92672>and</span> max(id(lock) <span style=color:#66d9ef>for</span> lock <span style=color:#f92672>in</span> acquired) <span style=color:#f92672>&gt;=</span> id(locks[<span style=color:#ae81ff>0</span>]):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Lock Order Violation&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Acquire all of the locks</span>
</span></span><span style=display:flex><span>    acquired<span style=color:#f92672>.</span>extend(locks)
</span></span><span style=display:flex><span>    _local<span style=color:#f92672>.</span>acquired <span style=color:#f92672>=</span> acquired
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> lock <span style=color:#f92672>in</span> locks:
</span></span><span style=display:flex><span>            lock<span style=color:#f92672>.</span>acquire()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Release locks in reverse order of acquisition</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> lock <span style=color:#f92672>in</span> reversed(locks):
</span></span><span style=display:flex><span>            lock<span style=color:#f92672>.</span>release()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> acquired[<span style=color:#f92672>-</span>len(locks):]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span>x_lock <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Lock()
</span></span><span style=display:flex><span>y_lock <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>thread_1</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> acquire(x_lock, y_lock):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Thread-1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>thread_2</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> acquire(y_lock, x_lock):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Thread-2&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>t1 <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>thread_1)
</span></span><span style=display:flex><span>t1<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>t1<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>t2 <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>thread_2)
</span></span><span style=display:flex><span>t2<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>t2<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>如果你执行这段代码，你会发现它即使在不同的函数中以不同的顺序获取锁也没有发生死锁。 其关键在于，在第一段代码中，我们对这些锁进行了排序。通过排序，使得不管用户以什么样的顺序来请求锁，这些锁都会按照<strong>固定的顺序被获取</strong>。</p><h3 id=避免死锁>避免死锁
<a class=header-anchor href=#%e9%81%bf%e5%85%8d%e6%ad%bb%e9%94%81></a></h3><p>死锁的检测与恢复是一个几乎没有优雅的解决方案的扩展话题。一个比较常用的死锁检测与恢复的方案是引入看门狗计数器。当线程正常运行的时候会每隔一段时间重置计数器，在没有发生死锁的情况下，一切都正常进行。一旦发生死锁，由于无法重置计数器导致定时器超时，这时程序会通过重启自身恢复到正常状态。</p><p>避免死锁是另外一种解决死锁问题的方式，在进程获取锁的时候会严格按照对象id升序排列获取，经过数学证明，这样保证程序不会进入死锁状态。避免死锁的主要思想是，单纯地按照对象id递增的顺序加锁不会产生循环依赖，而循环依赖是 死锁的一个必要条件，从而避免程序进入死锁状态。</p><h2 id=保存线程的状态信息>保存线程的状态信息
<a class=header-anchor href=#%e4%bf%9d%e5%ad%98%e7%ba%bf%e7%a8%8b%e7%9a%84%e7%8a%b6%e6%80%81%e4%bf%a1%e6%81%af></a></h2><p>可使用 <code>thread.local()</code> 创建一个本地线程存储对象。 对这个对象的属性的保存和读取操作都只会对执行线程可见，而其他线程并不可见。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LazyConnection</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, address, family<span style=color:#f92672>=</span>AF_INET, type<span style=color:#f92672>=</span>SOCK_STREAM):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> address
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>family <span style=color:#f92672>=</span> AF_INET
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> SOCK_STREAM
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>local <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>local()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> hasattr(self<span style=color:#f92672>.</span>local, <span style=color:#e6db74>&#39;sock&#39;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Already connected&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>local<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> socket(self<span style=color:#f92672>.</span>family, self<span style=color:#f92672>.</span>type)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>local<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>address)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>local<span style=color:#f92672>.</span>sock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_ty, exc_val, tb):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>local<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>del</span> self<span style=color:#f92672>.</span>local<span style=color:#f92672>.</span>sock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test</span>(conn):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> conn <span style=color:#66d9ef>as</span> s:
</span></span><span style=display:flex><span>        s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;GET /index.html HTTP/1.0</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Host: www.python.org</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        s<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(iter(partial(s<span style=color:#f92672>.</span>recv, <span style=color:#ae81ff>8192</span>), <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> bytes&#39;</span><span style=color:#f92672>.</span>format(len(resp)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    conn <span style=color:#f92672>=</span> LazyConnection((<span style=color:#e6db74>&#39;www.python.org&#39;</span>, <span style=color:#ae81ff>80</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    t1 <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>test, args<span style=color:#f92672>=</span>(conn,))
</span></span><span style=display:flex><span>    t2 <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>test, args<span style=color:#f92672>=</span>(conn,))
</span></span><span style=display:flex><span>    t1<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>    t2<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>    t1<span style=color:#f92672>.</span>join()
</span></span><span style=display:flex><span>    t2<span style=color:#f92672>.</span>join()
</span></span></code></pre></div><p>初始化为一个 <code>threading.local()</code> 实例。 其他方法操作被存储为 self.local.sock 的套接字对象。每个线程会创建一个自己专属的套接字连接（存储为self.local.sock）。 因此，当不同的线程执行套接字操作时，由于操作的是不同的套接字，因此它们不会相互影响。</p><p>其原理是，每个 threading.local() 实例为每个线程维护着一个单独的实例字典。 所有普通实例操作比如获取、修改和删除值仅仅操作这个字典。 每个线程使用一个独立的字典就可以保证数据的隔离了。</p><h2 id=线程池>线程池
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0></a></h2><h3 id=threadpoolexecutor-实现>ThreadPoolExecutor 实现
<a class=header-anchor href=#threadpoolexecutor-%e5%ae%9e%e7%8e%b0></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> AF_INET, SOCK_STREAM, socket
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> concurrent.futures <span style=color:#f92672>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_client</span>(sock, client_addr):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Handle a client connection
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got connection from&#39;</span>, client_addr)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> msg:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>sendall(msg)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Client closed connection&#39;</span>)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_server</span>(addr):
</span></span><span style=display:flex><span>    pool <span style=color:#f92672>=</span> ThreadPoolExecutor(<span style=color:#ae81ff>128</span>)
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>bind(addr)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        client_sock, client_addr <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        pool<span style=color:#f92672>.</span>submit(echo_client, client_sock, client_addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo_server((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>15000</span>))
</span></span></code></pre></div><h3 id=queue-实现>Queue 实现
<a class=header-anchor href=#queue-%e5%ae%9e%e7%8e%b0></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> queue <span style=color:#f92672>import</span> Queue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_client</span>(q):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Handle a client connection
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    sock, client_addr <span style=color:#f92672>=</span> q<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got connection from&#39;</span>, client_addr)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>65536</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> msg:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>sendall(msg)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Client closed connection&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo_server</span>(addr, nworkers):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Launch the client workers</span>
</span></span><span style=display:flex><span>    q <span style=color:#f92672>=</span> Queue()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(nworkers):
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>echo_client, args<span style=color:#f92672>=</span>(q,))
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Run the server</span>
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> socket(AF_INET, SOCK_STREAM)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>bind(addr)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        client_sock, client_addr <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        q<span style=color:#f92672>.</span>put((client_sock, client_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo_server((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>15000</span>), <span style=color:#ae81ff>128</span>)
</span></span></code></pre></div><p>使用 ThreadPoolExecutor 相对于手动实现的一个好处在于它使得任务提交者更方便的从被调用函数中获取返回值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> concurrent.futures <span style=color:#f92672>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib.request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fetch_url</span>(url):
</span></span><span style=display:flex><span>    u <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>urlopen(url)
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> u<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pool <span style=color:#f92672>=</span> ThreadPoolExecutor(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Submit work to the pool</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span>submit(fetch_url, <span style=color:#e6db74>&#39;http://www.python.org&#39;</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span>submit(fetch_url, <span style=color:#e6db74>&#39;http://www.pypy.org&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get the results back</span>
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>result()
</span></span><span style=display:flex><span>y <span style=color:#f92672>=</span> b<span style=color:#f92672>.</span>result()
</span></span></code></pre></div><p><code>a.result()</code> 操作会<strong>阻塞进程</strong>直到对应的函数执行完成并返回一个结果。</p><p>当创建一个线程时，操作系统会预留一个虚拟内存区域来放置线程的执行栈（通常是8MB大小）。但是这个内存只有一小片段被实际映射到真实内存中。 因此，Python 进程使用到的真实内存其实很小 （比如，对于2000个线程来讲，只使用到了70MB的真实内存，而不是9GB）。 如果你担心虚拟内存大小，可以使用 <code>threading.stack_size()</code> 函数来降低它。注意线程栈大小必须至少为32768字节，通常是系统内存页大小（4096、8192等）的整数倍。</p><h2 id=简单的并行编程>简单的并行编程
<a class=header-anchor href=#%e7%ae%80%e5%8d%95%e7%9a%84%e5%b9%b6%e8%a1%8c%e7%bc%96%e7%a8%8b></a></h2><p>concurrent.futures 库提供了一个 ProcessPoolExecutor 类， 可被用来在一个单独的 Python 解释器中执行计算密集型函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># findrobots.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> gzip
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> glob
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> concurrent <span style=color:#f92672>import</span> futures
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_robots</span>(filename):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Find all of the hosts that access robots.txt in a single log file
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    robots <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> gzip<span style=color:#f92672>.</span>open(filename) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> io<span style=color:#f92672>.</span>TextIOWrapper(f,encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ascii&#39;</span>):
</span></span><span style=display:flex><span>            fields <span style=color:#f92672>=</span> line<span style=color:#f92672>.</span>split()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> fields[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/robots.txt&#39;</span>:
</span></span><span style=display:flex><span>                robots<span style=color:#f92672>.</span>add(fields[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> robots
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_all_robots</span>(logdir):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Find all hosts across and entire sequence of files
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    files <span style=color:#f92672>=</span> glob<span style=color:#f92672>.</span>glob(logdir<span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/*.log.gz&#39;</span>)
</span></span><span style=display:flex><span>    all_robots <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>    <span style=color:#75715e># pool map 函数</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> futures<span style=color:#f92672>.</span>ProcessPoolExecutor() <span style=color:#66d9ef>as</span> pool:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> robots <span style=color:#f92672>in</span> pool<span style=color:#f92672>.</span>map(find_robots, files):
</span></span><span style=display:flex><span>            all_robots<span style=color:#f92672>.</span>update(robots)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> all_robots
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    robots <span style=color:#f92672>=</span> find_all_robots(<span style=color:#e6db74>&#39;logs&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ipaddr <span style=color:#f92672>in</span> robots:
</span></span><span style=display:flex><span>        print(ipaddr)
</span></span></code></pre></div><h3 id=pool-通用使用方式>pool 通用使用方式
<a class=header-anchor href=#pool-%e9%80%9a%e7%94%a8%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># A function that performs a lot of work</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>work</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Nonparallel code</span>
</span></span><span style=display:flex><span>results <span style=color:#f92672>=</span> map(work, data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Parallel implementation</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> ProcessPoolExecutor() <span style=color:#66d9ef>as</span> pool:
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span>map(work, data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Some function</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>work</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> ProcessPoolExecutor() <span style=color:#66d9ef>as</span> pool:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Example of submitting work to the pool</span>
</span></span><span style=display:flex><span>    future_result <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span>submit(work, arg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Obtaining the result (blocks until done)</span>
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> future_result<span style=color:#f92672>.</span>result()
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># callback</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>when_done</span>(r):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Got:&#39;</span>, r<span style=color:#f92672>.</span>result())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> ProcessPoolExecutor() <span style=color:#66d9ef>as</span> pool:
</span></span><span style=display:flex><span>     future_result <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span>submit(work, arg)
</span></span><span style=display:flex><span>     future_result<span style=color:#f92672>.</span>add_done_callback(when_done)
</span></span></code></pre></div><p>如果你手动提交一个任务，结果是一个 Future 实例。 要获取最终结果，你需要调用它的 <code>result()</code> 方法。 它会<strong>阻塞进程</strong>直到结果被返回来。如果不想阻塞，你还可以使用一个回调函数，回调函数接受一个 Future 实例，被用来获取最终的结果（比如通过调用它的result()方法）。</p><p><strong>Note</strong>：</p><ul><li>这种并行处理技术只适用于那些可以被分解为互相独立部分的问题。</li><li>被提交的任务必须是简单函数形式。对于方法、闭包和其他类型的并行执行还不支持。</li><li>函数参数和返回值必须兼容pickle，因为要使用到进程间的通信，所有解释器之间的交换数据必须被序列化</li><li>被提交的任务函数不应保留状态或有副作用。除了打印日志之类简单的事情。</li></ul><h2 id=定义一个actor任务>定义一个Actor任务
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aaactor%e4%bb%bb%e5%8a%a1></a></h2><p>// TODO
<a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c12/p10_defining_an_actor_task.html title=理解 rel="noopener external nofollow noreferrer" target=_blank class=exturl>理解
<i class="fa fa-external-link-alt"></i></a></p><p>actor 模式是一种最古老的也是最简单的<strong>并行和分布式计算解决方案</strong>。一个 actor 就是一个并发执行的任务，只是简单的执行发送给它的消息任务。响应这些消息时，它可能还会给其他 actor 发送更进一步的消息。actor 之间的通信是单向和异步的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> queue <span style=color:#f92672>import</span> Queue
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread, Event
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sentinel used for shutdown</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActorExit</span>(<span style=color:#a6e22e>Exception</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Actor</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_mailbox <span style=color:#f92672>=</span> Queue()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send</span>(self, msg):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Send a message to the actor
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_mailbox<span style=color:#f92672>.</span>put(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recv</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Receive an incoming message
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_mailbox<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> msg <span style=color:#f92672>is</span> ActorExit:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> ActorExit()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> msg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Close the actor, thus shutting it down
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>send(ActorExit)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Start concurrent execution
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_terminated <span style=color:#f92672>=</span> Event()
</span></span><span style=display:flex><span>        t <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>_bootstrap)
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_bootstrap</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>run()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> ActorExit:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_terminated<span style=color:#f92672>.</span>set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>join</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_terminated<span style=color:#f92672>.</span>wait()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Run method to be implemented by the user
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sample ActorTask</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrintActor</span>(Actor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Got:&#39;</span>, msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sample use</span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> PrintActor()
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;Hello&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;World&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>join()
</span></span></code></pre></div><p>使用actor实例的 <code>send()</code> 方法发送消息给它们。 其机制是，这个方法会将消息放入一个队里中， 然后将其转交给处理被接受消息的一个内部线程。 <code>close()</code> 方法通过在队列中放入一个特殊的哨兵值（ActorExit）来关闭这个actor。 用户可以通过继承Actor并定义实现自己处理逻辑 <code>run()</code> 方法来定义新的actor。 ActorExit 异常的使用就是用户自定义代码可以在需要的时候来捕获终止请求 （异常被 <code>get()</code> 方法抛出并传播出去）。</p><h3 id=生成器方法>生成器方法
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e5%99%a8%e6%96%b9%e6%b3%95></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_actor</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span>      <span style=color:#75715e># Get a message</span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Got:&#39;</span>, msg)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>GeneratorExit</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Actor terminating&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sample use</span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> print_actor()
</span></span><span style=display:flex><span>next(p)     <span style=color:#75715e># Advance to the yield (ready to receive)</span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;Hello&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;World&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><h3 id=拓展>拓展
<a class=header-anchor href=#%e6%8b%93%e5%b1%95></a></h3><p>actor 模式的魅力就在于它的简单性。 实际上，这里仅仅只有一个核心操作 <code>send()</code>。 甚至，对于在基于 actor 系统中的“消息”的泛化概念可以已多种方式被扩展。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TaggedActor</span>(Actor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>             tag, <span style=color:#f92672>*</span>payload <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>             getattr(self,<span style=color:#e6db74>&#39;do_&#39;</span><span style=color:#f92672>+</span>tag)(<span style=color:#f92672>*</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Methods correponding to different message tags</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_A</span>(self, x):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Running A&#39;</span>, x)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_B</span>(self, x, y):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Running B&#39;</span>, x, y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> TaggedActor()
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>send((<span style=color:#e6db74>&#39;A&#39;</span>, <span style=color:#ae81ff>1</span>))      <span style=color:#75715e># Invokes do_A(1)</span>
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>send((<span style=color:#e6db74>&#39;B&#39;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>))   <span style=color:#75715e># Invokes do_B(2,3)</span>
</span></span></code></pre></div><p>actor 允许在一个工作者中运行任意的函数， 并且通过一个特殊的 Result 对象返回结果。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Event
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Result</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_evt <span style=color:#f92672>=</span> Event()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_result <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set_result</span>(self, value):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_result <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_evt<span style=color:#f92672>.</span>set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>result</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_evt<span style=color:#f92672>.</span>wait()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Worker</span>(Actor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>submit</span>(self, func, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> Result()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>send((func, args, kwargs, r))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            func, args, kwargs, r <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>recv()
</span></span><span style=display:flex><span>            r<span style=color:#f92672>.</span>set_result(func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span>worker <span style=color:#f92672>=</span> Worker()
</span></span><span style=display:flex><span>worker<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> worker<span style=color:#f92672>.</span>submit(pow, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>print(r<span style=color:#f92672>.</span>result())
</span></span></code></pre></div><h2 id=实现消息发布订阅模型>实现消息发布/订阅模型
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0%e6%b6%88%e6%81%af%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85%e6%a8%a1%e5%9e%8b></a></h2><p>// TODO
<a href=https://python3-cookbook.readthedocs.io/zh_CN/latest/c12/p11_implement_publish_subscribe_messaging.html title=理解 rel="noopener external nofollow noreferrer" target=_blank class=exturl>理解
<i class="fa fa-external-link-alt"></i></a></p><p>目的：基于线程通信的程序，想让它们实现发布/订阅模式的消息通信。</p><h3 id=交换机>交换机
<a class=header-anchor href=#%e4%ba%a4%e6%8d%a2%e6%9c%ba></a></h3><p>要实现发布/订阅的消息通信模式， 你通常要引入一个单独的“交换机”或“网关”对象作为所有消息的中介。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exchange</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_subscribers <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>attach</span>(self, task):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_subscribers<span style=color:#f92672>.</span>add(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>detach</span>(self, task):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_subscribers<span style=color:#f92672>.</span>remove(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send</span>(self, msg):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> subscriber <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_subscribers:
</span></span><span style=display:flex><span>            subscriber<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Dictionary of all created exchanges</span>
</span></span><span style=display:flex><span>_exchanges <span style=color:#f92672>=</span> defaultdict(Exchange)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Return the Exchange instance associated with a given name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_exchange</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _exchanges[name]
</span></span></code></pre></div><p>一个交换机就是一个普通对象，负责维护一个活跃的订阅者集合，并为绑定、解绑和发送消息提供相应的方法。 每个交换机通过一个名称定位，<code>get_exchange()</code> 通过给定一个名称返回相应的 Exchange 实例。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Example of a task.  Any object with a send() method</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Task</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send</span>(self, msg):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>task_a <span style=color:#f92672>=</span> Task()
</span></span><span style=display:flex><span>task_b <span style=color:#f92672>=</span> Task()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example of getting an exchange</span>
</span></span><span style=display:flex><span>exc <span style=color:#f92672>=</span> get_exchange(<span style=color:#e6db74>&#39;name&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Examples of subscribing tasks to it</span>
</span></span><span style=display:flex><span>exc<span style=color:#f92672>.</span>attach(task_a)
</span></span><span style=display:flex><span>exc<span style=color:#f92672>.</span>attach(task_b)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example of sending messages</span>
</span></span><span style=display:flex><span>exc<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;msg1&#39;</span>)
</span></span><span style=display:flex><span>exc<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;msg2&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example of unsubscribing</span>
</span></span><span style=display:flex><span>exc<span style=color:#f92672>.</span>detach(task_a)
</span></span><span style=display:flex><span>exc<span style=color:#f92672>.</span>detach(task_b)
</span></span></code></pre></div><p>使用发布订阅模式的优势</p><ul><li>使用一个交换机可以简化大部分涉及到线程通信的工作。</li><li>交换机广播消息给多个订阅者的能力带来了一个全新的通信模式。</li><li>兼容多个“task-like”对象。消息接受者可以是actor、协程、网络连接或任何实现了正确的 send() 方法的东西。</li></ul><h3 id=交换机拓展上下文管理>交换机拓展上下文管理
<a class=header-anchor href=#%e4%ba%a4%e6%8d%a2%e6%9c%ba%e6%8b%93%e5%b1%95%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86></a></h3><p>关于交换机的一个可能问题是对于订阅者的正确绑定和解绑。 为了正确的管理资源，每一个绑定的订阅者必须最终要解绑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> contextlib <span style=color:#f92672>import</span> contextmanager
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exchange</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_subscribers <span style=color:#f92672>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>attach</span>(self, task):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_subscribers<span style=color:#f92672>.</span>add(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>detach</span>(self, task):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_subscribers<span style=color:#f92672>.</span>remove(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@contextmanager</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>subscribe</span>(self, <span style=color:#f92672>*</span>tasks):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> task <span style=color:#f92672>in</span> tasks:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>attach(task)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> task <span style=color:#f92672>in</span> tasks:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>detach(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send</span>(self, msg):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> subscriber <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>_subscribers:
</span></span><span style=display:flex><span>            subscriber<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Dictionary of all created exchanges</span>
</span></span><span style=display:flex><span>_exchanges <span style=color:#f92672>=</span> defaultdict(Exchange)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Return the Exchange instance associated with a given name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_exchange</span>(name):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _exchanges[name]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example of using the subscribe() method</span>
</span></span><span style=display:flex><span>exc <span style=color:#f92672>=</span> get_exchange(<span style=color:#e6db74>&#39;name&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> exc<span style=color:#f92672>.</span>subscribe(task_a, task_b):
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>     exc<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;msg1&#39;</span>)
</span></span><span style=display:flex><span>     exc<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;msg2&#39;</span>)
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># task_a and task_b detached here</span>
</span></span></code></pre></div><h2 id=生成器代替线程>生成器代替线程
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e5%99%a8%e4%bb%a3%e6%9b%bf%e7%ba%bf%e7%a8%8b></a></h2><p>yield 语句会让一个生成器挂起它的执行，这样就可以编写一个调度器， 将生成器当做某种“任务”并使用任务协作切换来替换它们的执行。</p><h3 id=任务调度器>任务调度器
<a class=header-anchor href=#%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6%e5%99%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Two simple generator functions</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countdown</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;T-minus&#39;</span>, n)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>        n <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Blastoff!&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>countup</span>(n):
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> x <span style=color:#f92672>&lt;</span> n:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Counting up&#39;</span>, x)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>        x <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> deque
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TaskScheduler</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_task_queue <span style=color:#f92672>=</span> deque()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new_task</span>(self, task):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Admit a newly started task to the scheduler
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_task_queue<span style=color:#f92672>.</span>append(task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Run until there are no more tasks
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> self<span style=color:#f92672>.</span>_task_queue:
</span></span><span style=display:flex><span>            task <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_task_queue<span style=color:#f92672>.</span>popleft()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># Run until the next yield statement</span>
</span></span><span style=display:flex><span>                next(task)
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_task_queue<span style=color:#f92672>.</span>append(task)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># Generator is no longer executing</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span>sched <span style=color:#f92672>=</span> TaskScheduler()
</span></span><span style=display:flex><span>sched<span style=color:#f92672>.</span>new_task(countdown(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span>sched<span style=color:#f92672>.</span>new_task(countdown(<span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>sched<span style=color:#f92672>.</span>new_task(countup(<span style=color:#ae81ff>15</span>))
</span></span><span style=display:flex><span>sched<span style=color:#f92672>.</span>run()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Counting up 0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 9</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 4</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Counting up 1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 8</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Counting up 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 7</span>
</span></span><span style=display:flex><span><span style=color:#75715e># T-minus 2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div><p>TaskScheduler 类在一个循环中运行生成器集合——每个都运行到碰到yield语句为止。到此为止，我们实际上已经实现了一个“操作系统”的最小核心部分。 生成器函数就是认为，而 yield 语句是任务挂起的信号。调度器循环检查任务列表直到没有任务要执行为止。</p><h3 id=生成器版-actor>生成器版 actor
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e5%99%a8%e7%89%88-actor></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> deque
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActorScheduler</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_actors <span style=color:#f92672>=</span> { }          <span style=color:#75715e># Mapping of names to actors</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_msg_queue <span style=color:#f92672>=</span> deque()   <span style=color:#75715e># Message queue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new_actor</span>(self, name, actor):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Admit a newly started actor to the scheduler and give it a name
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_msg_queue<span style=color:#f92672>.</span>append((actor,<span style=color:#66d9ef>None</span>))
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_actors[name] <span style=color:#f92672>=</span> actor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send</span>(self, name, msg):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Send a message to a named actor
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        actor <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_actors<span style=color:#f92672>.</span>get(name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> actor:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_msg_queue<span style=color:#f92672>.</span>append((actor,msg))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Run as long as there are pending messages.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> self<span style=color:#f92672>.</span>_msg_queue:
</span></span><span style=display:flex><span>            actor, msg <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_msg_queue<span style=color:#f92672>.</span>popleft()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                 actor<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>                 <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example use</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>printer</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Got:&#39;</span>, msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>counter</span>(sched):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Receive the current count</span>
</span></span><span style=display:flex><span>            n <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Send to the printer task</span>
</span></span><span style=display:flex><span>            sched<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;printer&#39;</span>, n)
</span></span><span style=display:flex><span>            <span style=color:#75715e># Send the next count to the counter task (recursive)</span>
</span></span><span style=display:flex><span>            sched<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;counter&#39;</span>, n<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sched <span style=color:#f92672>=</span> ActorScheduler()
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create the initial actors</span>
</span></span><span style=display:flex><span>    sched<span style=color:#f92672>.</span>new_actor(<span style=color:#e6db74>&#39;printer&#39;</span>, printer())
</span></span><span style=display:flex><span>    sched<span style=color:#f92672>.</span>new_actor(<span style=color:#e6db74>&#39;counter&#39;</span>, counter(sched))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Send an initial message to the counter to initiate</span>
</span></span><span style=display:flex><span>    sched<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#39;counter&#39;</span>, <span style=color:#ae81ff>10000</span>)
</span></span><span style=display:flex><span>    sched<span style=color:#f92672>.</span>run()
</span></span></code></pre></div><h3 id=生成器版并发网络程序>生成器版并发网络程序
<a class=header-anchor href=#%e7%94%9f%e6%88%90%e5%99%a8%e7%89%88%e5%b9%b6%e5%8f%91%e7%bd%91%e7%bb%9c%e7%a8%8b%e5%ba%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> deque
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> select <span style=color:#f92672>import</span> select
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This class represents a generic yield event in the scheduler</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>YieldEvent</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_yield</span>(self, sched, task):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_resume</span>(self, sched, task):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Task Scheduler</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Scheduler</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_numtasks <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>       <span style=color:#75715e># Total num of tasks</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ready <span style=color:#f92672>=</span> deque()    <span style=color:#75715e># Tasks ready to run</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_read_waiting <span style=color:#f92672>=</span> {}  <span style=color:#75715e># Tasks waiting to read</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_write_waiting <span style=color:#f92672>=</span> {} <span style=color:#75715e># Tasks waiting to write</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Poll for I/O events and restart waiting tasks</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_iopoll</span>(self):
</span></span><span style=display:flex><span>        rset,wset,eset <span style=color:#f92672>=</span> select(self<span style=color:#f92672>.</span>_read_waiting,
</span></span><span style=display:flex><span>                                self<span style=color:#f92672>.</span>_write_waiting,[])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> rset:
</span></span><span style=display:flex><span>            evt, task <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_read_waiting<span style=color:#f92672>.</span>pop(r)
</span></span><span style=display:flex><span>            evt<span style=color:#f92672>.</span>handle_resume(self, task)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> w <span style=color:#f92672>in</span> wset:
</span></span><span style=display:flex><span>            evt, task <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_write_waiting<span style=color:#f92672>.</span>pop(w)
</span></span><span style=display:flex><span>            evt<span style=color:#f92672>.</span>handle_resume(self, task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new</span>(self,task):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Add a newly started task to the scheduler
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ready<span style=color:#f92672>.</span>append((task, <span style=color:#66d9ef>None</span>))
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_numtasks <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_ready</span>(self, task, msg<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Append an already started task to the ready queue.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        msg is what to send into the task when it resumes.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_ready<span style=color:#f92672>.</span>append((task, msg))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add a task to the reading set</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_read_wait</span>(self, fileno, evt, task):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_read_waiting[fileno] <span style=color:#f92672>=</span> (evt, task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Add a task to the write set</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_write_wait</span>(self, fileno, evt, task):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_write_waiting[fileno] <span style=color:#f92672>=</span> (evt, task)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Run the task scheduler until there are no tasks
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> self<span style=color:#f92672>.</span>_numtasks:
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>_ready:
</span></span><span style=display:flex><span>                  self<span style=color:#f92672>.</span>_iopoll()
</span></span><span style=display:flex><span>             task, msg <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_ready<span style=color:#f92672>.</span>popleft()
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                 <span style=color:#75715e># Run the coroutine to the next yield</span>
</span></span><span style=display:flex><span>                 r <span style=color:#f92672>=</span> task<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>                 <span style=color:#66d9ef>if</span> isinstance(r, YieldEvent):
</span></span><span style=display:flex><span>                     r<span style=color:#f92672>.</span>handle_yield(self, task)
</span></span><span style=display:flex><span>                 <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                     <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;unrecognized yield event&#39;</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>StopIteration</span>:
</span></span><span style=display:flex><span>                 self<span style=color:#f92672>.</span>_numtasks <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Example implementation of coroutine-based socket I/O</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReadSocket</span>(YieldEvent):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, sock, nbytes):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> sock
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>nbytes <span style=color:#f92672>=</span> nbytes
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_yield</span>(self, sched, task):
</span></span><span style=display:flex><span>        sched<span style=color:#f92672>.</span>_read_wait(self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>fileno(), self, task)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_resume</span>(self, sched, task):
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>recv(self<span style=color:#f92672>.</span>nbytes)
</span></span><span style=display:flex><span>        sched<span style=color:#f92672>.</span>add_ready(task, data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WriteSocket</span>(YieldEvent):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, sock, data):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> sock
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>data <span style=color:#f92672>=</span> data
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_yield</span>(self, sched, task):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sched<span style=color:#f92672>.</span>_write_wait(self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>fileno(), self, task)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_resume</span>(self, sched, task):
</span></span><span style=display:flex><span>        nsent <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>send(self<span style=color:#f92672>.</span>data)
</span></span><span style=display:flex><span>        sched<span style=color:#f92672>.</span>add_ready(task, nsent)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AcceptSocket</span>(YieldEvent):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, sock):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sock <span style=color:#f92672>=</span> sock
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_yield</span>(self, sched, task):
</span></span><span style=display:flex><span>        sched<span style=color:#f92672>.</span>_read_wait(self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>fileno(), self, task)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_resume</span>(self, sched, task):
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sock<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>        sched<span style=color:#f92672>.</span>add_ready(task, r)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wrapper around a socket object for use with yield</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Socket</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, sock):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_sock <span style=color:#f92672>=</span> sock
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recv</span>(self, maxbytes):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ReadSocket(self<span style=color:#f92672>.</span>_sock, maxbytes)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send</span>(self, data):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> WriteSocket(self<span style=color:#f92672>.</span>_sock, data)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>accept</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> AcceptSocket(self<span style=color:#f92672>.</span>_sock)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getattr__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>_sock, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>from</span> socket <span style=color:#f92672>import</span> socket, AF_INET, SOCK_STREAM
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Example of a function involving generators.  This should</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># be called using line = yield from readline(sock)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>readline</span>(sock):
</span></span><span style=display:flex><span>        chars <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            c <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span> sock<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> c:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            chars<span style=color:#f92672>.</span>append(c)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> c <span style=color:#f92672>==</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(chars)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Echo server using generators</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EchoServer</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> __init__(self,addr,sched):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>sched <span style=color:#f92672>=</span> sched
</span></span><span style=display:flex><span>            sched<span style=color:#f92672>.</span>new(self<span style=color:#f92672>.</span>server_loop(addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>server_loop</span>(self,addr):
</span></span><span style=display:flex><span>            s <span style=color:#f92672>=</span> Socket(socket(AF_INET,SOCK_STREAM))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            s<span style=color:#f92672>.</span>bind(addr)
</span></span><span style=display:flex><span>            s<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>                c,a <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span> s<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#39;Got connection from &#39;</span>, a)
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>sched<span style=color:#f92672>.</span>new(self<span style=color:#f92672>.</span>client_handler(Socket(c)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>client_handler</span>(self,client):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>                line <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield from</span> readline(client)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> line:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>                line <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;GOT:&#39;</span> <span style=color:#f92672>+</span> line
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> line:
</span></span><span style=display:flex><span>                    nsent <span style=color:#f92672>=</span> <span style=color:#66d9ef>yield</span> client<span style=color:#f92672>.</span>send(line)
</span></span><span style=display:flex><span>                    line <span style=color:#f92672>=</span> line[nsent:]
</span></span><span style=display:flex><span>            client<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Client closed&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sched <span style=color:#f92672>=</span> Scheduler()
</span></span><span style=display:flex><span>    EchoServer((<span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>16000</span>),sched)
</span></span><span style=display:flex><span>    sched<span style=color:#f92672>.</span>run()
</span></span></code></pre></div><p>如果使用生成器编程，要提醒你的是它还是有很多缺点的。 特别是，你得不到任何线程可以提供的好处。例如，如果你执行CPU依赖或I/O阻塞程序， 它会将整个任务挂起知道操作完成。为了解决这个问题， 你只能选择将操作委派给另外一个可以独立运行的线程或进程。 另外一个限制是大部分Python库并不能很好的兼容基于生成器的线程。</p><h2 id=多个线程队列轮询>多个线程队列轮询
<a class=header-anchor href=#%e5%a4%9a%e4%b8%aa%e7%ba%bf%e7%a8%8b%e9%98%9f%e5%88%97%e8%bd%ae%e8%af%a2></a></h2><p>目的：你有一个线程队列集合，想为传入的参数轮询.</p><p>对于轮询问题的一个常见解决方案中有个很少有人知道的技巧，包含了一个隐藏的回路网络连接。 本质上讲其思想就是：对于每个你想要轮询的队列，你创建一对连接的套接字。 然后你在其中一个套接字上面编写代码来标识存在的数据， 另外一个套接字被传给 <code>select()</code> 或类似的一个轮询数据到达的函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> queue
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PollableQueue</span>(queue<span style=color:#f92672>.</span>Queue):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>        <span style=color:#75715e># Create a pair of connected sockets</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;posix&#39;</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_putsocket, self<span style=color:#f92672>.</span>_getsocket <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socketpair()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Compatibility on non-POSIX systems</span>
</span></span><span style=display:flex><span>            server <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span>bind((<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_putsocket <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_putsocket<span style=color:#f92672>.</span>connect(server<span style=color:#f92672>.</span>getsockname())
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_getsocket, _ <span style=color:#f92672>=</span> server<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fileno</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_getsocket<span style=color:#f92672>.</span>fileno()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>put</span>(self, item):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>put(item)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_putsocket<span style=color:#f92672>.</span>send(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;x&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_getsocket<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 消费者</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> select
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consumer</span>(queues):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Consumer that reads data on multiple queues simultaneously
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        can_read, _, _ <span style=color:#f92672>=</span> select<span style=color:#f92672>.</span>select(queues,[],[])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> can_read:
</span></span><span style=display:flex><span>            item <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>get()
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Got:&#39;</span>, item)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>q1 <span style=color:#f92672>=</span> PollableQueue()
</span></span><span style=display:flex><span>q2 <span style=color:#f92672>=</span> PollableQueue()
</span></span><span style=display:flex><span>q3 <span style=color:#f92672>=</span> PollableQueue()
</span></span><span style=display:flex><span>t <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>consumer, args<span style=color:#f92672>=</span>([q1,q2,q3],))
</span></span><span style=display:flex><span>t<span style=color:#f92672>.</span>daemon <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Feed data to the queues</span>
</span></span><span style=display:flex><span>q1<span style=color:#f92672>.</span>put(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>q2<span style=color:#f92672>.</span>put(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>q3<span style=color:#f92672>.</span>put(<span style=color:#e6db74>&#39;hello&#39;</span>)
</span></span><span style=display:flex><span>q2<span style=color:#f92672>.</span>put(<span style=color:#ae81ff>15</span>)
</span></span></code></pre></div><p><code>fileno()</code> 方法使用一个函数比如 <code>select()</code> 来让这个队列可以被轮询。 它仅仅只是暴露了底层被 <code>get()</code> 函数使用到的socket的文件描述符而已。</p><p>这个方案通过将队列和套接字等同对待来解决了大部分的问题。 一个单独的 <code>select()</code> 调用可被同时用来轮询。 使用超时或其他基于时间的机制来执行周期性检查并没有必要。 甚至，如果数据被加入到一个队列，消费者几乎可以实时的被通知。 尽管会有一点点底层的I/O损耗，使用它通常会获得更好的响应时间并简化编程。</p><h2 id=unix-系统上面启动守护进程>Unix 系统上面启动守护进程
<a class=header-anchor href=#unix-%e7%b3%bb%e7%bb%9f%e4%b8%8a%e9%9d%a2%e5%90%af%e5%8a%a8%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b></a></h2><p><a href=https://blog.csdn.net/tdonald/article/details/1724996 title=tdonald rel="noopener external nofollow noreferrer" target=_blank class=exturl>tdonald
<i class="fa fa-external-link-alt"></i></a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># daemon.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> atexit
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> signal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>daemonize</span>(pidfile, <span style=color:#f92672>*</span>, stdin<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/dev/null&#39;</span>,
</span></span><span style=display:flex><span>                          stdout<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/dev/null&#39;</span>,
</span></span><span style=display:flex><span>                          stderr<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/dev/null&#39;</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(pidfile):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Already running&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># First fork (detaches from parent)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>fork() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>0</span>)   <span style=color:#75715e># Parent exit</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>OSError</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;fork #1 failed.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>chdir(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>umask(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使进程成为会话组长，脱离终端</span>
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>setsid()
</span></span><span style=display:flex><span>    <span style=color:#75715e># Second fork (relinquish session leadership)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>fork() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>OSError</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;fork #2 failed.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Flush I/O buffers</span>
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Replace file descriptors for stdin, stdout, and stderr</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(stdin, <span style=color:#e6db74>&#39;rb&#39;</span>, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>dup2(f<span style=color:#f92672>.</span>fileno(), sys<span style=color:#f92672>.</span>stdin<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(stdout, <span style=color:#e6db74>&#39;ab&#39;</span>, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>dup2(f<span style=color:#f92672>.</span>fileno(), sys<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(stderr, <span style=color:#e6db74>&#39;ab&#39;</span>, <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>dup2(f<span style=color:#f92672>.</span>fileno(), sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Write the PID file</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(pidfile,<span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        print(os<span style=color:#f92672>.</span>getpid(),file<span style=color:#f92672>=</span>f)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Arrange to have the PID file removed on exit/signal</span>
</span></span><span style=display:flex><span>    atexit<span style=color:#f92672>.</span>register(<span style=color:#66d9ef>lambda</span>: os<span style=color:#f92672>.</span>remove(pidfile))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Signal handler for termination (required)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sigterm_handler</span>(signo, frame):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    signal<span style=color:#f92672>.</span>signal(signal<span style=color:#f92672>.</span>SIGTERM, sigterm_handler)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;Daemon started with pid </span><span style=color:#e6db74>{}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(os<span style=color:#f92672>.</span>getpid()))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#39;Daemon Alive! </span><span style=color:#e6db74>{}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(time<span style=color:#f92672>.</span>ctime()))
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    PIDFILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/tmp/daemon.pid&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Usage: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> [start|stop]&#39;</span><span style=color:#f92672>.</span>format(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>0</span>]), file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;start&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            daemonize(PIDFILE,
</span></span><span style=display:flex><span>                      stdout<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/tmp/daemon.log&#39;</span>,
</span></span><span style=display:flex><span>                      stderr<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/tmp/dameon.log&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>RuntimeError</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            print(e, file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        main()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;stop&#39;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(PIDFILE):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> open(PIDFILE) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>kill(int(f<span style=color:#f92672>.</span>read()), signal<span style=color:#f92672>.</span>SIGTERM)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;Not running&#39;</span>, file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;Unknown command </span><span style=color:#e6db74>{!r}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]), file<span style=color:#f92672>=</span>sys<span style=color:#f92672>.</span>stderr)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>SystemExit</span>(<span style=color:#ae81ff>1</span>)
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/python>python
</a><a href=/tags/cookbook>cookbook</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Python Cookbook</li><li class=post-copyright-author><strong>本文作者： </strong>cnewbie</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://cnewbie.github.io/posts/python-cookbook/ title="Python Cookbook">https://cnewbie.github.io/posts/python-cookbook/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/rss.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/oop-design-pattern/ rel=next title=设计模式><i class="fa fa-chevron-left"></i> 设计模式</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/python-deepcopy/ rel=prev title="Python 内存拷贝">Python 内存拷贝
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>cnewbie</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.122.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"cnewbie/cnewbie.github.io","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://cnewbie.github.io","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>