<!DOCTYPE html>
<html lang="zh-CN">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">




<title>设计模式 | Hugo Blog</title>

<link rel="stylesheet" href="https://cnewbie.github.io/css/styles.css">

<link href="https://cdn.bootcss.com/font-awesome/5.2.0/css/all.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>



<link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/zenburn.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>
<script src="https://cnewbie.github.io/js/highlight.js"></script>



<link href="https://cdn.bootcss.com/jsSocials/1.4.0/jssocials.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/jsSocials/1.4.0/jssocials-theme-minima.css" rel="stylesheet">

<script type="text/javascript" src="https://cnewbie.github.io/js/jssocials.js"></script>




<div class="container">
    <nav class="navbar level">
      <div class="navbar-brand">
          <a class="nav-item" href="https://cnewbie.github.io"><h1 class="title is-3">Hugo Blog</h1></a>
      </div>           
      <div class="navbar-menu has-text-centered is-active">
          <div class="navbar-end is-centered">
              
                <a href="https://cnewbie.github.io/about" rel="me">
                  <span class="icon">
                    <i class="fas fa-info"></i>
                  </span>
                </a>
              
                <a href="https://github.com/cnewbie/" rel="me">
                  <span class="icon">
                    <i class="fab fa-github"></i>
                  </span>
                </a>
              
           </div>
      </div>
    </nav>
  </div>

<div class="container">
  <h2 class="subtitle is-6">November 1, 2019</h2>
  <h1 class="subtitle is-size-4-mobile is-size-3-desktop">设计模式</h1>
  <div class="content">
    <p>面向对象之设计模式</p>
<h1 id="创建型模式">创建型模式</h1>
<p>创建型模式提供了创建对象的机制， 能够提升已有代码的灵活性和可复用性。</p>
<h2 id="工厂方法-factory-method">工厂方法 Factory Method</h2>
<h3 id="意图">意图</h3>
<p>父类中提供创建对象的接口，但是允许子类修改需要创建对象的类型</p>
<h3 id="问题">问题</h3>
<p>创建物流管理类，起先实现了火车类，随着业务的增长，需要进行水路运输。
在修改物流管理类时，需要修改所有运输的代码。</p>
<h3 id="解决方案">解决方案</h3>
<p>工厂方法通过调用特殊的工厂方法替代直接使用构造方法构建对象，通过工厂方法返回的对象称之为产品。</p>
<h3 id="uml-结构">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Product{
    -doStuff()
}
class ConcreteProductA{

}
class ConcreteProductB{

}
class Creator{
    +someOperation()
    +createProduct(): Product
}
class ConcreteCreatorA{

}
class ConcreteCreatorB{
}
ConcreteProductA ..|&gt; Product
ConcreteProductB ..|&gt; Product
ConcreteCreatorA --|&gt; Creator
ConcreteCreatorB --|&gt; Creator
Creator --&gt; Product
</code></pre><ul>
<li>Product 抽象产品接口</li>
<li>ConcreteProduct 产品类</li>
<li>Creator 抽象工厂方法，依赖抽象产品接口</li>
<li>ConcreteCreator 工厂方法</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/factory-method/structure.png" alt="factory method"></p>
<h3 id="应用示例">应用示例</h3>
<p>多平台 UI 元素</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Button</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_click</span>(self):
        <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WindowsButton</span>(Button):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_click</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;click&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LinuxButton</span>(Button):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_click</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;click&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dialog</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render</span>(self):
        ok_button <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_button()
        ok_button<span style="color:#f92672">.</span>on_click()
        ok_button<span style="color:#f92672">.</span>render()

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_button</span>(self):
        <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WindowsDialog</span>(Dialog):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_button</span>(self):
        <span style="color:#66d9ef">return</span> WindowsButton()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LinuxDialog</span>(Dialog):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_butoon</span>(self):
        <span style="color:#66d9ef">return</span> LinuxButton()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    dailog <span style="color:#f92672">=</span> WindowsDialog()
    dailog<span style="color:#f92672">.</span>render()
</code></pre></div><h3 id="适用性">适用性</h3>
<ul>
<li>事先不知道应使用对象的确切类型和依赖关系</li>
<li>为库或框架提供内部组件拓展</li>
<li>重用已存在对象而不是每次新建对象，以节约系统资源</li>
</ul>
<h3 id="实现步骤">实现步骤</h3>
<ol>
<li>创建所有产品的接口</li>
<li>创建者中添加空的工厂方法，返回类型为抽象产品</li>
<li>将创建者代码中所有产品构造函数引用处替换成工厂方法，并将产品创建代码提取到工厂方法中</li>
<li>构造创建者子类对象，复写工厂方法</li>
<li>如果基类工厂方法为空，可以声明为抽象方法</li>
</ol>
<h3 id="优缺点">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 解耦创建者和产品</li>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input disabled="" type="checkbox"> 代码层级复杂</li>
</ul>
<h2 id="抽象工厂-abstract-factory">抽象工厂 Abstract Factory</h2>
<h3 id="意图-1">意图</h3>
<p>不指定具体工厂类生产一系列相关产品的族</p>
<h3 id="问题-1">问题</h3>
<p>生产家具族，具体的家具有不同的变种。如何在不改动原有代码的情况下生产新的产品或族</p>
<h3 id="解决方案-1">解决方案</h3>
<p>首先声明产品族的接口，通过接口衍生处不同的产品；接着声明具有创建产品族的方法抽象工厂；
最后通过抽象工厂衍生具体工厂类，生产需要的产品族。</p>
<h3 id="uml-结构-1">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface ProductA
interface ProductB
class ConcreteProductA1
class ConcreteProductA2
class ConcreteProductB1
class ConcreteProductB2
interface AbstractFactory{
    +createProduct(): ProductA
    +createProduct(): ProductB
}
class ConcreteFactory1
class ConcreteFactory2
class Client{
    - factory: AbstractFactory
    + Client(f: AbstractFactory)
    + someOperation()
}
ConcreteFactory1 ..|&gt; AbstractFactory
ConcreteFactory2 ..|&gt; AbstractFactory
ConcreteProductA1 ..|&gt; ProductA
ConcreteProductA2 ..|&gt; ProductA
ConcreteProductB1 ..|&gt; ProductB
ConcreteProductB2 ..|&gt; ProductB
ConcreteFactory1 ..&gt; ConcreteProductA1
ConcreteFactory1 ..&gt; ConcreteProductB1
ConcreteFactory2 ..&gt; ConcreteProductA2
ConcreteFactory2 ..&gt; ConcreteProductB2
Client o--&gt; AbstractFactory
</code></pre><ul>
<li>AbstractFactory 抽象工厂接口</li>
<li>Product 抽象产品</li>
<li>ConcreteFactory 具体工厂</li>
<li>ConcreteProduct 具体产品</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/abstract-factory/structure.png" alt="abstract factory"></p>
<h3 id="应用示例-1">应用示例</h3>
<p>跨平台 UI 主题</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Button</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CheckBox</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WinButton</span>(Button):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WinCheckBox</span>(CheckBox):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Button</span>(Button):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CheckBox</span>(CheckBox):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GUIFactory</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_button</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_checkbox</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WinFactory</span>(GUIFactory):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_button</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;button&#39;</span>)
        <span style="color:#66d9ef">return</span> WinButton()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_checkbox</span>(self):
        <span style="color:#66d9ef">print</span>(slef<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>)
        <span style="color:#66d9ef">return</span> WinCheckBox()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MacFactory</span>(GUIFactory):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_button</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;button&#39;</span>)
        <span style="color:#66d9ef">return</span> MacButton()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_checkbox</span>(self):
        <span style="color:#66d9ef">print</span>(slef<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>)
        <span style="color:#66d9ef">return</span> MacCheckBox()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, factory):
        self<span style="color:#f92672">.</span>factory <span style="color:#f92672">=</span> factory

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_ui</span>(self):
        self<span style="color:#f92672">.</span>button <span style="color:#f92672">=</span> factory<span style="color:#f92672">.</span>create_button()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    factory <span style="color:#f92672">=</span> WinFactory()
    app <span style="color:#f92672">=</span> Application(factory)
    app<span style="color:#f92672">.</span>create_ui()
</code></pre></div><h3 id="适用性-1">适用性</h3>
<ul>
<li>需要生产一系列相关产品族，但是不希望具体类依赖这些产品</li>
</ul>
<h3 id="实现步骤-1">实现步骤</h3>
<ol>
<li>抽象处不同产品的类型</li>
<li>声明抽象产品接口</li>
<li>声明抽象工厂接口</li>
<li>实现具体工厂类和具体产品</li>
<li>创建工厂初始化代码，实例化具体工厂类</li>
</ol>
<h3 id="优缺点-1">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 确保工厂生产的产品相互匹配</li>
<li><input checked="" disabled="" type="checkbox"> 解耦具体工厂与客户端代码</li>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input disabled="" type="checkbox"> 代码复杂</li>
</ul>
<h2 id="创建者-builder">创建者 Builder</h2>
<h3 id="意图-2">意图</h3>
<p>逐步构造复杂的对象，可使用相同的构造代码生成对象的不同类型和表示形式。</p>
<h3 id="问题-2">问题</h3>
<p>多步创建复杂对象，如创建房子需要创建车库、花园、游泳池等部分。一种方法是通过房子基类衍生不同的特定子类，
新增参数必须引入多个子类，最终层级过于复杂，另一种方法创建包含选项的构造函数控制生成的对象，使得参数判断变得复杂。</p>
<h3 id="解决方案-2">解决方案</h3>
<p>分解创建过程成不同的步骤的创建者，随后根据需求调用创建者对象。
由于构建复杂，可对用于构建产品的构建器步骤的一系列调用提取到一个单独的指挥类中，
指挥类定义了执行创建步骤的顺序，而创建者提供了这些步骤的实现。</p>
<h3 id="uml-结构-2">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Builder{
    + reset()
    + buildStepA()
    + buildStepB()
    + buildStepC()
}
class ConcreteBuilder1{
    - result: Product1
    + reset()
    + buildStepA()
    + buildStepB()
    + buildStepC()
    + getResult(): Product1
}

class ConcreteBuilder2{
    - result: Product2
    + reset()
    + buildStepA()
    + buildStepB()
    + buildStepC()
    + getResult(): Product2
}
class Director{
    - builder: Builder
    + Director(builder)
    + changeBuilder(builder)
    + make(type)
}
ConcreteBuilder1 ..|&gt; Builder
ConcreteBuilder2 ..|&gt; Builder
ConcreteBuilder1 --&gt; Product1
ConcreteBuilder2 --&gt; Product2
Director o--&gt; Builder
Client --&gt; Director
Client --&gt; ConcreteBuilder1
</code></pre><ul>
<li>Builder 创建者接口</li>
<li>ConcreteBuilder 具体创建者</li>
<li>Director 指挥者</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/builder/structure.png" alt="builder structure"></p>
<h3 id="应用示例-2">应用示例</h3>
<p>创建多种不同类型的车及其手册，通过创建者分解不同的步骤</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Car</span>(object):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CarManual</span>(object):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SportEngine</span>(object):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Builder</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_seats</span>(self, number):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_engine</span>(self, engine):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_trip_computer</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_gps</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CarBuilder</span>(Builder):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
        self<span style="color:#f92672">.</span>_car <span style="color:#f92672">=</span> Car()
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;reset&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_seats</span>(self, number):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set seats&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_engine</span>(self, engine):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set engine&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_trip_computer</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set trip computer&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_gps</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set gps&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_result</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_car


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CarManualBuilder</span>(Builder):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
        self<span style="color:#f92672">.</span>_car_manual <span style="color:#f92672">=</span> CarManual()
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;reset&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_seats</span>(self, number):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set seats&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_engine</span>(self, engine):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set engine&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_trip_computer</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set trip computer&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_gps</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;set gps&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_result</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_car_manual


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Director</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_builder</span>(self, builder):
        self<span style="color:#f92672">.</span>builder <span style="color:#f92672">=</span> builder

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_sports_car</span>(self, builder):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> builder:
            builder <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>builder
        builder<span style="color:#f92672">.</span>reset()
        builder<span style="color:#f92672">.</span>set_seats(<span style="color:#ae81ff">2</span>)
        builder<span style="color:#f92672">.</span>set_engine(SportEngine())
        builder<span style="color:#f92672">.</span>set_trip_computer(True)
        builder<span style="color:#f92672">.</span>set_gps(True)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_SUV</span>(self, builder):
        <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    director <span style="color:#f92672">=</span> Director()
    builder <span style="color:#f92672">=</span> CarBuilder()
    director<span style="color:#f92672">.</span>construct_sports_car(builder)
    car <span style="color:#f92672">=</span> builder<span style="color:#f92672">.</span>get_result()
    manual_builder <span style="color:#f92672">=</span> CarManualBuilder()
    director<span style="color:#f92672">.</span>construct_sports_car(manual_builder)
    manual <span style="color:#f92672">=</span> manual_builder<span style="color:#f92672">.</span>get_result()
</code></pre></div><h3 id="适用性-2">适用性</h3>
<ul>
<li>避免多参数构造函数</li>
<li>构造不同类型的产品</li>
</ul>
<h3 id="实现步骤-2">实现步骤</h3>
<ol>
<li>确保可抽象出可以创建不同表示产品的共同步骤</li>
<li>声明创建者接口</li>
<li>创建具体创建者类，需要实现获取产品类方法，如果产品类型相同可在接口中实现</li>
<li>创建指挥类</li>
<li>使用创建类与指挥类</li>
</ol>
<h3 id="优缺点-2">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 逐步创建复杂对象</li>
<li><input checked="" disabled="" type="checkbox"> 重用相同构造代码</li>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input disabled="" type="checkbox"> 创建多个类，增加复杂性</li>
</ul>
<h2 id="原型模式">原型模式</h2>
<h3 id="意图-3">意图</h3>
<p>不依赖对象类代码复制已存在的对象</p>
<h3 id="问题-3">问题</h3>
<p>通过创建新对象遍历对象属性复制的方法，可能会忽略私有属性，导致复制不完全</p>
<h3 id="解决方案-3">解决方案</h3>
<p>原型模式将复制过程委派给被复制的对象，模式声明一个统一的接口，让接口支持复制对象，而无需将代码与对象类耦合。</p>
<h3 id="uml-结构-3">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Prototype{
    + clone(): Prototype
}

class ConcretePrototype{
    - field1
    + ConcretePrototype(prototype)
    + clone(): Prototype
}

class SubclassPrototype{
    - field2
    + SubclassPrototype(prototype)
    + clone(): Prototype
}

ConcretePrototype ..|&gt;Prototype
SubclassPrototype --|&gt;ConcretePrototype
Client --&gt; Prototype
</code></pre><ul>
<li>Prototype 原型接口</li>
<li>ConcretePtototype 具体原型，实现复制方法</li>
<li>Client 客户端调用</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/prototype/structure-indexed.png" alt="prototype structure"></p>
<p>原型注册表实现</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface Prototype{
    + getColor(): string
    + clone(): Prototype
}
class PrototypeRegistry{
    - items: Prototype[]
    + addItem(id: string, p:Prototype)
    + getById(id: string): Prototype
    + getByColor(color: string): Prototype
}
class Button{
    - x,y,color
    + Button(x,y,color)
    + BUtton(prototype)
    + getColor(): string
    + clone(): Prototype
}
class Client{

}

Client --&gt; PrototypeRegistry
PrototypeRegistry o--&gt; Prototype
Button ..|&gt; Prototype
</code></pre><p>原型注册表提供了一种访问常用原型的简单方法， 其中存储了一系列可供随时复制的预生成对象。</p>
<p><a href="https://refactoringguru.cn/design-patterns/prototype/python/example">python example</a></p>
<h3 id="应用示例-3">应用示例</h3>
<p>复制几何对象副本</p>
<pre><code class="language-plantuml" data-lang="plantuml">abstract class Shape{
    - x, y
    - color
    + Shape(source)
    + clone()
}

class Recangle{
    - width
    - height
    + Rectangle()
    + clone()
}

class Circle{
    - radius
    + Circle()
    + clone()
}

Rectangle --|&gt; Shape
Circle --|&gt; Shape
Application o--&gt; Shape
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Shape</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#66d9ef">def</span> __init__(self, x<span style="color:#f92672">=</span>None, y<span style="color:#f92672">=</span>None, color<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> y
        self<span style="color:#f92672">.</span>color <span style="color:#f92672">=</span> color

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clone</span>(self)
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Rectangle</span>(Shape):

    <span style="color:#66d9ef">def</span> __init__(self, w<span style="color:#f92672">=</span>None, h<span style="color:#f92672">=</span>None):
        super()<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>w <span style="color:#f92672">=</span> w
        self<span style="color:#f92672">.</span>h <span style="color:#f92672">=</span> h

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clone</span>(self):
        <span style="color:#66d9ef">return</span> Rectangle(self<span style="color:#f92672">.</span>x, self<span style="color:#f92672">.</span>y)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Circle</span>(Shape):

    <span style="color:#66d9ef">def</span> __init__(self, radius<span style="color:#f92672">=</span>None):
        super()<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>radius <span style="color:#f92672">=</span> radius

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clone</span>(self):
        <span style="color:#66d9ef">return</span> Circle(self<span style="color:#f92672">.</span>x)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self):
        circle <span style="color:#f92672">=</span> Circle()
        circle<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
        circle<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
        self<span style="color:#f92672">.</span>shapes <span style="color:#f92672">=</span> list()
        self<span style="color:#f92672">.</span>shapes<span style="color:#f92672">.</span>append(circle)
        self<span style="color:#f92672">.</span>shapes<span style="color:#f92672">.</span>append(circle<span style="color:#f92672">.</span>clone())
        rectangle <span style="color:#f92672">=</span> Rectangle()
        rectangle<span style="color:#f92672">.</span>w <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
        rectangle<span style="color:#f92672">.</span>h <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
        self<span style="color:#f92672">.</span>shapes<span style="color:#f92672">.</span>append(rectangle)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clone_all</span>(self):
        ret <span style="color:#f92672">=</span> list()
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>shapes:
            ret<span style="color:#f92672">.</span>append(i<span style="color:#f92672">.</span>clone())
        <span style="color:#66d9ef">return</span> ret


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app <span style="color:#f92672">=</span> Application()
    app<span style="color:#f92672">.</span>clone_all()
</code></pre></div><h3 id="适用性-3">适用性</h3>
<ul>
<li>需要复制对象，又希望代码独立于对象所属的类</li>
<li>子类的区别在于对象初始化的方式，可使用该模式减少子类数量</li>
</ul>
<h3 id="实现步骤-3">实现步骤</h3>
<ul>
<li>创建原型接口，声明克隆方法</li>
<li>定义额外的构造函数</li>
<li>实现克隆方法</li>
<li>可选的丝线注册表类管理常用原型</li>
</ul>
<h3 id="优缺点-3">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 克隆对象接口具体子类</li>
<li><input checked="" disabled="" type="checkbox"> 摆脱重复初始化代码</li>
<li><input checked="" disabled="" type="checkbox"> 更方便的生产复杂对象</li>
<li><input checked="" disabled="" type="checkbox"> 除继承之外的处理复杂对象预先配置</li>
<li><input disabled="" type="checkbox"> 复杂对象循环引用问题</li>
</ul>
<h2 id="单例模式">单例模式</h2>
<h3 id="意图-4">意图</h3>
<p>确保类仅有单一的实例，提供全局统一访问入口</p>
<h3 id="问题-4">问题</h3>
<ul>
<li>确保仅有一个实例，常用于限制访问共享资源</li>
<li>为该实例提供一个全局访问入口</li>
<li>违反了单一职责原则</li>
</ul>
<h3 id="解决方案-4">解决方案</h3>
<ul>
<li>构造函数私有化</li>
<li>重新定义构造函数并缓存已创建对象</li>
</ul>
<h3 id="uml-结构-4">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">class Singleton{
    - instance: Singleton
    - Singleton()
    + getInstance(): Singleton
}
class Client{

}
Client --&gt; Singleton
</code></pre><ul>
<li>Singleton 单例类：私有化构造函数，定义静态方法</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/singleton/structure-en-indexed.png" alt="Singleton structure"></p>
<h3 id="应用示例-4">应用示例</h3>
<p>数据库访问类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod
<span style="color:#f92672">import</span> threading


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SingletonMeta</span>(type):
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>_instance <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>single_lock <span style="color:#f92672">=</span> Lock()
        super(SingletonMeta, self)<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)

    <span style="color:#66d9ef">def</span> __call__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_local:
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_instance <span style="color:#f92672">is</span> None:
                self<span style="color:#f92672">.</span>_instance <span style="color:#f92672">=</span> super(SingletonMeta, self)<span style="color:#f92672">.</span>__call__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_instance


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Database</span>(metaclass<span style="color:#f92672">=</span>SingletonMeta):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">query</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} {} {}&#39;</span><span style="color:#f92672">.</span>format(self, args, kwargs))


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Database2</span>(object):
    vars <span style="color:#f92672">=</span> {}
    single_lock <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()
    <span style="color:#66d9ef">def</span> __new__(cls, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">if</span> cls <span style="color:#f92672">in</span> cls<span style="color:#f92672">.</span>vars:
            <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>vars[cls]
        cls<span style="color:#f92672">.</span>single_lock<span style="color:#f92672">.</span>acquire()
        <span style="color:#66d9ef">try</span>:
            <span style="color:#66d9ef">if</span> cls <span style="color:#f92672">in</span> cls<span style="color:#f92672">.</span>vars:
                <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>vars[cls]
            cls<span style="color:#f92672">.</span>vars[cls] <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>__new__(cls, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
            <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>vars[cls]
        <span style="color:#66d9ef">finally</span>:
            cls<span style="color:#f92672">.</span>single_lock<span style="color:#f92672">.</span>release()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">query</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} {} {}&#39;</span><span style="color:#f92672">.</span>format(self, args, kwargs))

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span>(object):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(self,  <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        db <span style="color:#f92672">=</span> Database()
        db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;haha&#39;</span>)

        db <span style="color:#f92672">=</span> Database()
        db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;heihei&#39;</span>)

        db <span style="color:#f92672">=</span> Database2()
        db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;haha2&#39;</span>)

        db <span style="color:#f92672">=</span> Database2()
        db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;heihei2&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    db <span style="color:#f92672">=</span> Database()
    db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;haha&#39;</span>)

    db <span style="color:#f92672">=</span> Database()
    db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;heihei&#39;</span>)

    db <span style="color:#f92672">=</span> Database2()
    db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;haha2&#39;</span>)

    db <span style="color:#f92672">=</span> Database2()
    db<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;heihei2&#39;</span>)
</code></pre></div><h3 id="适用性-4">适用性</h3>
<ul>
<li>程序中类的对于所有客户端只有一个可用实例</li>
<li>更加严格的控制全局变量</li>
</ul>
<h3 id="实现步骤-4">实现步骤</h3>
<ul>
<li>私有静态变量</li>
<li>声明公共静态方法</li>
<li>延迟初始化</li>
<li>构造函数私有</li>
</ul>
<h3 id="优缺点-4">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 确保类实例唯一</li>
<li><input checked="" disabled="" type="checkbox"> 全局访问入口</li>
<li><input checked="" disabled="" type="checkbox"> 延迟加载</li>
<li><input disabled="" type="checkbox"> 违反单一职责原则</li>
<li><input disabled="" type="checkbox"> 多线程环境需要加锁</li>
</ul>
<h1 id="结构型模式">结构型模式</h1>
<p>结构型模式介绍如何将对象和类组装成较大的结构， 并同时保持结构的灵活和高效。</p>
<h2 id="适配器-adapter">适配器 Adapter</h2>
<h3 id="意图-5">意图</h3>
<p>使不兼容的对象能够相互兼容</p>
<h3 id="问题-5">问题</h3>
<p>原有的 XML 接口现在需要对接 JSON 接口，可以修改现有代码库实现，可能核心库未提供源代码，无法修改如何处理？</p>
<h3 id="解决方案-5">解决方案</h3>
<p>使用一个适配器对象转换接口，使接口能够兼容。</p>
<p>适配器不仅能够转换不同格式的数据，其次还有助于采用不同接口的对象之间的合作</p>
<h3 id="uml-结构-5">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface ClientInterface{
    + method(data)
}
class Adapter{
    - adaptee: Service
    + method(data)
}
class Service{
    + serviceMethod(specialData)
}
class Client
Client --&gt; ClientInterface
Adapter ..|&gt; ClientInterface
Adapter o--&gt; Service
</code></pre><ul>
<li>ClientInterface 客户端接口，抽象协议</li>
<li>Service 服务，不兼容接口</li>
<li>Adapter 适配器，处理接口数据</li>
</ul>
<p>客户端代码与具体适配器代码解耦，方便修改增加新的适配而不修改代码。</p>
<h4 id="类适配器">类适配器</h4>
<pre><code class="language-plantuml" data-lang="plantuml">class Client
class OlderClass{
    + method(data)
}
class Service{
    + serviceMethod(specialData)
}
class Adapter{
    + method(data)
}
Client --&gt; OlderClass
Adapter --|&gt; OlderClass
Adapter --|&gt; Service
</code></pre><p>多继承语言支持，类适配器不需要封装对象，同时继承客户端和服务端的行为，重写需要的方法即可。</p>
<h3 id="应用示例-5">应用示例</h3>
<p>不同材料的兼容，方钉和圆孔</p>
<pre><code class="language-plantuml" data-lang="plantuml">class RoundHole{
    - radius: int
    + RoundHole(radius: int)
    + getRadius(): int
    + fits(peg: RoundPeg): bool
}
class RoundPeg{
    - radius: int
    + RoundPeg(radius: int)
    + getRadius(): int
}
class SquarePegAdapter{
    - peg: SquarePeg
    + SquarePegAdapter(peg: SquarePeg)
    + getRadius(): int
}
class SquarePeg{
    - width: int
    +SquarePeg(width: int)
    + getWidth(): int
}
RoundHole --&gt; RoundPeg
SquarePegAdapter --|&gt; RoundPeg
SquarePeg &lt;|--o SquarePegAdapter
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">import</span> math

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RoundHole</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, radius):
        self<span style="color:#f92672">.</span>_radius <span style="color:#f92672">=</span> radius

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_radius</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_radius

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fits</span>(self, peg):
        ret <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_radius() <span style="color:#f92672">&gt;=</span> peg<span style="color:#f92672">.</span>get_radius()
        <span style="color:#66d9ef">print</span>(ret)
        <span style="color:#66d9ef">return</span> ret


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RoundPeg</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, radius):
        self<span style="color:#f92672">.</span>_radius <span style="color:#f92672">=</span> radius

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_radius</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_radius


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquarePeg</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, width):
        self<span style="color:#f92672">.</span>_width <span style="color:#f92672">=</span> width

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_width</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_width


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquarePegAdapter</span>(RoundPeg):

    <span style="color:#66d9ef">def</span> __init__(self, peg):
        self<span style="color:#f92672">.</span>_peg <span style="color:#f92672">=</span> peg

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_radius</span>(self):
        <span style="color:#66d9ef">return</span> math<span style="color:#f92672">.</span>sqrt(self<span style="color:#f92672">.</span>_peg<span style="color:#f92672">.</span>get_width()) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    hole <span style="color:#f92672">=</span> RoundHole(<span style="color:#ae81ff">5</span>)
    rpeg <span style="color:#f92672">=</span> RoundPeg(<span style="color:#ae81ff">5</span>)
    hole<span style="color:#f92672">.</span>fits(rpeg)

    s_sqpeg <span style="color:#f92672">=</span> SquarePeg(<span style="color:#ae81ff">5</span>)
    l_sqpeg <span style="color:#f92672">=</span> SquarePeg(<span style="color:#ae81ff">10</span>)
    <span style="color:#75715e"># hole.fits(s_sqpeg)</span>

    s_sqpeg_adapter <span style="color:#f92672">=</span> SquarePegAdapter(s_sqpeg)
    l_sqpeg_adapter <span style="color:#f92672">=</span> SquarePegAdapter(l_sqpeg)
    hole<span style="color:#f92672">.</span>fits(s_sqpeg_adapter)
    hole<span style="color:#f92672">.</span>fits(l_sqpeg_adapter)
</code></pre></div><h3 id="适用性-5">适用性</h3>
<ul>
<li>希望使用不兼容的接口类时</li>
<li>希望复用多个缺少相同功能而无法被添加到父类的子类时</li>
</ul>
<h3 id="实现步骤-5">实现步骤</h3>
<ul>
<li>确保有两个类接口不兼容</li>
<li>声明客户端协议接口</li>
<li>创建具体的适配类</li>
<li>在适配器中保存需要适配的对象</li>
<li>实现兼容方法</li>
</ul>
<h3 id="优缺点-5">优缺点</h3>
<ul>
<li>单一职责原则</li>
<li>开闭原则</li>
<li>代码整体复杂度增加</li>
</ul>
<h2 id="桥接模式">桥接模式</h2>
<h3 id="意图-6">意图</h3>
<p>将大类或一系列相关的类炒粉为抽象和实现两个层次结构，可在开发中独立使用</p>
<h3 id="问题-6">问题</h3>
<p>不同的几何图形配合不同的颜色，如果再新增不同的图形，需要新增多个颜色的不同子类</p>
<h3 id="解决方案-6">解决方案</h3>
<p>通过抽取颜色纬度为独立层次，使初始类中引用这个层次的对象，从而使得一个类不必用所有的状态和行为。</p>
<p>抽象常成为接口是一些实体的高层控制层，不做具体工作，将工作委派给实现层</p>
<h3 id="uml-结构-6">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">class Abstraction{
  - i: Implementation
  + feature1()
  + feature2()
}
interface Implementation{
  + method1()
  + method2()
}

class ConcreteImplementations

ConcreteImplementations ..|&gt; Implementation
Abstraction o--&gt; Implementation
Client --&gt; Abstraction
RefinedAbstraction --|&gt; Abstraction
</code></pre><ul>
<li>Abstraction 抽象部分控制逻辑</li>
<li>Implementation 实现部分声明通用接口</li>
<li>ConcreteImplementations 具体实现</li>
<li>RefinedAbstraction 具体抽象</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/bridge/structure-en-indexed.png" alt="bridge structure"></p>
<h3 id="应用示例-6">应用示例</h3>
<p>设备与遥控器应用</p>
<pre><code class="language-plantuml" data-lang="plantuml">class Remote{
  - device: Device
  + togglePower()
  + volumeDown()
  + volumeUp()
  + channelDown()
  + channelUp()
}
interface Device{
  + isEnabled()
  + enable()
  + disable()
  + getVolume()
  + setVolume(percent)
  + getChannel()
  + setChannel(channel)
}
class Radio
class TV
class AdvancedRemote

Radio ..|&gt; Device
TV ..|&gt; Device
AdvancedRemote --|&gt; Remote
Client --&gt; Remote
</code></pre><p>遥控基类声明了一个设备对象的引用，所有遥控器通过通用设备接口与设备进行交互，使得遥控器可以支持不同类型的设备</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RemoteControl</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, device):
        self<span style="color:#f92672">.</span>_device <span style="color:#f92672">=</span> device

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">toggle_power</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;switch power&#39;</span>)
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>is_enable():
            self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>disable()
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>enable()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">volume_down</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;volume down&#39;</span>)
        self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>volume <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>volume <span style="color:#f92672">-</span> <span style="color:#ae81ff">10</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">volume_up</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;volume up&#39;</span>)
        self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>volume <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>volume <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">channel_down</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;channel down&#39;</span>)
        self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>channel <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>channel <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">channel_up</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;channel up&#39;</span>)
        self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>channel <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>channel <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdvancedRemoteControl</span>(RemoteControl):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mute</span>(self):
        slef<span style="color:#f92672">.</span>_device<span style="color:#f92672">.</span>volume <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Device</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, status<span style="color:#f92672">=</span>False, volume<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, channel<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
        self<span style="color:#f92672">.</span>_status <span style="color:#f92672">=</span> status
        self<span style="color:#f92672">.</span>_volume <span style="color:#f92672">=</span> volume
        self<span style="color:#f92672">.</span>_channel <span style="color:#f92672">=</span> channel

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_enable</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_status

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">enable</span>(self):
        self<span style="color:#f92672">.</span>_status <span style="color:#f92672">=</span> True

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">disable</span>(self):
        self<span style="color:#f92672">.</span>_status <span style="color:#f92672">=</span> False

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">volume</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_volume

    <span style="color:#a6e22e">@volume.setter</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">volume</span>(self, v):
        self<span style="color:#f92672">.</span>_volume <span style="color:#f92672">=</span> v

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">channel</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_channel

    <span style="color:#a6e22e">@channel.setter</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">channel</span>(self, v):
        self<span style="color:#f92672">.</span>_channel <span style="color:#f92672">=</span> v


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TV</span>(Device):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Radio</span>(Device):
    <span style="color:#66d9ef">pass</span>

tv <span style="color:#f92672">=</span> TV()
remote <span style="color:#f92672">=</span> RemoteControl(tv)
remote<span style="color:#f92672">.</span>toggle_power()

radio <span style="color:#f92672">=</span> Radio()
remote <span style="color:#f92672">=</span> AdvancedRemoteControl(radio)
remote<span style="color:#f92672">.</span>volume_down()
</code></pre></div><h3 id="适用性-6">适用性</h3>
<ul>
<li>需要拆分重组一个具有多重功能的类</li>
<li>需要在几个独立纬度拓展一个类</li>
<li>在运行时切换不同的实现方法</li>
</ul>
<h3 id="实现步骤-6">实现步骤</h3>
<ul>
<li>明确类中独立的纬度</li>
<li>定义抽象类</li>
<li>确认平台可用操作，声明抽象接口</li>
<li>平台类实现接口</li>
<li>抽象类中添加实现类型的引用</li>
</ul>
<h3 id="优缺点-6">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 创建与平台无关的类</li>
<li><input checked="" disabled="" type="checkbox"> 客户端代码与高层抽象互动</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input disabled="" type="checkbox"> 高内聚类使用该方法可能会更复杂</li>
</ul>
<h2 id="组合模式">组合模式</h2>
<h3 id="意图-7">意图</h3>
<p>将对象组合成树状结构，并能像独立对象一样使用它们</p>
<h3 id="问题-7">问题</h3>
<p>计算订单时，需要去除产品的包装后，再计算订单总金额，计算需要去除包装等因素</p>
<h3 id="解决方案-7">解决方案</h3>
<p>组合模式建议使用一个通用接口来与包装和产品交互，并且再该接口中声明一个计算总价的方法</p>
<h3 id="uml-结构-7">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Component{
  + execute()
}
class Leaf{
  + execute()
}
class Composite{
   - children: Component[]
   + add(c: Component)
   + remove(c: Component)
   + getChildren(): Component[]
   + execute()
}
class Client
Leaf ..|&gt; Component
Composite ..|&gt; Component
Client --&gt; Component
</code></pre><ul>
<li>Component 组件 抽象接口描述共同操作</li>
<li>Leaf 树节点</li>
<li>Composite 组合 包含也节点的单位</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/composite/structure-en-indexed.png" alt="composite structure"></p>
<h3 id="应用示例-7">应用示例</h3>
<p>图形编辑器实现一系列图形, 组合图形包含多个子图形，组合图形自身不完成具体工作，将请求传递给自己的子部件，然后合成结果</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface Graphic{
  + move(x, y)
  + draw()
}
class Dot{
  + Dot(x, y)
  + move(x, y)
  + draw()
}
class Circle{
  radius
  + Circle(x, y, radius)
  + draw()
}
class CompoundGraphic{
  - children: Graphic[]
  + add(child: Graphic)
  + remove(child: Graphic)
  + move(x, y)
  + draw()
}
class ImageEditor
ImageEditor --&gt; Graphic
Dot ..|&gt; Graphic
CompoundGraphic ..|&gt; Graphic
Circle --|&gt; Dot
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Graphic</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move</span>(self, x, y):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dot</span>(Graphic):

    <span style="color:#66d9ef">def</span> __init__(self, x, y):
        self<span style="color:#f92672">.</span>_x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>_y <span style="color:#f92672">=</span> y

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move</span>(self, x, y):
        self<span style="color:#f92672">.</span>_x <span style="color:#f92672">+=</span> x
        self<span style="color:#f92672">.</span>_y <span style="color:#f92672">+=</span> y

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;draw graphic&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Circle</span>(Dot):

    <span style="color:#66d9ef">def</span> __init__(self, x, y, radius):
        super()<span style="color:#f92672">.</span>__init__(x, y)
        self<span style="color:#f92672">.</span>_raidus <span style="color:#f92672">=</span> radius

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;draw Circle&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CompoundGraphic</span>(Graphic):

    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>_children <span style="color:#f92672">=</span> list()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, child):
        self<span style="color:#f92672">.</span>_children<span style="color:#f92672">.</span>append(child)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove</span>(self, child):
        self<span style="color:#f92672">.</span>_children<span style="color:#f92672">.</span>remove(child)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move</span>(self, x, y):
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_children:
            i<span style="color:#f92672">.</span>move(x, y)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self):
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_children:
            i<span style="color:#f92672">.</span>draw()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImageEditor</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load</span>(self):
        self<span style="color:#f92672">.</span>cg <span style="color:#f92672">=</span> CompoundGraphic()
        self<span style="color:#f92672">.</span>cg<span style="color:#f92672">.</span>add(Dot(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>))
        self<span style="color:#f92672">.</span>cg<span style="color:#f92672">.</span>add(Circle(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">group_selected</span>(self, components):
        group <span style="color:#f92672">=</span> CompoundGraphic()
        group<span style="color:#f92672">.</span>add(components)
        self<span style="color:#f92672">.</span>cg<span style="color:#f92672">.</span>add(group)
        self<span style="color:#f92672">.</span>cg<span style="color:#f92672">.</span>draw()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    ie <span style="color:#f92672">=</span> ImageEditor()
    ie<span style="color:#f92672">.</span>load()
    ie<span style="color:#f92672">.</span>group_selected(Dot(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>))
</code></pre></div><h3 id="适用性-7">适用性</h3>
<ul>
<li>需要实现树状对象结构</li>
<li>希望客户端以相同的方式处理简单和复杂的元素</li>
</ul>
<h3 id="实现步骤-7">实现步骤</h3>
<ul>
<li>确保核心模型能分解成简单元素和容器</li>
<li>声明组件接口以及一系列方法</li>
<li>创建一个也节点类表示简单元素</li>
<li>创建一个组合类表示容器的复杂元素。用于储存子元素</li>
<li>在容器中定义添加和删除子元素的方法</li>
</ul>
<h3 id="优缺点-7">优缺点</h3>
<ul>
<li>利用多态和递归机制方便使用复杂树结构</li>
<li>开闭原则</li>
<li>对于功能差异大的类，提供公共结构或许会有困难</li>
</ul>
<h2 id="装饰模式">装饰模式</h2>
<h3 id="意图-8">意图</h3>
<p>通过对象放入包含行为的特殊封装对象中来为原对象绑定新的行为</p>
<h3 id="问题-8">问题</h3>
<p>通知类中可以发送通知，后续需要增加不同的接受终端和通知方式，如果修改源代码会使代码量快速膨胀和复杂</p>
<h3 id="解决方案-8">解决方案</h3>
<p>通过装饰器将目标对象的方法进行拓展，而不改变结构名称与参数。上述问题可以实现基类装饰器后，衍生出不同终端和通知方式的装饰器。</p>
<h3 id="uml-结构-8">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Component{
  + execute()
}
class ConcreteComponent{
  + execute()
}
class BaseDecorator{
  - wrappee: Component
  + Decorator(c: Component)
  + execute()
}
class ConcreteDecorators{
  + execute()
  + extra()
}
class Client
Client --&gt; Component
ConcreteComponent ..|&gt; Component
BaseDecorator ..|&gt; Component
ConcreteDecorators --|&gt; BaseDecorator
</code></pre><ul>
<li>Component 部件 装饰器和被装饰对象的公共接口</li>
<li>ConcreteComponent 具体部件 被装饰对象</li>
<li>BaseDecorator 基类装饰器 通用装饰器接口</li>
<li>ConcreteDecorators 动态添加行为，改变原有被装饰对象行为</li>
</ul>
<p><img src="https://refactoringguru.cn/images/patterns/diagrams/decorator/structure-indexed.png" alt="decorator structure"></p>
<h3 id="应用示例-8">应用示例</h3>
<p>装饰模式加密数据</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface DataSource{
  + writeData(data)
  + readData()
}
class FileDataSource{
  - filename
  + FileDataSource(filename)
  + writeData(data)
  - readData()
}
class DataSourceDecorator{
  - wrappee: DataSource
  + DataSourceDecorator(s:DataSource)
  + writeData(data)
  + readData()
}
class EncryptionDecorator{
  + writeData(data)
  + readData()
}
class CompresionDecorator{
  + writeData(data)
  + readData()
}
FileDataSource ..|&gt; DataSource
DataSourceDecorator ..|&gt; DataSource
EncryptionDecorator --|&gt; DataSourceDecorator
CompressionDecorator --|&gt; DataSourceDecorator
DataSourceDecorator o--&gt; DataSource
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DataSource</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data</span>(self, data):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileDataSource</span>(DataSource):

    <span style="color:#66d9ef">def</span> __init__(self, filename):
        self<span style="color:#f92672">.</span>_filename <span style="color:#f92672">=</span> filename

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data</span>(self, data):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;write data&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;read data&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DataSourceDecorator</span>(DataSource):

    <span style="color:#66d9ef">def</span> __init__(self, wrappee):
        self<span style="color:#f92672">.</span>_wrappee <span style="color:#f92672">=</span> wrappee


    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data</span>(self, data):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;decorator write data&#39;</span>)
        self<span style="color:#f92672">.</span>_wrappee<span style="color:#f92672">.</span>write_data(data)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;decorator read data&#39;</span>)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_wrappee<span style="color:#f92672">.</span>read_data()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EncryptionDecorator</span>(DataSourceDecorator):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data</span>(self, data):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;encrypt data&#39;</span>)
        super()<span style="color:#f92672">.</span>write_data(data)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;decrypt data&#39;</span>)
        super()<span style="color:#f92672">.</span>read_data()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CompressionDecorator</span>(DataSourceDecorator):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_data</span>(self, data):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;compress data&#39;</span>)
        super()<span style="color:#f92672">.</span>write_data(data)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;decompress data&#39;</span>)
        super()<span style="color:#f92672">.</span>read_data()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    source <span style="color:#f92672">=</span> FileDataSource(<span style="color:#e6db74">&#39;haha&#39;</span>)
    source<span style="color:#f92672">.</span>write_data(<span style="color:#e6db74">&#39;abc&#39;</span>)
    c_source <span style="color:#f92672">=</span> CompressionDecorator(source)
    c_source<span style="color:#f92672">.</span>write_data(<span style="color:#e6db74">&#39;abc&#39;</span>)
    e_source <span style="color:#f92672">=</span> EncryptionDecorator(source)
    e_source<span style="color:#f92672">.</span>write_data(<span style="color:#e6db74">&#39;abc&#39;</span>)
</code></pre></div><h3 id="适用性-8">适用性</h3>
<ul>
<li>不修改代码的情况下增加对象的功能</li>
<li>使用继承拓展对象行为难以实现，使用装饰模式</li>
</ul>
<h3 id="实现步骤-8">实现步骤</h3>
<ul>
<li>确保业务逻辑可用一个基本组件和多个额外可选组件表示</li>
<li>找出通用方法，声明接口</li>
<li>创建一个具体组件类，定义基础行为</li>
<li>创建装饰基类，使用一个成员变量储存被装饰对象</li>
<li>确保所有类实现组件接口</li>
<li>将装饰基类拓展为具体装饰类，添加额外行为</li>
</ul>
<h3 id="优缺点-8">优缺点</h3>
<ul>
<li>无需新建子类即可拓展对象行为</li>
<li>运行时添加或删除对象的功能</li>
<li>多个装饰器组合几种行为</li>
<li>单一职责原则</li>
<li>装饰器删除特定装饰器比较困难</li>
<li>实现行为不受装饰顺序装饰比较困难</li>
<li>各层初始化配置代码比较糟糕</li>
</ul>
<h2 id="外观模式">外观模式</h2>
<h3 id="意图-9">意图</h3>
<p>使复杂类提供一个简单的接口</p>
<h3 id="问题-9">问题</h3>
<p>代码中使用复杂的库或框架中对象，需要负责所有对象的初始化工作、管理其依赖关系并正确执行。将业务逻辑和第三方类的实现耦合，使代码难以维护。</p>
<h3 id="解决方案-9">解决方案</h3>
<p>外观模式为许多部件的复杂子系统提供一个简单的接口，不关心内部实现，仅调用需要的功能。</p>
<h3 id="uml-结构-9">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">class Facade{
  - linkToSubsystemObjects
  - optionalAdditionFacade
  + subsystemOperation()
}
class AdditionalFacade{
  + anotherOperation()
}
class Client
class Subsystem
Client --&gt; Facade
Facade --&gt; AdditionalFacade
Facade ..&gt; Subsystem
AdditionalFacade ..&gt; Subsystem
</code></pre><ul>
<li>Facade 外观 提供特定子系统功能便捷访问</li>
<li>AdditionalFacade 附加外观 避免多种不相关的功能污染单一外观</li>
<li>Subsystem 复杂子系统</li>
</ul>
<p><img src="https://refactoringguru.cn/images/patterns/diagrams/facade/structure-indexed.png" alt="facade structure"></p>
<h3 id="应用示例-9">应用示例</h3>
<p>视频转换框架</p>
<pre><code class="language-plantuml" data-lang="plantuml">class Application
class VideoConverter{
  + converVideo(filename, format)
}
class AudioMixer
class VideoFile
class CodecFactory
Application --&gt; VideoConverter
VideoConverter ..&gt; VideoFile
VideoConverter ..&gt; AudioMixer
VideoConverter ..&gt; CodecFactory
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VideoFile</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, filename<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>filename <span style="color:#f92672">=</span> filename
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;init&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CodecFactory</span>(object):

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract</span>(file_<span style="color:#f92672">=</span>None):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;CodecFactory extract&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VideoConverter</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">convert</span>(self, filename):
        file_ <span style="color:#f92672">=</span> VideoFile(filename)
        source_codec <span style="color:#f92672">=</span> CodecFactory<span style="color:#f92672">.</span>extract(file_)
        <span style="color:#66d9ef">return</span> source_codec


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    convertor <span style="color:#f92672">=</span> VideoConverter()
    mp4 <span style="color:#f92672">=</span> convertor<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#39;adfd&#39;</span>)
</code></pre></div><h3 id="适用性-9">适用性</h3>
<ul>
<li>需要一个复杂子系统的直接接口，且该接口功能有限</li>
<li>需要将子系统组织为多层结构，减少子系统之间的耦合</li>
</ul>
<h3 id="实现步骤-9">实现步骤</h3>
<ul>
<li>确认能否在现有子系统的基础上提供一个更简单的接口</li>
<li>在外观类中声明并实现接口</li>
<li>确保所有客户端代码仅通过外观模式与子系统进行交互</li>
</ul>
<h3 id="优缺点-9">优缺点</h3>
<ul>
<li>可以让代码独立与复杂子系统</li>
<li>外观可能成为与程序中所有类耦合的类对象</li>
</ul>
<h2 id="享元模式">享元模式</h2>
<h3 id="意图-10">意图</h3>
<p>享元模式通过共享对象状态，在有限的内存中保存更多的对象</p>
<h3 id="问题-10">问题</h3>
<p>对象过多造成内存不足，程序崩溃</p>
<h3 id="解决方案-10">解决方案</h3>
<p>对象的常量数据通常被称为固有属性， 其位于对象中， 其他对象只能读取但不能修改其数值。 而对象的其他状态常常能被其他对象 “从外部” 改变， 因此被称为外在属性。</p>
<p>享元模式建议不在对象中存储外在状态， 而是将其传递给依赖于它的一个特殊方法。 程序只在对象中保存固有属性， 以方便在不同情景下重用。</p>
<h3 id="uml-结构-10">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">class FlyweightFactory{
    - cache: Flyweight[]
    + getFlyweight(repeationState)
}
class Flyweight{
    - repeatingState
    + operation(uniqueState)
}
class Context{
    - unniqueState
    - flyweight
    + Context(repeatingState, uniqueState)
    + opeartion()
}
class Client
Client *--&gt; Context
Context --&gt; Flyweight
Context --&gt; FlyweightFactory
</code></pre><ul>
<li>Flyweight 享元类固有属性</li>
<li>FlyweightFactory 工厂类</li>
<li>Context 外在属性类</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/flyweight/structure.png" alt="flyweight structure"></p>
<h3 id="应用示例-10">应用示例</h3>
<p>储存多个树对象</p>
<pre><code class="language-plantuml" data-lang="plantuml">class TreeType{
    - name
    - color
    - texture
    + TreeType(name, color, texture)
    + draw(canvas, x, y)
}
class Tree{
    + x
    + y
    + type: TreeType
    + draw(canvas)
}
class Forest{
    + tree: Tree[]
    + plantTree(x, y, name, color, texture): Tree
    + draw(canvans)
}
class TreeFactory{
    - treeTypes: TreeType[]
    + getTreeType(name, color, texture)
}
TreeFactory o--&gt; TreeType
Tree --&gt; Treetype
Tree --&gt; TreeFactory
Forest o--&gt; Tree
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding:utf-8 -*-</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TreeType</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, name, color, texture):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>color <span style="color:#f92672">=</span> color
        self<span style="color:#f92672">.</span>texture <span style="color:#f92672">=</span> texture

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self, canvas, x, y):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;tree type draw&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TreeFactory</span>(object):
    tree_types <span style="color:#f92672">=</span> list()

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_tree</span>(trees, target):
        ret <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> trees:
            <span style="color:#66d9ef">return</span> ret
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> trees:
            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> target:
                ret <span style="color:#f92672">=</span> i
                <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">return</span> ret

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_tree_type</span>(name, color, texture):
        tree_type <span style="color:#f92672">=</span> TreeFactory<span style="color:#f92672">.</span>find_tree(
            TreeFactory<span style="color:#f92672">.</span>tree_types, (name, color, texture))
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tree_type:
            tree_type <span style="color:#f92672">=</span> TreeType(name, color, texture)
            TreeFactory<span style="color:#f92672">.</span>tree_types<span style="color:#f92672">.</span>append(tree_type)
        <span style="color:#66d9ef">return</span> tree_type


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Tree</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, x, y, t):
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> y
        self<span style="color:#f92672">.</span>t <span style="color:#f92672">=</span> t

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self, canvas):
        self<span style="color:#f92672">.</span>t<span style="color:#f92672">.</span>draw(canvas, self<span style="color:#f92672">.</span>x, self<span style="color:#f92672">.</span>y)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Forest</span>(object):
    trees <span style="color:#f92672">=</span> list()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plant_tree</span>(self, x, y, name, color, texture):
        t <span style="color:#f92672">=</span> TreeFactory<span style="color:#f92672">.</span>get_tree_type(name, color, texture)
        tree <span style="color:#f92672">=</span> Tree(x, y, t)
        self<span style="color:#f92672">.</span>trees<span style="color:#f92672">.</span>append(tree)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw</span>(self, canvas):
        <span style="color:#66d9ef">for</span> tree <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>trees:
            tree<span style="color:#f92672">.</span>draw(canvas)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    forest <span style="color:#f92672">=</span> Forest()
    forest<span style="color:#f92672">.</span>plant_tree(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;tree&#39;</span>, <span style="color:#e6db74">&#39;red&#39;</span>, <span style="color:#e6db74">&#39;p&#39;</span>)
    forest<span style="color:#f92672">.</span>draw(<span style="color:#e6db74">&#39;canvas&#39;</span>)

</code></pre></div><h3 id="适用性-10">适用性</h3>
<ul>
<li>当程序使用需要大量对象，并且内存不足的情况</li>
</ul>
<h3 id="实现步骤-10">实现步骤</h3>
<ul>
<li>分离类属性至两个部分，固有属性；外在属性</li>
<li>类中不可变的保留固有属性成员变量</li>
<li>找到所耦外在转台成员变量方法，使用参数替代成员变量</li>
<li>可选的实现工厂类管理享元缓存池</li>
<li>客户端必须储存和计算外在状态的数值</li>
</ul>
<h3 id="优缺点-10">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 节省内存</li>
<li><input disabled="" type="checkbox"> 牺牲速度换取内存</li>
<li><input disabled="" type="checkbox"> 代码复杂</li>
</ul>
<h2 id="代理模式">代理模式</h2>
<h3 id="意图-11">意图</h3>
<p>代理模式控制原始对象的访问，并允许在将请求提交给对象前后进行一些处理。</p>
<h3 id="问题-11">问题</h3>
<p>大量消耗系统资源的对象，实现懒加载，类中可能存在重复的代码。但对于不能修改代码第三方库，不能实现懒加载。</p>
<h3 id="解决方案-11">解决方案</h3>
<p>创建一个新的代理类，将操作委托给代理类，可以真实操作前后执行某些操作。</p>
<h3 id="uml-结构-11">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface ServiceInterface{
    + opeartion()
}
class Proxy{
    - realService: Service
    + Proxy(s: Service)
    + checkAccess()
    + operation()
}
class Service{
    + operation
}
Proxy ..|&gt; ServiceInterface
Service ..|&gt; ServiceInterface
Proxy o--&gt; Service
</code></pre><ul>
<li>ServiceInterface 抽象接口</li>
<li>Proxy 代理类</li>
<li>Service 真实逻辑类</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/proxy/structure.png" alt="proxy structure"></p>
<h3 id="应用示例-11">应用示例</h3>
<p>视频懒加载与缓存</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface YoutubeLib{
    + listVideos()
    + getVideoInfo(id)
    + downloadVideo(id)
}
class YoutubeVideo{
    + listVides()
    + getVideoInfo(id)
    + downloadVideo(id)
}
class CachedVideo{
    - service: YoutubeVideo
    + CachedVideo(s: YoutubeVideo)
    + listVideos()
    + getVideoInfo(id)
    + downloadVideo(id)
}
CachedVideo ..|&gt; YoutubeLib
YoutubeVideo ..|&gt; YoutubeLib
CachedVideo o--&gt; YoutubeVideo
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#! /usr/bin/env python3</span>
<span style="color:#75715e">#  -*- coding:utf-8 -*-</span>


<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoutubeLib</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_videos</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_video_info</span>(self, id_):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_video</span>(self, id_):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoutubeVideo</span>(YoutubeLib):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_videos</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;origin list&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_video_info</span>(self, id_):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;id {} origin info&#39;</span><span style="color:#f92672">.</span>format(id_))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_video</span>(self, id_):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;origin download video&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CachedVideo</span>(YoutubeLib):

    <span style="color:#66d9ef">def</span> __init__(self, service):
        self<span style="color:#f92672">.</span>service <span style="color:#f92672">=</span> service
        self<span style="color:#f92672">.</span>list_cache <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>video_cache <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>need_reset <span style="color:#f92672">=</span> False

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_videos</span>(self):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>list_cache <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>need_reset:
            self<span style="color:#f92672">.</span>list_cache <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>list_videos()
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>list_cache

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_video_info</span>(self, id_):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>video_cache <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>need_reset:
            self<span style="color:#f92672">.</span>video_cache <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>get_video_info(id_)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>video_cache

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_video</span>(self, id_):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>need_reset:
            self<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>download_video(id_)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoutubeManager</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, service):
        self<span style="color:#f92672">.</span>service <span style="color:#f92672">=</span> service

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render_video_page</span>(self, id_):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>get_video_info(id_)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render_list_panel</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>list_videos()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">react_on_user_input</span>(self, id_):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>render_video_page(id_), self<span style="color:#f92672">.</span>render_list_panel()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    youtube_service <span style="color:#f92672">=</span> YoutubeVideo()
    service_proxy <span style="color:#f92672">=</span> CachedVideo(youtube_service)
    manager <span style="color:#f92672">=</span> YoutubeManager(service_proxy)
    ret <span style="color:#f92672">=</span> manager<span style="color:#f92672">.</span>react_on_user_input(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">print</span>(ret)

</code></pre></div><h3 id="适用性-11">适用性</h3>
<ul>
<li>懒加载</li>
<li>访问控制</li>
<li>本地执行远程服务</li>
<li>打印日志</li>
<li>缓存</li>
</ul>
<h3 id="实现步骤-11">实现步骤</h3>
<ul>
<li>创建代理与服务的接口，备选的方式是将代理作为服务类的子类</li>
<li>创建代理类，通常代理负责创建和管理服务</li>
<li>实现代理方法，委派给服务对象</li>
<li>创建构造方法判断代理还是服务对象，可以用工厂方法代替</li>
<li>可选服务对象延迟加载</li>
</ul>
<h3 id="优缺点-11">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 客户端无感知控制服务对象</li>
<li><input checked="" disabled="" type="checkbox"> 可管理服务对象生命周期</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input disabled="" type="checkbox"> 代码复杂</li>
<li><input disabled="" type="checkbox"> 服务延迟响应</li>
</ul>
<h1 id="行为模式">行为模式</h1>
<p>行为模式负责对象间的高效沟通和职责委派</p>
<h2 id="责任链模式">责任链模式</h2>
<h3 id="意图-12">意图</h3>
<p>请求发送至责任链。 收到请求后，每个处理者均可对请求进行处理，或将其传递给链上的下个处理者。</p>
<h3 id="问题-12">问题</h3>
<p>在线订单系统，限制非认证用户创建订单，处理认证还需要添加授权、数据验证、缓存等检查，随着功能的增多系统代码越来越复杂。</p>
<h3 id="解决方案-12">解决方案</h3>
<p>责任链会将特定行为转换为被称作 handler 的独立对象，请求与数据传递给 handler 对象处理。</p>
<p>将多个 handler 串联成链，请求在链上移动并且有计划被 handler 处理。</p>
<p>最重要的是：handler 可以决定不再沿着链传递请求，这可高效地取消所有后续处理步骤。</p>
<p>另一种不同的方式为：对于每个请求如果 handler 可以处理就不会在向后传递。</p>
<h3 id="uml-结构-12">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Handler{
    + setNext(h: Handler)
    + handle(request)
}
class BaseHandler{
    - next: Handler
    + setNext(h: Handler)
    + handle(request)
}
ConcreteHandlers{
    + handle(request)
}
BaseHandler ..|&gt; Handler
ConcreteHandlers --|&gt; BaseHandler
</code></pre><ul>
<li>Handler 处理抽象类</li>
<li>BaseHandler 基础处理类 定义下一个 handler 指针</li>
<li>ConcreteHandlers 具体处理类</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/chain-of-responsibility/structure.png" alt="chain sturcture"></p>
<h3 id="应用示例-12">应用示例</h3>
<p>GUI 元素显示上下文帮助信息</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface ComponentWithContextualHelp{
    + showHelp()
}
class Component{
    - container: Container
    + tooltipText
    + showHelp()
}
class Button
class Comtainer{
    - children: Component
    + add(child)
}
class Panel{
    - modalHelpText
    + showHelp()
}
class Dialog{
    - wikiPageURL
    + showHelp()
}
Component ..|&gt; ComponentWithContextualHelp
Container o--&gt; Component
Component --&gt; Container
Container --|&gt; Component
Panel --&gt; Container
Dialog --&gt; Container
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/chain-of-responsibility/example-en.png" alt="GUI structure"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#75715e"># 责任链抽象接口</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ComponentWithContextualHelp</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_help</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#75715e"># 简单组件基础类</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Component</span>(ComponentWithContextualHelp):

    <span style="color:#66d9ef">def</span> __init__(self, help_text<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>help_text <span style="color:#f92672">=</span> help_text
        self<span style="color:#f92672">.</span>container <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_help</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>help_text:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;component help&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>container<span style="color:#f92672">.</span>help()


<span style="color:#75715e"># 容器类包含组件或其他容器</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Container</span>(Component):

    <span style="color:#66d9ef">def</span> __init__(self):
        super()<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>children <span style="color:#f92672">=</span> list()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, child):
        self<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>append(child)
        child<span style="color:#f92672">.</span>container <span style="color:#f92672">=</span> self


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Button</span>(Component):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Panel</span>(Container):

    <span style="color:#66d9ef">def</span> __init__(self, help_text<span style="color:#f92672">=</span>None):
        super()<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>help_text <span style="color:#f92672">=</span> help_text

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_help</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>help_text:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;modal_text&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            super()<span style="color:#f92672">.</span>show_help()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dialog</span>(Container):

    <span style="color:#66d9ef">def</span> __init__(self, help_text<span style="color:#f92672">=</span>None):
        super()<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>help_text <span style="color:#f92672">=</span> help_text

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_help</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>help_text:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;dialog text&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            super()<span style="color:#f92672">.</span>show_help()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    dialog <span style="color:#f92672">=</span> Dialog(<span style="color:#e6db74">&#39;haha&#39;</span>)
    panel <span style="color:#f92672">=</span> Panel(<span style="color:#e6db74">&#39;panel&#39;</span>)
    button <span style="color:#f92672">=</span> Button(<span style="color:#e6db74">&#39;button&#39;</span>)
    button1 <span style="color:#f92672">=</span> Button(<span style="color:#e6db74">&#39;button1&#39;</span>)
    panel<span style="color:#f92672">.</span>add(button)
    panel<span style="color:#f92672">.</span>add(button1)
    dialog<span style="color:#f92672">.</span>add(panel)
    dialog<span style="color:#f92672">.</span>show_help()

</code></pre></div><h3 id="适用性-12">适用性</h3>
<ul>
<li>程序需要不同处理方式处理不同种类的请求，而且请求类型和顺序位置</li>
<li>必须按顺序执行处理者</li>
<li>如果处理者及其顺序必须在运行是改变，可以使用该模式</li>
</ul>
<h3 id="实现步骤-12">实现步骤</h3>
<ul>
<li>声明处理者接口并描述请求处理方法</li>
<li>为了精简代码可以在处理者接口穿件抽象处理者基类</li>
<li>依次创建集体处理者代码</li>
<li>客户端可自行组装责任链，或独立工厂类获取</li>
</ul>
<h3 id="优缺点-12">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 控制请求处理顺序</li>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input disabled="" type="checkbox"> 部分请求可能未处理</li>
</ul>
<h2 id="命令模式">命令模式</h2>
<h3 id="意图-13">意图</h3>
<p>将请求转换为一个包含与请求相关的所有信息的独立对象。</p>
<h3 id="问题-13">问题</h3>
<p>定义文本编辑器基类抽象按钮，为了实现功能具体化多个按钮，修改按钮基类使影响所有子类。除了按钮如快捷键等行为代码如何处理。</p>
<h3 id="解决方案-13">解决方案</h3>
<p>优良的软件设计通常会将关注点分离，即常用的软件分层。如编辑软件分离 GUI 与业务逻辑。命令模式将所有操作进行抽象成命令类，通过命令对象负责连接不同的 GUI 和业务逻辑对象。</p>
<p>命令模式使用数据对命令对象进行配置，实现不同请求参数。</p>
<h3 id="uml-结构-13">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">class Invoker{
    - command
    + setCommand(command)
    + executeCommand()
}
interface Command{
    + execute()
}
class Command1{
    - receiver
    - params
    + Command1(receiver, params)
    + execute()
}
class Receiver
class Client
Invoker o--&gt; Command
Command1 ..|&gt; Command
Client --&gt; Invoker
Client --&gt; Command1
Client --&gt; Receiver
</code></pre><ul>
<li>Invoker 调用者 初始化请求</li>
<li>Command 抽象命令类</li>
<li>Command1 具体命令类</li>
<li>Receiver 接受者 处理业务逻辑</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/command/structure.png" alt="command structure"></p>
<h3 id="应用示例-13">应用示例</h3>
<p>命令模式实现命令历史与撤销</p>
<p>有些命令会改变编辑器的状态 （例如剪切和粘贴），它们可在执行相关操作前对编辑器的状态进行备份。命令执行后会和当前点备份的编辑器状态一起被放入命令历史 （命令对象栈）。 此后，如果用户需要进行回滚操作，程序可从历史记录中取出最近的命令，读取相应的编辑器状态备份，然后进行恢复。</p>
<pre><code class="language-plantuml" data-lang="plantuml">class Command{
    - app
    - editor
    - backup
    + Command(app, editor)
    + saveBackup
    + undo
    + execute()
}
class Buttons
class Shortcuts
class CommandHistory{
    - history: Command[]
    + push(c: Command)
    + pop(): Command
}
class CopyCommand{
    + execute()
}
class CutCommand{
    + execute()
}
class PasteCommand{
    + execute()
}
class UndoCommand{
    + execute()
}
class Editor{
    + text
    + getSelection()
    + deleteSelection()
    + replaceSelection(text)
}
class Application{
    + editors: Editor[]
    + activeEditor: Editor
    + clipboard
    + history: CommandHistory
    + createUI()
    + executeCommand)c: Command)
    + undo
}
Application o--&gt; Editor
Application o--&gt; CommandHistory
Application --&gt; Buttons
Application --&gt; Shortcuts
Buttons o--&gt; Command
Shortcuts o--&gt; Command
CommandHistory o--&gt; Command
CopyCommand --|&gt; Command
CutCommand --|&gt; Command
PasteCommand --|&gt; Command
UndoCommand --|&gt; Command
CopyCommand --&gt; Editor
CutCommand --&gt; Editor
PasteCommand --&gt; Editor
UndoCommand --&gt; Application
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/command/example.png" alt="command example"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#75715e"># 命令</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Command</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#66d9ef">def</span> __init__(self, app, editor):
        self<span style="color:#f92672">.</span>app <span style="color:#f92672">=</span> app
        self<span style="color:#f92672">.</span>editor <span style="color:#f92672">=</span> editor
        self<span style="color:#f92672">.</span>backup <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_backup</span>(self):
        self<span style="color:#f92672">.</span>backup <span style="color:#f92672">=</span> editor<span style="color:#f92672">.</span>text

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CopyCommand</span>(Command):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;execute&#39;</span>)
        self<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>clipboard <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>get_selection()
        <span style="color:#66d9ef">return</span> False


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CutCommand</span>(Command):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;execute&#39;</span>)
        self<span style="color:#f92672">.</span>save_backup()
        self<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>clipboard <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>get_selection()
        self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>delete_selection()
        <span style="color:#66d9ef">return</span> True


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PasteCommand</span>(Command):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;execute&#39;</span>)
        self<span style="color:#f92672">.</span>save_backup()
        self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>repalce_selection(self<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>clipboard)
        <span style="color:#66d9ef">return</span> True


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UndoCommand</span>(Command):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
        <span style="color:#66d9ef">print</span>(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;execute&#39;</span>)
        self<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>undo()
        <span style="color:#66d9ef">return</span> False


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommandHistory</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>history <span style="color:#f92672">=</span> list()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">push</span>(self, c):
        self<span style="color:#f92672">.</span>history<span style="color:#f92672">.</span>append(c)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pop</span>(self):
        self<span style="color:#f92672">.</span>history<span style="color:#f92672">.</span>pop()


<span style="color:#75715e"># 接受者</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Editor</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_selection</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;editor get selection&#39;</span>)
        ret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>text:
            ret <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>text
        <span style="color:#66d9ef">return</span> ret

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_selection</span>(self):
        <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;editor delete selection&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Button</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, command<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>command <span style="color:#f92672">=</span> command

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_command</span>(self, command):
        self<span style="color:#f92672">.</span>command <span style="color:#f92672">=</span> command

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>command:
            self<span style="color:#f92672">.</span>command()


<span style="color:#75715e"># 发送者</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>clipboard <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>editors <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>active_editor <span style="color:#f92672">=</span> Editor()
        self<span style="color:#f92672">.</span>history <span style="color:#f92672">=</span> CommandHistory()


    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_ui</span>(self, buttons):
        copy_button, undo_button <span style="color:#f92672">=</span> buttons
        copy <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> : self<span style="color:#f92672">.</span>execute_command(
                CopyCommand(self, self<span style="color:#f92672">.</span>active_editor))
        copy_button<span style="color:#f92672">.</span>set_command(copy)
        undo <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> : self<span style="color:#f92672">.</span>execute_command(
                UndoCommand(self, self<span style="color:#f92672">.</span>active_editor))
        undo_button<span style="color:#f92672">.</span>set_command(undo)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute_command</span>(self, command):
        <span style="color:#66d9ef">if</span> command<span style="color:#f92672">.</span>execute():
            self<span style="color:#f92672">.</span>push(command)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">undo</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>history<span style="color:#f92672">.</span>history:
            command <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>history<span style="color:#f92672">.</span>pop()
            <span style="color:#66d9ef">if</span> command:
                command<span style="color:#f92672">.</span>undo()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_buttons</span>(self, buttons):
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> buttons:
            i<span style="color:#f92672">.</span>execute()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app <span style="color:#f92672">=</span> Application()
    copy_button <span style="color:#f92672">=</span> Button()
    undo_button <span style="color:#f92672">=</span> Button()
    buttons <span style="color:#f92672">=</span> (copy_button, undo_button)
    app<span style="color:#f92672">.</span>create_ui(buttons)
    app<span style="color:#f92672">.</span>test_buttons(buttons)

</code></pre></div><p>TODO</p>
<h3 id="适用性-13">适用性</h3>
<ul>
<li>通过操作来参数化对象，将特定的方法调用转化为独立对象。</li>
<li>想要将操作放入队列中、 操作的执行或者远程执行操作</li>
<li>想要实现操作回滚功能</li>
</ul>
<h3 id="实现步骤-13">实现步骤</h3>
<ul>
<li>声明仅有一个执行方法的抽象命令接口</li>
<li>具体命令类实现抽象接口，类必须保存请求参数与接受者</li>
<li>实现命令发送者类，类中保存命令的成员变量</li>
<li>修改发送者使其执行命令，而非直接将请求发送给接收者</li>
<li>顺序初始化对象：接受者、创建命令、关联命令与发送者</li>
</ul>
<h3 id="优缺点-13">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 单一职责</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 实现撤销与恢复</li>
<li><input checked="" disabled="" type="checkbox"> 实现延迟操作</li>
<li><input checked="" disabled="" type="checkbox"> 将一组简单命令组合成复杂命令</li>
<li><input disabled="" type="checkbox"> 代码复杂</li>
</ul>
<h2 id="迭代器模式">迭代器模式</h2>
<h3 id="意图-14">意图</h3>
<p>不暴露集合底层数据表现形式的情况下遍历集合中所有的元素</p>
<h3 id="问题-14">问题</h3>
<p>将遍历方法写入集合类中会造成代码复杂，并且不符合高效存储的设计理念</p>
<h3 id="解决方案-14">解决方案</h3>
<p>迭代器模式的主要思想是将集合的遍历行为抽取为单独的迭代器对象。</p>
<p>迭代器提供获取集合元素的基础方法，通过调用方法遍历集合所有元素。</p>
<p>迭代器实现相同的接口，如果需要新的迭代方式，按照需求新建新的迭代器类，无需修改集合代码。</p>
<h3 id="uml-结构-14">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Iterator{
    + getNext()
    + hasMore(): bool
}
interface IterableCollextion{
    + createIterator(): Iterator
}
class ConcreteIterator{
    - collection: ConcreteCollection
    - iterationState
    + ConcreteIterator(c: ConcreteCollection)
    + getNext()
    + hasMore(): bool
}
class ConcreteCollection{
    + creteIterator(): Iterator
}
class Client
Client --&gt; IterableCollection
Client ---&gt; Iterator
ConcreteIterator ..|&gt; Iterator
ConcreteCollection ..|&gt; IterableCollection
ConcreteIterator &lt;--&gt; ConcreteCollection
</code></pre><ul>
<li>Iterator 抽象迭代器接口</li>
<li>IterableCollection 集合返回迭代器接口</li>
<li>ConcreteIterator 具体迭代器类 需保存遍历进度</li>
<li>ConcreteIterableCollection 具体返回迭代器类</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/iterator/structure.png" alt="iterator structure"></p>
<h3 id="应用示例-14">应用示例</h3>
<p>遍历一个好友关系功能的特殊集合</p>
<pre><code class="language-plantuml" data-lang="plantuml">class Profile{
    + getId()
    + getEmail()
}
interface Iterator{
    + getNext: Profile
    + hasMore(): bool
}
interface SocialNetwork{
    + createFriendsIterator(profiledId): ProfileIterator
    + createCoworkersIterator(profiledId): ProfileIterator
}
class Facebook{
    + createFriendsIterator(profileId): ProfileIterator
    + createCoworkersIterator(profiledId): ProfileIterator
}
class FacebookIterator{
    - facebook: Facebook
    - profileId, type
    - currentPosition
    - cache: Profile[]
    + FackbookIterator()
    - lazyInit()
    + getNext(): Profile
    + hasMore(): bool
}
class SocialSpammer{
    + send(iterator, message)
}
class Application{
    - spammer
    - network
    + sendSpamToFriends(profile)
    + sendSpanToCoworkers(profile)
}
Application --&gt; SocialSpammer
Application --&gt; Facebook
SocialSpammer --&gt; Profile
SocialSpammer --&gt; Iterator
Iterator --&gt; Profile
FacebookIterator ..|&gt; Iterator
FacebookIterator &lt;--&gt; Facebook
SocialNetwork --&gt; Iterator
Facebook ..|&gt; SocialNetwork
Facebook o--&gt; Profile
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/iterator/example.png" alt="iteartor example"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Profile</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_id</span>(self):
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
<span style="color:#75715e"># 抽象社交网络接口</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocialNetwork</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_friends_iterator</span>(self, profile_id):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_coworkers_iterator</span>(self, profile_id):
        <span style="color:#66d9ef">pass</span>


<span style="color:#75715e"># 迭代器接口</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProfileIterator</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_more</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#75715e"># 具体迭代器</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FacebookIterator</span>(ProfileIterator):

    <span style="color:#66d9ef">def</span> __init__(self, facebook, profile_id, type_):
        self<span style="color:#f92672">.</span>facebook <span style="color:#f92672">=</span> facebook
        self<span style="color:#f92672">.</span>profile_id <span style="color:#f92672">=</span> profile_id
        self<span style="color:#f92672">.</span>type_ <span style="color:#f92672">=</span> type_
        self<span style="color:#f92672">.</span>current_pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lazy_init</span>(self):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>cache:
            self<span style="color:#f92672">.</span>cache <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>facebook<span style="color:#f92672">.</span>social_graph_request(self<span style="color:#f92672">.</span>profile_id, self<span style="color:#f92672">.</span>type_)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>has_more():
            ret <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cache[self<span style="color:#f92672">.</span>current_pos]
            self<span style="color:#f92672">.</span>current_pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">return</span> ret

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_more</span>(self):
        self<span style="color:#f92672">.</span>lazy_init()
        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>cache) <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>current_pos


<span style="color:#75715e"># 具体社交类</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Facebook</span>(SocialNetwork):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_friends_iterator</span>(self, profile_id):
        <span style="color:#66d9ef">return</span> FacebookIterator(self, profile_id, <span style="color:#e6db74">&#39;friends&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_coworkers_iterator</span>(self, profile_id):
        <span style="color:#66d9ef">return</span> FacebookIterator(self, profile_id, <span style="color:#e6db74">&#39;coworkers&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">social_graph_request</span>(self, profile_id, type_):
        ret <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
        <span style="color:#66d9ef">if</span> type_ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;coworkers&#39;</span>:
            ret<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">4</span>)
        <span style="color:#66d9ef">return</span> ret


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocialSpammer</span>(object):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send</span>(self, iterator, message):
        <span style="color:#66d9ef">while</span> iterator<span style="color:#f92672">.</span>has_more():
            profile <span style="color:#f92672">=</span> iterator<span style="color:#f92672">.</span>get_next()
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;send email {}&#39;</span><span style="color:#f92672">.</span>format(profile))


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>network <span style="color:#f92672">=</span> Facebook()
        self<span style="color:#f92672">.</span>spammer <span style="color:#f92672">=</span> SocialSpammer()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_sapm_to_friends</span>(self, profile):
        iterator <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>network<span style="color:#f92672">.</span>create_friends_iterator(profile<span style="color:#f92672">.</span>get_id())
        self<span style="color:#f92672">.</span>spammer<span style="color:#f92672">.</span>send(iterator, <span style="color:#e6db74">&#39;haha&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_spam_to_coworkers</span>(self, profile):
        iterator <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>network<span style="color:#f92672">.</span>create_coworkers_iterator(profile<span style="color:#f92672">.</span>get_id())
        self<span style="color:#f92672">.</span>spammer<span style="color:#f92672">.</span>send(iterator, <span style="color:#e6db74">&#39;haha&#39;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app <span style="color:#f92672">=</span> Application()
    profile <span style="color:#f92672">=</span> Profile()
    app<span style="color:#f92672">.</span>send_sapm_to_friends(profile)
    app<span style="color:#f92672">.</span>send_spam_to_coworkers(profile)

</code></pre></div><h3 id="适用性-14">适用性</h3>
<ul>
<li>集合背后为复杂的数据结构，希望隐藏其复杂性</li>
<li>减少程序中重复的遍历代码</li>
<li>希望代码能遍历不同的甚至是无法与之的数据结构</li>
</ul>
<h3 id="实现步骤-14">实现步骤</h3>
<ul>
<li>声明迭代器接口，至少提供获取下一个元素的方法</li>
<li>声明集合接口并描述一个获取迭代器的方法</li>
<li>使用迭代器实现具体的迭代类</li>
<li>集合中实现集合接口，提供不同创建迭代器的方法</li>
</ul>
<h3 id="优缺点-14">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 单一职责</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 并行遍历集合</li>
<li><input checked="" disabled="" type="checkbox"> 可暂停后继续遍历集合</li>
<li><input disabled="" type="checkbox"> 特殊集合迭代器效率低</li>
</ul>
<h2 id="中介者模式">中介者模式</h2>
<h3 id="意图-15">意图</h3>
<p>减少对象之间相互依赖，通过限制对象直接交互，使用中介者进行交互。</p>
<h3 id="问题-15">问题</h3>
<p>包含多个组件的对话框进行交互，如果在组件中实现组件之间动态交互与数据的校验等逻辑，会导致代码复杂无法复用。</p>
<h3 id="解决方案-15">解决方案</h3>
<p>中介者模式使组件调用特殊的中介者对象， 通过中介者以间接的方式进行交互。</p>
<p>上个例子，将对话框作为中介者，所有部件与对话框交互，减少部件之间的依赖。</p>
<h3 id="uml-结构-15">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Mediator{
    + notify(sender)
}
class ComponentA{
    - m: Mediator
    + opeartionA()
}
class ComponentB{
    - m: Mediator
    + opeartionB()
}
class ConcreteMediator{
    - componentA
    - componentB
    + notify(sender)
    + reactOnA()
    + reactOnB()
}
ConcreteMediator ..|&gt; Mediator
ConcreteMediator *--&gt; ComponentA
ConcreteMediator *--&gt; ComponentB
</code></pre><ul>
<li>Mediator 抽象中介者</li>
<li>ConcreteMediator 具体中介者</li>
<li>ComponentA 组件</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/mediator/structure.png" alt="mediator structure"></p>
<h3 id="应用示例-15">应用示例</h3>
<p>UI 组件交互</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface Mediator{
    + notify(sender: Component, event: string)
}
class Component{
    # dialog: Mediator
    + Component(dialog)
    + click()
    + keypress()
}
class AuthenticationDialog{
    title: string
    loginOrRegister: bool
    loginUsername, loginPassword: Textbox
    regUserame, regPassword, regEmail: Textbox
    ok, cancel: Button
    rememerMe: Checkbox
    + AuthenticationDialog()
    + notify(sender, event)
}
class Checkbox{
    + check()
}
class Button
class Textbox
Button --|&gt; Component
Textbox --|&gt; Component
Checkbox --|&gt; Component
Component &lt;--&gt; Mediator
AuthenticationDialog ..|&gt; Mediator
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- condig: utf-8 -*-</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#75715e"># 抽象接口</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Mediator</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notify</span>(self, sender, event):
        <span style="color:#66d9ef">pass</span>


<span style="color:#75715e"># 具体实现</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationDialog</span>(Mediator):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>title <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>login_or_register_chkbx <span style="color:#f92672">=</span> True
        self<span style="color:#f92672">.</span>login_username <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>login_password <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>registration_email <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>registration_password <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>registration_email <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>ok_btn <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>cancel_btn <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_chk</span>(self, chk):
        self<span style="color:#f92672">.</span>login_or_register_chkbx <span style="color:#f92672">=</span> chk

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notify</span>(self, sender, event):
        <span style="color:#66d9ef">if</span> sender <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>login_or_register_chkbx <span style="color:#f92672">and</span> event <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;check&#39;</span>:
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>login_or_register_chkbx<span style="color:#f92672">.</span>checked:
                self<span style="color:#f92672">.</span>title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;log in&#39;</span>
            <span style="color:#66d9ef">else</span>:
                self<span style="color:#f92672">.</span>title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;register&#39;</span>
        <span style="color:#66d9ef">elif</span> sender <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>ok_btn <span style="color:#f92672">and</span> event <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;click&#39;</span>:
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>login_or_register<span style="color:#f92672">.</span>checked:
                self<span style="color:#f92672">.</span>title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;click&#39;</span>
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>title:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>title))


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Component</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, dialog):
        self<span style="color:#f92672">.</span>dialog <span style="color:#f92672">=</span> dialog

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click</span>(self):
        self<span style="color:#f92672">.</span>dialog<span style="color:#f92672">.</span>notify(self, <span style="color:#e6db74">&#39;click&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keypress</span>(self):
        self<span style="color:#f92672">.</span>dialog<span style="color:#f92672">.</span>notify(self, <span style="color:#e6db74">&#39;keypress&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Button</span>(Component):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Textbox</span>(Component):
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Checkbox</span>(Component):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        self<span style="color:#f92672">.</span>checked <span style="color:#f92672">=</span> True

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check</span>(self):
        self<span style="color:#f92672">.</span>dialog<span style="color:#f92672">.</span>notify(self, <span style="color:#e6db74">&#39;check&#39;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    ad <span style="color:#f92672">=</span> AuthenticationDialog()
    btn <span style="color:#f92672">=</span> Button(ad)
    chk <span style="color:#f92672">=</span> Checkbox(ad)
    ad<span style="color:#f92672">.</span>set_chk(chk)
    btn<span style="color:#f92672">.</span>click()
    chk<span style="color:#f92672">.</span>check()

</code></pre></div><h3 id="适用性-15">适用性</h3>
<ul>
<li>对象与对象紧密耦合时，使用中介者模式</li>
<li>组件过于依赖其他组件而无法复用是</li>
<li>不同场景下复用一些基本行为，导致您需要创建大量组件子类</li>
</ul>
<h3 id="实现步骤-15">实现步骤</h3>
<ul>
<li>找一组分离有益的耦合类</li>
<li>声明中介者接口与协议</li>
<li>实现具体中介者类</li>
<li>组件必须保存对于中介者对象的引用，构造函数传入</li>
<li>修改组件代码，使其可调用中介者通知方法，而非其他组件方法</li>
</ul>
<h3 id="优缺点-15">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 单一职责</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 减轻组件之间的耦合</li>
<li><input checked="" disabled="" type="checkbox"> 复用组件</li>
<li><input disabled="" type="checkbox"> 中介者过于复杂</li>
</ul>
<h2 id="备忘录模式">备忘录模式</h2>
<h3 id="意图-16">意图</h3>
<p>在不暴露对象实现细节的情况下保存和恢复对象之前的状态。</p>
<h3 id="问题-16">问题</h3>
<p>文本编辑器除了实现简单的文字编辑还具有图片等多媒体编辑功能，软件需要提供文件的修改历史。编辑器对象需要对所需要的属性进行保存，但是会涉及到对象权限问题。</p>
<h3 id="解决方案-16">解决方案</h3>
<p>备忘录模式将创建状态快照的工作委派给实际状态的拥有者对象。 这样拥有者对象就不再需要暴露私有属性，编辑器类也拥有其状态的完全访问权。</p>
<p>备忘录模式将对象的副本储存在备忘对象中，除了创建该对象的对象外，任何其他对象都无权访问内容。其他对象必须使用受限接口与备忘录进行交互， 它们可以获取快照的元数据。</p>
<h3 id="uml-结构-16">UML 结构</h3>
<h4 id="基于嵌套类实现">基于嵌套类实现</h4>
<pre><code class="language-plantuml" data-lang="plantuml">class Memento{
    - state
    - Memento(state)
    - getState()
}
class Originator{
    + save(): Memento
    + restore(m: Memento)
}
class Caretaker{
    - originator
    - history: Memento[]
    + doSomething()
    + undo()
}
Originator ..&gt; Memento
Caretaker --&gt; Memento
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/memento/structure1-indexed.png" alt="memento structure"></p>
<ul>
<li>Originator 原生类 可生成恢复快照</li>
<li>Memento 备忘录</li>
<li>Caretaker 负责人 负责状态相关操作</li>
<li>备忘录嵌套在原生类中</li>
</ul>
<h4 id="基于接口实现">基于接口实现</h4>
<pre><code class="language-plantuml" data-lang="plantuml">interface Memeto
class ConcreteMemento{
    - state
    + Memento(state)
    + getState()
}
class Originator{
    - state
    + save(): Memento
    + restore(m: Memento)
}
class Client{
    - origintor
    - history: Memento[]
    + undo()
}
ConcreteMemento ..|&gt; Memento
Originator ..&gt; ConcreteMemento
Client --&gt; Memento
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/memento/structure2-indexed.png" alt="memento structure"></p>
<ul>
<li>负责人仅可通过明确声明的中间接口与备忘录互动， 该接口仅声明与备忘录元数据相关的方法， 限制其对备忘录成员变量的直接访问权限。</li>
<li>原生类可以直接与备忘录对象进行交互， 访问备忘录类中声明的成员变量和方法。</li>
</ul>
<h4 id="严格封装">严格封装</h4>
<pre><code class="language-plantuml" data-lang="plantuml">interface Originator{
    save(): Memento
}
interface Memento{
    + restore()
}
class Caretaker{
    - history: Memento[]
    + undo()
}
class ConcreteMemento{
    - originator
    - state
    + Memento(originator, state)
    + restore()
}
class ConcreteOriginator{
    - state
    + save(): Memento
    + setState(state)
}
Originator ..&gt; Memento
ConcreteOriginator ..|&gt; Originator
Caretaker --&gt; Memento
ConcreteMemento ..|&gt; Memento
ConcreteOriginator &lt;--&gt; ConcreteMemento
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/memento/structure3-indexed.png" alt="memento structure"></p>
<h3 id="应用示例-16">应用示例</h3>
<p>基于命令模式与备忘录模式，保存复杂文字编辑器的状态快照。</p>
<p>命令对象作为负责人，执行与命令相关的操作前获取编辑器的备忘录，在撤销时，保存其状态。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Editor</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, text<span style="color:#f92672">=</span>None, cur_x<span style="color:#f92672">=</span>None, cur_y<span style="color:#f92672">=</span>None, selection_width<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> text
        self<span style="color:#f92672">.</span>cur_x <span style="color:#f92672">=</span> cur_x
        self<span style="color:#f92672">.</span>cur_y <span style="color:#f92672">=</span> cur_y
        self<span style="color:#f92672">.</span>selection_width <span style="color:#f92672">=</span> selection_width

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_text</span>(self, text):
        self<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> text

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_cursor</span>(self, x, y):
        self<span style="color:#f92672">.</span>cur_x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>cur_y <span style="color:#f92672">=</span> y

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_selection_width</span>(self, width):
        self<span style="color:#f92672">.</span>selection_width <span style="color:#f92672">=</span> width

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_snapshot</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;create snap&#39;</span>)
        <span style="color:#66d9ef">return</span> Snapshot(self, self<span style="color:#f92672">.</span>text, self<span style="color:#f92672">.</span>cur_x, self<span style="color:#f92672">.</span>cur_y, self<span style="color:#f92672">.</span>selection_width)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Snapshot</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, editor<span style="color:#f92672">=</span>None, text<span style="color:#f92672">=</span>None, cur_x<span style="color:#f92672">=</span>None, cur_y<span style="color:#f92672">=</span>None, selection_width<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>editor <span style="color:#f92672">=</span> editor
        self<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> text
        self<span style="color:#f92672">.</span>cur_x <span style="color:#f92672">=</span> cur_x
        self<span style="color:#f92672">.</span>cur_y <span style="color:#f92672">=</span> cur_y
        self<span style="color:#f92672">.</span>selection_width <span style="color:#f92672">=</span> selection_width

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">restore</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;restore snap&#39;</span>)
        self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>set_text(self<span style="color:#f92672">.</span>text)
        self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>set_cursor(self<span style="color:#f92672">.</span>cur_x, self<span style="color:#f92672">.</span>cur_y)
        self<span style="color:#f92672">.</span>editor<span style="color:#f92672">.</span>set_selection_width(self<span style="color:#f92672">.</span>selection_width)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Command</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, backup<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>backup <span style="color:#f92672">=</span> backup

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_backup</span>(self, editor):
        self<span style="color:#f92672">.</span>backup <span style="color:#f92672">=</span> editor<span style="color:#f92672">.</span>create_snapshot()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">undo</span>(self, editor):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>backup:
            self<span style="color:#f92672">.</span>backup<span style="color:#f92672">.</span>restore()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    cmd <span style="color:#f92672">=</span> Command()
    editor <span style="color:#f92672">=</span> Editor(<span style="color:#e6db74">&#39;text&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>)
    cmd<span style="color:#f92672">.</span>make_backup(editor)
    cmd<span style="color:#f92672">.</span>undo(editor)

</code></pre></div><h3 id="适用性-16">适用性</h3>
<ul>
<li>需要创建对象快照恢复其之前的状态</li>
<li>直接访问对象成员变量破坏封装特性时</li>
</ul>
<h3 id="实现步骤-16">实现步骤</h3>
<ul>
<li>确认原生类</li>
<li>创建备忘录类</li>
<li>将备忘录类设为不可变，备忘录只能通过构造函数一次性接收数据</li>
<li>可通过嵌套类或接口的方式创建备忘录类的关键关系</li>
<li>原生类中添加创建备忘录的方法、添加恢复自身状态的方法</li>
<li>负责人类处理具体如何被触发创建备忘录和恢复备忘录的逻辑</li>
</ul>
<h3 id="优缺点-16">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 不破坏对象封装情况的前提下创建对象状态快照</li>
<li><input checked="" disabled="" type="checkbox"> 通过负责人维护原生类状态历史</li>
<li><input disabled="" type="checkbox"> 客户端频繁创建备忘录会消耗大量内存</li>
<li><input disabled="" type="checkbox"> 负责人必须跟踪原生类生命周期，才能销毁不使用的备忘录</li>
<li><input disabled="" type="checkbox"> 动态编程语言不能确保备忘录状态不能被更改</li>
</ul>
<h2 id="观察者模式">观察者模式</h2>
<h3 id="意图-17">意图</h3>
<p>允许你定义一种订阅机制， 可在对象事件发生时通知多个 “观察” 该对象的其他对象。</p>
<h3 id="问题-17">问题</h3>
<p>商店到货通知，要么让顾客浪费时间检查产品是否到货， 要么让商店浪费资源去通知没有需求的顾客。</p>
<h3 id="解决方案-17">解决方案</h3>
<p>将自身状态改变通知其他对象称为发布者，关注发布者状态变化的称为订阅者。</p>
<p>发布者实现订阅机制，一、存储订阅者对象引用的列表成员变量，二、实现列表增删的公共方法。</p>
<p>为了实现通知订阅者，需要订阅者实现相同的接口，以便发布者通过该接口与订阅者交互。</p>
<h3 id="uml-结构-17">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Subscriber{
    + update()
}
class Publisher{
    - subscribers: Subscriber[]
    - mainState
    + subscribe(s: Subscriber)
    + unsubscribe(s: Subscriber)
    + notifySubscribers()
    + mainBusinessLogic()
}
class ConcreteSubscribers{
    + update(publisher)
}
ConcreteSubscribers ..|&gt; Subscriber
Publisher o--&gt; Subscriber
Client --&gt; Publisher
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/observer/structure-indexed.png" alt="observer structure"></p>
<ul>
<li>Publisher 发布者 触发事件</li>
<li>Subscriber 订阅者 抽象接口</li>
<li>ConcreteSubscriber 具体订阅者 接收事件</li>
</ul>
<h3 id="应用示例-17">应用示例</h3>
<p>文本编辑器将自身状态通知其他服务</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface EventListeners{
    + update(filename)
}
class Editor{
    - eventManager
    + Editor()
    + openFile()
    + saveFile()
}
class EventManager{
    - listeners
    + subscribe(eventType, listener)
    + unsubscribe(eventType, listener)
    + notify(eventType, data)
}
class EmainAlertsListener{
    + update(filename)
}
class LogginListener{
    + update(filename)
}
Editor o--&gt; EventManager
EventManager o--&gt; EventListeners
EmailAlertsListener ..|&gt; EventListeners
LoggingListener ..|&gt; EventListeners
</code></pre><p>只要发布者通过同样的接口与所有订阅者进行交互， 那么在程序中新增订阅者时就无需修改已有发布者类的代码。</p>
<p><img src="https://refactoring.guru/images/patterns/diagrams/observer/example.png" alt="observer example"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>
<span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventManager</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>_listeners <span style="color:#f92672">=</span> defaultdict(list)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">subscribe</span>(self, event_type, listener):
        self<span style="color:#f92672">.</span>_listeners[event_type]<span style="color:#f92672">.</span>append(listener)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unsubscribe</span>(self, event_type, listener):
        self<span style="color:#f92672">.</span>_listeners[event_type]<span style="color:#f92672">.</span>remove(listener)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notify</span>(self, event_type, data):
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_listeners[event_type]:
            i<span style="color:#f92672">.</span>update(data)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Editor</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>file <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>events <span style="color:#f92672">=</span> EventManager()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open_file</span>(self, path):
        self<span style="color:#f92672">.</span>file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;open file&#39;</span>
        self<span style="color:#f92672">.</span>events<span style="color:#f92672">.</span>notify(<span style="color:#e6db74">&#39;open&#39;</span>, self<span style="color:#f92672">.</span>file)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_file</span>(self):
        self<span style="color:#f92672">.</span>file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;write file&#39;</span>
        self<span style="color:#f92672">.</span>events<span style="color:#f92672">.</span>notify(<span style="color:#e6db74">&#39;save&#39;</span>, self<span style="color:#f92672">.</span>file)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventListener</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, file_name):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LoggingListener</span>(EventListener):

    <span style="color:#66d9ef">def</span> __init__(self, log_file_name, message):
        self<span style="color:#f92672">.</span>log <span style="color:#f92672">=</span> log_file_name
        self<span style="color:#f92672">.</span>message <span style="color:#f92672">=</span> message

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, file_name):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} {} update&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>log, file_name))


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailAlertsListener</span>(EventListener):

    <span style="color:#66d9ef">def</span> __init__(self, email, message):
        self<span style="color:#f92672">.</span>email <span style="color:#f92672">=</span> email
        self<span style="color:#f92672">.</span>message <span style="color:#f92672">=</span> message


    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, file_name):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} {} update&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>email, file_name))

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    editor <span style="color:#f92672">=</span> Editor()
    logger <span style="color:#f92672">=</span> LoggingListener(<span style="color:#e6db74">&#39;log&#39;</span>, <span style="color:#e6db74">&#39;file 1&#39;</span>)
    editor<span style="color:#f92672">.</span>events<span style="color:#f92672">.</span>subscribe(<span style="color:#e6db74">&#39;open&#39;</span>, logger)
    email <span style="color:#f92672">=</span> EmailAlertsListener(<span style="color:#e6db74">&#39;email&#39;</span>, <span style="color:#e6db74">&#39;haha&#39;</span>)
    editor<span style="color:#f92672">.</span>events<span style="color:#f92672">.</span>subscribe(<span style="color:#e6db74">&#39;save&#39;</span>, email)
    editor<span style="color:#f92672">.</span>open_file(<span style="color:#e6db74">&#39;file2&#39;</span>)
    editor<span style="color:#f92672">.</span>save_file()

</code></pre></div><h3 id="适用性-17">适用性</h3>
<ul>
<li>当一个对象状态的改变需要改变其他对象，或实际对象是事先未知的或动态变化的，可以使用观察者模式</li>
<li>当应用中的一些对象必须观察其他对象是，可以使用该模式</li>
</ul>
<h3 id="实现步骤-17">实现步骤</h3>
<ul>
<li>声明订阅者接口，至少声明一个 update 方法</li>
<li>声明发布者接口并定义一些接口来管理订阅对象</li>
<li>实现订阅方法</li>
<li>创建发布者类，每次事件发生需要通知订阅者</li>
<li>在具体订阅类中实现通知更新的方法</li>
<li>客户端必须生成全部订阅者，并在相应的发布者处完成注册工作</li>
</ul>
<h3 id="优缺点-17">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 可以运行时建立对象之间的联系</li>
<li><input disabled="" type="checkbox"> 订阅者的通知顺序是随机的</li>
</ul>
<h2 id="状态模式">状态模式</h2>
<h3 id="意图-18">意图</h3>
<p>当对象的内部状态变化时改变其行为， 使其看上去就像改变了自身所属的类一样。</p>
<h3 id="问题-18">问题</h3>
<p>相近概念：有限状态机</p>
<p>程序在任何时刻仅可处于几种有限的状态中，在任何一个特定状态中，程序的行为都不相同， 且可瞬间从一个状态切换到另一个状态。</p>
<p>基于条件语句的状态机，为了能根据当前状态选择完成相应行为的方法会包含复杂的条件语句。 修改其转换逻辑可能会涉及到修改所有方法中的状态条件语句， 导致代码的维护工作非常艰难。</p>
<h3 id="解决方案-18">解决方案</h3>
<p>创建包含所有状态的类，然后将所有状态的对应行为抽取到这些类中。原始对象作为上下文对象，保存指向状态对象的引用，且将所有与状态相关的工作委派给该对象。</p>
<h3 id="uml-结构-18">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface State{
    + doThis()
    + doThat()
}
class ConcreteStates{
    - context
    + setContext(context)
    + doThis()
    + doThat()
}
class Context{
    - state
    + Context(initialState)
    + changeState(state)
    + doThis()
    + doThat()
}
class Client
Client --&gt; Context
Client --&gt; ConcreteStates
ConcreteStates --|&gt; State
ConcreteStates --&gt; Context
Context o--&gt; State
</code></pre><ul>
<li>State 抽象状态接口</li>
<li>ConcreteStates 具体状态类 包含所有需要状态</li>
<li>Context 上下文 切换状态</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/state/structure.png" alt="state structure"></p>
<h3 id="应用示例-18">应用示例</h3>
<p>状态模式将根据当前回放状态， 让媒体播放器中的相同控件完成不同的行为。</p>
<pre><code class="language-plantuml" data-lang="plantuml">class State{
    - player
    + State(player)
    + clickLock()
    + clickPlay()
    + clickNext()
    + clickPrevious()
}
class Player{
    - state
    + UI,volume,playlist,currentSong
    + Player()
    + changeState(state)
    + clickLock()
    + clickPlay()
    + clickNext()
    + clickPrevious()
    + startPlayback()
    + stopPlayback()
    + nextSong()
    + previousSong()
    + fastForward()
    + rewind()
}
Player o--&gt; State
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AudioPlay</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> ReadyState(self)
        self<span style="color:#f92672">.</span>UI <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;UI&#39;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">change_state</span>(self, state):
        self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> state

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_lock</span>(self):
        self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>click_lock()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_play</span>(self):
        self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>click_play()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_next</span>(self):
        self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>click_next()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_previous</span>(self):
        self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>click_previous()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">State</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#66d9ef">def</span> __init__(self, player):
        self<span style="color:#f92672">.</span>player <span style="color:#f92672">=</span> player

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_lock</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_play</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_next</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_previous</span>(self):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LockedState</span>(State):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_lock</span>(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>player<span style="color:#f92672">.</span>playing:
            self<span style="color:#f92672">.</span>player<span style="color:#f92672">.</span>change_state(PlayingState(self<span style="color:#f92672">.</span>player))
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>player<span style="color:#f92672">.</span>change_state(ReadyState(self<span style="color:#f92672">.</span>player))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_next</span>(self):
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>click_next()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_play</span>(self):
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>click_play()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_previous</span>(self):
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>click_previous()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReadyState</span>(State):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_lock</span>(self):
        self<span style="color:#f92672">.</span>player<span style="color:#f92672">.</span>change_state(LockedState(self<span style="color:#f92672">.</span>player))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_next</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;next song&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_previous</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;previous song&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_play</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;play song&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PlayingState</span>(State):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_lock</span>(self):
        self<span style="color:#f92672">.</span>player<span style="color:#f92672">.</span>change_state(LockedState(self<span style="color:#f92672">.</span>player))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_play</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;stop play&#39;</span>)
        self<span style="color:#f92672">.</span>player<span style="color:#f92672">.</span>change_state(ReadyState(self<span style="color:#f92672">.</span>player))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_next</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;next song&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_previous</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;previous song&#39;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    play <span style="color:#f92672">=</span> AudioPlay()
    play<span style="color:#f92672">.</span>click_next()
    play<span style="color:#f92672">.</span>click_previous()
    play<span style="color:#f92672">.</span>click_play()
    play<span style="color:#f92672">.</span>click_lock()
    play<span style="color:#f92672">.</span>click_next()
    play<span style="color:#f92672">.</span>click_previous()
    play<span style="color:#f92672">.</span>click_play()

</code></pre></div><h3 id="适用性-18">适用性</h3>
<ul>
<li>如果对象需要根据自身当前状态进行不同行为，同时状态的数量非常多且与状态相关的代码会频繁变更</li>
<li>如果某个类需要根据成员变量的当前值改变自身行为，需要使用大量的条件语句</li>
<li>当相似状态和基于条件的状态机转换中存在许多重复代码</li>
</ul>
<h3 id="实现步骤-18">实现步骤</h3>
<ul>
<li>
<p>确认上下文类</p>
</li>
<li>
<p>声明状态接口</p>
</li>
<li>
<p>实现特定状态的具体类</p>
<ul>
<li>这些成员变量或方法设为公有。</li>
<li>将需要抽取的上下文行为更改为上下文中的公有方法， 然后在状态类中调用。</li>
<li>将状态类嵌套在上下文类中。</li>
</ul>
</li>
<li>
<p>上下文类中添加一个状态接口类型的引用成员变量， 以及一个用于修改该成员变量值的公有接口。</p>
</li>
</ul>
<h3 id="优缺点-18">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 消除臃肿的状态机条件语句简化上下文代码</li>
<li><input disabled="" type="checkbox"> 状态机只有很少的几个状态， 或者很少发生改变， 那么应用该模式可能会显得小题大作</li>
</ul>
<h2 id="策略模式">策略模式</h2>
<h3 id="意图-19">意图</h3>
<p>定义一系列算法， 并将每种算法分别放入独立的类中， 以使算法的对象能够相互替换。</p>
<h3 id="问题-19">问题</h3>
<p>实现自动导航的导游程序，首次实现了公交版的路线规划，随后增加了骑行者者版本的路线规划，随着需求越来越多，代码量增加可维护性下降。</p>
<h3 id="解决方案-19">解决方案</h3>
<p>策略模式找出负责用许多不同方式完成特定任务的类， 然后将其中的算法抽取到一组被称为策略的独立类中。</p>
<p>上下文的原始类必须包含一个成员变量来存储对于每种策略的引用。 上下文并不执行任务， 而是将工作委派给已连接的策略对象。</p>
<h3 id="uml-结构-19">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Strategy{
    + execute(data)
}
class ConcreteStrategies{
    + execute(data)
}
class Context{
    - strategy
    + setStrategy(strategy)
    + doSomething()
}
class Client
Client --&gt; Context
Client --&gt; ConcreteStrategies
Context o--&gt; Strategy
ConcreteStrategies ..|&gt; Strategy
</code></pre><ul>
<li>Strategy 抽象策略类</li>
<li>ConcreteStrategies 具体策略类</li>
<li>Context 上下文 维护指向具体策略的引用，上下文不清楚其所涉及的策略类型与算法的执行方式</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/strategy/structure.png" alt="strategy structure"></p>
<h3 id="应用示例-19">应用示例</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Strategy</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConcreteStrategyAdd</span>(Strategy):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> args:
            ret <span style="color:#f92672">+=</span> int(i)
        <span style="color:#66d9ef">return</span> ret


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConcreteStrategySubtract</span>(Strategy):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        ret <span style="color:#f92672">=</span> args[<span style="color:#ae81ff">0</span>]
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> args[<span style="color:#ae81ff">1</span>:]:
            ret <span style="color:#f92672">-=</span> int(i)
        <span style="color:#66d9ef">return</span> ret



<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConcreteStrategyMultiply</span>(Strategy):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> args:
            ret <span style="color:#f92672">*=</span> int(i)
        <span style="color:#66d9ef">return</span> ret


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Context</span>(object):

    <span style="color:#66d9ef">def</span> __init__(self, strategy<span style="color:#f92672">=</span>None):
        super()<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>strategy <span style="color:#f92672">=</span> strategy

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_strategy</span>(self, strategy):
        self<span style="color:#f92672">.</span>strategy <span style="color:#f92672">=</span> strategy

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute_strategy</span>(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>strategy<span style="color:#f92672">.</span>execute(<span style="color:#f92672">*</span>args)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:

    a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>

    context <span style="color:#f92672">=</span> Context()
    context<span style="color:#f92672">.</span>set_strategy(ConcreteStrategyAdd())
    <span style="color:#66d9ef">print</span>(context<span style="color:#f92672">.</span>execute_strategy(a, b))
    context<span style="color:#f92672">.</span>set_strategy(ConcreteStrategySubtract())
    <span style="color:#66d9ef">print</span>(context<span style="color:#f92672">.</span>execute_strategy(a, b))
    context<span style="color:#f92672">.</span>set_strategy(ConcreteStrategyMultiply())
    <span style="color:#66d9ef">print</span>(context<span style="color:#f92672">.</span>execute_strategy(a, b))

</code></pre></div><h3 id="适用性-19">适用性</h3>
<ul>
<li>当你想使用对象中各种不同的算法变体， 并希望能在运行时切换算法时， 可使用策略模式。</li>
<li>当你有许多仅在执行某些行为时略有不同的相似类时， 可使用策略模式。</li>
<li>如果算法在逻辑的上下文中不是特别重要， 使用该模式能将类的业务逻辑与其算法实现细节隔离开来。</li>
<li>当类中使用了复杂条件运算符以在同一算法的不同变体中切换时， 可使用该模式。</li>
</ul>
<h3 id="实现步骤-19">实现步骤</h3>
<ul>
<li>上下文中修改频率较高的算法</li>
<li>声明该算法的通用接口</li>
<li>实现具体策略类</li>
<li>上下文类中添加一个成员变量用于保存对于策略对象的引用。 然后提供设置方法</li>
</ul>
<h3 id="优缺点-19">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 在运行时切换对象内的算法。</li>
<li><input checked="" disabled="" type="checkbox"> 将算法的实现和使用算法的代码隔离开来。</li>
<li><input checked="" disabled="" type="checkbox"> 使用组合来代替继承。</li>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input disabled="" type="checkbox"> 如果你的算法极少发生改变， 那么没有任何理由引入新的类和接口。</li>
<li><input disabled="" type="checkbox"> 客户端必须知晓策略间的不同——它需要选择合适的策略。</li>
<li><input disabled="" type="checkbox"> 许多现代编程语言支持函数类型功能， 允许你在一组匿名函数中实现不同版本的算法。</li>
</ul>
<h2 id="模版方法模式">模版方法模式</h2>
<h3 id="意图-20">意图</h3>
<p>超类中定义了一个算法的框架， 允许子类在不修改结构的情况下重写算法的特定步骤。</p>
<h3 id="问题-20">问题</h3>
<p>编写文档数据提取工具，首个版本仅支持 DOC 文件，随后增加了 CSV、PDF 文件的支持。</p>
<p>发现这三个类中包含许多相似代码。 尽管这些类处理不同数据格式的代码完全不同， 但数据处理和分析的代码却几乎完全一样。并且客户端中包含了很多条件语句。</p>
<h3 id="解决方案-20">解决方案</h3>
<p>模板方法模式建议将算法分解为一系列步骤， 然后将这些步骤改写为方法， 最后在 “模板方法” 中依次调用这些方法。步骤可以是抽象的， 也可以有一些默认的实现。为了能够使用算法， 客户端需要自行提供子类并实现所有的抽象步骤。 如有必要还需重写一些步骤（不包括模板方法）。</p>
<h3 id="uml-结构-20">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">class AbstractClass{
    + templateMethod()
    + step1()
    + step2()
    + step3()
}
class ConcreteClass1{
    + step2()
    + step3()
}
class ConcreteClass2{
    + step1()
    + step2()
}
ConcreteClass1 --|&gt; AbstractClass
ConcreteClass2 --|&gt; AbstractClass
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/template-method/structure.png" alt="tempalte method structure"></p>
<h3 id="应用示例-20">应用示例</h3>
<p>AI 策略类游戏</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GameAI</span>(object):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_structures</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_units</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_scouts</span>(self, position):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_warriors</span>(self, position):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">closest_enemy</span>(self):
        <span style="color:#66d9ef">return</span> True

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collection_resources</span>(self):
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>build_structures():
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;collection {}&#39;</span><span style="color:#f92672">.</span>format(i))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">attack</span>(self):
        enemy <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>closest_enemy()
        <span style="color:#66d9ef">if</span> enemy:
            self<span style="color:#f92672">.</span>send_warriors(<span style="color:#e6db74">&#39;x1&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>send_scouts(<span style="color:#e6db74">&#39;y1&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">turn</span>(self):
        <span style="color:#75715e"># template method</span>
        self<span style="color:#f92672">.</span>collection_resources()
        self<span style="color:#f92672">.</span>build_structures()
        self<span style="color:#f92672">.</span>build_units()
        self<span style="color:#f92672">.</span>attack()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrcsAI</span>(GameAI):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_structures</span>(self):
        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_units</span>(self):
        <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;u1&#39;</span>, <span style="color:#e6db74">&#39;u2&#39;</span>, <span style="color:#e6db74">&#39;u3&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_scouts</span>(self, position):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} send scouts to {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, position))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_warriors</span>(self, position):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{} send warriors to {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, position))


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MonstersAI</span>(GameAI):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collection_resources</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_structures</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_units</span>(self):
        <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    orcs_ai <span style="color:#f92672">=</span> OrcsAI()
    orcs_ai<span style="color:#f92672">.</span>turn()
    monsters_ai <span style="color:#f92672">=</span> MonstersAI()
    monsters_ai<span style="color:#f92672">.</span>turn()

</code></pre></div><h3 id="适用性-20">适用性</h3>
<ul>
<li>希望客户端扩展某个特定算法步骤， 而不是整个算法或其结构</li>
<li>多个类的算法除一些细微不同之外几乎完全一样时， 你可使用该模式。 但其后果就是， 只要算法发生变化， 你就可能需要修改所有的类。</li>
</ul>
<h3 id="实现步骤-20">实现步骤</h3>
<ul>
<li>分析目标算法， 确定能否将其分解为多个步骤</li>
<li>创建抽象基类并声明一个模板方法和代表算法步骤的一系列抽象方法</li>
<li>可考虑在算法的关键步骤之间添加钩子，改变算法流程</li>
<li>为每个算法变体新建一个具体子类， 实现抽象步骤</li>
</ul>
<h3 id="优缺点-20">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 允许客户端重写一个大型算法中的特定部分</li>
<li><input checked="" disabled="" type="checkbox"> 将重复代码提取到一个超类中</li>
<li><input disabled="" type="checkbox"> 部分客户端可能会受到算法框架的限制</li>
<li><input disabled="" type="checkbox"> 违反里氏替换原则</li>
<li><input disabled="" type="checkbox"> 模板方法中的步骤越多， 其维护工作就可能会越困难</li>
</ul>
<h2 id="访问者模式">访问者模式</h2>
<h3 id="意图-21">意图</h3>
<p>访问者的目的是让你能为整个类层次结构添加 “外部” 操作， 而无需修改这些类的已有代码。</p>
<h3 id="问题-21">问题</h3>
<p>已有的地图产品需要实现地图节点 XML 导出模块，可以修改原有的类实现导出功能，但是可能引入潜在的风险</p>
<h3 id="解决方案-21">解决方案</h3>
<p>访问者模式建议将新行为放入一个名为访问者的独立类中， 而不是试图将其整合到已有类中。 现在， 需要执行操作的原始对象将作为参数被传递给访问者中的方法， 让方法能访问对象所包含的一切必要数据。</p>
<p>访问者类访问不同的节点对象时，由于节点对象各自处理方法不同，需要进行判断。访问模式实现了双分派技巧，将处理的方法委派给作为参数传递给访问者的节点对象</p>
<h3 id="uml-结构-21">UML 结构</h3>
<pre><code class="language-plantuml" data-lang="plantuml">interface Visitor{
    + visit(e: ElementA)
    + visit(e: ElementB)
}
interface Element{
    + accept(v: Visitor)
}
class ElementA{
    + featureA()
    + accept(v: Visitor)
}
class ElementB{
    + featureB()
    + accept(v: Visitor)
}
class ConcreteVisitors{
    + visit(e: ElementA)
    + visit(e: ElementB)
}
class Client
Client --&gt; ConcreteVisitors
Client --&gt; Element
Element --&gt; Visitor
Visitor --&gt; ElementA
Visitor --&gt; ElementB
ConcreteVisitors ..|&gt; Visitor
ElementA ..|&gt; Element
ElementB ..|&gt; Element
</code></pre><ul>
<li>Visitor 抽象接口声明节点对象访问方法</li>
<li>Element 抽象节点声明接收访问者的方法</li>
<li>ElementA 具体节点类</li>
<li>ConcreteVisitors 具体访问者</li>
</ul>
<p><img src="https://refactoring.guru/images/patterns/diagrams/visitor/structure.png" alt="visitor structure"></p>
<h3 id="应用示例-21">应用示例</h3>
<p>几何图像层次结构添加了对于 XML 文件导出功能</p>
<pre><code class="language-plantuml" data-lang="plantuml">interface Visitor{
    + visitDot(d: Dot)
    + visitCircle(c: Circle)
    + visitRectangle(r: Rectangle)
    + visitCompundGraphic(cs: CompoundGraphic)
}
interface Shape{
    + move(x, y)
    + draw()
    + accept(v: Visitor)
}
class Dot
class Circle
class Rectangle
class CompundGraphic
class XMLExportVisitor{
    + visitDot(d: Dot)
    + visitCircle(c: Circle)
    + visitRectangle(r: Rectangle)
    + visitCompundGraphic(cs: CompoundGraphic)
}
class Application
Application --&gt; XMLExportVisitor
Application --&gt; Shape
Shape --&gt; Visitor
Visitor --&gt; Dot
Visitor --&gt; Circle
Visitor --&gt; Rectangle
Visitor --&gt; CompundGraphic
</code></pre><p><img src="https://refactoring.guru/images/patterns/diagrams/visitor/example.png" alt="visitor example">
<a href="https://refactoring.guru/design-patterns/visitor-double-dispatch">visitor and double dispatch</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Shape</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#75715e"># @abstractmethod</span>
    <span style="color:#75715e"># def move(self, x, y):</span>
    <span style="color:#75715e">#     pass</span>

    <span style="color:#75715e"># @abstractmethod</span>
    <span style="color:#75715e"># def draw(self):</span>
    <span style="color:#75715e">#     pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">accept</span>(self, visitor):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Visitor</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitDot</span>(self, shape):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitCircle</span>(self, shape):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitRectangle</span>(self, shape):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitCompoundShape</span>(self, shape):
        <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dot</span>(Shape):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">accept</span>(self, visitor):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, visitor: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, visitor))
        visitor<span style="color:#f92672">.</span>visitDot(self)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Circle</span>(Shape):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">accept</span>(self, visitor):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, visitor: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, visitor))
        visitor<span style="color:#f92672">.</span>visitCircle(self)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Rectangle</span>(Shape):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">accept</span>(self, visitor):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, visitor: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, visitor))
        visitor<span style="color:#f92672">.</span>visitRectangle(self)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CompoundShape</span>(Shape):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">accept</span>(self, visitor):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, visitor: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, visitor))
        visitor<span style="color:#f92672">.</span>visitCompoundShape(self)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">XMLExportVisitor</span>(Visitor):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitDot</span>(self, shape):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, self: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, self))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitCircle</span>(self, shape):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, self: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, self))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitRectangle</span>(self, shape):
        super()<span style="color:#f92672">.</span>visitRectangle(shape)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, self: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, self))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visitCompoundShape</span>(self, shape):
        super()<span style="color:#f92672">.</span>visitCompoundShape(shape)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;class: {}, self: {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__, self))


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    export_visitor <span style="color:#f92672">=</span> XMLExportVisitor()
    shapes <span style="color:#f92672">=</span> [Dot(), Circle(), Rectangle(), CompoundShape()]
    <span style="color:#66d9ef">for</span> shape <span style="color:#f92672">in</span> shapes:
        shape<span style="color:#f92672">.</span>accept(export_visitor)

</code></pre></div><h3 id="适用性-21">适用性</h3>
<ul>
<li>对一个复杂对象结构 （例如对象树） 中的所有元素执行某些操作， 可使用访问者模式。</li>
<li>可使用访问者模式来清理辅助行为的业务逻辑。</li>
<li>当某个行为仅在类层次结构中的一些类中有意义， 而在其他类中没有意义时， 可使用该模式。</li>
</ul>
<h3 id="实现步骤-21">实现步骤</h3>
<ul>
<li>在访问者接口中声明一组 “访问” 方法， 分别对应程序中的每个具体元素类。</li>
<li>声明元素接口，该方法必须接受访问者对象作为参数。</li>
<li>在所有具体元素类中实现接收方法。 这些方法必须将调用重定向到当前元素对应的访问者对象中的访问者方法上。</li>
<li>元素类只能通过访问者接口与访问者进行交互。</li>
<li>为每个无法在元素层次结构中实现的行为创建一个具体访问者类并实现所有的访问者方法。</li>
</ul>
<h3 id="优缺点-21">优缺点</h3>
<ul>
<li><input checked="" disabled="" type="checkbox"> 开闭原则</li>
<li><input checked="" disabled="" type="checkbox"> 单一职责原则</li>
<li><input disabled="" type="checkbox"> 访问者对象可以在与各种对象交互时收集一些有用的信息。</li>
<li><input disabled="" type="checkbox"> 每次在元素层次结构中添加或移除一个类时， 你都要更新所有的访问者。</li>
<li><input disabled="" type="checkbox"> 在访问者同某个元素进行交互时， 它们可能没有访问元素私有成员变量和方法的必要权限。</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="https://python-patterns.guide/">python pattern</a></li>
<li><a href="https://refactoring.guru/design-patterns">refactor guru</a></li>
</ul>

  </div>
</div>
<div class="container has-text-centered">
    
    <aside><div id="share"></div></aside>
    <script type="text/javascript">
        $("#share").jsSocials({
            showLabel: false,
            showCount: false,
            shares: ["email", "twitter", "facebook", "googleplus", "linkedin", "pinterest", "stumbleupon", "whatsapp"]
        });
    </script>
    
</div>

<div class="container has-text-centered">
  
</div>
<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/cnewbie/">cnewbie</a> 2018 - 2020</p>
  </div>
</section>


